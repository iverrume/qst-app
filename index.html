<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QSTiUM - Интерактивная платформа для тестов и обучения</title>

    <meta name="description" content="Создавайте, проходите и делитесь тестами в формате .qst, .txt и .pdf. Используйте AI-генератор для создания учебных материалов, анализируйте ошибки и готовьтесь к экзаменам с QSTiUM.">
    <meta name="keywords" content="тесты, qst, обучение, экзамены, подготовка к экзаменам, создать тест, онлайн тест, AI генератор тестов, работа над ошибками, шпаргалка">

    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <link rel="manifest" href="manifest.json">
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <style>
        #gradusButton {
            line-height: 1.3;
            padding-top: 12px;
            padding-bottom: 12px;
        }
        #gradusButton .gradus-subtitle {
            display: block;
            font-size: 0.75em;
            font-weight: normal;
            margin-top: 4px;
        }
    </style>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- KaTeX для отображения математических формул -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>
</head>

<body>

    <div id="updateNotification" class="update-notification hidden">
        <span data-lang-key="update_available_text">Доступна новая версия!</span>
        <button id="updateBtn" data-lang-key="update_button_text">Обновить</button>
    </div>

    <div class="app-wrapper">
        <!-- === ВОТ ОН, ВОССТАНОВЛЕННЫЙ КОНТЕЙНЕР === -->
        <div class="container">

            <!-- ========== ИНДИКАТОР НАЧАЛЬНОЙ ЗАГРУЗКИ ========== -->
            <div id="initial-loader" class="loading-placeholder">
                <div class="loading-spinner"></div>
                <p>Загрузка приложения...</p>
            </div>
            <!-- ========== КОНЕЦ ИНДИКАТОРА ========== -->

            <div class="header-controls">
                <!-- Заголовок теперь ВНЕ контейнера с кнопками -->
                <h1 id="appTitleHeader" data-lang-key="app_title">QSTiUM</h1>
 
                <!-- Контейнер теперь только для кнопок -->
                <div class="header-buttons"> 
                    <button id="copyQuestionBtnQuiz" title="Копировать текущий вопрос" aria-label="Копировать текущий вопрос" class="hidden" data-lang-key="copy_question_title" data-lang-skip-content="true"><i data-lucide="copy"></i></button>
                    <div class="dropdown hidden" id="webSearchDropdown">
                        <button id="searchWebButton" title="Найти в интернете" aria-label="Найти в интернете" data-lang-key="search_web_title" data-lang-skip-content="true"><i data-lucide="search"></i></button>
                        <div id="searchDropdownContent" class="dropdown-content">
                            <a href="#" data-engine="google" data-lang-key="search_engine_google">Google</a>
                            <a href="#" data-engine="yandex" data-lang-key="search_engine_yandex">Яндекс</a>
                            <a href="#" data-engine="perplexity" data-lang-key="search_engine_perplexity">Perplexity</a>
                        </div>
                    </div>
                    <button id="chatToggle" title="Открыть чат" aria-label="Открыть чат" data-lang-key="chat_button_title" data-lang-skip-content="true"><i data-lucide="message-circle"></i></button>
                    <button id="quickModeToggle" title="Быстрый режим (Автопереход)" aria-label="Быстрый режим" class="hidden" data-lang-key="quick_mode_title" data-lang-skip-content="true"><i data-lucide="zap"></i></button>
                    <button id="triggerWordToggle" title="Триггер-слова" aria-label="Триггер-слова" class="hidden" data-lang-key="trigger_words_title" data-lang-skip-content="true"><i data-lucide="highlighter"></i></button>

                    <div class="dropdown" id="themeDropdownContainer">
                        <button id="themeDropdownButton" title="Сменить тему" aria-label="Сменить тему" data-lang-key="theme_button_title" data-lang-skip-content="true">
                            <span id="themeIcon"><i data-lucide="sun-moon"></i></span>
                        </button>
                        <div id="themeDropdownContent" class="dropdown-content theme-picker-dropdown">
                            <!-- Сюда JS вставит иконки тем -->
                        </div>
                    </div>

                    <button id="languageToggle" title="Сменить язык" aria-label="Сменить язык" data-lang-key="language_toggle_title">Рус</button>
                    <button id="favoriteQuestionBtn" title="Добавить в избранное" aria-label="Добавить в избранное" class="hidden" data-lang-key="favorite_button_title" data-lang-skip-content="true"><i data-lucide="star"></i></button>
                    <div class="translate-engine-container">
                        <button id="translateQuestionBtn" title="Перевести вопрос" aria-label="Перевести вопрос" class="hidden" data-lang-key="translate_question_title" data-lang-skip-content="true"><i data-lucide="languages"></i></button>
                        <button id="translateEngineToggle" class="hidden" title="Выбрать движок перевода" aria-label="Выбрать движок перевода">▼</button>
                        <div id="translateEngineDropdown" class="dropdown-content">
                            <a href="#" data-engine="google" data-lang-key="translate_engine_google">
                                <span class="engine-name">Google</span>
                                <span class="checkmark">✓</span>
                            </a>
                            <a href="#" data-engine="ai" data-lang-key="translate_engine_ai">
                                <span class="engine-name">AI (ИИ)</span>
                                <span class="checkmark">✓</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="file-upload-area" id="fileUploadArea">
                <div id="searchVerificationContainer" class="hidden">
                    <p data-lang-key="checking_access">Проверка...</p>
                </div>
                <div id="searchActivationContainer" class="hidden">
                    <label for="accessCodeInput" data-lang-key="activation_label">Активация:</label>
                    <input type="text" id="accessCodeInput" placeholder="Введите ваш одноразовый ключ..." data-lang-key="activation_placeholder">
                    <button id="activateSearchBtn" data-lang-key="activation_button">Активировать</button>
                </div>
                <div id="searchContainer" class="hidden">
                    <label for="searchQueryInput" data-lang-key="search_in_db">Поиск вопроса в базе:</label>
                    <input type="text" id="searchQueryInput" placeholder="Введите часть текста вопроса..." data-lang-key="search_placeholder">
                    <button id="searchButton" data-lang-key="find_button">Найти</button>
                </div>
                <p class="main-screen-divider" data-lang-key="or_divider"></p>

                <!-- === НАЧАЛО ИЗМЕНЕНИЙ: Динамический блок с подсказками === -->
                <div id="dynamicDescriptionContainer" class="dynamic-description-container" style="text-align: center; margin-bottom: 20px; color: var(--secondary-text-color); line-height: 1.6; cursor: pointer;">
                    <!-- Этот блок виден поисковикам и пользователям с отключенным JS -->
                    <p data-lang-key="app_description">
                        QSTiUM — это мощный инструмент для подготовки к тестам и экзаменам. Загружайте готовые файлы, создавайте новые тесты из текста с помощью ИИ, проводите работу над ошибками и делитесь материалами с другими.
                    </p>
                </div>
                <!-- === КОНЕЦ ИЗМЕНЕНИЙ === -->



                <div class="main-actions-grid">
                    <label for="fileInput" class="custom-file-upload-btn">
                        <i data-lucide="file-up"></i>
                        <!-- Добавлена обертка div -->
                        <div class="main-action-text-wrapper">
                            <span data-lang-key="choose_file">Выберите .qst|.txt|.pdf файл</span>
                        </div>
                    </label>
                    <input type="file" id="fileInput" accept=".qst,.txt,.pdf" multiple>
                    
                    <button id="parserButton">
                        <i data-lucide="lightbulb"></i>
                        <!-- Добавлена обертка div -->
                        <div class="main-action-text-wrapper">
                             <span data-lang-key="parser_button_main">Создать тест</span>
                        </div>
                    </button>

                    <button id="gradusButton">
                        <i data-lucide="graduation-cap"></i>
                        <!-- Добавлена обертка div -->
                        <div class="main-action-text-wrapper">
                            <span>GRADUS</span>
                        </div>
                    </button>
                </div>
                                


                <div id="savedSessionArea" class="hidden">
                    <h4 data-lang-key="continue_sessions">Продолжить:</h4>
                    <div id="savedSessionList"></div>
                </div>
                <div id="recentFilesArea" class="hidden">
                    <h4 data-lang-key="recent_files">Недавно использованные:</h4>
                    <ul id="recentFilesList"></ul>
                </div>
            </div>

            <div id="searchResultsContainer" class="view hidden">
                <div class="search-results-header">
                    <h2 data-lang-key="search_results_title">Результаты поиска</h2>
                    <button id="backToSearchButton" class="btn btn-secondary" data-lang-key="back_to_search">Новый поиск</button>
                </div>
                <div id="searchNavigation" class="search-navigation hidden">
                    <button id="prevResultBtn" class="nav-arrow" disabled>&lt;</button>
                    <span id="resultCounter">0 / 0</span>
                    <button id="nextResultBtn" class="nav-arrow" disabled>&gt;</button>
                </div>
                <div id="searchResultCards">
                    <!-- Карточки с результатами будут вставляться сюда -->
                </div>
            </div>

            <div id="gradusFoldersContainer" class="hidden">
                <h2 data-lang-key="nav_gradus">Навигация по GRADUS</h2>
                <div id="gradusBreadcrumbs"></div>
                <div id="gradusFolderList"></div>
                <button id="backToFileUploadButton" style="margin-top: 15px;" data-lang-key="back_to_main">Назад к главному экрану</button>
            </div>

            <div id="quizSetupArea" class="hidden">
                <h2 data-lang-key="quiz_settings_title">Настройки теста</h2>

                <div class="settings-group">
                    <label for="timeLimitSlider" data-lang-key="time_limit">Лимит времени (минуты, 0 - без лимита):</label>
                    <div class="time-limit-wrapper">
                        <!-- Поле для ручного ввода -->
                        <div class="range-inputs-container time-limit-input-container">
                             <input type="number" id="timeLimitInput" min="0" max="180" value="0" class="range-input">
                             <span data-lang-key="time_limit_minutes">мин</span>
                        </div>
                        <!-- Улучшенный слайдер с подсказкой -->
                        <div class="single-slider-container time-slider-modern">
                            <div id="timeSliderValueBubble" class="slider-value-bubble">0 мин</div>
                            <div id="timeSliderTrack" class="slider-track"></div>
                            <div id="timeSliderTicks" class="slider-ticks"></div>
                            <div id="timeSliderProgress" class="slider-progress"></div>
                            <input type="range" id="timeLimitSlider" min="0" max="180" value="0" step="1">
                        </div>
                    </div>
                </div>


                <div class="settings-group" id="questionRangeGroup">
                    <div class="range-label-container">
                        <label for="questionRangeStart" data-lang-key="question_range">Диапазон вопросов:</label>
                        <span id="maxQuestionsInfo"></span>
                    </div>
                    <div class="dual-slider-container">
                        <div id="sliderTrack" class="slider-track"></div>
                        <div id="sliderTicks" class="slider-ticks"></div>
                        <div id="sliderProgress" class="slider-progress"></div>
                        <input type="range" id="rangeSliderStart" min="1" value="1" step="1">
                        <input type="range" id="rangeSliderEnd" min="1" value="100" step="1">
                    </div>
                    <div class="range-inputs-container">
                        <span data-lang-key="range_from">От</span> 
                        <input type="number" id="questionRangeStart" min="1" value="1" class="range-input">
                        <span data-lang-key="range_to">До</span> 
                        <input type="number" id="questionRangeEnd" min="1" class="range-input">
                    </div>
                </div>




                <div class="settings-group">
                    <input type="checkbox" id="shuffleNQuestions">
                    <label for="shuffleNQuestions" data-lang-key="shuffle_n_questions">Случайный набор из</label>
                    <input type="number" id="shuffleNQuestionsCount" min="1" value="50" class="range-input" style="width: 70px;">
                    <label for="shuffleNQuestionsCount" data-lang-key="questions_label_for_range">вопросов</label>
                </div>

                <!-- ======== НАЧАЛО НОВОГО КОДА ======== -->
                <div class="settings-group hidden" id="languageFilterGroup">
                    <label for="languageFilter" data-lang-key="language_filter_label">Язык вопросов:</label>
                    <select id="languageFilter" style="width: 100%; padding: 8px; border-radius: 4px; margin-top: 10px;">
                        <!-- Опции будут добавлены через JS -->
                    </select>
                </div>
                <!-- ======== КОНЕЦ НОВОГО КОДА ======== -->

                <!-- ======== НАЧАЛО БЛОКА ФИЛЬТРА КАТЕГОРИЙ ======== -->
                <div class="settings-group hidden" id="categoryFilterGroup">
                    <div class="category-filter-header">
                        <label data-lang-key="category_filter_label">Фильтр по категориям:</label>
                        <div>
                            <button id="selectAllCategoriesBtn" class="btn-secondary-small" data-lang-key="select_all_btn">Все</button>
                            <button id="deselectAllCategoriesBtn" class="btn-secondary-small" data-lang-key="deselect_all_btn">Снять</button>
                        </div>
                    </div>
                    <div id="categoryCheckboxes" class="category-checkboxes-container">
                        <!-- Чекбоксы с категориями будут вставлены сюда через JS -->
                    </div>
                    <p class="category-filter-note" data-lang-key="category_filter_note">
                        Если ни одна категория не выбрана, в тест войдут вопросы из всех категорий.
                    </p>
                </div>
                <!-- ======== КОНЕЦ БЛОКА ФИЛЬТРА КАТЕГОРИЙ ======== -->

                <div class="settings-group">
                    <input type="checkbox" id="shuffleQuestions">
                    <label for="shuffleQuestions" data-lang-key="shuffle_questions">Перемешать вопросы</label>
                </div>



                <div class="settings-group">
                    <input type="checkbox" id="shuffleAnswers">
                    <label for="shuffleAnswers" data-lang-key="shuffle_answers">Перемешать ответы</label>
                </div>
                <div class="settings-group">
                    <input type="checkbox" id="feedbackMode">
                    <label for="feedbackMode" data-lang-key="feedback_mode">Режим обратной связи (сохранить ошибки)</label>
                </div>
                <div class="settings-group">
                    <input type="checkbox" id="readingMode">
                    <label for="readingMode" data-lang-key="reading_mode">Режим чтения (первый вариант верный)</label>
                </div>
                <div class="settings-group">
                    <input type="checkbox" id="flashcardsMode">
                    <label for="flashcardsMode" data-lang-key="flashcards_mode">Режим карточек (вопрос/ответ)</label>
                </div>
                <button id="startQuizButton" data-lang-key="start_quiz_button">Начать тест</button>
                <button id="generateCheatSheetButton" style="margin-top: 10px;" data-lang-key="generate_cheat_sheet_button">Создать шпору</button>
                <button id="chooseAnotherFileButton" style="margin-top: 10px;" data-lang-key="choose_another_file_button">Выбрать другой файл</button>
            </div>

            <div id="cheatSheetResultArea" class="hidden">
                <h2 data-lang-key="cheat_sheet_title">Сгенерированная шпора:</h2>
                <textarea id="cheatSheetOutput" readonly rows="15"></textarea>
                <button id="downloadCheatSheetButton" data-lang-key="download_cheat_sheet_button">Скачать шпору (.txt)</button>
                <button id="backToSettingsButton" style="margin-top: 10px;" data-lang-key="back_to_settings_button">Назад к настройкам</button>
            </div>

            <div id="quizArea" class="hidden">
                <div id="timerDisplay" class="hidden"><span data-lang-key="timer_label">Время:</span> <span id="timeLeft">--:--</span></div>
                <div id="questionContainer">
                    <div id="questionText"></div>
                    <ul id="answerOptions"></ul>
                    <div id="feedbackArea" class="feedback-area"></div>
                </div>
                <div id="questionNavigationControls">
                    <button id="prevQuestionButton" disabled data-lang-key="prev_question_button">Предыдущий</button>
                    <button id="nextButton" data-lang-key="next_question_button">Следующий</button>
                </div>
                <div id="score">
                    <p><span data-lang-key="question_label">Вопрос:</span> <span id="currentQuestionNum">0</span> / <span id="totalQuestionsNum">0</span></p>
                    <p><span data-lang-key="correct_label">Правильно:</span> <span id="correctAnswersCount">0</span></p>
                </div>
                <div id="quickNavPanel" class="hidden">
                    <h4 data-lang-key="quick_nav_title">Навигация по вопросам:</h4>
                    <div id="quickNavButtons"></div>
                </div>
                <div class="quiz-footer-controls">
                     <button id="downloadTranslatedTxtButton" class="hidden">Скачать (txt)</button>
                     <button id="downloadTranslatedQstButton" class="hidden">Скачать (qst)</button>
                     <button id="continueLaterButton" class="hidden" data-lang-key="continue_later_button">Продолжить позже</button>
                     <button id="finishTestButton" class="finish-test-early hidden" data-lang-key="finish_early_button">Завершить тест</button>
                </div>
            </div>

            <div id="resultsArea" class="hidden">
                <h2 data-lang-key="quiz_finished_title">Тест завершен!</h2>
                <p><span data-lang-key="your_result">Ваш результат:</span> <span id="finalCorrect"></span> <span data-lang-key="of_label">из</span> <span id="finalTotal"></span>.</p>
                <p><span data-lang-key="accuracy_label">Точность:</span> <span id="finalPercentage"></span>%</p>
                <div id="feedbackDownloadArea" class="hidden">
                    <button id="downloadErrorsButton" data-lang-key="download_errors_button">Скачать неотвеченные/неправильные вопросы</button>
                </div>
                <div id="errorReviewArea" class="hidden">
                     <button id="reviewErrorsButton" data-lang-key="review_errors_button">Работа над ошибками</button>
                </div>
                <div id="aiAnalysisArea" class="hidden">
                    <button id="aiAnalysisBtn" data-lang-key="ai_error_analysis_button">🤖 Аналитика ошибок от ИИ</button>
                    <div id="aiAnalysisResult" class="ai-analysis-result hidden">
                        <!-- Сюда будет вставлен результат анализа -->
                    </div>
                </div>
                <div id="triggeredQuizDownloadArea" class="hidden">
                    <button id="downloadTriggeredQuizButton" data-lang-key="download_triggered_quiz_button">Скачать тест с триггерами</button>
                </div>
                <button id="restartButton" data-lang-key="restart_button">Пройти другой тест</button>
            </div>

            <div id="parserArea" class="hidden">
                <div class="parser-tabs">
                    <button id="converterTabBtn" class="parser-tab active" data-lang-key="tab_converter">Конвертер из текста</button>
                    <button id="aiFromTextTabBtn" class="parser-tab" data-lang-key="tab_ai_from_text">ИИ-генератор из текста</button>
                    <button id="aiFromTopicTabBtn" class="parser-tab" data-lang-key="tab_ai_generator">ИИ-генератор по теме</button>
                </div>
                <div class="parser-tab-content-wrapper">
                    <!-- === ВКЛАДКА 1: КОНВЕРТЕР === -->
                    <div id="converterContent" class="parser-tab-content active">
                        <p style="text-align: center; color: var(--secondary-text-color);" data-lang-key="parser_description">Загрузите файл или вставьте текст...</p>
                        <div class="settings-group">
                            <div class="parser-label-container">
                                <label for="parserFileInput" data-lang-key="parser_upload_or_paste">Загрузите файл (.txt) или вставьте текст ниже:</label>
                                <button id="clearParserInputBtn" class="btn-secondary-small" data-lang-key="clear_parser_input">Очистить поле</button>
                            </div>
                            <input type="file" id="parserFileInput" accept=".txt,.pdf" multiple>
                            <textarea id="parserInput" rows="10" placeholder="Или вставьте сюда текст из вашего документа..." data-lang-key="parser_input_placeholder"></textarea>
                        </div>
                        <div class="settings-group">
                            <label for="parserPatternSelect" data-lang-key="parser_select_format">Выберите формат (или оставьте для автоопределения):</label>
                            <select id="parserPatternSelect" style="width: 100%; padding: 8px; border-radius: 4px;">
                                <option value="auto" selected data-lang-key="parser_auto_detect">-- Автоматическое определение --</option>
                            </select>
                        </div>
                        <div class="settings-group" style="text-align: center;">
                            <button id="runParserBtn" data-lang-key="parser_run_button">Конвертировать</button>
                        </div>
                        <div id="converterOutputArea" class="hidden">
                            <hr>
                            <div class="parser-output-header">
                                <h3 data-lang-key="parser_result_title">Результат:</h3>
                                <div style="display: flex; gap: 10px;">
                                     <button id="filterVariantsBtn" data-lang-key="filter_variants_button">⚙️ Фильтр по вариантам</button>
                                     <button id="clearConverterOutputBtn" class="btn-secondary-small" data-lang-key="clear_parser_input">Очистить</button>
                                </div>
                            </div>
                            <div id="filterVariantsDropdown" class="filter-dropdown hidden">
                                <div class="filter-dropdown-header" data-lang-key="filter_variants_header">Выберите кол-во вариантов:</div>
                                <div id="filterVariantCheckboxes" class="filter-checkboxes">
                                    <!-- Чекбоксы будут сгенерированы JavaScript -->
                                </div>
                                <div class="filter-actions">
                                    <button id="resetVariantFilterBtn" class="btn-secondary-small" data-lang-key="filter_reset_button">Сброс</button>
                                    <button id="applyVariantFilterBtn" data-lang-key="filter_apply_button">Применить</button>
                                </div>
                            </div>
                            <div class="parser-result-wrapper">
                                <div class="result-column">
                                    <textarea id="converterOutput" rows="15"></textarea>
                                </div>
                                <div id="converterErrorsArea" class="errors-column hidden">
                                    <div id="converterErrorsHeader" class="errors-header">
                                        <span><span data-lang-key="parser_errors_found">⚠️ Ошибки</span> (<span id="converterErrorCount">0</span>)</span>
                                    </div>
                                    <ul id="converterErrorList"></ul>
                                </div>
                            </div>
                            <button id="downloadConverterBtn" data-lang-key="download_parsed_button">Скачать .qst файл</button>
                        </div>
                    </div>

                    <!-- === ВКЛАДКА 2: ИИ-ГЕНЕРАТОР ИЗ ТЕКСТА === -->
                    <div id="aiFromTextContent" class="parser-tab-content">
                        <p style="text-align: center; color: var(--secondary-text-color);" data-lang-key="ai_from_text_description">Вставьте текст, и ИИ создаст по нему тест.</p>
                        <div class="settings-group">
                            <div class="parser-label-container">
                                <label for="aiParserFileInput" data-lang-key="parser_upload_or_paste">1. Загрузите файл (.txt) или вставьте текст ниже:</label>
                                <button id="clearAiParserInputBtn" class="btn-secondary-small" data-lang-key="clear_parser_input">Очистить поле</button>
                            </div>
                            <input type="file" id="aiParserFileInput" accept=".txt">
                            <textarea id="aiParserInput" rows="10" placeholder="Вставьте сюда текст для анализа ИИ..." data-lang-key="ai_parser_input_placeholder"></textarea>
                        </div>
                        <div class="settings-group">
                            <label for="aiQuestionCount" data-lang-key="ai_question_count_label">2. Количество вопросов для ИИ:</label>
                            <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                                <input type="number" id="aiQuestionCount" min="1" value="5" class="range-input" style="width: 80px;">
                                <input type="checkbox" id="aiAutoCount" style="margin-left: 15px;">
                                <label for="aiAutoCount" data-lang-key="ai_auto_mode_label">Авто</label>
                            </div>
                        </div>
                        <div class="settings-group">
                            <label for="aiAnswerCount" data-lang-key="ai_answer_count_label">3. Количество вариантов ответа:</label>
                            <select id="aiAnswerCount" style="width: 100%; padding: 8px; border-radius: 4px; margin-top: 10px;">
                                <option value="3">3</option>
                                <option value="4" selected><span data-lang-key="ai_option_default">4 (стандарт)</span></option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                        </div>
                        <div class="settings-group">
                             <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                                <input type="checkbox" id="aiAutoCategory" checked>
                                <label for="aiAutoCategory" data-lang-key="ai_auto_category_label">4. Автоматически создавать категории</label>
                            </div>
                        </div>
                        <div class="settings-group" style="text-align: center;">
                            <button id="generateTestFromTextBtn"><span data-lang-key="ai_generate_from_text_button">Сгенерировать тест из текста</span></button>
                        </div>
                        <div id="aiFromTextOutputArea" class="hidden">
                            <hr>
                            <div class="parser-output-header">
                                <h3 data-lang-key="parser_result_title">Результат:</h3>
                                <button id="clearAiFromTextOutputBtn" class="btn-secondary-small" data-lang-key="clear_parser_input">Очистить</button>
                            </div>
                            <textarea id="aiFromTextOutput" rows="10"></textarea>
                            <button id="downloadAiFromTextBtn" data-lang-key="download_parsed_button">Скачать .qst файл</button>
                        </div>
                    </div>

                    <!-- === ВКЛАДКА 3: ИИ-ГЕНЕРАТОР ПО ТЕМЕ === -->
                    <div id="aiGeneratorContent" class="parser-tab-content">
                        <p style="text-align: center; color: var(--secondary-text-color);" data-lang-key="ai_topic_description">ИИ самостоятельно создаст тест...</p>
                        <div class="settings-group">
                             <label for="aiTopicInput" data-lang-key="ai_topic_label">Введите тему для генерации теста:</label>
                             <textarea id="aiTopicInput" rows="4" placeholder="Пример: История Древнего Рима..." data-lang-key="ai_topic_placeholder"></textarea>
                        </div>
                        <div class="settings-group">
                            <label for="aiTopicQuestionCount" data-lang-key="ai_topic_question_count_label">Количество вопросов (если не указано в теме):</label>
                            <input type="number" id="aiTopicQuestionCount" min="1" max="50" value="10" class="range-input" style="width: 80px; margin-top: 10px;">
                        </div>
                        <div class="settings-group">
                            <label for="aiTopicAnswerCount" data-lang-key="ai_topic_answer_count_label">Количество вариантов ответа (если не указано в теме):</label>
                            <select id="aiTopicAnswerCount" style="width: 100%; padding: 8px; border-radius: 4px; margin-top: 10px;">
                                <option value="3">3</option>
                                <option value="4" selected><span data-lang-key="ai_option_default">4 (стандарт)</span></option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                        </div>
                        <div class="settings-group">
                             <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                                <input type="checkbox" id="aiTopicAutoCategory" checked>
                                <label for="aiTopicAutoCategory" data-lang-key="ai_topic_auto_category_label">Автоматически создавать категории</label>
                            </div>
                        </div>
                        <div class="settings-group" style="text-align: center;">
                            <button id="generateTestFromTopicBtn"><span data-lang-key="ai_generate_from_topic_button">🤖 Создать тест по теме (ИИ)</span></button>
                        </div>
                        <div id="aiFromTopicOutputArea" class="hidden">
                            <hr>
                            <div class="parser-output-header">
                                <h3 data-lang-key="parser_result_title">Результат:</h3>
                                <button id="clearAiFromTopicOutputBtn" class="btn-secondary-small" data-lang-key="clear_parser_input">Очистить</button>
                            </div>
                            <textarea id="aiFromTopicOutput" rows="10"></textarea>
                            <button id="downloadAiFromTopicBtn" data-lang-key="download_parsed_button">Скачать .qst файл</button>
                        </div>
                    </div>
                </div>
                <div id="parserErrorsArea" class="hidden">
                </div>
                <div id="parserOutputArea" class="hidden">
                </div>
                <button id="backToMainFromParserBtn" style="margin-top: 15px; background-color: var(--button-secondary-bg);" data-lang-key="back_button">Назад</button>
            </div>
        </div> 

        <!-- ========== ШАБЛОНЫ ДЛЯ ДИНАМИЧЕСКОГО КОНТЕНТА ========== -->
        <template id="searchResultCardTemplate">
            <div class="result-card">
                <div class="result-card-header">
                    <div class="result-card-actions">
                        <button class="explain-search-result-btn" title="Объяснить с помощью ИИ"><i data-lucide="brain-circuit"></i></button>
                        <button class="copy-search-result-btn" title="Копировать вопрос"><i data-lucide="copy"></i></button>
                        <button class="favorite-search-result-btn" title="Добавить в избранное"><i data-lucide="star"></i></button>
                        <button class="translate-search-result-btn" title="Перевести вопрос"><i data-lucide="languages"></i></button>
                    </div>
                </div>
                <div class="result-card-content">
                    <!-- Содержимое вопроса и ответов будет вставлено сюда -->
                </div>
            </div>
        </template>
        <template id="messageTemplate">
            <div class="message">
                <div class="message-header">
                    <span class="author"></span>
                    <span class="timestamp"></span>
                </div>
                <div class="reply-context-container"></div>
                <div class="message-main-content"></div>
                <div class="reactions-container"></div>
                <div class="message-actions-toolbar"></div>
            </div>
        </template>
        <template id="savedSessionCardTemplate">
            <div class="saved-session-card">
                <div class="saved-session-name"></div>
                <div class="saved-session-progress-info">
                    <span class="progress-label"></span>
                    <div class="saved-session-time"></div>
                </div>
                <div class="progress-bar">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="saved-session-actions">
                    <button class="btn-resume"></button>
                    <button class="btn-delete"></button>
                </div>
            </div>
        </template>
        <!-- ========== КОНЕЦ ШАБЛОНОВ ========== -->
        
        <footer>
            <p>
                <a href="https://chromewebstore.google.com/detail/qstium-helper/ekamfcpbkcekmmbclpnlmhcimnenabcl?hl=ru&utm_source=ext_sidebar" target="_blank" rel="noopener noreferrer" data-lang-key="footer_copyright">prod by @iverrum</a>
            </p>
        </footer>

        <!-- ======================================================= -->
        <!-- ===      НОВАЯ КНОПКА (FAB) ДЛЯ AI-ЧАТА             === -->
        <!-- ======================================================= -->
        <button id="aiChatFab" class="ai-chat-fab" title="AI Помощник" data-lang-key="ai_fab_title" data-lang-skip-content="true">
            <i data-lucide="bot"></i>
        </button>

            <!-- ======================================================= -->
            <!-- ===    НОВОЕ МОДАЛЬНОЕ ОКНО ДЛЯ AI-ЧАТА             === -->
            <!-- ======================================================= -->
            <div id="aiChatModal" class="modal-overlay hidden">
                <div class="modal-content ai-chat-modal-content">

                    <div class="ai-chat-header">
                        <h3><i data-lucide="brain-circuit"></i> <span data-lang-key="ai_chat_title"></span></h3>

                        <div id="aiColorLegendsWithEditor" class="ai-color-legend-container hidden">


                            <div id="aiColorLegendsWithList" class="ai-color-legend-list">
                                <!-- Сюда JS будет вставлять элементы легенды -->
                            </div>
                            <div id="aiColorLegendEditor" class="ai-color-legend-editor hidden">
                                <div class="legend-editor-header">
                                    <span id="aiLegendEditorColor" class="legend-color-swatch"></span>
                                    <input type="text" id="aiLegendTextInput" placeholder="Описание для цвета..." data-lang-key="ai_legend_editor_placeholder">
                                </div>
                                <div class="legend-editor-actions">
                                    <button id="aiLegendCancelBtn" class="btn-secondary-small" data-lang-key="modal_cancel_button">Отмена</button>
                                    <button id="aiLegendSaveBtn" data-lang-key="modal_save_button">Сохранить</button>
                                </div>
                            </div>
                        </div>


                        <!-- Новый контейнер для кнопок -->
                        <div class="ai-chat-header-controls">
                            <button id="aiChatSettingsBtn" class="ai-chat-control-btn" title="Настройки ИИ" data-lang-key="ai_settings_title" data-lang-skip-content="true"><i data-lucide="sliders-horizontal"></i></button>
                            <button id="aiChatResizeBtn" class="ai-chat-control-btn" title="Развернуть / Свернуть" data-lang-key="ai_resize_title" data-lang-skip-content="true"><i data-lucide="maximize-2"></i></button>
                            <button id="aiChatCloseBtn" class="ai-chat-control-btn" title="Закрыть" data-lang-key="ai_close_chat_title" data-lang-skip-content="true"><i data-lucide="x"></i></button>
                        </div>


                    </div> <!-- Закрывающий </div> для .ai-chat-header -->



                    <!-- ======== НАЧАЛО НОВОЙ ПАНЕЛИ НАСТРОЕК ======== -->
                    <div id="aiChatSettingsPanel" class="ai-chat-settings-panel hidden">

                        <div class="ai-setting-group">
                            <label for="aiModelSelectContainer" data-lang-key="ai_model_label">Модель ИИ</label>
                            <div class="ai-custom-select" id="aiModelSelectContainer">
                                <button class="ai-select-button">
                                    <span id="aiModelSelectText">Flash (самая умная и быстрая)</span>
                                    <i data-lucide="chevron-down"></i>
                                </button>
                                <div class="ai-select-dropdown hidden">
                                    <a href="#" data-value="gemini-2.5-flash-lite" data-lang-key="ai_model_flash">Flash 2.5 (самая умная)</a>
                                    <a href="#" data-value="gemma-3-27b-it" data-lang-key="ai_model_gemma_27b">Gemma 3.27b (умная)</a>
                                    <a href="#" data-value="gemma-3-12b-it" data-lang-key="ai_model_gemma_12b">Gemma 3.12b (баланс)</a>
                                </div>
                            </div>
                        </div>
                        <div class="ai-setting-group">
                            <label for="aiResponseLengthSelectContainer" data-lang-key="ai_response_style_label">Стиль ответа</label>
                            <div class="ai-custom-select" id="aiResponseLengthSelectContainer">
                                <button class="ai-select-button">
                                    <span id="aiResponseLengthSelectText">Обычный</span>
                                    <i data-lucide="chevron-down"></i>
                                </button>
                                <div class="ai-select-dropdown hidden">
                                    <a href="#" data-value="short" data-lang-key="ai_response_short">Короткий</a>
                                    <a href="#" data-value="medium" data-lang-key="ai_response_medium">Обычный</a>
                                    <a href="#" data-value="long" data-lang-key="ai_response_long">Развернутый</a>
                                </div>
                            </div>
                        </div>

                        <div class="ai-setting-group">
                            <label for="aiCreativitySlider" data-lang-key="ai_creativity_label">Креативность</label>
                            <span id="aiCreativityValue" data-creativity-key="medium">Средняя</span>
                        </div>
                        <input type="range" id="aiCreativitySlider" min="0" max="2" value="1" step="1">
                        
                    </div>

                    <div class="ai-chat-body-wrapper">  

                        <div id="aiChatSidebar" class="ai-chat-sidebar">




                            <!-- === ВЕРХНЯЯ СЕКЦИЯ: ПРИВАТНЫЕ ЧАТЫ === -->
                            <div class="ai-sidebar-section" id="aiPrivateChatsSection">
                                <div class="ai-sidebar-section-header">
                                    <h4><i data-lucide="lock"></i> <span data-lang-key="ai_private_chats">Приватные чаты</span></h4>
                                    <button id="aiNewPrivateChatBtn" class="ai-sidebar-action-btn" title="Создать новый приватный чат" data-lang-key="ai_new_private_chat_title" data-lang-skip-content="true">
                                        <i data-lucide="plus"></i>
                                    </button>
                                </div>
                                <ul id="aiChatHistoryList" class="ai-chat-history-list">
                                    <!-- Сюда JS добавит приватные чаты -->
                                </ul>
                            </div>




                            <!-- === РАЗДЕЛИТЕЛЬ === -->
                            <div class="ai-sidebar-divider"></div>




                            <!-- === НИЖНЯЯ СЕКЦИЯ: ПУБЛИЧНЫЕ АУДИТОРИИ === -->
                            <div class="ai-sidebar-section" id="aiPublicAudiencesSection">
                                <div class="ai-sidebar-section-header">
                                    <h4><i data-lucide="users"></i> <span data-lang-key="ai_audiences">Аудитории</span></h4>
                                    <button id="aiNewAudienceBtn" class="ai-sidebar-action-btn" title="Создать новую Аудиторию (видна всем)" data-lang-key="ai_new_audience_title" data-lang-skip-content="true">
                                        <i data-lucide="plus"></i>
                                    </button>
                                </div>


                                <ul id="aiAudiencesList" class="ai-chat-history-list">
                                     <!-- Сюда JS добавит публичные аудитории -->
                                </ul>
                            </div>

                            <!-- === НОВЫЙ БЛОК: ЭКРАН ПРОСМОТРА ТЕМ ВНУТРИ АУДИТОРИИ === -->
                            <div class="ai-sidebar-section hidden" id="aiTopicsView">


                                <div class="ai-sidebar-section-header">
                                    <button id="aiBackToAudiencesBtn" class="ai-sidebar-action-btn" title="Назад к списку Аудиторий" data-lang-key="ai_back_to_audiences_title" data-lang-skip-content="true">
                                        <i data-lucide="arrow-left"></i>
                                    </button>
                                    <div id="aiTopicsBreadcrumb" class="ai-topics-breadcrumb"></div>
                                    <button id="aiNewTopicBtn" class="ai-sidebar-action-btn" title="Создать новую Тему в этой Аудитории" data-lang-key="ai_new_topic_title" data-lang-skip-content="true">
                                        <i data-lucide="plus"></i>
                                    </button>
                                </div>


                                <ul id="aiTopicsList" class="ai-chat-history-list">
                                     <!-- Сюда JS добавит список тем (чатов) -->
                                </ul>
                            </div>  

                            <!-- РУЧКА ДЛЯ ИЗМЕНЕНИЯ РАЗМЕРА (остается без изменений) -->
                            <div id="aiSidebarHandle" class="ai-sidebar-handle"></div>
                        </div>

                        <div class="ai-chat-scroll-wrapper">
                            <div id="aiScrollbarTooltip" class="scrollbar-tooltip"></div>
                            <div id="aiChatMessages" class="ai-chat-messages">
                                <!-- Сюда будут добавляться сообщения -->
                            </div>
                            <div id="aiCustomScrollbar" class="ai-custom-scrollbar hidden">
                                <div id="aiScrollbarTrack" class="scrollbar-track">
                                    <div id="aiScrollbarDots" class="scrollbar-dots-container"></div>
                                </div>
                                <div id="aiScrollbarThumb" class="scrollbar-thumb"></div>
                            </div>

                        <button id="aiScrollToBottomBtn" class="ai-scroll-to-bottom-btn" title="Перейти к последнему сообщению" data-lang-key="ai_scroll_to_bottom_title" data-lang-skip-content="true">
                            ↓
                        </button>

                        </div>

                        <!-- ======== НАЧАЛО НОВОЙ ПРАВОЙ ПАНЕЛИ ======== -->
                        <div id="aiChatUserMessagesSidebar" class="ai-chat-user-messages-sidebar">
                            <ul id="aiUserMessagesList" class="ai-user-messages-list">
                                <!-- Сюда JS будет вставлять сообщения -->
                            </ul>
                        </div>


                        <!-- ======== КОНЕЦ НОВОЙ ПРАВОЙ ПАНЕЛИ ======== -->

                    </div> <!-- === ЗАКРЫВАЮЩИЙ тег для ai-chat-body-wrapper === -->









                    <div class="ai-chat-input-area">
                        <div class="ai-main-controls">
                            <!-- Левая группа: все, что связано с поиском -->
                            <div class="ai-chat-footer-main-group">
                                <div class="ai-setting-group">
                                    <label for="aiGroundingToggleMain" data-lang-key="ai_grounding_label">Поиск в Google</label>
                                    <label class="ai-toggle-switch">
                                        <input type="checkbox" id="aiGroundingToggleMain">
                                        <span class="ai-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Правая группа: действия с диалогом -->
                            <div class="ai-chat-footer-actions">
                                <button id="aiShowSearchBtn" class="ai-action-btn" title="Поиск по всем чатам" data-lang-key="ai_search_all_chats_title" data-lang-skip-content="true">
                                    <i data-lucide="search"></i>
                                </button>
                                <button id="aiGenerateTestFromDialogBtn" class="ai-action-btn" title="Создать тест из всего диалога" data-lang-key="ai_create_test_from_dialog_title" data-lang-skip-content="true">
                                    <i data-lucide="clipboard-list"></i>
                                </button>
                                <button id="aiShowAllUserMessagesBtn" class="ai-action-btn" title="Показать все мои сообщения" data-lang-key="ai_show_all_user_messages_tooltip" data-lang-skip-content="true">
                                    <i data-lucide="user-round-search"></i>
                                </button>
                            </div>
                        </div>

                        <div id="aiReplyPanel" class="ai-reply-panel hidden">
                            <div class="ai-reply-info">
                                <span class="ai-reply-title" data-lang-key="ai_reply_to_message">Ответ на сообщение:</span>
                                <p id="aiReplyText" class="ai-reply-snippet"></p>
                            </div>
                            <button id="aiCancelReplyBtn" class="ai-cancel-reply-btn" title="Отменить ответ" data-lang-key="ai_cancel_reply_title" data-lang-skip-content="true"><i data-lucide="x"></i></button>
                        </div>
                        <div class="ai-chat-input-container">
                            <input type="file" id="aiChatFileInput" class="hidden" accept="image/*,application/pdf,audio/*,text/plain" multiple>
                            <div id="aiAttachmentPreview" class="ai-attachment-preview hidden"></div>
                            <div id="aiChatMainInputRow" class="ai-chat-main-input-row">
                                <button id="aiChatAttachBtn" class="ai-chat-attach-btn" title="Прикрепить файл" data-lang-key="ai_attach_file_title" data-lang-skip-content="true">
                                    <i data-lucide="plus" class="ai-chat-input-icon"></i>
                                </button>
                                <textarea id="aiChatInput" placeholder="Спросите что-нибудь..." data-lang-key="ai_chat_placeholder"></textarea>
                                <button id="aiChatSendBtn" class="advanced-send-btn">
                                    <i data-lucide="arrow-up"></i>
                                </button>
                            </div>
                        </div>
                    </div>







                    <div id="aiChatSearchContainer" class="ai-chat-search-container hidden">
                        <input type="text" id="aiChatSearchInputGlobal" placeholder="Поиск по всем чатам..." data-lang-key="ai_search_all_chats_placeholder">
                        <button id="aiCloseSearchBtn" class="ai-chat-control-btn"><i data-lucide="x"></i></button>
                        <div id="aiChatSearchResults" class="ai-chat-search-results hidden">
                            <!-- Результаты поиска будут здесь -->
                        </div>
                    </div>

                </div>
            </div>
        <audio id="notificationSound" src="https://notificationsounds.com/storage/sounds/file-sounds-1150-pristine.mp3" preload="auto"></audio>
    </div> 

    <!-- ======== НАЧАЛО МОДАЛЬНОГО ОКНА КОНФЛИКТА СЕССИЙ ======== -->
    <div id="sessionConflictModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 500px;">
            <h3 data-lang-key="session_conflict_title">Сессия уже существует</h3>
            <p id="sessionConflictText" style="margin: 20px 0; line-height: 1.6;" data-lang-key="session_conflict_text">
                Для файла "{fileName}" уже есть сохраненный прогресс. Что вы хотите сделать?
            </p>
            <div class="modal-buttons vertical">
                <button id="overwriteSessionBtn" class="btn btn-danger" data-lang-key="session_overwrite_button">Перезаписать</button>
                <button id="saveNewSessionBtn" class="btn" data-lang-key="session_save_new_button">Сохранить как новую</button>
                <button id="cancelConflictBtn" class="btn btn-secondary" data-lang-key="modal_cancel_button">Отмена</button>
            </div>
        </div>
    </div>
    <!-- ======== КОНЕЦ МОДАЛЬНОГО ОКНА КОНФЛИКТА СЕССИЙ ======== -->
    
    <div id="testResultsModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 600px;">
            <h3 id="testResultsModalTitle" data-lang-key="results_modal_title">Результаты по тесту</h3>
            <div id="testResultsTableContainer" style="max-height: 400px; overflow-y: auto; margin-top: 20px;"></div>
            <div class="modal-buttons">
                <button onclick="ChatModule.closeModal('testResultsModal')" data-lang-key="auth_close_button">Закрыть</button>
            </div>
        </div>
    </div>

    <div id="aiExplanationModal" class="modal-overlay hidden">
        <div class="modal-content" style="text-align: left;">
            <div class="parser-label-container" style="margin-bottom: 10px;">
                <h3 data-lang-key="ai_explanation_title">💡 Объяснение от ИИ</h3>
                <button id="aiExplanationTranslateBtn" class="btn-secondary-small hidden" data-lang-key="ai_toggle_translation_button">
                    Оригинал/Перевод
                </button>
            </div>
            <div id="aiExplanationQuestion" style="background: var(--input-bg-color); padding: 10px; border-radius: 5px; margin-bottom: 10px;"></div>
            <div class="settings-group" style="border: none; padding: 0; margin-bottom: 15px;">
                <label data-lang-key="ai_explanation_style_label">Стиль объяснения:</label>
                <div id="aiExplanationStyleDropdown" class="style-dropdown">
                    <button id="aiExplanationStyleButton" class="style-dropdown-btn">
                        <span id="aiExplanationStyleText">Просто</span>
                        <span class="dropdown-arrow">▼</span>
                    </button>
                    <div id="aiExplanationStyleContent" class="style-dropdown-content hidden">
                        <a href="#" data-style="simple" data-lang-key="ai_style_simple">Просто</a>
                        <a href="#" data-style="scientific" data-lang-key="ai_style_scientific">Научно</a>
                        <a href="#" data-style="associative" data-lang-key="ai_style_associative">Аналогия</a>
                        <a href="#" data-style="stepbystep" data-lang-key="ai_style_stepbystep">Пошагово</a>
                        <a href="#" data-style="practical" data-lang-key="ai_style_practical">Практично</a>
                        <a href="#" data-style="visual" data-lang-key="ai_style_visual">Наглядно</a>
                    </div>
                </div>
            </div>
            <div id="aiExplanationOutput"></div>
            <div class="modal-buttons" style="justify-content: space-between; margin-top: 20px;">
                <button id="copyExplanationBtn" data-lang-key="copy_button">Копировать</button>
                <button onclick="ChatModule.closeModal('aiExplanationModal')" data-lang-key="auth_close_button">Закрыть</button>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
    </script>     
      
    <script src="script.js" defer></script>   

    <div id="exitToast" class="exit-toast hidden" data-lang-key="exit_toast_text">
        Нажмите еще раз для выхода
    </div>

    <!-- ======================================================= -->
    <!-- ===    УНИВЕРСАЛЬНОЕ МОДАЛЬНОЕ ОКНО ПОДТВЕРЖДЕНИЯ   === -->
    <!-- ======================================================= -->
    <div id="confirmModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 420px;">
            <h3 id="confirmModalTitle">Подтвердите действие</h3>
            <p id="confirmModalText" style="margin: 20px 0; line-height: 1.6;"></p>
            <div id="confirmModalButtons" class="modal-buttons">
                <button id="confirmModalNoBtn" class="btn btn-secondary" data-lang-key="modal_cancel_button">Отмена</button>
                <button id="confirmModalYesBtn" class="btn btn-danger">Подтвердить</button>
            </div>
        </div>
    </div>
    <!-- ======================================================= -->
    <!-- ===   НОВОЕ МОДАЛЬНОЕ ОКНО ДЛЯ ВВОДА ПАРОЛЯ КАНАЛА   === -->
    <!-- ======================================================= -->
    <div id="channelPasswordModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 420px;">
            <h3 id="channelPasswordModalTitle"></h3>
            <p id="channelPasswordModalText" style="margin: 20px 0; line-height: 1.6;"></p>
            
            <!-- Используем обертку для иконки "глаза", как в окне авторизации -->
            <div class="password-wrapper" style="margin-bottom: 25px;">
                <input type="password" id="channelPasswordInputModal" class="auth-input" placeholder="Введите пароль...">
                <span class="toggle-password"><i data-lucide="eye"></i></span>
            </div>

            <div id="channelPasswordModalButtons" class="modal-buttons">
                <button id="channelPasswordCancelBtn" class="btn btn-secondary">Отмена</button>
                <button id="channelPasswordConfirmBtn" class="btn">Войти</button>
            </div>
        </div>
    </div>





    <!-- ======================================================= -->
    <!-- ===  НОВОЕ МОДАЛЬНОЕ ОКНО ДЛЯ СОЗДАНИЯ АУДИТОРИИ    === -->
    <!-- ======================================================= -->
    <div id="audienceCreateModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 420px;">
            <h3 id="audienceCreateModalTitle">Создание новой Аудитории</h3>
            <p id="audienceCreateModalText" style="margin: 20px 0; line-height: 1.6;">Введите название для вашей публичной Аудитории. Оно будет видно всем пользователям.</p>
            
            <input type="text" id="audienceNameInput" class="auth-input" placeholder="Название Аудитории..." style="margin-bottom: 25px;">

            <div id="audienceCreateModalButtons" class="modal-buttons">
                <button id="audienceCreateCancelBtn" class="btn btn-secondary">Отмена</button>
                <button id="audienceCreateConfirmBtn" class="btn">Создать</button>
            </div>
        </div>
    </div>




    <!-- ======================================================= -->
    <!-- ===    НОВОЕ МОДАЛЬНОЕ ОКНО ДЛЯ СОЗДАНИЯ ТЕМЫ       === -->
    <!-- ======================================================= -->
    <div id="topicCreateModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 420px;">
            <h3 id="topicCreateModalTitle" data-lang-key="topic_create_modal_title">Создание новой Темы</h3>
            <p id="topicCreateModalText" style="margin: 20px 0; line-height: 1.6;" data-lang-key="topic_create_modal_text">Введите название для вашей новой Темы (чата) в этой Аудитории.</p>
            
            <input type="text" id="topicNameInput" class="auth-input" placeholder="Название Темы..." data-lang-key="topic_create_placeholder" style="margin-bottom: 25px;">

            <div id="topicCreateModalButtons" class="modal-buttons">
                <button id="topicCreateCancelBtn" class="btn btn-secondary" data-lang-key="modal_cancel_button">Отмена</button>
                <button id="topicCreateConfirmBtn" class="btn" data-lang-key="audience_create_button">Создать</button>
            </div>
        </div>
    </div>
    <!-- ======================================================= -->
    <!-- ======================================================= -->
    <!-- ===      НОВОЕ МОДАЛЬНОЕ ОКНО ДЛЯ ПРОСМОТРА ИЗОБРАЖЕНИЙ === -->
    <!-- ======================================================= -->
    <div id="imagePreviewModal" class="modal-overlay hidden">
        <div class="image-preview-content">
            <img id="previewImage" src="" alt="Предпросмотр изображения">
        </div>
        <button class="close-image-preview" title="Закрыть"><i data-lucide="x"></i></button>
    </div>
    <!-- ======================================================= -->
    <!-- ===      НОВОЕ МОДАЛЬНОЕ ОКНО ДЛЯ ПРОСМОТРА ТЕКСТА   === -->
    <!-- ======================================================= -->
    <div id="textPreviewModal" class="modal-overlay hidden">
        <div class="text-preview-content">
            <div class="text-preview-header">
                <h3 id="textPreviewFilename">Имя файла</h3>
                <button class="close-text-preview" title="Закрыть"><i data-lucide="x"></i></button>
            </div>
            <pre id="textPreviewBody"></pre>
        </div>
    </div>
    <!-- ======================================================= -->
    <!-- ===   НОВОЕ МОДАЛЬНОЕ ОКНО ДЛЯ РЕДАКТИРОВАНИЯ АУДИТОРИИ === -->
    <!-- ======================================================= -->
    <div id="audienceEditModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 480px;">
            <h3 id="audienceEditModalTitle" data-lang-key="ai_audience_settings_title">Настройки Аудитории</h3>
            
            <div class="settings-group" style="text-align: left; border-bottom: none; padding-bottom: 0;">
                <label for="audienceNameEditInput" style="font-weight: 500;" data-lang-key="ai_audience_name_label">Название Аудитории:</label>
                <input type="text" id="audienceNameEditInput" class="auth-input" placeholder="Новое название..." data-lang-key="ai_audience_name_placeholder">

                <label for="audiencePasswordEditInput" style="font-weight: 500; margin-top: 15px;" data-lang-key="ai_audience_password_label">Пароль (пусто = без пароля):</label>
                <div class="password-wrapper">
                    <input type="password" id="audiencePasswordEditInput" class="auth-input" placeholder="Новый пароль..." data-lang-key="ai_audience_password_placeholder">
                    <span class="toggle-password"><i data-lucide="eye"></i></span>
                </div>
            </div>

            <!-- Блок управления модераторами -->
            <div class="moderator-management-section">
                <h4 data-lang-key="ai_moderator_management">Управление модераторами</h4>
                <div class="moderator-add-form">
                    <input type="email" id="moderatorEmailInput" class="auth-input" placeholder="Email нового модератора..." data-lang-key="ai_moderator_email_placeholder">
                    <button id="addModeratorBtn" class="btn-secondary-small" data-lang-key="ai_moderator_add_btn">Добавить</button>
                </div>
                <ul id="moderatorsList" class="moderator-list">
                    <!-- Сюда JS добавит список модераторов -->
                </ul>
            </div>

            <div id="audienceEditModalButtons" class="modal-buttons" style="margin-top: 25px;">
                <button id="cancelAudienceEditBtn" class="btn btn-secondary" data-lang-key="modal_cancel_button">Отмена</button>
                <button id="saveAudienceSettingsBtn" class="btn" data-lang-key="modal_save_button">Сохранить</button>
            </div>
        </div>
    </div>





    <!-- ======================================================= -->
    <!-- ===   НОВОЕ МОДАЛЬНОЕ ОКНО ДЛЯ РЕДАКТИРОВАНИЯ ЛЕГЕНДЫ === -->
    <!-- ======================================================= -->
    <div id="legendEditModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 420px;">
            <h3 id="legendEditModalTitle" style="display: flex; align-items: center; gap: 10px;">
                <span id="legendEditModalColorSwatch" class="legend-color-swatch"></span>
                <span data-lang-key="ai_legend_edit_title">Редактирование легенды</span>
            </h3>
            <p style="margin: 20px 0; line-height: 1.6;" data-lang-key="ai_legend_edit_text">Введите новое описание для этого цвета.</p>
            
            <input type="text" id="legendNameInput" class="auth-input" placeholder="Описание..." data-lang-key="ai_legend_edit_placeholder" style="margin-bottom: 25px;">

            <div class="modal-buttons">
                <button id="legendEditCancelBtn" class="btn btn-secondary" data-lang-key="modal_cancel_button">Отмена</button>
                <button id="legendEditConfirmBtn" class="btn" data-lang-key="modal_save_button">Сохранить</button>
            </div>
        </div>
    </div>





    <!-- ======================================================= -->
    <!-- ===   НОВОЕ МОДАЛЬНОЕ ОКНО ДЛЯ ГЕНЕРАЦИИ ТЕСТА ИЗ AI-ЧАТА === -->
    <!-- ======================================================= -->
    <div id="aiTestFromMessageModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 480px; text-align: left;">
            <h3 data-lang-key="ai_test_from_msg_title">Создание теста из сообщения</h3>
            <p style="margin: 20px 0; line-height: 1.6;" data-lang-key="ai_test_from_msg_text">
                Настройте параметры для генерации теста на основе выбранного ответа ИИ.
            </p>
            
            <input type="hidden" id="aiTestFromMessageIndex">
            
            <!-- ======== НАЧАЛО ИСПРАВЛЕННОГО БЛОКА СЛАЙДЕРА ======== -->
            <div class="settings-group" style="border: none; padding: 0;">
                <label for="aiTestMsgQuestionCount" data-lang-key="ai_question_count_label" style="font-weight: 500;">Количество вопросов:</label>
                <div class="time-limit-wrapper" style="margin-top: 10px;">
                    <div class="range-inputs-container time-limit-input-container">
                         <input type="number" id="aiTestMsgQuestionCount" min="1" max="50" value="5" step="1" class="range-input">
                    </div>
                    <div class="single-slider-container time-slider-modern">
                        <div id="aiTestMsgSliderProgress" class="slider-progress"></div>
                        <input type="range" id="aiTestMsgQuestionSlider" min="1" max="50" value="5" step="1">
                    </div>
                </div>
            </div>
            <!-- ======== КОНЕЦ ИСПРАВЛЕННОГО БЛОКА СЛАЙДЕРА ======== -->

            <div class="settings-group" style="border: none; padding: 0;">
                <label for="aiTestMsgAnswerCount" data-lang-key="ai_answer_count_label" style="font-weight: 500;">Количество вариантов ответа:</label>
                <select id="aiTestMsgAnswerCount" style="width: 100%; padding: 8px; border-radius: 4px; margin-top: 10px;">
                    <option value="3">3</option>
                    <option value="4" selected data-lang-key="ai_option_default">4 (стандарт)</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                </select>
            </div>
            
            <div class="settings-group" style="border: none; padding: 0;">
                <label for="aiTestMsgDifficulty" data-lang-key="ai_test_difficulty_label" style="font-weight: 500;">Сложность:</label>
                <select id="aiTestMsgDifficulty" style="width: 100%; padding: 8px; border-radius: 4px; margin-top: 10px;">
                    <option value="easy" data-lang-key="ai_test_difficulty_easy">Простой</option>
                    <option value="medium" selected data-lang-key="ai_test_difficulty_medium">Средний</option>
                    <option value="hard" data-lang-key="ai_test_difficulty_hard">Сложный</option>
                </select>
            </div>

            <!-- ======== НАЧАЛО ИСПРАВЛЕННОГО БЛОКА ЧЕКБОКСА ======== -->
            <div class="settings-group" style="border: none; padding: 0; margin-top: 15px;">
                <label class="category-checkbox-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 5px 0;">
                    <input type="checkbox" id="aiTestMsgAutoCategory" style="margin: 0; width: 18px; height: 18px;">
                    <span data-lang-key="ai_auto_category_label">Автоматически создавать категории</span>
                </label>
            </div>
            <!-- ======== КОНЕЦ ИСПРАВЛЕННОГО БЛОКА ЧЕКБОКСА ======== -->

            <div class="modal-buttons" style="margin-top: 25px;">
                <button id="cancelAiTestGenerationBtn" class="btn btn-secondary" data-lang-key="modal_cancel_button">Отмена</button>
                <button id="confirmAiTestGenerationBtn" class="btn" data-lang-key="ai_generate_from_text_button">Сгенерировать</button>
            </div>
        </div>
    </div>
    <!-- ======================================================= -->

</body>
</html>
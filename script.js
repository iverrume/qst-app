  function shouldEnableLowPowerMode() {
    try {
      // navigator.hardwareConcurrency –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
      const coreCount = navigator.hardwareConcurrency || 2;
      // navigator.deviceMemory - —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ API, –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ
      const memoryInGB = navigator.deviceMemory || 2;
      
      // –°—á–∏—Ç–∞–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ "—Å–ª–∞–±—ã–º", –µ—Å–ª–∏ —É –Ω–µ–≥–æ 4 –∏–ª–∏ –º–µ–Ω—å—à–µ —è–¥–µ—Ä, –ò–õ–ò 4 –ì–ë –∏–ª–∏ –º–µ–Ω—å—à–µ –û–ó–£.
      const isWeakHardware = coreCount <= 4 || memoryInGB <= 4;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É "–£–º–µ–Ω—å—à–∏—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ"
      const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      // –ù–û–í–ê–Ø –°–¢–†–û–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–±–∏–ª—å–Ω—ã–º –ø–æ User Agent
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      // –ò–ó–ú–ï–ù–ï–ù–ê –≠–¢–ê –°–¢–†–û–ö–ê: –î–æ–±–∞–≤–∏–ª–∏ –≤ –ª–æ–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–±–∏–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
      console.log(`–û—Ü–µ–Ω–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: –Ø–¥—Ä–∞=${coreCount}, –ü–∞–º—è—Ç—å=${memoryInGB}GB. –°–ª–∞–±–æ–µ –∂–µ–ª–µ–∑–æ: ${isWeakHardware}. –£–º–µ–Ω—å—à–∏—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ: ${prefersReducedMotion}. –ú–æ–±–∏–ª—å–Ω–æ–µ: ${isMobile}`);
      
      // –ò–ó–ú–ï–ù–ï–ù–ê –≠–¢–ê –°–¢–†–û–ö–ê: –î–æ–±–∞–≤–∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É isMobile
      return isWeakHardware || prefersReducedMotion || isMobile;
    } catch (e) {
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–µ–∂–∏–º.", e);
      return false; // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏, —Ä–∞–±–æ—Ç–∞–µ–º –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ
    }
  }

    // –ü—Ä–∏–º–µ–Ω—è–µ–º "–ª–µ–≥–∫–∏–π" —Ä–µ–∂–∏–º, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    function applyLowPowerMode() {
      if (shouldEnableLowPowerMode()) {
        document.body.classList.add('low-power');
        console.log('–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —Ä–µ–∂–∏–º –Ω–∏–∑–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (low-power).');
      }
    }

    // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    applyLowPowerMode();



// ============================================
// –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ú–û–î–£–õ–¨ –ß–ê–¢–ê
// ============================================




const ChatModule = (function() {
    'use strict';

    const getEl = (id) => document.getElementById(id);

    const LOCALE_MAP = {
        ru: 'ru-RU',
        en: 'en-US',
        kk: 'kk-KZ'
    };

    // === –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ë–õ–û–ö–ê: –ü–ï–†–ï–í–û–î –ß–ê–¢–ê ===
    const LANG_PACK_CHAT = {
        ru: {
            // TABS
            tab_messages: "–°–æ–æ–±—â–µ–Ω–∏—è",
            tab_questions: "–í–æ–ø—Ä–æ—Å—ã",
            tab_favorites: "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ",
            tab_users: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
            // Auth
            auth_title: "üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è",
            auth_login_tab: "–í—Ö–æ–¥",
            auth_register_tab: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è",
            auth_login_placeholder: "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ Email",
            auth_password_placeholder: "–ü–∞—Ä–æ–ª—å",
            auth_login_button: "–í–æ–π—Ç–∏",
            auth_register_username_placeholder: "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
            auth_register_email_placeholder: "Email",
            auth_register_password_placeholder: "–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)",
            auth_register_confirm_placeholder: "–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å",
            auth_register_button: "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è",
            auth_close_button: "–ó–∞–∫—Ä—ã—Ç—å",
            auth_or_divider: "–∏–ª–∏",
            auth_google_signin: "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google",
            auth_forgot_password: "–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?",
            forgot_password_modal_title: "–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è",
            forgot_password_modal_text: "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email. –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º –≤–∞–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è.",
            forgot_password_email_placeholder: "–í–∞—à Email",
            forgot_password_send_button: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å",
            // Main Chat
            chat_header_title: "üí¨ –ß–∞—Ç",
            guest_user: "–ì–æ—Å—Ç—å",
            generic_user: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
            edit_profile_link: "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å",
            logout_link: "üö™ –í—ã–π—Ç–∏",
            notifications_title: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
            sidebar_sections: "üìÇ –†–∞–∑–¥–µ–ª—ã",
            sidebar_channels: "üìã –ö–∞–Ω–∞–ª—ã",
            sidebar_create_channel: "+ –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª",
            sidebar_private_messages: "‚úâÔ∏è –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è",
            sidebar_online: "üë• –û–Ω–ª–∞–π–Ω",
            channel_general: "# –û–±—â–∏–π",
            search_placeholder: "üîç –ü–æ–∏—Å–∫...",
            pinned_toggle_title: "–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ",
            reply_panel_title: "–û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ:",
            emoji_button_title: "–≠–º–æ–¥–∑–∏",
            create_question_button_title: "–°–æ–∑–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å",
            attach_file_button_title: "–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª",
            chat_input_placeholder: "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...",
            download_qst_button: "üì• –°–∫–∞—á–∞—Ç—å .qst",
            download_txt_button: "üì• –°–∫–∞—á–∞—Ç—å .txt",
            add_to_favorites_button: "‚≠ê –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ",
            copy_question_button: "üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
            delete_question_button: "üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å",
            clear_favorites_button: "üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ", 
            question_label: "–í–æ–ø—Ä–æ—Å:",
            author_label: "–ê–≤—Ç–æ—Ä:",
            date_label: "–î–∞—Ç–∞:",
            anonymous_user: "–ê–Ω–æ–Ω–∏–º",
            expand_message: "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å", 
            collapse_message: "–°–≤–µ—Ä–Ω—É—Ç—å",
            edited_indicator: "(–∏–∑–º.)", 
            // Modals
            user_actions_title: "–î–µ–π—Å—Ç–≤–∏—è",
            user_actions_text: "–í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å.",
            user_actions_chat_button: "–ù–∞–ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç–µ",
            user_actions_email_button: "–ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞ Email",
            modal_cancel_button: "–û—Ç–º–µ–Ω–∞",
            channel_settings_title: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–Ω–∞–ª–∞",
            channel_edit_name_placeholder: "–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞",
            channel_edit_password_placeholder: "–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–ø—É—Å—Ç–æ = –±–µ–∑ –ø–∞—Ä–æ–ª—è)",
            channel_edit_desc_placeholder: "–ù–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞",
            channel_members_title: "–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–∞–Ω–∞–ª–∞",
            channel_members_loading: "–ó–∞–≥—Ä—É–∑–∫–∞...",
            modal_save_button: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
            delete_channel_button: "üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ö–∞–Ω–∞–ª",
            create_channel_title: "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–∞–Ω–∞–ª",
            channel_create_name_placeholder: "–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞",
            channel_create_password_placeholder: "–ü–∞—Ä–æ–ª—å (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ)",
            channel_create_desc_placeholder: "–û–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞",
            modal_create_button: "–°–æ–∑–¥–∞—Ç—å",
            create_question_title: "–°–æ–∑–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å",
            create_question_placeholder: `–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –≤ —Ñ–æ—Ä–º–∞—Ç–µ .qst\n\n?–°—Ç–æ–ª–∏—Ü–∞ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞\n+–ê—Å—Ç–∞–Ω–∞\n-–ù—É—Ä-–°—É–ª—Ç–∞–Ω\n-–£—Ç–µ—Ä–∞\n\n*–ú–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ`,
            create_question_modal_button: "–°–æ–∑–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å",
            edit_message_title: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ",
            edit_profile_title: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å",
            edit_profile_name_placeholder: "–í–∞—à–µ –∏–º—è",
            edit_profile_new_password_placeholder: "–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –º–µ–Ω—è–µ—Ç–µ)",
            delete_account_button: "üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç",
            file_actions_title: "–î–µ–π—Å—Ç–≤–∏—è —Å —Ñ–∞–π–ª–æ–º",
            file_actions_download: "üì• –°–∫–∞—á–∞—Ç—å",
            file_actions_test: "‚ö°Ô∏è –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç",
            // JS Messages & Alerts
            auth_system_unavailable: "–°–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞",
            fill_all_fields: "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è",
            password_min_length: "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤",
            passwords_do_not_match: "–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!",
            error_user_not_found: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω",
            error_wrong_password: "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å",
            error_email_in_use: "Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è",
            error_weak_password: "–°–ª–∏—à–∫–æ–º —Å–ª–∞–±—ã–π –ø–∞—Ä–æ–ª—å",
            error_invalid_email: "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email",
            error_too_many_requests: "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ",
            error_generic: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑",
            loading_messages: "–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...",
            loading_error: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.",
            pinned_messages_empty: "–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç",
            messages_empty: "–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤—ã–º!",
            file_share_question_1: "–≤–æ–ø—Ä–æ—Å",
            file_share_question_2_4: "–≤–æ–ø—Ä–æ—Å–∞",
            file_share_question_5_more: "–≤–æ–ø—Ä–æ—Å–æ–≤",
            new_question_notification: "–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å",
            notification_new_message: "–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!",
            questions_empty: "–í–æ–ø—Ä–æ—Å–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç",
            favorites_empty: "–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç",
            favorites_loading_error: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ",
            users_not_found: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.",
            confirm_delete_message: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?",
            confirm_delete_question: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.",
            confirm_kick_user: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ –∫–∞–Ω–∞–ª–∞?",
            confirm_delete_channel: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–∞–Ω–∞–ª? –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –Ω–µ–º –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.",
            confirm_delete_account: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û.",
            confirm_clear_favorites: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.",
            profile_updated_success: "–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!",
            channel_name_empty: "–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.",
            cant_delete_general: "–û—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª —É–¥–∞–ª–∏—Ç—å –Ω–µ–ª—å–∑—è.",
            invalid_channel_password: "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.",
            add_to_favorites_success: "–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ!",
            add_to_favorites_auth_required: "–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è.",
            question_format_unrecognized: "–§–æ—Ä–º–∞—Ç –≤–æ–ø—Ä–æ—Å–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å.",
            questions_added_from_chat_success: "–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ —á–∞—Ç–∞:",
            questions_added_success: "–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤:",
            notifications_enabled: "–ó–≤—É–∫–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã",
            notifications_disabled: "–ó–≤—É–∫–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω—ã",
            notifications_title_enabled: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã",
            notifications_title_disabled: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω—ã",
            pinned_mode_on_title: "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è",
            pinned_mode_off_title: "–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ",
            download_no_data: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤ —Ä–∞–∑–¥–µ–ª–µ",
            favorites_cleared_success: "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω–æ.",
            favorites_already_empty: "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ —É–∂–µ –ø—É—Å—Ç–æ.",
            copy_success: "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!",
            copy_error: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.",
            file_type_unsupported: "–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã .qst –∏ .txt",
            reauth_prompt: "–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å:",
            reauth_cancelled: "–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ. –ü–∞—Ä–æ–ª—å –Ω–µ –±—ã–ª –≤–≤–µ–¥–µ–Ω.",
            deleting_account_status: "–£–¥–∞–ª–µ–Ω–∏–µ...",
            delete_account_success: "–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –±—ã–ª —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.",
            question_deleted_message: "–≠—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –±—ã–ª —É–¥–∞–ª–µ–Ω.",
            file_download_error: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª:",
            test_start_error: "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç:",
            global_loader_loading_test: "–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–∞",
            password_reauth_required: "–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–µ–¥–∞–≤–Ω–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–π–¥–∏—Ç–µ –∏ –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.",
            channel_enter_password_prompt: "–ö–∞–Ω–∞–ª '{channelName}' –∑–∞—â–∏—â–µ–Ω. –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:",
            question_card_question_label: "–í–æ–ø—Ä–æ—Å:",
            question_card_author_label: "–ê–≤—Ç–æ—Ä:",
            question_card_date_label: "–î–∞—Ç–∞:",
            question_card_anonymous: "–ê–Ω–æ–Ω–∏–º",
            testing_channel_option: "–ö–∞–Ω–∞–ª –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å –∑–∞–ø–∏—Å—å—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)",
            results_button: "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã",
            practice_test_button: "‚ö°Ô∏è –ü—Ä–æ–±–Ω—ã–π —Ç–µ—Å—Ç",
            official_test_button: "üèÜ –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç",
            results_modal_title: "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Ç–µ—Å—Ç—É",
            results_table_header_num: "#",
            results_table_header_user: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
            results_table_header_accuracy: "–¢–æ—á–Ω–æ—Å—Ç—å",
            results_table_header_time: "–í—Ä–µ–º—è",
            results_empty_state: "–ü–æ —ç—Ç–æ–º—É —Ç–µ—Å—Ç—É –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.",
            file_actions_modal_title: "–§–∞–π–ª:",
            ai_helper_title: "AI-–ø–æ–º–æ—â–Ω–∏–∫",
            ai_summarize_from_selection: "–°–≤–æ–¥–∫–∞ —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è",
            ai_summarize_all: "–ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –ø–æ –≤—Å–µ–º—É –∫–∞–Ω–∞–ª—É",
            ai_selection_banner_text: "–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —Å –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–∞—á–∞—Ç—å —Å–≤–æ–¥–∫—É",
            ai_selection_cancel: "–û—Ç–º–µ–Ω–∞",
            ai_summary_title_selection: "üí° –°–≤–æ–¥–∫–∞ —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:",
            ai_summary_title_all: "üí° –û–±—â–∞—è —Å–≤–æ–¥–∫–∞ –ø–æ –∫–∞–Ω–∞–ª—É:",
            password_reset_email_sent: "–ü–∏—Å—å–º–æ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à—É –ø–æ—á—Ç—É (–≤–∫–ª—é—á–∞—è –ø–∞–ø–∫—É '–°–ø–∞–º').",
            error_user_not_found_for_reset: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω.",
            ai_analyzing_chat: '–ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–ø–∏—Å–∫—É...',
            chat_translate_button_title_on: "–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª",
            chat_translate_button_title_off: "–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ —á–∞—Ç",
            chat_translation_failed: "–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞",
            ai_error_summary_generic: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–≤–æ–¥–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.',
            ai_error_summary_server: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–≤–æ–¥–∫—É: –ü—Ä–æ–∏–∑–æ—à–ª–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ.',
            smart_timestamp_yesterday: '–í—á–µ—Ä–∞',
            delete_favorite_button: 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ',
            error_no_messages_to_select: '–í —ç—Ç–æ–º –∫–∞–Ω–∞–ª–µ –µ—â–µ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –≤—ã–±–æ—Ä–∞.',
            chat_online_list_empty: '–í —Å–µ—Ç–∏ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç',
            chat_user_actions_for: '–î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {userName}',
            chat_kick_user_confirm: '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ –∫–∞–Ω–∞–ª–∞?',
            kick_user_button: '–£–¥–∞–ª–∏—Ç—å',
            chat_kick_user_fail: '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞.',
            chat_cannot_delete_general_alert: '–û—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª —É–¥–∞–ª–∏—Ç—å –Ω–µ–ª—å–∑—è.',
            chat_delete_channel_fail_alert: '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª.',
            chat_channel_name_empty_alert: '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.',
            chat_create_channel_fail_alert: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª.',
            chat_favorites_empty_to_clear: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ —É–∂–µ –ø—É—Å—Ç–æ.',
            chat_profile_update_password_error: '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤.',
            chat_profile_update_success: '–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!',
            chat_profile_update_fail_prefix: '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:',
            error_upload_file_type: "–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã .qst –∏ .txt",
            error_fetch_file_id_failed: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID —Ñ–∞–π–ª–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏.',
            error_upload_failed: '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å.',
            error_file_process_failed: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞.',
            chat_file_download_failed: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª –∏–∑ —á–∞—Ç–∞: {error}',
            error_start_test_failed: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç: {error}',
            chat_analyze_no_messages: '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.',
            chat_analyze_no_valid_messages: '–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.',
            chat_test_results_empty: '–ü–æ —ç—Ç–æ–º—É —Ç–µ—Å—Ç—É –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.',
            chat_test_results_loading_error: '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∞:',
            chat_check_question_status_failed: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤–æ–ø—Ä–æ—Å–∞.',
            chat_question_deleted_alert: '–≠—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –±—ã–ª —É–¥–∞–ª–µ–Ω.',
            chat_show_all_messages: '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è',

            chat_show_pinned_messages: '–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ',
            tooltip_reply: '–û—Ç–≤–µ—Ç–∏—Ç—å',
            tooltip_add_reaction: '–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–∫—Ü–∏—é',
            tooltip_pin: '–ó–∞–∫—Ä–µ–ø–∏—Ç—å',
            tooltip_unpin: '–û—Ç–∫—Ä–µ–ø–∏—Ç—å',
            tooltip_edit_message: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ',
            tooltip_delete_message: '–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ',

            download_file_question_label: "–í–æ–ø—Ä–æ—Å",
            download_file_answer_label: "–û—Ç–≤–µ—Ç",
            download_file_message_label: "–°–æ–æ–±—â–µ–Ω–∏–µ",

            error_save_message_failed: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.',
            error_delete_question_failed: '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å.',
            error_question_parse_failed_detailed: '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç: –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å "?", –∞ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å "+" –∏–ª–∏ "-".',
            error_vote_failed: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å.',
            error_add_favorite_failed: '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ',
            error_remove_favorite_failed: '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ',
            error_start_private_chat_failed: '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –ª–∏—á–Ω—ã–π —á–∞—Ç.',
            error_send_message_failed: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ',

            share_title_favorites: "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ",
            share_title_questions: "–í–æ–ø—Ä–æ—Å—ã",
            share_title_generic_file: "–§–∞–π–ª",

            tooltip_choose_reaction: '–í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é —Ä–µ–∞–∫—Ü–∏—é',

            default_channel_name: "–û–±—â–∏–π",
            default_channel_desc: "–û—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª –¥–ª—è –æ–±—â–µ–Ω–∏—è",

            error_pin_message_failed: "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è.",
            error_create_question_failed: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å(—ã).",
            error_clear_favorites_failed: "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ.",
            error_copy_question_failed: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å.",
            error_download_system_unavailable: "–°–∏—Å—Ç–µ–º–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",

            error_vote_favorite_failed: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º.",
            error_save_channel_failed: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.",
            error_remove_from_favorites_failed: "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ.",
            error_delete_message_failed: '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.',
            error_download_auth_required: "–î–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ —á–∞—Ç–µ.",
            sidebar_search_placeholder: '–ü–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–æ–≤...',
            error_add_to_favorites_failed: "–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ.",
            auth_required_to_view: '–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞',
            ai_summary_modal_title: 'üí° –°–≤–æ–¥–∫–∞ –æ—Ç –ò–ò',

            reauth_wrong_password: "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.",
            results_modal_title: "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Ç–µ—Å—Ç—É",
            results_table_header_num: "#",
            results_table_header_user: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
            results_table_header_accuracy: "–¢–æ—á–Ω–æ—Å—Ç—å",
            results_table_header_time: "–í—Ä–µ–º—è",
            results_empty_state: "–ü–æ —ç—Ç–æ–º—É —Ç–µ—Å—Ç—É –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤."


        },
        kk: {
            // TABS
            tab_messages: "–•–∞–±–∞—Ä–ª–∞–º–∞–ª–∞—Ä",
            tab_questions: "–°“±—Ä–∞“õ—Ç–∞—Ä",
            tab_favorites: "–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä",
            tab_users: "–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã–ª–∞—Ä",
            // Auth
            auth_title: "üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è",
            auth_login_tab: "–ö—ñ—Ä—É",
            auth_register_tab: "–¢—ñ—Ä–∫–µ–ª—É",
            auth_login_placeholder: "–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã –∞—Ç—ã –Ω–µ–º–µ—Å–µ Email",
            auth_password_placeholder: "“ö“±–ø–∏—è —Å”©–∑",
            auth_login_button: "–ö—ñ—Ä—É",
            auth_register_username_placeholder: "–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã –∞—Ç—ã",
            auth_register_email_placeholder: "Email",
            auth_register_password_placeholder: "“ö“±–ø–∏—è —Å”©–∑ (–∫–µ–º—ñ–Ω–¥–µ 6 —Ç–∞“£–±–∞)",
            auth_register_confirm_placeholder: "“ö“±–ø–∏—è —Å”©–∑–¥—ñ “õ–∞–π—Ç–∞–ª–∞“£—ã–∑",
            auth_register_button: "–¢—ñ—Ä–∫–µ–ª—É",
            auth_close_button: "–ñ–∞–±—É",
            auth_or_divider: "–Ω–µ–º–µ—Å–µ",
            auth_google_signin: "Google –∞—Ä“õ—ã–ª—ã –∫—ñ—Ä—É",
            auth_forgot_password: "“ö“±–ø–∏—è —Å”©–∑–¥—ñ “±–º—ã—Ç—Ç—ã“£—ã–∑ –±–∞?",
            forgot_password_modal_title: "“ö“±–ø–∏—è —Å”©–∑–¥—ñ “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É",
            forgot_password_modal_text: "Email –º–µ–∫–µ–Ω–∂–∞–π—ã“£—ã–∑–¥—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑. –ë—ñ–∑ —Å—ñ–∑–≥–µ “õ“±–ø–∏—è —Å”©–∑–¥—ñ “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É —Å—ñ–ª—Ç–µ–º–µ—Å—ñ–Ω –∂—ñ–±–µ—Ä–µ–º—ñ–∑.",
            forgot_password_email_placeholder: "–°—ñ–∑–¥—ñ“£ Email",
            forgot_password_send_button: "–ñ—ñ–±–µ—Ä—É",
            // Main Chat
            chat_header_title: "üí¨ –ß–∞—Ç",
            guest_user: "“ö–æ–Ω–∞“õ",
            generic_user: "–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã",
            edit_profile_link: "‚úèÔ∏è –ü—Ä–æ—Ñ–∏–ª—å–¥—ñ ”©“£–¥–µ—É",
            logout_link: "üö™ –®—ã“ì—É",
            notifications_title: "–•–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É–ª–∞—Ä",
            sidebar_sections: "üìÇ –ë”©–ª—ñ–º–¥–µ—Ä",
            sidebar_channels: "üìã –ê—Ä–Ω–∞–ª–∞—Ä",
            sidebar_create_channel: "+ –ê—Ä–Ω–∞ “õ“±—Ä—É",
            sidebar_private_messages: "‚úâÔ∏è –ñ–µ–∫–µ —Ö–∞–±–∞—Ä–ª–∞–º–∞–ª–∞—Ä",
            sidebar_online: "üë• –ñ–µ–ª—ñ–¥–µ",
            channel_general: "# –ñ–∞–ª–ø—ã",
            search_placeholder: "üîç –Ü–∑–¥–µ—É...",
            pinned_toggle_title: "–ë–µ–∫—ñ—Ç—ñ–ª–≥–µ–Ω–¥–µ—Ä",
            reply_panel_title: "–ñ–∞—É–∞–ø –±–µ—Ä—É:",
            emoji_button_title: "–≠–º–æ–¥–∑–∏",
            create_question_button_title: "–°“±—Ä–∞“õ “õ“±—Ä—É",
            attach_file_button_title: "–§–∞–π–ª–¥—ã —Ç—ñ—Ä–∫–µ—É",
            chat_input_placeholder: "–•–∞–±–∞—Ä–ª–∞–º–∞ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑...",
            download_qst_button: "üì• .qst –∂“Ø–∫—Ç–µ–ø –∞–ª—É",
            download_txt_button: "üì• .txt –∂“Ø–∫—Ç–µ–ø –∞–ª—É",
            add_to_favorites_button: "‚≠ê –¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä“ì–∞ “õ–æ—Å—É",
            copy_question_button: "üìã –ö”©—à—ñ—Ä—É",
            delete_question_button: "üóëÔ∏è –°“±—Ä–∞“õ—Ç—ã –∂–æ—é",
            clear_favorites_button: "üóëÔ∏è –¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä–¥—ã —Ç–∞–∑–∞—Ä—Ç—É",
            question_label: "–°“±—Ä–∞“õ:",
            author_label: "–ê–≤—Ç–æ—Ä—ã:",
            date_label: "–ö“Ø–Ω—ñ:",
            anonymous_user: "–ê–Ω–æ–Ω–∏–º",
            expand_message: "–ö”©–±—ñ—Ä–µ–∫ –∫”©—Ä—Å–µ—Ç—É",
            collapse_message: "–ñ–∞—Å—ã—Ä—É",
            edited_indicator: "(”©–∑–≥.)",
            // Modals
            user_actions_title: "”ò—Ä–µ–∫–µ—Ç—Ç–µ—Ä",
            user_actions_text: "–ù–µ —ñ—Å—Ç–µ–≥—ñ“£—ñ–∑ –∫–µ–ª–µ—Ç—ñ–Ω—ñ–Ω —Ç–∞“£–¥–∞“£—ã–∑.",
            user_actions_chat_button: "–ß–∞—Ç—Ç–∞ –∂–∞–∑—É",
            user_actions_email_button: "Email-–≥–µ –∂–∞–∑—É",
            modal_cancel_button: "–ë–æ–ª–¥—ã—Ä–º–∞—É",
            channel_settings_title: "–ê—Ä–Ω–∞ –±–∞–ø—Ç–∞—É–ª–∞—Ä—ã",
            channel_edit_name_placeholder: "–ê—Ä–Ω–∞–Ω—ã“£ –∂–∞“£–∞ –∞—Ç–∞—É—ã",
            channel_edit_password_placeholder: "–ñ–∞“£–∞ “õ“±–ø–∏—è —Å”©–∑ (–±–æ—Å = “õ“±–ø–∏—è —Å”©–∑—Å—ñ–∑)",
            channel_edit_desc_placeholder: "–ê—Ä–Ω–∞–Ω—ã“£ –∂–∞“£–∞ —Å–∏–ø–∞—Ç—Ç–∞–º–∞—Å—ã",
            channel_members_title: "–ê—Ä–Ω–∞ –º“Ø—à–µ–ª–µ—Ä—ñ",
            channel_members_loading: "–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...",
            modal_save_button: "–°–∞“õ—Ç–∞—É",
            delete_channel_button: "üóëÔ∏è –ê—Ä–Ω–∞–Ω—ã –∂–æ—é",
            create_channel_title: "–ñ–∞“£–∞ –∞—Ä–Ω–∞ “õ“±—Ä—É",
            channel_create_name_placeholder: "–ê—Ä–Ω–∞ –∞—Ç–∞—É—ã",
            channel_create_password_placeholder: "“ö“±–ø–∏—è —Å”©–∑ (–∂–∞–ª–ø—ã“ì–∞ –æ—Ä—Ç–∞“õ “Ø—à—ñ–Ω –±–æ—Å “õ–∞–ª–¥—ã—Ä—ã“£—ã–∑)",
            channel_create_desc_placeholder: "–ê—Ä–Ω–∞ —Å–∏–ø–∞—Ç—Ç–∞–º–∞—Å—ã",
            modal_create_button: "“ö“±—Ä—É",
            create_question_title: "–°“±—Ä–∞“õ “õ“±—Ä—É",
            create_question_placeholder: `–°“±—Ä–∞“ì—ã“£—ã–∑–¥—ã .qst –ø—ñ—à—ñ–º—ñ–Ω–¥–µ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑\n\n?“ö–∞–∑–∞“õ—Å—Ç–∞–Ω–Ω—ã“£ –∞—Å—Ç–∞–Ω–∞—Å—ã\n+–ê—Å—Ç–∞–Ω–∞\n-–ù“±—Ä-–°“±–ª—Ç–∞–Ω\n-–£—Ç–µ—Ä–∞\n\n*–ë—ñ—Ä–¥–µ–Ω –±—ñ—Ä–Ω–µ—à–µ —Å“±—Ä–∞“õ –µ–Ω–≥—ñ–∑—É–≥–µ –±–æ–ª–∞–¥—ã`,
            create_question_modal_button: "–°“±—Ä–∞“õ—Ç—ã “õ“±—Ä—É",
            edit_message_title: "–•–∞–±–∞—Ä–ª–∞–º–∞–Ω—ã ”©“£–¥–µ—É",
            edit_profile_title: "–ü—Ä–æ—Ñ–∏–ª—å–¥—ñ ”©“£–¥–µ—É",
            edit_profile_name_placeholder: "–°—ñ–∑–¥—ñ“£ –∞—Ç—ã“£—ã–∑",
            edit_profile_new_password_placeholder: "–ñ–∞“£–∞ “õ“±–ø–∏—è —Å”©–∑ (”©–∑–≥–µ—Ä—Ç–ø–µ—Å–µ“£—ñ–∑ –±–æ—Å “õ–∞–ª–¥—ã—Ä—ã“£—ã–∑)",
            delete_account_button: "üóëÔ∏è –ê–∫–∫–∞—É–Ω—Ç—Ç—ã –∂–æ—é",
            file_actions_title: "–§–∞–π–ª ”ô—Ä–µ–∫–µ—Ç—Ç–µ—Ä—ñ",
            file_actions_download: "üì• –ñ“Ø–∫—Ç–µ–ø –∞–ª—É",
            file_actions_test: "‚ö°Ô∏è –¢–µ—Å—Ç ”©—Ç—É",
            // JS Messages & Alerts
            auth_system_unavailable: "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∂“Ø–π–µ—Å—ñ “õ–æ–ª–∂–µ—Ç—ñ–º—Å—ñ–∑",
            fill_all_fields: "–ë–∞—Ä–ª—ã“õ ”©—Ä—ñ—Å—Ç–µ—Ä–¥—ñ —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑",
            password_min_length: "“ö“±–ø–∏—è —Å”©–∑ –∫–µ–º—ñ–Ω–¥–µ 6 —Ç–∞“£–±–∞–¥–∞–Ω —Ç“±—Ä—É—ã –∫–µ—Ä–µ–∫",
            passwords_do_not_match: "“ö“±–ø–∏—è —Å”©–∑–¥–µ—Ä —Å”ô–π–∫–µ—Å –∫–µ–ª–º–µ–π–¥—ñ!",
            error_user_not_found: "–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã —Ç–∞–±—ã–ª–º–∞–¥—ã",
            error_wrong_password: "“ö–∞—Ç–µ “õ“±–ø–∏—è —Å”©–∑",
            error_email_in_use: "Email “õ–∞–∑—ñ—Ä–¥—ñ“£ ”©–∑—ñ–Ω–¥–µ “õ–æ–ª–¥–∞–Ω—ã—Å—Ç–∞",
            error_weak_password: "–¢—ã–º ”ô–ª—Å—ñ–∑ “õ“±–ø–∏—è —Å”©–∑",
            error_invalid_email: "–ñ–∞—Ä–∞–º—Å—ã–∑ email –ø—ñ—à—ñ–º—ñ",
            error_too_many_requests: "–¢—ã–º –∫”©–ø ”ô—Ä–µ–∫–µ—Ç. –ö–µ–π—ñ–Ω—ñ—Ä–µ–∫ “õ–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑",
            error_generic: "“ö–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã. “ö–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑",
            loading_messages: "–•–∞–±–∞—Ä–ª–∞–º–∞–ª–∞—Ä –∂“Ø–∫—Ç–µ–ª—É–¥–µ...",
            loading_error: "–ñ“Ø–∫—Ç–µ—É “õ–∞—Ç–µ—Å—ñ.",
            pinned_messages_empty: "–ë–µ–∫—ñ—Ç—ñ–ª–≥–µ–Ω —Ö–∞–±–∞—Ä–ª–∞–º–∞–ª–∞—Ä ”ô–∑—ñ—Ä–≥–µ –∂–æ“õ",
            messages_empty: "–•–∞–±–∞—Ä–ª–∞–º–∞–ª–∞—Ä ”ô–∑—ñ—Ä–≥–µ –∂–æ“õ. –ë—ñ—Ä—ñ–Ω—à—ñ –±–æ–ª—ã–ø –∂–∞–∑—ã“£—ã–∑!",
            file_share_question_1: "—Å“±—Ä–∞“õ",
            file_share_question_2_4: "—Å“±—Ä–∞“õ",
            file_share_question_5_more: "—Å“±—Ä–∞“õ",
            new_question_notification: "–ñ–∞“£–∞ —Å“±—Ä–∞“õ “õ“±—Ä—ã–ª–¥—ã",
            notification_new_message: "–ñ–∞“£–∞ —Ö–∞–±–∞—Ä–ª–∞–º–∞!",
            questions_empty: "–°“±—Ä–∞“õ—Ç–∞—Ä ”ô–∑—ñ—Ä–≥–µ –∂–æ“õ",
            favorites_empty: "–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä–¥–∞ ”ô–∑—ñ—Ä–≥–µ –µ—à—Ç–µ“£–µ –∂–æ“õ",
            favorites_loading_error: "–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä–¥—ã –∂“Ø–∫—Ç–µ—É “õ–∞—Ç–µ—Å—ñ",
            users_not_found: "–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã–ª–∞—Ä —Ç–∞–±—ã–ª–º–∞–¥—ã.",
            confirm_delete_message: "–û—Å—ã —Ö–∞–±–∞—Ä–ª–∞–º–∞–Ω—ã –∂–æ–π“ì—ã“£—ã–∑ –∫–µ–ª–µ—Ç—ñ–Ω—ñ–Ω–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ?",
            confirm_delete_question: "–û—Å—ã —Å“±—Ä–∞“õ—Ç—ã –∂–æ–π“ì—ã“£—ã–∑ –∫–µ–ª–µ—Ç—ñ–Ω—ñ–Ω–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ? –ë“±–ª ”ô—Ä–µ–∫–µ—Ç—Ç—ñ “õ–∞–π—Ç–∞—Ä—É –º“Ø–º–∫—ñ–Ω –µ–º–µ—Å.",
            confirm_kick_user: "–û—Å—ã –º“Ø—à–µ–Ω—ñ –∞—Ä–Ω–∞–¥–∞–Ω –∞–ª“ì—ã“£—ã–∑ –∫–µ–ª–µ—Ç—ñ–Ω—ñ–Ω–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ?",
            confirm_delete_channel: "–û—Å—ã –∞—Ä–Ω–∞–Ω—ã –∂–æ–π“ì—ã“£—ã–∑ –∫–µ–ª–µ—Ç—ñ–Ω—ñ–Ω–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ? –û–Ω–¥–∞“ì—ã –±–∞—Ä–ª—ã“õ —Ö–∞–±–∞—Ä–ª–∞–º–∞–ª–∞—Ä –∂–æ“ì–∞–ª–∞–¥—ã. –ë“±–ª ”ô—Ä–µ–∫–µ—Ç—Ç—ñ “õ–∞–π—Ç–∞—Ä—É –º“Ø–º–∫—ñ–Ω –µ–º–µ—Å.",
            confirm_delete_account: "–ê–∫–∫–∞—É–Ω—Ç—ã“£—ã–∑–¥—ã –∂–æ–π“ì—ã“£—ã–∑ –∫–µ–ª–µ—Ç—ñ–Ω—ñ–Ω–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ? –ë“±–ª ”ô—Ä–µ–∫–µ—Ç—Ç—ñ “ö–ê–ô–¢–ê–†–£ –ú“Æ–ú–ö–Ü–ù –ï–ú–ï–°.",
            confirm_clear_favorites: "–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä–¥–∞–Ω –ë–ê–†–õ–´“ö —ç–ª–µ–º–µ–Ω—Ç—Ç–µ—Ä–¥—ñ –∂–æ–π“ì—ã“£—ã–∑ –∫–µ–ª–µ—Ç—ñ–Ω—ñ–Ω–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ? –ë“±–ª ”ô—Ä–µ–∫–µ—Ç—Ç—ñ “õ–∞–π—Ç–∞—Ä—É –º“Ø–º–∫—ñ–Ω –µ–º–µ—Å.",
            profile_updated_success: "–ü—Ä–æ—Ñ–∏–ª—å —Å”ô—Ç—Ç—ñ –∂–∞“£–∞—Ä—Ç—ã–ª–¥—ã!",
            channel_name_empty: "–ê—Ä–Ω–∞ –∞—Ç–∞—É—ã –±–æ—Å –±–æ–ª–º–∞—É—ã –∫–µ—Ä–µ–∫.",
            cant_delete_general: "–ù–µ–≥—ñ–∑–≥—ñ –∞—Ä–Ω–∞–Ω—ã –∂–æ—é –º“Ø–º–∫—ñ–Ω –µ–º–µ—Å.",
            invalid_channel_password: "“ö–∞—Ç–µ “õ“±–ø–∏—è —Å”©–∑.",
            add_to_favorites_success: "–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä“ì–∞ “õ–æ—Å—ã–ª–¥—ã!",
            add_to_favorites_auth_required: "–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä“ì–∞ “õ–æ—Å—É “Ø—à—ñ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è–¥–∞–Ω ”©—Ç—É “õ–∞–∂–µ—Ç.",
            question_format_unrecognized: "–°“±—Ä–∞“õ –ø—ñ—à—ñ–º—ñ —Ç–∞–Ω—ã–ª–º–∞–¥—ã. –°–∏–Ω—Ç–∞–∫—Å–∏—Å—Ç—ñ —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑.",
            questions_added_from_chat_success: "–ß–∞—Ç—Ç–∞–Ω —Å”ô—Ç—Ç—ñ “õ–æ—Å—ã–ª“ì–∞–Ω —Å“±—Ä–∞“õ—Ç–∞—Ä —Å–∞–Ω—ã:",
            questions_added_success: "–°”ô—Ç—Ç—ñ “õ–æ—Å—ã–ª“ì–∞–Ω —Å“±—Ä–∞“õ—Ç–∞—Ä —Å–∞–Ω—ã:",
            notifications_enabled: "–î—ã–±—ã—Å—Ç—ã“õ —Ö–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É–ª–∞—Ä “õ–æ—Å—É–ª—ã",
            notifications_disabled: "–î—ã–±—ã—Å—Ç—ã“õ —Ö–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É–ª–∞—Ä ”©—à—ñ—Ä—É–ª—ñ",
            notifications_title_enabled: "–•–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É–ª–∞—Ä “õ–æ—Å—É–ª—ã",
            notifications_title_disabled: "–•–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É–ª–∞—Ä ”©—à—ñ—Ä—É–ª—ñ",
            pinned_mode_on_title: "–ë–∞—Ä–ª—ã“õ —Ö–∞–±–∞—Ä–ª–∞–º–∞–ª–∞—Ä–¥—ã –∫”©—Ä—Å–µ—Ç—É",
            pinned_mode_off_title: "–ë–µ–∫—ñ—Ç—ñ–ª–≥–µ–Ω–¥–µ—Ä–¥—ñ –∫”©—Ä—Å–µ—Ç—É",
            download_no_data: "–±”©–ª—ñ–º—ñ–Ω–¥–µ –∂“Ø–∫—Ç–µ—É–≥–µ –¥–µ—Ä–µ–∫—Ç–µ—Ä –∂–æ“õ",
            favorites_cleared_success: "–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä —Å”ô—Ç—Ç—ñ —Ç–∞–∑–∞—Ä—Ç—ã–ª–¥—ã.",
            favorites_already_empty: "–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä “õ–∞–∑—ñ—Ä–¥—ñ“£ ”©–∑—ñ–Ω–¥–µ –±–æ—Å.",
            copy_success: "–ú–∞–∑–º“±–Ω –∞–ª–º–∞—Å—É –±—É—Ñ–µ—Ä—ñ–Ω–µ –∫”©—à—ñ—Ä—ñ–ª–¥—ñ!",
            copy_error: "–ö”©—à—ñ—Ä—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã. –ú”ô—Ç—ñ–Ω–¥—ñ “õ–æ–ª–º–µ–Ω –∫”©—à—ñ—Ä—ñ“£—ñ–∑.",
            file_type_unsupported: "–¢–µ–∫ .qst –∂”ô–Ω–µ .txt —Ñ–∞–π–ª–¥–∞—Ä—ã–Ω –∂“Ø–∫—Ç–µ—É–≥–µ –±–æ–ª–∞–¥—ã",
            reauth_prompt: "–ñ–æ—é–¥—ã —Ä–∞—Å—Ç–∞—É “Ø—à—ñ–Ω –∞“ì—ã–º–¥–∞“ì—ã “õ“±–ø–∏—è —Å”©–∑—ñ“£—ñ–∑–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑:",
            reauth_cancelled: "–ñ–æ—é –±–æ–ª–¥—ã—Ä—ã–ª–º–∞–¥—ã. “ö“±–ø–∏—è —Å”©–∑ –µ–Ω–≥—ñ–∑—ñ–ª–º–µ–¥—ñ.",
            deleting_account_status: "–ñ–æ–π—ã–ª—É–¥–∞...",
            delete_account_success: "–°—ñ–∑–¥—ñ“£ –∞–∫–∫–∞—É–Ω—Ç—ã“£—ã–∑ —Å”ô—Ç—Ç—ñ –∂–æ–π—ã–ª–¥—ã.",
            question_deleted_message: "–ë“±–ª —Å“±—Ä–∞“õ –∂–æ–π—ã–ª–¥—ã.",
            file_download_error: "–§–∞–π–ª–¥—ã –∂“Ø–∫—Ç–µ—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã:",
            test_start_error: "–¢–µ—Å—Ç—Ç—ñ –±–∞—Å—Ç–∞—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã:",
            global_loader_loading_test: "–¢–µ—Å—Ç –∂“Ø–∫—Ç–µ–ª—É–¥–µ",
            password_reauth_required: "–ë“±–ª ”ô—Ä–µ–∫–µ—Ç—Ç—ñ –æ—Ä—ã–Ω–¥–∞—É “Ø—à—ñ–Ω –∂–∞“õ—ã–Ω–¥–∞ –∫—ñ—Ä—É “õ–∞–∂–µ—Ç. –®—ã“ì—ã–ø, “õ–∞–π—Ç–∞ –∫—ñ—Ä—ñ“£—ñ–∑.",
            channel_enter_password_prompt: "'{channelName}' –∞—Ä–Ω–∞—Å—ã “õ–æ—Ä“ì–∞–ª“ì–∞–Ω. “ö“±–ø–∏—è —Å”©–∑–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑:",
            question_card_question_label: "–°“±—Ä–∞“õ:",
            question_card_author_label: "–ê–≤—Ç–æ—Ä—ã:",
            question_card_date_label: "–ö“Ø–Ω—ñ:",
            question_card_anonymous: "–ê–Ω–æ–Ω–∏–º",
            testing_channel_option: "–¢–µ—Å—Ç—ñ–ª–µ—É –∞—Ä–Ω–∞—Å—ã (–Ω”ô—Ç–∏–∂–µ–ª–µ—Ä–¥—ñ –∂–∞–∑—É–º–µ–Ω)",
            results_button: "üìä –ù”ô—Ç–∏–∂–µ–ª–µ—Ä",
            practice_test_button: "‚ö°Ô∏è –°—ã–Ω–∞“õ —Ç–µ—Å—Ç—ñ",
            official_test_button: "üèÜ –¢–µ—Å—Ç—Ç—ñ ”©—Ç—É",
            results_modal_title: "–¢–µ—Å—Ç –Ω”ô—Ç–∏–∂–µ–ª–µ—Ä—ñ",
            results_table_header_num: "#",
            results_table_header_user: "–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã",
            results_table_header_accuracy: "–î”ô–ª–¥—ñ–∫",
            results_table_header_time: "–£–∞“õ—ã—Ç",
            results_empty_state: "–ë“±–ª —Ç–µ—Å—Ç –±–æ–π—ã–Ω—à–∞ ”ô–∑—ñ—Ä–≥–µ –Ω”ô—Ç–∏–∂–µ –∂–æ“õ.",
            file_actions_modal_title: "–§–∞–π–ª:",
            ai_helper_title: "AI-–∫”©–º–µ–∫—à—ñ",
            ai_summarize_from_selection: "–¢–∞“£–¥–∞–ª“ì–∞–Ω —Ö–∞–±–∞—Ä–ª–∞–º–∞–¥–∞–Ω “õ–æ—Ä—ã—Ç—ã–Ω–¥—ã",
            ai_summarize_all: "–ë“Ø–∫—ñ–ª –∞—Ä–Ω–∞–Ω—ã“£ “õ—ã—Å“õ–∞—à–∞ —Ç“Ø–π—ñ–Ω–¥–µ–º–µ—Å—ñ",
            ai_selection_cancel: "–ë–æ–ª–¥—ã—Ä–º–∞—É",
            ai_summary_title_selection: "üí° –¢–∞“£–¥–∞–ª“ì–∞–Ω —Ö–∞–±–∞—Ä–ª–∞–º–∞–¥–∞–Ω –±–∞—Å—Ç–∞–ø —Ç“Ø–π—ñ–Ω–¥–µ–º–µ:",
            ai_selection_banner_text: "“ö–æ—Ä—ã—Ç—ã–Ω–¥—ã–Ω—ã –±–∞—Å—Ç–∞–π—Ç—ã–Ω —Ö–∞–±–∞—Ä–ª–∞–º–∞–Ω—ã —Ç–∞“£–¥–∞“£—ã–∑",
            ai_summary_title_all: "üí° –ê—Ä–Ω–∞ –±–æ–π—ã–Ω—à–∞ –∂–∞–ª–ø—ã —Ç“Ø–π—ñ–Ω–¥–µ–º–µ:",
            password_reset_email_sent: "“ö“±–ø–∏—è —Å”©–∑–¥—ñ “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É —Ö–∞—Ç—ã –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ! –ü–æ—à—Ç–∞“£—ã–∑–¥—ã —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑ ('–°–ø–∞–º' “õ–∞–ª—Ç–∞—Å—ã–Ω “õ–æ—Å–∞).",
            error_user_not_found_for_reset: "–ë“±–ª email-–º–µ–Ω –ø–∞–π–¥–∞–ª–∞–Ω—É—à—ã —Ç–∞–±—ã–ª–º–∞–¥—ã.",
            ai_analyzing_chat: '–ñ–ò —Ö–∞—Ç –∞–ª–º–∞—Å—É–¥—ã —Ç–∞–ª–¥–∞—É–¥–∞...',
            chat_translate_button_title_on: "–¢“Ø–ø–Ω“±—Å“õ–∞–Ω—ã –∫”©—Ä—Å–µ—Ç—É",
            chat_translate_button_title_off: "–ß–∞—Ç—Ç—ã –∞—É–¥–∞—Ä—É",
            chat_translation_failed: "–ê—É–¥–∞—Ä—É “õ–∞—Ç–µ—Å—ñ",
            ai_error_summary_generic: '–¢“Ø–π—ñ–Ω–¥–µ–º–µ–Ω—ñ –∞–ª—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã. “ö–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑.',
            ai_error_summary_server: '–¢“Ø–π—ñ–Ω–¥–µ–º–µ–Ω—ñ –∞–ª—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã: –°–µ—Ä–≤–µ—Ä–¥–µ —É–∞“õ—ã—Ç—à–∞ “õ–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã. –ö–µ–π—ñ–Ω—ñ—Ä–µ–∫ “õ–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑.',
            smart_timestamp_yesterday: '–ö–µ—à–µ',
            delete_favorite_button: 'üóëÔ∏è –¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä–¥–∞–Ω –∂–æ—é',
            error_no_messages_to_select: '–ë“±–ª –∞—Ä–Ω–∞–¥–∞ —Ç–∞“£–¥–∞—É “Ø—à—ñ–Ω —Ö–∞–±–∞—Ä–ª–∞–º–∞–ª–∞—Ä ”ô–ª—ñ –∂–æ“õ.',
            chat_online_list_empty: '–ñ–µ–ª—ñ–¥–µ –µ—à–∫—ñ–º –∂–æ“õ',
            chat_user_actions_for: '{userName} –ø–∞–π–¥–∞–ª–∞–Ω—É—à—ã—Å—ã “Ø—à—ñ–Ω ”ô—Ä–µ–∫–µ—Ç—Ç–µ—Ä',
            chat_kick_user_confirm: '–û—Å—ã –º“Ø—à–µ–Ω—ñ –∞—Ä–Ω–∞–¥–∞–Ω –∞–ª“ì—ã“£—ã–∑ –∫–µ–ª–µ—Ç—ñ–Ω—ñ–Ω–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ?',
            kick_user_button: '–ñ–æ—é',
            chat_kick_user_fail: '–ú“Ø—à–µ–Ω—ñ –∂–æ—é –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',
            chat_cannot_delete_general_alert: '–ù–µ–≥—ñ–∑–≥—ñ –∞—Ä–Ω–∞–Ω—ã –∂–æ—é –º“Ø–º–∫—ñ–Ω –µ–º–µ—Å.',
            chat_delete_channel_fail_alert: '–ê—Ä–Ω–∞–Ω—ã –∂–æ—é –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',
            chat_channel_name_empty_alert: '–ê—Ä–Ω–∞ –∞—Ç–∞—É—ã –±–æ—Å –±–æ–ª–º–∞—É—ã –∫–µ—Ä–µ–∫.',
            chat_create_channel_fail_alert: '–ê—Ä–Ω–∞–Ω—ã “õ“±—Ä—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',
            chat_favorites_empty_to_clear: '–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä “õ–∞–∑—ñ—Ä–¥—ñ“£ ”©–∑—ñ–Ω–¥–µ –±–æ—Å.',
            chat_profile_update_password_error: '“ö“±–ø–∏—è —Å”©–∑ –∫–µ–º—ñ–Ω–¥–µ 6 —Ç–∞“£–±–∞–¥–∞–Ω —Ç“±—Ä—É—ã –∫–µ—Ä–µ–∫.',
            chat_profile_update_success: '–ü—Ä–æ—Ñ–∏–ª—å —Å”ô—Ç—Ç—ñ –∂–∞“£–∞—Ä—Ç—ã–ª–¥—ã!',
            chat_profile_update_fail_prefix: '–ü—Ä–æ—Ñ–∏–ª—å–¥—ñ –∂–∞“£–∞—Ä—Ç—É “õ–∞—Ç–µ—Å—ñ:',
            error_upload_file_type: "–¢–µ–∫ .qst –∂”ô–Ω–µ .txt —Ñ–∞–π–ª–¥–∞—Ä—ã–Ω –∂“Ø–∫—Ç–µ—É–≥–µ –±–æ–ª–∞–¥—ã",
            error_fetch_file_id_failed: '–ñ“Ø–∫—Ç–µ—É–¥–µ–Ω –∫–µ–π—ñ–Ω —Ñ–∞–π–ª ID-—ñ–Ω –∞–ª—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',
            error_upload_failed: '–§–∞–π–ª–¥—ã –∂“Ø–∫—Ç–µ—É —Å”ô—Ç—Å—ñ–∑ –∞—è“õ—Ç–∞–ª–¥—ã.',
            error_file_process_failed: '–§–∞–π–ª–¥—ã ”©“£–¥–µ—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã.',
            chat_file_download_failed: '–ß–∞—Ç—Ç–∞–Ω —Ñ–∞–π–ª–¥—ã –∂“Ø–∫—Ç–µ—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã: {error}',
            error_start_test_failed: '–¢–µ—Å—Ç—Ç—ñ –±–∞—Å—Ç–∞—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã: {error}',
            chat_analyze_no_messages: '–¢–∞–ª–¥–∞—É “Ø—à—ñ–Ω —Ö–∞–±–∞—Ä–ª–∞–º–∞–ª–∞—Ä –∂–æ“õ.',
            chat_analyze_no_valid_messages: '–¢–∞–ª–¥–∞—É“ì–∞ –∂–∞—Ä–∞–º–¥—ã —Ö–∞–±–∞—Ä–ª–∞–º–∞–ª–∞—Ä –∂–æ“õ.',
            chat_test_results_empty: '–ë“±–ª —Ç–µ—Å—Ç –±–æ–π—ã–Ω—à–∞ ”ô–∑—ñ—Ä–≥–µ –Ω”ô—Ç–∏–∂–µ –∂–æ“õ.',
            chat_test_results_loading_error: '–¢–µ—Å—Ç –Ω”ô—Ç–∏–∂–µ–ª–µ—Ä—ñ–Ω –∂“Ø–∫—Ç–µ—É “õ–∞—Ç–µ—Å—ñ:',
            chat_check_question_status_failed: '–°“±—Ä–∞“õ—Ç—ã“£ –∫“Ø–π—ñ–Ω —Ç–µ–∫—Å–µ—Ä—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',
            chat_question_deleted_alert: '–ë“±–ª —Å“±—Ä–∞“õ –∂–æ–π—ã–ª–¥—ã.',
            chat_show_all_messages: '–ë–∞—Ä–ª—ã“õ —Ö–∞–±–∞—Ä–ª–∞–º–∞–ª–∞—Ä–¥—ã –∫”©—Ä—Å–µ—Ç—É',
            chat_show_pinned_messages: '–ë–µ–∫—ñ—Ç—ñ–ª–≥–µ–Ω–¥–µ—Ä–¥—ñ –∫”©—Ä—Å–µ—Ç—É',

            tooltip_reply: '–ñ–∞—É–∞–ø –±–µ—Ä—É',
            tooltip_add_reaction: '–†–µ–∞–∫—Ü–∏—è “õ–æ—Å—É',
            tooltip_pin: '–ë–µ–∫—ñ—Ç—É',
            tooltip_unpin: '–ë–µ–∫—ñ—Ç—É–¥–µ–Ω –∞–ª—É',
            tooltip_edit_message: '–•–∞–±–∞—Ä–ª–∞–º–∞–Ω—ã ”©“£–¥–µ—É',
            tooltip_delete_message: '–•–∞–±–∞—Ä–ª–∞–º–∞–Ω—ã –∂–æ—é',

            download_file_question_label: "–°“±—Ä–∞“õ",
            download_file_answer_label: "–ñ–∞—É–∞–ø",
            download_file_message_label: "–•–∞–±–∞—Ä–ª–∞–º–∞",

            error_save_message_failed: '”®–∑–≥–µ—Ä—ñ—Å—Ç–µ—Ä–¥—ñ —Å–∞“õ—Ç–∞—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',
            error_delete_question_failed: '–°“±—Ä–∞“õ—Ç—ã –∂–æ—é –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',
            error_question_parse_failed_detailed: '–°“±—Ä–∞“õ—Ç–∞—Ä–¥—ã —Ç–∞–Ω—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã. –ü—ñ—à—ñ–º–¥—ñ —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑: ”ô—Ä —Å“±—Ä–∞“õ "?"-—Ç–µ–Ω, –∞–ª –Ω“±—Å“õ–∞–ª–∞—Ä "+" –Ω–µ–º–µ—Å–µ "-"-—Ç–µ–Ω –±–∞—Å—Ç–∞–ª—É—ã –∫–µ—Ä–µ–∫.',
            error_vote_failed: '–î–∞—É—ã—Å –±–µ—Ä—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',
            error_add_favorite_failed: '–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä“ì–∞ “õ–æ—Å—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã',
            error_remove_favorite_failed: '–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä–¥–∞–Ω –∂–æ—é –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã',
            error_start_private_chat_failed: '–ñ–µ–∫–µ —á–∞—Ç—Ç—ã –±–∞—Å—Ç–∞—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',
            error_send_message_failed: '–•–∞–±–∞—Ä–ª–∞–º–∞–Ω—ã –∂—ñ–±–µ—Ä—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã',

            share_title_favorites: "–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä",
            share_title_questions: "–°“±—Ä–∞“õ—Ç–∞—Ä",
            share_title_generic_file: "–§–∞–π–ª",

            tooltip_choose_reaction: '–ë–∞—Å“õ–∞ —Ä–µ–∞–∫—Ü–∏—è–Ω—ã —Ç–∞“£–¥–∞—É',

            default_channel_name: "–ñ–∞–ª–ø—ã",
            default_channel_desc: "–ù–µ–≥—ñ–∑–≥—ñ —Å”©–π–ª–µ—Å—É –∞—Ä–Ω–∞—Å—ã",

            error_pin_message_failed: "–•–∞–±–∞—Ä–ª–∞–º–∞–Ω—ã –±–µ–∫—ñ—Ç—É –∫“Ø–π—ñ–Ω ”©–∑–≥–µ—Ä—Ç—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.",
            error_create_question_failed: "–°“±—Ä–∞“õ(—Ç–∞—Ä)–¥—ã “õ“±—Ä—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.",
            error_clear_favorites_failed: "–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä–¥—ã —Ç–∞–∑–∞—Ä—Ç—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.",
            error_copy_question_failed: "–°“±—Ä–∞“õ—Ç—ã –∫”©—à—ñ—Ä—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.",
            error_download_system_unavailable: "–ñ“Ø–∫—Ç–µ—É –∂“Ø–π–µ—Å—ñ “õ–æ–ª–∂–µ—Ç—ñ–º—Å—ñ–∑. –ë–µ—Ç—Ç—ñ “õ–∞–π—Ç–∞ –∂“Ø–∫—Ç–µ–ø, ”ô—Ä–µ–∫–µ—Ç—Ç—ñ “õ–∞–π—Ç–∞–ª–∞“£—ã–∑.",

            error_vote_favorite_failed: "–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä–¥–∞ –¥–∞—É—ã—Å –±–µ—Ä—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.",
            error_save_channel_failed: "”®–∑–≥–µ—Ä—ñ—Å—Ç–µ—Ä–¥—ñ —Å–∞“õ—Ç–∞—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.",
            error_remove_from_favorites_failed: "–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä–¥–∞–Ω –∂–æ—é –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.",
            error_add_to_favorites_failed: "–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä“ì–∞ “õ–æ—Å—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.",
            error_delete_message_failed: '–•–∞–±–∞—Ä–ª–∞–º–∞–Ω—ã –∂–æ—é –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',
            error_download_auth_required: '–ñ“Ø–∫—Ç–µ–ø –∞–ª—É “Ø—à—ñ–Ω —á–∞—Ç“õ–∞ –∫—ñ—Ä—É—ñ“£—ñ–∑ “õ–∞–∂–µ—Ç.',
            sidebar_search_placeholder: '–ê—Ä–Ω–∞–ª–∞—Ä–¥—ã —ñ–∑–¥–µ—É...',
            auth_required_to_view: '–ö”©—Ä—É “Ø—à—ñ–Ω –∫—ñ—Ä—ñ“£—ñ–∑',
            ai_summary_modal_title: 'üí° –ñ–ò —Ç“Ø–π—ñ–Ω–¥–µ–º–µ—Å—ñ',

            reauth_wrong_password: "“ö–∞—Ç–µ “õ“±–ø–∏—è —Å”©–∑. “ö–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑.",
            results_modal_title: "–¢–µ—Å—Ç –Ω”ô—Ç–∏–∂–µ–ª–µ—Ä—ñ",
            results_table_header_num: "#",
            results_table_header_user: "–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã",
            results_table_header_accuracy: "–î”ô–ª–¥—ñ–∫",
            results_table_header_time: "–£–∞“õ—ã—Ç",
            results_empty_state: "–ë“±–ª —Ç–µ—Å—Ç –±–æ–π—ã–Ω—à–∞ ”ô–∑—ñ—Ä–≥–µ –Ω”ô—Ç–∏–∂–µ –∂–æ“õ."
        },
        en: {
            // TABS
            tab_messages: "Messages",
            tab_questions: "Questions",
            tab_favorites: "Favorites",
            tab_users: "Users",
            // Auth
            auth_title: "üîê Authorization",
            auth_login_tab: "Login",
            auth_register_tab: "Register",
            auth_login_placeholder: "Username or Email",
            auth_password_placeholder: "Password",
            auth_login_button: "Log In",
            auth_register_username_placeholder: "Username",
            auth_register_email_placeholder: "Email",
            auth_register_password_placeholder: "Password (min. 6 characters)",
            auth_register_confirm_placeholder: "Confirm password",
            auth_register_button: "Register",
            auth_close_button: "Close",
            auth_or_divider: "or",
            auth_google_signin: "Sign in with Google",
            auth_forgot_password: "Forgot password?",
            forgot_password_modal_title: "Reset Password",
            forgot_password_modal_text: "Enter your email. We'll send you a link to reset your password.",
            forgot_password_email_placeholder: "Your Email",
            forgot_password_send_button: "Send",
            // Main Chat
            chat_header_title: "üí¨ Chat",
            guest_user: "Guest",
            generic_user: "User",
            edit_profile_link: "‚úèÔ∏è Edit Profile",
            logout_link: "üö™ Logout",
            notifications_title: "Notifications",
            sidebar_sections: "üìÇ Sections",
            sidebar_channels: "üìã Channels",
            sidebar_create_channel: "+ Create Channel",
            sidebar_private_messages: "‚úâÔ∏è Private Messages",
            sidebar_online: "üë• Online",
            channel_general: "# General",
            search_placeholder: "üîç Search...",
            pinned_toggle_title: "Pinned",
            reply_panel_title: "Replying to:",
            emoji_button_title: "Emoji",
            create_question_button_title: "Create Question",
            attach_file_button_title: "Attach File",
            chat_input_placeholder: "Enter a message...",
            download_qst_button: "üì• Download .qst",
            download_txt_button: "üì• Download .txt",
            add_to_favorites_button: "‚≠ê Add to Favorites",
            copy_question_button: "üìã Copy",
            delete_question_button: "üóëÔ∏è Delete Question",
            clear_favorites_button: "üóëÔ∏è Clear Favorites",
            question_label: "Question:",
            author_label: "Author:",
            date_label: "Date:",
            anonymous_user: "Anonymous",
            expand_message: "Read more", 
            collapse_message: "Show less", 
            edited_indicator: "(edited)",
            // Modals
            user_actions_title: "Actions",
            user_actions_text: "Choose what you want to do.",
            user_actions_chat_button: "Send a message",
            user_actions_email_button: "Send an Email",
            modal_cancel_button: "Cancel",
            channel_settings_title: "Channel Settings",
            channel_edit_name_placeholder: "New channel name",
            channel_edit_password_placeholder: "New password (empty = no password)",
            channel_edit_desc_placeholder: "New channel description",
            channel_members_title: "Channel Members",
            channel_members_loading: "Loading...",
            modal_save_button: "Save",
            delete_channel_button: "üóëÔ∏è Delete Channel",
            create_channel_title: "Create New Channel",
            channel_create_name_placeholder: "Channel name",
            channel_create_password_placeholder: "Password (leave empty for public)",
            channel_create_desc_placeholder: "Channel description",
            modal_create_button: "Create",
            create_question_title: "Create Question",
            create_question_placeholder: `Enter your question in .qst format\n\n?Capital of Kazakhstan\n+Astana\n-Nur-Sultan\n-Utera\n\n*You can enter multiple questions at once`,
            create_question_modal_button: "Create Question",
            edit_message_title: "Edit Message",
            edit_profile_title: "Edit Profile",
            edit_profile_name_placeholder: "Your name",
            edit_profile_new_password_placeholder: "New password (leave empty if not changing)",
            delete_account_button: "üóëÔ∏è Delete Account",
            file_actions_title: "File Actions",
            file_actions_download: "üì• Download",
            file_actions_test: "‚ö°Ô∏è Take Test",
            // JS Messages & Alerts
            auth_system_unavailable: "Authentication system is not available",
            fill_all_fields: "Please fill in all fields",
            password_min_length: "Password must be at least 6 characters long",
            passwords_do_not_match: "Passwords do not match!",
            error_user_not_found: "User not found",
            error_wrong_password: "Incorrect password",
            error_email_in_use: "Email is already in use",
            error_weak_password: "Password is too weak",
            error_invalid_email: "Invalid email format",
            error_too_many_requests: "Too many requests. Please try again later",
            error_generic: "An error occurred. Please try again",
            loading_messages: "Loading messages...",
            loading_error: "Loading error.",
            pinned_messages_empty: "No pinned messages yet",
            messages_empty: "No messages yet. Be the first to write!",
            file_share_question_1: "question",
            file_share_question_2_4: "questions",
            file_share_question_5_more: "questions",
            new_question_notification: "A new question has been created",
            notification_new_message: "New message!",
            questions_empty: "No questions yet",
            favorites_empty: "Nothing in favorites yet",
            favorites_loading_error: "Error loading favorites",
            users_not_found: "Users not found.",
            confirm_delete_message: "Are you sure you want to delete this message?",
            confirm_delete_question: "Are you sure you want to delete this question? This action is irreversible.",
            confirm_kick_user: "Are you sure you want to remove this member from the channel?",
            confirm_delete_channel: "Are you sure you want to delete this channel? All messages within it will be lost. This action is irreversible.",
            confirm_delete_account: "Are you sure you want to delete your account? This action is IRREVERSIBLE.",
            confirm_clear_favorites: "Are you sure you want to delete ALL items from your favorites? This action is irreversible.",
            profile_updated_success: "Profile updated successfully!",
            channel_name_empty: "Channel name cannot be empty.",
            cant_delete_general: "The main channel cannot be deleted.",
            invalid_channel_password: "Incorrect password.",
            add_to_favorites_success: "Added to favorites!",
            add_to_favorites_auth_required: "You must be logged in to add to favorites.",
            question_format_unrecognized: "Question format not recognized. Please check the syntax.",
            questions_added_from_chat_success: "Successfully added questions from chat:",
            questions_added_success: "Successfully added questions:",
            notifications_enabled: "Sound notifications are enabled",
            notifications_disabled: "Sound notifications are disabled",
            notifications_title_enabled: "Notifications on",
            notifications_title_disabled: "Notifications off",
            pinned_mode_on_title: "Show all messages",
            pinned_mode_off_title: "Show pinned messages",
            download_no_data: "No data to download in section",
            favorites_cleared_success: "Favorites cleared successfully.",
            favorites_already_empty: "Favorites is already empty.",
            copy_success: "Content copied to clipboard!",
            copy_error: "Could not copy. Please copy the text manually.",
            file_type_unsupported: "Only .qst and .txt files can be uploaded",
            reauth_prompt: "To confirm deletion, please enter your current password:",
            reauth_cancelled: "Deletion cancelled. Password was not entered.",
            deleting_account_status: "Deleting...",
            delete_account_success: "Your account has been successfully deleted.",
            question_deleted_message: "This question has been deleted.",
            file_download_error: "Failed to download file:",
            test_start_error: "Failed to start test:",
            global_loader_loading_test: "Loading test",
            password_reauth_required: "This action requires a recent login. Please log out and log in again.",
            channel_enter_password_prompt: "Channel '{channelName}' is protected. Please enter the password:",
            question_card_question_label: "Question:",
            question_card_author_label: "Author:",
            question_card_date_label: "Date:",
            question_card_anonymous: "Anonymous",
            testing_channel_option: "Testing channel (with result tracking)",
            results_button: "üìä Results",
            practice_test_button: "‚ö°Ô∏è Practice Test",
            official_test_button: "üèÜ Take Test",
            results_modal_title: "Test Results",
            results_table_header_num: "#",
            results_table_header_user: "User",
            results_table_header_accuracy: "Accuracy",
            results_table_header_time: "Time",
            results_empty_state: "There are no results for this test yet.",
            file_actions_modal_title: "File:",
            ai_helper_title: "AI Assistant",
            ai_summarize_from_selection: "Summarize from selection",
            ai_summarize_all: "Summarize entire channel",
            ai_selection_banner_text: "Select a message to start the summary from",
            ai_selection_cancel: "Cancel",
            ai_summary_title_selection: "üí° Summary from selected message:",
            ai_summary_title_all: "üí° General channel summary:",
            password_reset_email_sent: "Password reset email sent! Please check your inbox (including the spam folder).",
            error_user_not_found_for_reset: "User with this email not found.",
            ai_analyzing_chat: 'AI is analyzing the chat...',
            chat_translate_button_title_on: "Show Original",
            chat_translate_button_title_off: "Translate Chat",
            chat_translation_failed: "Translation failed",
            ai_error_summary_generic: 'Failed to get summary. Please try again.',
            ai_error_summary_server: 'Failed to get summary: A temporary server error occurred. Please try again later.',
            smart_timestamp_yesterday: 'Yesterday',
            delete_favorite_button: 'üóëÔ∏è Remove from Favorites',
            error_no_messages_to_select: 'There are no messages in this channel to select yet.',
            chat_online_list_empty: 'No one is online',
            chat_user_actions_for: 'Actions for user {userName}',
            chat_kick_user_confirm: 'Are you sure you want to remove this member from the channel?',
            kick_user_button: 'Remove',
            chat_kick_user_fail: 'Failed to remove member.',
            chat_cannot_delete_general_alert: 'The main channel cannot be deleted.',
            chat_delete_channel_fail_alert: 'Failed to delete channel.',
            chat_channel_name_empty_alert: 'Channel name cannot be empty.',
            chat_create_channel_fail_alert: 'Failed to create channel.',
            chat_favorites_empty_to_clear: 'Favorites is already empty.',
            chat_profile_update_password_error: 'Password must be at least 6 characters.',
            chat_profile_update_success: 'Profile updated successfully!',
            chat_profile_update_fail_prefix: 'Profile update failed:',
            error_upload_file_type: "Only .qst and .txt files can be uploaded",
            error_fetch_file_id_failed: 'Failed to get file ID after upload.',
            error_upload_failed: 'File upload failed.',
            error_file_process_failed: 'Error processing file.',
            chat_file_download_failed: 'Failed to download file from chat: {error}',
            error_start_test_failed: 'Failed to start test: {error}',
            chat_analyze_no_messages: 'No messages to analyze.',
            chat_analyze_no_valid_messages: 'No suitable messages to analyze.',
            chat_test_results_empty: 'There are no results for this test yet.',
            chat_test_results_loading_error: 'Error loading test results:',
            chat_check_question_status_failed: 'Could not check question status.',
            chat_question_deleted_alert: 'This question has been deleted.',
            chat_show_all_messages: 'Show all messages',
            chat_show_pinned_messages: 'Show pinned messages',

            tooltip_reply: 'Reply',
            tooltip_add_reaction: 'Add reaction',
            tooltip_pin: 'Pin',
            tooltip_unpin: 'Unpin',
            tooltip_edit_message: 'Edit message',
            tooltip_delete_message: 'Delete message',

            download_file_question_label: "Question",
            download_file_answer_label: "Answer",
            download_file_message_label: "Message",

            error_save_message_failed: 'Failed to save changes.',
            error_delete_question_failed: 'Failed to delete question.',
            error_question_parse_failed_detailed: 'Could not recognize questions. Check the format: each question must start with "?", and options with "+" or "-".',
            error_vote_failed: 'Failed to vote.',
            error_add_favorite_failed: 'Failed to add to favorites',
            error_remove_favorite_failed: 'Failed to remove from favorites',
            error_start_private_chat_failed: 'Failed to start private chat.',
            error_send_message_failed: 'Failed to send message',

            share_title_favorites: "Favorites",
            share_title_questions: "Questions",
            share_title_generic_file: "File",

            tooltip_choose_reaction: 'Choose another reaction',

            default_channel_name: "General",
            default_channel_desc: "The main channel for communication",

            error_pin_message_failed: "Failed to change message pin status.",
            error_create_question_failed: "Failed to create question(s).",
            error_clear_favorites_failed: "Failed to clear favorites.",
            error_copy_question_failed: "Failed to copy the question.",
            error_download_system_unavailable: "The download system is unavailable. Please reload the page and try again.",

            error_vote_favorite_failed: "Failed to vote in favorites.",
            error_save_channel_failed: "Failed to save changes.",
            error_remove_from_favorites_failed: "Failed to remove from favorites.",
            error_add_to_favorites_failed: "Failed to add to favorites.",

            error_delete_message_failed: 'Failed to delete message.',
            error_download_auth_required: 'You must be logged in to download from the chat.',
            sidebar_search_placeholder: 'Search channels...',
            auth_required_to_view: 'Login to view',
            ai_summary_modal_title: 'üí° AI Summary',

            reauth_wrong_password: "Incorrect password. Please try again.",
            results_modal_title: "Test Results",
            results_table_header_num: "#",
            results_table_header_user: "User",
            results_table_header_accuracy: "Accuracy",
            results_table_header_time: "Time",
            results_empty_state: "There are no results for this test yet."
        }
    };




    let currentChatLang = localStorage.getItem('chatLanguage') || 'ru';

    function _chat(key) {
        return LANG_PACK_CHAT[currentChatLang]?.[key] || key;
    }
/**
     * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –ø–µ—Ä–µ–≤–æ–¥–∞, –∑–∞–º–µ–Ω—è—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã —Ç–∏–ø–∞ {key} –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è.
     * @param {string} key - –ö–ª—é—á —Å—Ç—Ä–æ–∫–∏ –≤ —è–∑—ã–∫–æ–≤–æ–º –ø–∞–∫–µ—Ç–µ.
     * @param {object} replacements - –û–±—ä–µ–∫—Ç —Å –∑–∞–º–µ–Ω–∞–º–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä { channelName: 'VIP' }.
     * @returns {string} - –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞.
     */
    function _chatFormat(key, replacements) {
        let str = _chat(key);
        for (const placeholder in replacements) {
            str = str.replace(`{${placeholder}}`, replacements[placeholder]);
        }
        return str;
    }
    
    // Core variables
    let db = null;
    let auth = null;
    let currentUser = null;
    let allMessages = [];
    let openChatAfterAuth = false;
    let currentChannel = 'general';
    let currentChannelType = 'public'; // 'public' –∏–ª–∏ 'private'
    let currentTab = 'messages';
    let channels = [];
    let privateChats = []; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤
    let allUsers = new Map(); // –•—Ä–∞–Ω–∏—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    let onlineUsers = new Map(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º Map –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    let isInitialized = false;
    let unreadCounts = new Map();
    let replyContext = null;
    let presenceListener = null;
    let heartbeatInterval = null; // –î–ª—è "–ø—É–ª—å—Å–∞"
    let notificationsEnabled = true;
    let originalTitle = document.title;
    let unreadMessageCount = 0; 
    let isPinnedMode = false;
    let isAiSelectionMode = false;
    let isChatTranslateModeEnabled = false; // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞
    let chatTranslations = new Map(); // –ö—ç—à –¥–ª—è —É–∂–µ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

    let messagesListener = null; // C–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
    let pmUnreadListener = null; // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –õ–ò–ß–ù–´–• –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
    let publicUnreadListener = null; // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –ü–£–ë–õ–ò–ß–ù–´–• –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
    let listenerInitializationTime = null; // –í–†–ï–ú–Ø –ó–ê–ü–£–°–ö–ê –°–õ–£–®–ê–¢–ï–õ–Ø
    let questionsListener = null; // –°–õ–£–®–ê–¢–ï–õ–¨ –î–õ–Ø –í–û–ü–†–û–°–û–í

    let questionToHighlight = null;
    let favoritesListener = null;
    let unlockedChannels = new Set();
    const QUICK_REACTIONS_KEY = 'userQuickReactions';
    const DEFAULT_QUICK_REACTIONS = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üî•'];
    
    // DOM elements
    let chatOverlay = null;
    let chatModal = null;
    let currentUserEl = null;
    let chatInput = null;
    let messageArea = null;
    let channelsList = null;
    let privateChatsList = null; // –î–ª—è —Å–ø–∏—Å–∫–∞ –õ–°
    let onlineUsersList = null;
    let searchInput = null;
    let authOverlay = null;
    let tabButtons = {};
    let tabCounters = {};
    let chatSearchToggleBtn = null;
    let lastMessageObserver = null; 

    // Tabs configuration
    const TABS = {
        messages: { langKey: 'tab_messages', icon: 'üí¨', collection: 'messages' },
        questions: { langKey: 'tab_questions', icon: '‚ùì', collection: 'questions' },
        favorites: { langKey: 'tab_favorites', icon: '‚≠ê', collection: 'favorites' },
        users: { langKey: 'tab_users', icon: 'üë•' }
    };

    /**
     * –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø-–ü–û–ú–û–©–ù–ò–ö (–í–ù–£–¢–†–ò CHATMODULE)
     * –°–æ–∑–¥–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –∫—ç—à–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞, –∫–æ–º–±–∏–Ω–∏—Ä—É—è ID –∏ —è–∑—ã–∫.
     * @param {string} messageId - ID —Å–æ–æ–±—â–µ–Ω–∏—è.
     * @param {string} lang - –ö–æ–¥ —è–∑—ã–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'ru', 'en').
     * @returns {string} - –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'xyz-123_en').
     */
    function getChatCacheKey(messageId, lang) {
        return `${messageId}_${lang}`;
    }

    // --- –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ö–û–î–ê: –í—Å—Ç–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ —Å—é–¥–∞ ---
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    };

    function handleSearch(event) {
        const query = event.target.value.toLowerCase().trim();
        if (!query) {
            loadTabData(currentTab);
            return;
        }
        const items = messageArea.querySelectorAll('.message, .question-bubble, .favorite-item, .user-list-item');
        items.forEach(item => {
            const text = item.textContent.toLowerCase();
            if (text.includes(query)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }


  

    function init(firebaseDb, firebaseAuth) {
        try {
            db = firebaseDb;
            auth = firebaseAuth;
            
            // 1. –°–æ–∑–¥–∞–µ–º HTML
            createHybridChatHTML();
            
            // 2. –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç—ã
            initDOMElements();
            
            // 3. –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            setupEventListeners();
            
            // 4. –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–µ
            setupAuthStateListener();
            setupVisibilityListener();
            
            isInitialized = true;
            console.log('‚úÖ –ì–∏–±—Ä–∏–¥–Ω—ã–π —á–∞—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–∞—Ç–∞:', error);
            isInitialized = false;
        }
    }


    function createHybridChatHTML() {

        // –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ —á–∞—Ç–∞, –µ—Å–ª–∏ –æ–Ω–∏ –≤–¥—Ä—É–≥ –æ—Å—Ç–∞–ª–∏—Å—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        const oldChats = document.querySelectorAll('#chatOverlay, #advancedChatOverlay');
        oldChats.forEach(chat => chat.remove());
        
        // –í—Å—è HTML-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤ –æ–¥–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
        const chatHTML = `
        <!-- –°–ò–°–¢–ï–ú–ê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò -->
        <div id="authOverlay" class="auth-overlay hidden">
            <div class="auth-modal">
                <h2 style="margin-bottom: 20px; color: var(--primary);">${_chat('auth_title')}</h2>
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login">${_chat('auth_login_tab')}</button>
                    <button class="auth-tab" data-tab="register">${_chat('auth_register_tab')}</button>
                </div>           
                <form class="auth-form active" id="loginForm">
                    <input type="text" class="auth-input" id="loginUsername" placeholder="${_chat('auth_login_placeholder')}" required>
                    <div class="password-wrapper">
                        <input type="password" class="auth-input" id="loginPassword" placeholder="${_chat('auth_password_placeholder')}" required>
                        <span class="toggle-password">üëÅÔ∏è</span>
                    </div>
                    <a href="#" id="forgotPasswordLink" class="forgot-password-link">${_chat('auth_forgot_password')}</a>
                    <button type="submit" class="auth-btn">${_chat('auth_login_button')}</button>
                </form>
                <form class="auth-form" id="registerForm">
                    <input type="text" class="auth-input" id="registerUsername" placeholder="${_chat('auth_register_username_placeholder')}" required>
                    <input type="email" class="auth-input" id="registerEmail" placeholder="${_chat('auth_register_email_placeholder')}" required>
                    <div class="password-wrapper">
                        <input type="password" class="auth-input" id="registerPassword" placeholder="${_chat('auth_register_password_placeholder')}" required>
                        <span class="toggle-password">üëÅÔ∏è</span>
                    </div>
                    <div class="password-wrapper">
                        <input type="password" class="auth-input" id="registerPasswordConfirm" placeholder="${_chat('auth_register_confirm_placeholder')}" required>
                        <span class="toggle-password">üëÅÔ∏è</span>
                    </div>
                    <button type="submit" class="auth-btn">${_chat('auth_register_button')}</button>
                </form>

                <div style="text-align: center; margin: 20px 0; color: var(--secondary-text-color);">${_chat('auth_or_divider')}</div>
                
                <button id="googleSignInBtn" class="google-signin-btn">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon">
                    ${_chat('auth_google_signin')}
                </button>
                
                <button id="authCloseButton" onclick="ChatModule.closeAuthModal()" style="margin-top: 15px; background: none; border: none; color: var(--secondary-text-color); cursor: pointer;">
                    ${_chat('auth_close_button')}
                </button>
            </div>
        </div>

        <!-- –ì–ò–ë–†–ò–î–ù–´–ô –ß–ê–¢ (–ø–æ–ª–Ω—ã–π –∫–æ–¥, –∫–∞–∫ –∏ —Ä–∞–Ω–µ–µ) -->
        <div id="chatOverlay" class="advanced-chat-overlay hidden">
            <div class="advanced-chat-modal">
                <!-- Header -->
                <div class="advanced-chat-header">
                    <div class="chat-title">
                        <h3 id="chatHeaderTitle">${_chat('chat_header_title')}</h3>
                        <span id="unreadBadge" class="unread-badge hidden">0</span>
                    </div>
                    <button id="sidebarToggleBtn" class="sidebar-toggle-btn">‚ò∞</button>
                    <div class="header-controls">
                        <div class="user-menu-container">
                            <span id="currentUser">${_chat('guest_user')}</span>
                            <div id="userDropdown" class="user-dropdown hidden">
                                <a href="#" onclick="ChatModule.showProfileModal()">${_chat('edit_profile_link')}</a>
                                <a href="#" onclick="ChatModule.logout()">${_chat('logout_link')}</a>
                            </div>
                        </div>
                        <button id="notificationToggle" class="notification-toggle" title="${_chat('notifications_title')}">üîî</button>
                        <button onclick="ChatModule.closeChatModal()" class="close-btn">√ó</button>
                    </div>
                </div>
                
                <!-- Main layout -->
                <div class="advanced-chat-body">
                    <div id="sidebarContainer" class="sidebar-container">
                        <!-- Sidebar -->
                        <div class="chat-sidebar">
                            <div class="sidebar-section">
                                <h4>${_chat('sidebar_sections')}</h4>
                                <div id="chatTabsList" class="tabs-list">
                                    <div class="tab-item active" data-tab="messages"><span class="tab-icon">üí¨</span><span class="tab-name">${_chat('tab_messages')}</span><span class="tab-counter" id="messagesCount">0</span></div>
                                    <div class="tab-item" data-tab="questions"><span class="tab-icon">‚ùì</span><span class="tab-name">${_chat('tab_questions')}</span><span class="tab-counter" id="questionsCount">0</span></div>
                                    <div class="tab-item" data-tab="favorites"><span class="tab-icon">‚≠ê</span><span class="tab-name">${_chat('tab_favorites')}</span><span class="tab-counter" id="favoritesCount">0</span></div>
                                    <div class="tab-item" data-tab="users"><span class="tab-icon">üë•</span><span class="tab-name">${_chat('tab_users')}</span><span class="tab-counter" id="usersCount">0</span></div>
                                </div>
                            </div>
                            <div class="sidebar-section">
                                <h4>${_chat('sidebar_channels')}</h4>
                                <div class="sidebar-search-container"><input type="text" id="channelSearchInput" class="sidebar-search-input" placeholder="${_chat('sidebar_search_placeholder')}"></div>
                                <div id="channelsList" class="channels-list"></div>
                                <button id="createChannelBtn" class="create-btn">${_chat('sidebar_create_channel')}</button>
                            </div>
                            <div class="sidebar-section" id="privateChatsSection">
                                <h4>${_chat('sidebar_private_messages')}</h4>
                                <div id="privateChatsList" class="channels-list"></div>
                            </div>                            
                            <div class="sidebar-section">
                                <h4><span class="online-label">${_chat('sidebar_online')}</span> (<span id="onlineCount">0</span>)</h4>
                                <div id="onlineUsersList" class="online-users-list"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Main chat area -->
                    <div class="chat-main-content">
                        <div class="chat-top-bar">
                            <h4 id="currentChannelName" style="margin: 0; flex-grow: 1; text-align: left; color: var(--heading-color);">${_chat('channel_general')}</h4>
                            <button id="chatSearchToggleBtn" class="chat-search-toggle">üîç</button>
                            <input type="text" id="chatSearchInput" placeholder="${_chat('search_placeholder')}" />
                            <!-- –ö–Ω–æ–ø–∫–∞ "–ó–∞–∫—Ä–µ–ø–∏—Ç—å" –ü–û–õ–ù–û–°–¢–¨–Æ –£–î–ê–õ–ï–ù–ê –û–¢–°–Æ–î–ê -->
                        </div>
                        <div id="aiSelectionBanner" class="ai-selection-banner hidden">
                            <span>${_chat('ai_selection_banner_text')}</span>
                            <button id="cancelAiSelectionBtn" class="btn-secondary-small">${_chat('ai_selection_cancel')}</button>
                        </div>
                        <div id="tabActionsContainer" class="tab-actions-container hidden"></div>
                        <div id="messageArea" class="message-area"><div class="empty-state">${_chat('loading_messages')}</div></div>
                        <div class="chat-input-area">
                            <div id="replyingToPanel" class="replying-to-panel hidden">
                                <div class="reply-info"><span>${_chat('reply_panel_title')}</span><p id="replyingToText"></p></div>
                                <button onclick="ChatModule.cancelReply()" class="cancel-reply-btn">√ó</button>
                            </div>


                            <div class="input-actions-top">
                                <button id="emojiBtn" class="input-action-btn" title="${_chat('emoji_button_title')}">üòä</button>
                                <button id="questionBtn" class="input-action-btn" title="${_chat('create_question_button_title')}">‚ùì</button>
                                <button id="uploadFileBtn" class="input-action-btn" title="${_chat('attach_file_button_title')}">üìé</button>
                                <button id="togglePinnedBtn" class="input-action-btn" title="${_chat('pinned_toggle_title')}">üìå</button>
                                <button id="chatTranslateBtn" class="input-action-btn" title="–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ —á–∞—Ç">‡§Ö|–∞</button>
                                <div class="ai-helper-container">
                                    <button id="aiChatHelperBtn" class="input-action-btn" title="${_chat('ai_helper_title')}">ü§ñ</button>
                                    <div id="aiChatHelperMenu" class="ai-helper-menu hidden">



                                        <a href="#" data-action="summarize-from-selection">${_chat('ai_summarize_from_selection')}</a>
                                        <a href="#" data-action="summarize-all">${_chat('ai_summarize_all')}</a>
                                    </div>
                                </div>
                            </div>
                            <input type="file" id="chatFileInput" class="hidden" accept=".qst,.txt">
                            <div class="input-wrapper">
                                <textarea id="chatInput" placeholder="${_chat('chat_input_placeholder')}"></textarea>
                                <button id="sendBtn" class="advanced-send-btn">‚û§</button>
                            </div>
                        </div>    
                    </div>
                </div>
            </div>
        </div>

        <!-- MODALS -->
        <div id="userActionsModal" class="modal-overlay hidden"><div class="modal-content"><h3 id="userActionsModalTitle">${_chat('user_actions_title')}</h3><p id="userActionsModalText" style="margin-bottom: 25px;">${_chat('user_actions_text')}</p><div class="modal-buttons vertical"><button id="userActionsChatBtn">${_chat('user_actions_chat_button')}</button><button id="userActionsEmailBtn">${_chat('user_actions_email_button')}</button><button onclick="ChatModule.closeModal('userActionsModal')" style="background-color: var(--button-secondary-bg); color: var(--button-secondary-text);">${_chat('modal_cancel_button')}</button></div></div></div>
        <div id="channelEditModal" class="modal-overlay hidden"><div class="modal-content"><h3>${_chat('channel_settings_title')}</h3><input type="hidden" id="editChannelId"><input type="text" id="editChannelNameInput" placeholder="${_chat('channel_edit_name_placeholder')}" required /><input type="password" id="editChannelPasswordInput" placeholder="${_chat('channel_edit_password_placeholder')}" /><textarea id="editChannelDescInput" placeholder="${_chat('channel_edit_desc_placeholder')}"></textarea><div id="channelMembersSection" class="channel-members-section hidden"><h4>${_chat('channel_members_title')}</h4><ul id="channelMembersList" class="channel-members-list"><li>${_chat('channel_members_loading')}</li></ul></div><div class="modal-buttons"><button onclick="ChatModule.saveChannelEdit()">${_chat('modal_save_button')}</button><button onclick="ChatModule.closeModal('channelEditModal')">${_chat('modal_cancel_button')}</button></div><button id="deleteChannelBtn" class="delete-btn" onclick="ChatModule.deleteChannel()" style="margin-top: 15px;">${_chat('delete_channel_button')}</button></div></div>
        <div id="channelCreateModal" class="modal-overlay hidden"><div class="modal-content"><h3>${_chat('create_channel_title')}</h3><input type="text" id="channelNameInput" placeholder="${_chat('channel_create_name_placeholder')}" required /><input type="password" id="channelPasswordInput" placeholder="${_chat('channel_create_password_placeholder')}" /><textarea id="channelDescInput" placeholder="${_chat('channel_create_desc_placeholder')}"></textarea><div class="settings-group" style="text-align: left; margin-top: 15px;"><input type="checkbox" id="channelIsForTesting"><label for="channelIsForTesting" data-lang-key="testing_channel_option">${_chat('testing_channel_option')}</label></div><div class="modal-buttons"><button onclick="ChatModule.createChannel()">${_chat('modal_create_button')}</button><button onclick="ChatModule.closeModal('channelCreateModal')">${_chat('modal_cancel_button')}</button></div></div></div>
        <div id="questionCreateModal" class="modal-overlay hidden"><div class="modal-content"><h3>${_chat('create_question_title')}</h3><textarea id="questionTextInput" placeholder="${_chat('create_question_placeholder')}" rows="4"></textarea><div class="modal-buttons"><button onclick="ChatModule.createQuestion()">${_chat('create_question_modal_button')}</button><button onclick="ChatModule.closeModal('questionCreateModal')">${_chat('modal_cancel_button')}</button></div></div></div>
        <div id="editMessageModal" class="modal-overlay hidden"><div class="modal-content"><h3>${_chat('edit_message_title')}</h3><textarea id="editMessageInput" rows="4"></textarea><input type="hidden" id="editMessageIdInput"><div class="modal-buttons"><button onclick="ChatModule.saveMessageEdit()">${_chat('modal_save_button')}</button><button onclick="ChatModule.closeModal('editMessageModal')">${_chat('modal_cancel_button')}</button></div></div></div>
        <div id="profileEditModal" class="modal-overlay hidden"><div class="modal-content"><h3>${_chat('edit_profile_title')}</h3><input type="text" id="profileDisplayName" placeholder="${_chat('edit_profile_name_placeholder')}" /><input type="email" id="profileEmail" placeholder="Email" readonly /><input type="password" id="profileNewPassword" placeholder="${_chat('edit_profile_new_password_placeholder')}" /><div class="modal-buttons"><button onclick="ChatModule.saveProfile()">${_chat('modal_save_button')}</button><button onclick="ChatModule.closeModal('profileEditModal')">${_chat('modal_cancel_button')}</button></div><button id="deleteAccountBtn" class="delete-btn" onclick="ChatModule.deleteAccount()" style="margin-top: 15px;">${_chat('delete_account_button')}</button></div></div>
        <div id="fileActionsModal" class="modal-overlay hidden"><div class="modal-content"><h3 id="fileActionsModalTitle">${_chat('file_actions_title')}</h3><p id="fileActionsModalText" style="margin-bottom: 25px;">${_chat('user_actions_text')}</p><div class="modal-buttons vertical"><button id="fileActionDownloadBtn">${_chat('file_actions_download')}</button><button id="fileActionTestBtn">${_chat('file_actions_test')}</button><button onclick="ChatModule.closeModal('fileActionsModal')" style="background-color: var(--button-secondary-bg); color: var(--button-secondary-text);">${_chat('modal_cancel_button')}</button></div></div></div>

        <div id="aiSummaryModal" class="modal-overlay hidden">
            <div class="modal-content" style="max-width: 600px; text-align: left;">
                <h3 id="aiSummaryModalTitle">${_chat('ai_summary_modal_title')}</h3>
                <div id="aiSummaryOutput" style="max-height: 60vh; overflow-y: auto; line-height: 1.6;">
                    <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å—Å—è —Å–≤–æ–¥–∫–∞ –∏–ª–∏ —Å–ø–∏–Ω–Ω–µ—Ä -->
                </div>
                <div class="modal-buttons" style="margin-top: 20px;">
                    <button onclick="ChatModule.closeModal('aiSummaryModal')" data-lang-key="auth_close_button">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>

        <div id="forgotPasswordModal" class="modal-overlay hidden">  <!-- <== –¢–ï–ü–ï–†–¨ –≠–¢–û–¢ –ë–õ–û–ö –ù–ê–•–û–î–ò–¢–°–Ø –ù–ê –ü–†–ê–í–ò–õ–¨–ù–û–ú –£–†–û–í–ù–ï -->
            <div class="modal-content">
                <h3 data-lang-key="forgot_password_modal_title">${_chat('forgot_password_modal_title')}</h3>
                <p style="margin-bottom: 20px;" data-lang-key="forgot_password_modal_text">${_chat('forgot_password_modal_text')}</p>
                <input type="email" id="resetEmailInput" class="auth-input" placeholder="${_chat('forgot_password_email_placeholder')}" required />
                <div class="modal-buttons">
                    <button onclick="ChatModule.handlePasswordReset()" data-lang-key="forgot_password_send_button">${_chat('forgot_password_send_button')}</button>
                    <button onclick="ChatModule.closeModal('forgotPasswordModal')" data-lang-key="modal_cancel_button">${_chat('modal_cancel_button')}</button>
                </div>
            </div>
        </div>
        `;

        document.body.insertAdjacentHTML('beforeend', chatHTML);
    }

 
    async function signInWithGoogle() {
        if (!auth) {
            showError('–°–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞');
            return;
        }

        const provider = new firebase.auth.GoogleAuthProvider();

        try {
            const result = await auth.signInWithPopup(provider);
            const user = result.user;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–æ–≤—ã–π –ª–∏ —ç—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            if (result.additionalUserInfo.isNewUser) {
                console.log('–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Google, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firestore:', user.displayName);
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–æ–≤—ã–π, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ –≤ –Ω–∞—à–µ–π –±–∞–∑–µ
                await db.collection('users').doc(user.uid).set({
                    username: user.displayName,
                    email: user.email,
                    uid: user.uid,
                    privateChatPartners: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            ChatModule.closeAuthModal();
            if (openChatAfterAuth) {
                openChatAfterAuth = false;
                ChatModule.openChatModal();
            }

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google:', error);
            showError(getErrorMessage(error.code));
        }
    }



    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —á–∞—Ç–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —è–∑—ã–∫–æ–º.
     * –ù–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç DOM, –∞ —Ç–æ–ª—å–∫–æ –º–µ–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç.
     */
    function updateChatUIText() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ DOM —á–∞—Ç–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫
        if (!document.getElementById('authOverlay')) return;

        // --- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ---
        document.querySelector('#authOverlay h2').textContent = _chat('auth_title');
        document.querySelector('.auth-tab[data-tab="login"]').textContent = _chat('auth_login_tab');
        document.querySelector('.auth-tab[data-tab="register"]').textContent = _chat('auth_register_tab');
        document.getElementById('loginUsername').placeholder = _chat('auth_login_placeholder');
        document.getElementById('loginPassword').placeholder = _chat('auth_password_placeholder');
        document.querySelector('#loginForm button').textContent = _chat('auth_login_button');
        document.getElementById('registerUsername').placeholder = _chat('auth_register_username_placeholder');
        document.getElementById('registerEmail').placeholder = _chat('auth_register_email_placeholder');
        document.getElementById('registerPassword').placeholder = _chat('auth_register_password_placeholder');
        document.getElementById('registerPasswordConfirm').placeholder = _chat('auth_register_confirm_placeholder');
        document.querySelector('#registerForm button').textContent = _chat('auth_register_button');
        const forgotLink = getEl('forgotPasswordLink');
        if (forgotLink) forgotLink.textContent = _chat('auth_forgot_password');
        
        const forgotModal = getEl('forgotPasswordModal');
        if (forgotModal) {
            forgotModal.querySelector('[data-lang-key="forgot_password_modal_title"]').textContent = _chat('forgot_password_modal_title');
            forgotModal.querySelector('[data-lang-key="forgot_password_modal_text"]').textContent = _chat('forgot_password_modal_text');
            forgotModal.querySelector('#resetEmailInput').placeholder = _chat('forgot_password_email_placeholder');
            forgotModal.querySelector('[data-lang-key="forgot_password_send_button"]').textContent = _chat('forgot_password_send_button');
            forgotModal.querySelector('[data-lang-key="modal_cancel_button"]').textContent = _chat('modal_cancel_button');
        }


        const googleBtn = document.getElementById('googleSignInBtn');
        if (googleBtn) {
            googleBtn.innerHTML = `
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon">
                ${_chat('auth_google_signin')}
            `;
        }

        document.getElementById('authCloseButton').textContent = _chat('auth_close_button');

        // --- –û—Å–Ω–æ–≤–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ ---
        // –®–∞–ø–∫–∞
        document.getElementById('chatHeaderTitle').textContent = _chat(TABS[currentTab].langKey);
        document.querySelector('#userDropdown a[onclick*="showProfileModal"]').textContent = _chat('edit_profile_link');
        document.querySelector('#userDropdown a[onclick*="logout"]').textContent = _chat('logout_link');
        document.getElementById('notificationToggle').title = _chat('notifications_title');
        
        // –°–∞–π–¥–±–∞—Ä
        document.querySelector('.sidebar-section:nth-of-type(1) h4').textContent = _chat('sidebar_sections');
        document.querySelector('.tab-item[data-tab="messages"] .tab-name').textContent = _chat('tab_messages');
        document.querySelector('.tab-item[data-tab="questions"] .tab-name').textContent = _chat('tab_questions');
        document.querySelector('.tab-item[data-tab="favorites"] .tab-name').textContent = _chat('tab_favorites');
        document.querySelector('.tab-item[data-tab="users"] .tab-name').textContent = _chat('tab_users');
        document.querySelector('.sidebar-section:nth-of-type(2) h4').textContent = _chat('sidebar_channels');
        document.getElementById('createChannelBtn').textContent = _chat('sidebar_create_channel');
        document.getElementById('privateChatsSection').querySelector('h4').textContent = _chat('sidebar_private_messages');
        document.querySelector('.online-label').textContent = _chat('sidebar_online');
        
        // –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å
        document.getElementById('chatSearchInput').placeholder = _chat('search_placeholder');
        document.getElementById('togglePinnedBtn').title = isPinnedMode ? _chat('pinned_mode_on_title') : _chat('pinned_mode_off_title');
        document.querySelector('#replyingToPanel span').textContent = _chat('reply_panel_title');
        document.getElementById('emojiBtn').title = _chat('emoji_button_title');
        document.getElementById('questionBtn').title = _chat('create_question_button_title');
        document.getElementById('uploadFileBtn').title = _chat('attach_file_button_title');
        document.getElementById('chatInput').placeholder = _chat('chat_input_placeholder');

        // --- –î—Ä—É–≥–∏–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ ---
        document.querySelector('#userActionsModal h3').textContent = _chat('user_actions_title');
        document.querySelector('#userActionsModal p').textContent = _chat('user_actions_text');
        document.querySelector('#userActionsChatBtn').textContent = _chat('user_actions_chat_button');
        document.querySelector('#userActionsEmailBtn').textContent = _chat('user_actions_email_button');
        document.querySelector('#userActionsModal button[onclick*="closeModal"]').textContent = _chat('modal_cancel_button');

        document.querySelector('#channelEditModal h3').textContent = _chat('channel_settings_title');
        document.getElementById('editChannelNameInput').placeholder = _chat('channel_edit_name_placeholder');
        document.getElementById('editChannelPasswordInput').placeholder = _chat('channel_edit_password_placeholder');
        document.getElementById('editChannelDescInput').placeholder = _chat('channel_edit_desc_placeholder');
        document.querySelector('#channelMembersSection h4').textContent = _chat('channel_members_title');
        document.querySelector('#channelEditModal button[onclick*="saveChannelEdit"]').textContent = _chat('modal_save_button');
        document.querySelector('#channelEditModal button[onclick*="closeModal"]').textContent = _chat('modal_cancel_button');
        document.getElementById('deleteChannelBtn').textContent = _chat('delete_channel_button');
        
        document.querySelector('#channelCreateModal h3').textContent = _chat('create_channel_title');
        document.getElementById('channelNameInput').placeholder = _chat('channel_create_name_placeholder');
        document.getElementById('channelPasswordInput').placeholder = _chat('channel_create_password_placeholder');
        document.getElementById('channelDescInput').placeholder = _chat('channel_create_desc_placeholder');
        document.querySelector('#channelCreateModal button[onclick*="createChannel"]').textContent = _chat('modal_create_button');
        document.querySelector('#channelCreateModal button[onclick*="closeModal"]').textContent = _chat('modal_cancel_button');

        document.querySelector('#questionCreateModal h3').textContent = _chat('create_question_title');
        document.getElementById('questionTextInput').placeholder = _chat('create_question_placeholder');
        document.querySelector('#questionCreateModal button[onclick*="createQuestion"]').textContent = _chat('create_question_modal_button');
        document.querySelector('#questionCreateModal button[onclick*="closeModal"]').textContent = _chat('modal_cancel_button');

        document.querySelector('#editMessageModal h3').textContent = _chat('edit_message_title');
        document.querySelector('#editMessageModal button[onclick*="saveMessageEdit"]').textContent = _chat('modal_save_button');
        document.querySelector('#editMessageModal button[onclick*="closeModal"]').textContent = _chat('modal_cancel_button');

        document.querySelector('#profileEditModal h3').textContent = _chat('edit_profile_title');
        document.getElementById('profileDisplayName').placeholder = _chat('edit_profile_name_placeholder');
        document.getElementById('profileNewPassword').placeholder = _chat('edit_profile_new_password_placeholder');
        document.querySelector('#profileEditModal button[onclick*="saveProfile"]').textContent = _chat('modal_save_button');
        document.querySelector('#profileEditModal button[onclick*="closeModal"]').textContent = _chat('modal_cancel_button');
        document.getElementById('deleteAccountBtn').textContent = _chat('delete_account_button');

        document.querySelector('#fileActionsModal h3').textContent = _chat('file_actions_title');
        document.querySelector('#fileActionsModal p').textContent = _chat('user_actions_text');
        document.getElementById('fileActionDownloadBtn').textContent = _chat('file_actions_download');
        document.getElementById('fileActionTestBtn').textContent = _chat('file_actions_test');
        document.querySelector('#fileActionsModal button[onclick*="closeModal"]').textContent = _chat('modal_cancel_button');

        // –ü–µ—Ä–µ–≤–æ–¥ –æ–ø—Ü–∏–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞
        const testingChannelLabel = document.querySelector('label[for="channelIsForTesting"]');
        if (testingChannelLabel) {
            testingChannelLabel.textContent = _chat('testing_channel_option');
        }

        // –ü–µ—Ä–µ–≤–æ–¥ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        const resultsModal = document.getElementById('testResultsModal');
        if (resultsModal) {
            const title = resultsModal.querySelector('#testResultsModalTitle');
            const closeButton = resultsModal.querySelector('button[onclick*="closeModal"]');
            
            if (title) title.textContent = _chat('results_modal_title');
            if (closeButton) closeButton.textContent = _chat('auth_close_button');
        }

        const aiModal = document.getElementById('aiExplanationModal');
        if (aiModal) {
            // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É "–ó–∞–∫—Ä—ã—Ç—å" –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞.
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—å –¥—Ä—É–≥–∏–µ –∫–Ω–æ–ø–∫–∏.
            const closeButton = aiModal.querySelector('button[data-lang-key="auth_close_button"]');
            if (closeButton) {
                closeButton.textContent = _chat('auth_close_button');
            }
        }


        // –ü–µ—Ä–µ–≤–æ–¥ AI-–ø–æ–º–æ—â–Ω–∏–∫–∞ –∏ –µ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ ===
        const aiHelperBtn = getEl('aiChatHelperBtn');
        if (aiHelperBtn) {
            aiHelperBtn.title = _chat('ai_helper_title');
        }

        const aiHelperMenu = getEl('aiChatHelperMenu');
        if (aiHelperMenu) {
            const summarizeSelectionLink = aiHelperMenu.querySelector('[data-action="summarize-from-selection"]');
            if (summarizeSelectionLink) summarizeSelectionLink.textContent = _chat('ai_summarize_from_selection');

            const summarizeAllLink = aiHelperMenu.querySelector('[data-action="summarize-all"]');
            if (summarizeAllLink) summarizeAllLink.textContent = _chat('ai_summarize_all');
        }
        
        const aiSelectionBanner = getEl('aiSelectionBanner');
        if (aiSelectionBanner) {
            const bannerText = aiSelectionBanner.querySelector('span');
            if (bannerText) bannerText.textContent = _chat('ai_selection_banner_text');
            
            const cancelBtn = aiSelectionBanner.querySelector('#cancelAiSelectionBtn');
            if (cancelBtn) cancelBtn.textContent = _chat('ai_selection_cancel');
        }

        
        
        const aiSummaryModal = getEl('aiSummaryModal');
        if (aiSummaryModal) {
            const closeBtn = aiSummaryModal.querySelector('button[onclick*="closeModal"]');
            if (closeBtn) closeBtn.textContent = _chat('auth_close_button');
        }
        
        // =======================
        // –ù–û–í–´–ô –ö–û–î (–î–û–ë–ê–í–ò–¢–¨)
        // =======================
        // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞ "# –û–±—â–∏–π"
        const currentChannelNameEl = getEl('currentChannelName');
        if (currentChannelNameEl && currentChannel === 'general') {
            // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –∫–∞–Ω–∞–ª - "general", –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫
            // –∏–∑ —è–∑—ã–∫–æ–≤–æ–≥–æ –ø–∞–∫–µ—Ç–∞. –î–ª—è –¥—Ä—É–≥–∏—Ö –∫–∞–Ω–∞–ª–æ–≤ –º—ã —ç—Ç–æ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º,
            // —Ç–∞–∫ –∫–∞–∫ –∏—Ö –Ω–∞–∑–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å—Å—è.
            currentChannelNameEl.textContent = _chat('channel_general');
        }
        // =======================
        // –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ö–û–î–ê
        // =======================

    }




    function initDOMElements() {
        chatOverlay = document.getElementById('chatOverlay');
        authOverlay = document.getElementById('authOverlay');
        currentUserEl = document.getElementById('currentUser');
        chatInput = document.getElementById('chatInput');
        messageArea = document.getElementById('messageArea');
        channelsList = document.getElementById('channelsList');
        privateChatsList = document.getElementById('privateChatsList');
        onlineUsersList = document.getElementById('onlineUsersList');
        searchInput = document.getElementById('chatSearchInput');
        Object.keys(TABS).forEach(tabId => {
            tabButtons[tabId] = document.querySelector(`[data-tab="${tabId}"]`);
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –≤–∫–ª–∞–¥–∫–∞ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π —Å–≤–æ–π —Å—á–µ—Ç—á–∏–∫
            if(tabId !== 'users') {
                 tabCounters[tabId] = document.getElementById(`${tabId}Count`);
            }
        });
        // –ü–†–ê–í–ò–õ–¨–ù–û –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        tabCounters['users'] = document.getElementById('usersCount'); // –°—á–µ—Ç—á–∏–∫ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
        tabCounters['online'] = document.getElementById('onlineCount'); // –°—á–µ—Ç—á–∏–∫ –¥–ª—è —Å–µ–∫—Ü–∏–∏ "–û–Ω–ª–∞–π–Ω"
        chatSearchToggleBtn = document.getElementById('chatSearchToggleBtn');
        console.log('DOM —ç–ª–µ–º–µ–Ω—Ç—ã –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ —á–∞—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
    }


    /**
     * –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –±—ã—Å—Ç—Ä—ã—Ö —Ä–µ–∞–∫—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage.
     * –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –Ω–∞–±–æ—Ä.
     * @returns {string[]} –ú–∞—Å—Å–∏–≤ —ç–º–æ–¥–∑–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ä–µ–∞–∫—Ü–∏–∏.
     */
    function getQuickReactions() {
        try {
            const storedReactions = localStorage.getItem(QUICK_REACTIONS_KEY);
            if (storedReactions) {
                const parsed = JSON.parse(storedReactions);
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫
                if (Array.isArray(parsed) && parsed.every(item => typeof item === 'string')) {
                    return parsed;
                }
            }
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –±—ã—Å—Ç—Ä—ã—Ö —Ä–µ–∞–∫—Ü–∏–π –∏–∑ localStorage:", e);
        }
        // –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞–±–æ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        return [...DEFAULT_QUICK_REACTIONS];
    }


    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ –±—ã—Å—Ç—Ä—ã—Ö —Ä–µ–∞–∫—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     * –ù–æ–≤—ã–π —ç–º–æ–¥–∑–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –Ω–∞—á–∞–ª–æ, —Å—Ç–∞—Ä—ã–π (–µ—Å–ª–∏ –±—ã–ª) —É–¥–∞–ª—è–µ—Ç—Å—è, 
     * –∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —É–¥–∞–ª—è–µ—Ç—Å—è, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–ª–∏–Ω—É.
     * @param {string} newEmoji - –ù–æ–≤—ã–π —ç–º–æ–¥–∑–∏, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å.
     */
    function updateQuickReactions(newEmoji) {
        let currentReactions = getQuickReactions();
        
        // 1. –£–±–∏—Ä–∞–µ–º —ç—Ç–æ—Ç —ç–º–æ–¥–∑–∏ –∏–∑ —Å–ø–∏—Å–∫–∞, –µ—Å–ª–∏ –æ–Ω —Ç–∞–º —É–∂–µ –±—ã–ª, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–µ–π
        let updatedReactions = currentReactions.filter(e => e !== newEmoji);

        // 2. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —ç–º–æ–¥–∑–∏ –≤ —Å–∞–º–æ–µ –Ω–∞—á–∞–ª–æ
        updatedReactions.unshift(newEmoji);

        // 3. –û–±—Ä–µ–∑–∞–µ–º –º–∞—Å—Å–∏–≤ –¥–æ 6 —ç–ª–µ–º–µ–Ω—Ç–æ–≤, —É–¥–∞–ª—è—è –ø–æ—Å–ª–µ–¥–Ω–∏–π
        const finalReactions = updatedReactions.slice(0, 6);

        // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ localStorage
        localStorage.setItem(QUICK_REACTIONS_KEY, JSON.stringify(finalReactions));
    }



    
    function setupEventListeners() {


        // Tab switching
        document.querySelectorAll('.tab-item').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const tabId = e.currentTarget.dataset.tab;
                if (tabId && TABS[tabId]) switchTab(tabId);
            });
        });

        document.getElementById('togglePinnedBtn')?.addEventListener('click', togglePinnedModeView);
        
        // Auth tabs
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.addEventListener('click', (e) => switchAuthTab(e.target.dataset.tab));
        });
        
        document.getElementById('loginForm')?.addEventListener('submit', handleLogin);
        document.getElementById('registerForm')?.addEventListener('submit', handleRegister);
        document.getElementById('googleSignInBtn')?.addEventListener('click', signInWithGoogle);
        document.getElementById('forgotPasswordLink')?.addEventListener('click', (e) => {
            e.preventDefault(); // –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏
            showModal('forgotPasswordModal');
        });


        if (chatInput) {
            chatInput.addEventListener('keydown', (e) => {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ Ctrl+Enter
                if (e.key === 'Enter' && e.ctrlKey) {
                    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏
                    e.preventDefault(); 
                    // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏
                    sendMessage();
                }
                // –ï—Å–ª–∏ –Ω–∞–∂–∞—Ç –ø—Ä–æ—Å—Ç–æ Enter (–±–µ–∑ Ctrl), —Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º,
                // –ø–æ–∑–≤–æ–ª—è—è –±—Ä–∞—É–∑–µ—Ä—É –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É.
            });
            chatInput.addEventListener('input', () => {
                chatInput.style.height = 'auto'; 
                chatInput.style.height = `${Math.min(chatInput.scrollHeight, 150)}px`; 
            });
        }
        
        document.getElementById('sendBtn')?.addEventListener('click', sendMessage);
        document.getElementById('notificationToggle')?.addEventListener('click', toggleNotifications);
        document.getElementById('emojiBtn')?.addEventListener('click', function() { showEmojiPicker(this) });
        document.getElementById('questionBtn')?.addEventListener('click', () => showModal('questionCreateModal'));
        document.getElementById('createChannelBtn')?.addEventListener('click', () => showModal('channelCreateModal'));
        // –í–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ setupEventListeners() –≤ ChatModule
        document.getElementById('uploadFileBtn')?.addEventListener('click', handleChatFileUploadTrigger);
        document.getElementById('chatFileInput')?.addEventListener('change', handleChatFileSelected);


        // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
        document.body.addEventListener('click', function(event) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –∫–ª–∏–∫ –∏–º–µ–Ω–Ω–æ –ø–æ –Ω–∞—à–µ–π –∏–∫–æ–Ω–∫–µ
            if (event.target.classList.contains('toggle-password')) {
                const icon = event.target;
                // –ù–∞—Ö–æ–¥–∏–º —Å–æ—Å–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç - –Ω–∞—à–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                const passwordInput = icon.previousElementSibling;

                if (passwordInput && passwordInput.type === 'password') {
                    // –ï—Å–ª–∏ –ø–æ–ª–µ —Å–∫—Ä—ã—Ç–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
                    passwordInput.type = 'text';
                    icon.textContent = 'üôà'; // –ú–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É –Ω–∞ "–æ—Ç–∫—Ä—ã—Ç—ã–π –≥–ª–∞–∑"
                } else if (passwordInput && passwordInput.type === 'text') {
                    // –ï—Å–ª–∏ –ø–æ–ª–µ –≤–∏–¥–Ω–æ - —Å–∫—Ä—ã–≤–∞–µ–º
                    passwordInput.type = 'password';
                    icon.textContent = 'üëÅÔ∏è'; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–∫–æ–Ω–∫—É "–∑–∞–∫—Ä—ã—Ç–æ–≥–æ –≥–ª–∞–∑–∞"
                }
            }
        });


        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–û—Ç–º–µ–Ω–∞" –Ω–∞ –ø–ª–∞—à–∫–µ
        getEl('cancelAiSelectionBtn')?.addEventListener('click', cancelAiSummarySelection);

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–ª–∏–∫–∞ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—é –≤ —Ä–µ–∂–∏–º–µ –≤—ã–±–æ—Ä–∞
        messageArea.addEventListener('click', handleAiMessageSelection);
        getEl('chatTranslateBtn')?.addEventListener('click', toggleChatTranslation);

        const aiHelperBtn = getEl('aiChatHelperBtn');
        const aiHelperMenu = getEl('aiChatHelperMenu');

        if (aiHelperBtn && aiHelperMenu) {
            aiHelperBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                aiHelperMenu.classList.toggle('hidden');
            });

            aiHelperMenu.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target.closest('a');
                if (target && target.dataset.action) {
                    const action = target.dataset.action;
                    aiHelperMenu.classList.add('hidden');
                    
                    if (action === 'summarize-from-selection') {
                        startAiSummarySelection(); // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–∂–∏–º –≤—ã–±–æ—Ä–∞
                    } else if (action === 'summarize-all') {
                        getAIChatSummary(action);  // –í—ã–∑—ã–≤–∞–µ–º —Å–≤–æ–¥–∫—É –ø–æ –≤—Å–µ–º
                    }
                }
            });

            // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ –ª—é–±–æ–º –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ
            window.addEventListener('click', () => {
                if (!aiHelperMenu.classList.contains('hidden')) {
                    aiHelperMenu.classList.add('hidden');
                }
            });


        // –ù–û–í–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–õ–Ø –í–°–ï–• –î–ï–ô–°–¢–í–ò–ô –í–ù–£–¢–†–ò –°–û–û–ë–©–ï–ù–ò–ô
        messageArea.addEventListener('click', (event) => {
            const target = event.target;
            const actionTarget = target.closest('[data-action]');
            if (!actionTarget) return;

            const action = actionTarget.dataset.action;
            const messageEl = actionTarget.closest('.message');
            if (!messageEl && !action.includes('question')) return; // –î–ª—è —Å—Å—ã–ª–æ–∫ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã messageEl –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å

            const messageId = messageEl?.id.replace('message-', '');
            const messageText = messageEl?.dataset.rawText || '';
            const authorName = messageEl?.querySelector('.author')?.textContent || _chat('anonymous_user');

            switch (action) {
                case 'reply':
                    startReply(messageId, authorName, messageText);
                    break;
                case 'show-reaction-picker':
                    showReactionPicker(messageId, actionTarget);
                    break;
                case 'toggle-pin':
                    togglePinMessage(messageId);
                    break;
                case 'edit':
                    startEditMessage(messageId, messageText);
                    break;
                case 'delete':
                    deleteMessage(messageId);
                    break;
                case 'toggle-reaction':
                    toggleReaction(messageId, actionTarget.dataset.emoji);
                    break;
                case 'scroll-to':
                    scrollToMessage(actionTarget.dataset.messageId);
                    break;
                case 'navigate-to-question':
                    navigateToQuestion(actionTarget.dataset.questionId, actionTarget.dataset.messageId);
                    break;
                case 'show-file-actions':
                    const isTesting = actionTarget.dataset.isTesting === 'true';
                    showFileActionsModal(actionTarget.dataset.fileId, actionTarget.dataset.fileName, isTesting);
                    break;
                case 'show-results':
                    showTestResults(actionTarget.dataset.fileId, actionTarget.dataset.channelId);
                    break;
            }
        });




        }




        const debouncedSearch = debounce(handleSearch, 300);
        if (searchInput) searchInput.addEventListener('input', debouncedSearch);

        

        const currentUserBtn = document.getElementById('currentUser');
        const userDropdown = document.getElementById('userDropdown');

        if (currentUserBtn && userDropdown) {
            currentUserBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                userDropdown.classList.toggle('hidden');
            });
            window.addEventListener('click', () => {
                if (!userDropdown.classList.contains('hidden')) userDropdown.classList.add('hidden');
            });
            userDropdown.addEventListener('click', (event) => event.stopPropagation());
        }

        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const sidebarContainer = document.getElementById('sidebarContainer');
        if (sidebarToggleBtn && sidebarContainer) {
            sidebarToggleBtn.addEventListener('click', () => sidebarContainer.classList.toggle('open'));
            sidebarContainer.addEventListener('click', (e) => {
                if (e.target === sidebarContainer) {
                    sidebarContainer.classList.remove('open');
                }
            });
            document.querySelector('.chat-sidebar').addEventListener('click', (e) => {
                 if (e.target.closest('.tab-item') || e.target.closest('.channel-item')) {
                    sidebarContainer.classList.remove('open');
                }
            });
        }
       
        console.log('Event listeners –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');

    // === –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ö–û–î–ê: –õ–û–ì–ò–ö–ê –ú–û–ë–ò–õ–¨–ù–û–ì–û –ü–û–ò–°–ö–ê ===

        // –ö–ª–∏–∫ –ø–æ –∏–∫–æ–Ω–∫–µ "–ª—É–ø—ã" –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
        if (chatSearchToggleBtn) {
            chatSearchToggleBtn.addEventListener('click', () => {
                const topBar = chatSearchToggleBtn.closest('.chat-top-bar');
                if (topBar) {
                    topBar.classList.add('search-active');
                    // –°—Ä–∞–∑—É —Å—Ç–∞–≤–∏–º —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
                    searchInput.focus();
                }
            });
        }

        // –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–±–∏—Ä–∞–µ—Ç —Ñ–æ–∫—É—Å —Å –ø–æ–ª—è –≤–≤–æ–¥–∞ (–∫–ª–∏–∫–∞–µ—Ç –≤ –¥—Ä—É–≥–æ–µ –º–µ—Å—Ç–æ)
        if (searchInput) {
            searchInput.addEventListener('blur', () => {
                const topBar = searchInput.closest('.chat-top-bar');
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ. –ï—Å–ª–∏ –µ—Å—Ç—å, –Ω–µ —Å–∫—Ä—ã–≤–∞–µ–º.
                if (topBar && searchInput.value.trim() === '') {
                    topBar.classList.remove('search-active');
                }
            });
        }

        // === –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ö–û–î–ê ===

        const channelSearchInput = document.getElementById('channelSearchInput');
        if (channelSearchInput) {
            
            // –°–æ–∑–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            const handleChannelSearch = (event) => {
                const query = event.target.value.toLowerCase().trim();
                const channels = document.querySelectorAll('#channelsList .channel-item');
                
                channels.forEach(channel => {
                    const channelName = channel.textContent.toLowerCase();
                    if (channelName.includes(query)) {
                        channel.style.display = 'flex'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º flex, —Ç.–∫. —É .channel-item —Ç–∞–∫–æ–π display
                    } else {
                        channel.style.display = 'none';
                    }
                });
            };

            // –ü—Ä–∏–º–µ–Ω—è–µ–º debounce, —á—Ç–æ–±—ã –ø–æ–∏—Å–∫ –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª –Ω–∞ –∫–∞–∂–¥—É—é –±—É–∫–≤—É
            const debouncedChannelSearch = debounce(handleChannelSearch, 250);
            channelSearchInput.addEventListener('input', debouncedChannelSearch);

        }

        // --- –î–û–ë–ê–í–õ–ï–ù–ù–´–ô –ö–û–î ---

        // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
        messageArea.addEventListener('click', function(event) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ –Ω–∞–∂–∞—Ç–∞ –∏–º–µ–Ω–Ω–æ –∫–Ω–æ–ø–∫–∞ —Å –∫–ª–∞—Å—Å–æ–º 'edit-message-btn'
            const editButton = event.target.closest('.edit-message-btn');
            
            if (editButton) {
                const messageId = editButton.dataset.messageId;
                const messageText = editButton.dataset.rawText; // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –Ω–∞—à–µ–≥–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞
                
                // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                ChatModule.startEditMessage(messageId, messageText);
            }
        });

        
    }




    
    function setupAuthStateListener() {
        if (!auth) return;
        
        auth.onAuthStateChanged(user => {
            currentUser = user;
            updateUserUI();


            if (user) {
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', user.displayName || user.email);
                
                // –ó–ê–ì–†–£–ñ–ê–ï–ú –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ê–ù–ù–´–ï –ö–ê–ù–ê–õ–´ –ò–ó –•–†–ê–ù–ò–õ–ò–©–ê
                const savedUnlocked = localStorage.getItem(`unlockedChannels_${user.uid}`);
                if (savedUnlocked) {
                    unlockedChannels = new Set(JSON.parse(savedUnlocked));
                }

                initializeUnreadListeners(); 
                setupPresenceSystem();
                fetchAllUsers();
                loadChannels();
                loadPrivateChats();
                loadTabData(currentTab);
                initializeDataListeners();
            } else {

                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                clearChatData();
                cleanupPresenceSystem();
            }
        });
    }

    let globalMessagesListener = null; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –Ω–∞—à–µ–≥–æ –Ω–æ–≤–æ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è
    let allMessagesByChannel = new Map(); // –ö—ç—à –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞–Ω–∞–ª–∞–º


    function processUnreadMessage(change) {
        if (change.type === 'added') {
            const messageData = change.doc.data();
            const messageTimestamp = messageData.createdAt?.toDate();

            if (!messageTimestamp || messageTimestamp < listenerInitializationTime) {
                return; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
            }

            const isUnread = messageData.authorId !== currentUser.uid && (currentChannel !== messageData.channelId || currentTab !== 'messages' || document.hidden);
            // –°–¢–ê–õ–û (—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –∑–∞–º–µ–Ω–∏—Ç–µ)
            if (isUnread) {
                const isPrivateMessage = !messageData.memberIds.includes('public');
                const isUnlockedPublicChannel = messageData.memberIds.includes('public') && (messageData.channelId === 'general' || unlockedChannels.has(messageData.channelId));

                if (isPrivateMessage || isUnlockedPublicChannel) {
                    updateUnreadCount(messageData.channelId, 1);

                    // --- –í–û–¢ –û–ù–û, –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï! ---
                    // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ –ª–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤.
                    // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —á–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ, –∏ —Å—á–µ—Ç—á–∏–∫ –Ω–∞ –Ω–µ–º –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è.
                    if (isPrivateMessage) loadPrivateChats(); 
                }
            }
        }
    }


    function initializeUnreadListeners() {
        if (pmUnreadListener) pmUnreadListener();
        if (publicUnreadListener) publicUnreadListener();
        if (!currentUser) return;

        listenerInitializationTime = new Date();
        console.log("–ó–∞–ø—É—Å–∫ –¥–≤–æ–π–Ω–æ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è –¥–ª—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –≤:", listenerInitializationTime);

        // –°–õ–£–®–ê–¢–ï–õ–¨ 1: –¢–æ–ª—å–∫–æ –¥–ª—è –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        pmUnreadListener = db.collection('messages')
            .where('memberIds', 'array-contains', currentUser.uid)
            .orderBy('createdAt', 'desc')
            .limit(10)
            .onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => processUnreadMessage(change));
            }, error => console.error("–û—à–∏–±–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è –õ–°:", error));

        // –°–õ–£–®–ê–¢–ï–õ–¨ 2: –¢–æ–ª—å–∫–æ –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
        publicUnreadListener = db.collection('messages')
            .where('memberIds', 'array-contains', 'public')
            .orderBy('createdAt', 'desc')
            .limit(10)
            .onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => processUnreadMessage(change));
            }, error => console.error("–û—à–∏–±–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è –∫–∞–Ω–∞–ª–æ–≤:", error));
    }




    function updateUserUI() {
        if (currentUserEl) {
            const displayName = currentUser ? (currentUser.displayName || currentUser.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å') : '–ì–æ—Å—Ç—å';
            currentUserEl.textContent = displayName;
            console.log('UI –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ:', displayName);
        }
    }

// script.js (–≤—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤ ChatModule)

    /**
     * –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—É—â–µ–º DOM –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –µ–≥–æ –∏–º—è.
     * @param {string} userId - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—å–µ –∏–º—è –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å.
     * @param {string} newName - –ù–æ–≤–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     */
    function updateAuthorNameInView(userId, newName) {
        if (!messageArea || !userId || !newName) return;
        
        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –ø–æ–º–µ—Ç–∏–ª–∏ –Ω–∞—à–∏–º data-–∞—Ç—Ä–∏–±—É—Ç–æ–º
        const userMessages = messageArea.querySelectorAll(`.message[data-author-id="${userId}"]`);
        
        userMessages.forEach(msgElement => {
            // –í –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –Ω–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç —Å –∏–º–µ–Ω–µ–º –∞–≤—Ç–æ—Ä–∞
            const authorEl = msgElement.querySelector('.author');
            if (authorEl) {
                // –ò –ø—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ–º –µ–≥–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                authorEl.textContent = newName;
            }
        });
        console.log(`–û–±–Ω–æ–≤–ª–µ–Ω–æ –∏–º—è –¥–ª—è ${userMessages.length} —Å–æ–æ–±—â–µ–Ω–∏–π –≤ DOM.`);
    }

    
    // ========== AUTHENTICATION ==========
    function switchAuthTab(tabType) {
        document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelector(`[data-tab="${tabType}"]`).classList.add('active');
        document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
        document.getElementById(`${tabType}Form`).classList.add('active');
    }

    async function handleLogin(e) {
        e.preventDefault();
        if (!auth) { showError('–°–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞'); return; }
        const loginIdentifier = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        if (!loginIdentifier || !password) { showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'); return; }
        
        try {
            let email;
            if (loginIdentifier.includes('@')) {
                email = loginIdentifier;
            } else {
                const querySnapshot = await db.collection('users').where('username', '==', loginIdentifier).limit(1).get();
                if (querySnapshot.empty) throw { code: 'auth/user-not-found' }; 
                email = querySnapshot.docs[0].data().email;
            }
            await auth.signInWithEmailAndPassword(email, password);
            ChatModule.closeAuthModal();
            if (openChatAfterAuth) {
                openChatAfterAuth = false; // –û–ø—É—Å–∫–∞–µ–º —Ñ–ª–∞–∂–æ–∫
                ChatModule.openChatModal(); // –û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
            showError(getErrorMessage(error.code));
        }
    }
    


    async function handleRegister(e) {
        e.preventDefault();
        if (!auth) { showError('–°–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞'); return; }
        const username = document.getElementById('registerUsername').value.trim();
        const email = document.getElementById('registerEmail').value.trim();
        const password = document.getElementById('registerPassword').value;
        const passwordConfirm = document.getElementById('registerPasswordConfirm').value; // <-- –ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞

        if (!username || !email || !password || !passwordConfirm) { // <-- –ò–∑–º–µ–Ω–µ–Ω–æ
            showError(_chat('fill_all_fields')); 
            return; 
        }
        if (password.length < 6) { 
            showError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤'); 
            return; 
        }
        if (password !== passwordConfirm) { // <-- –ù–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            showError('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!');
            return;
        }

        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;
            await user.updateProfile({ displayName: username });
            await db.collection('users').doc(user.uid).set({
                username: username,
                email: email,
                uid: user.uid,
                privateChatPartners: [], // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –¥–ª—è –õ–°
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            ChatModule.closeAuthModal();

            if (openChatAfterAuth) {
                openChatAfterAuth = false; // –û–ø—É—Å–∫–∞–µ–º —Ñ–ª–∞–∂–æ–∫
                ChatModule.openChatModal(); // –û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç
            }

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
            showError(getErrorMessage(error.code));
        }
    }



    function getErrorMessage(errorCode) {
        const errorKeys = {
            'auth/user-not-found': 'error_user_not_found',
            'auth/wrong-password': 'error_wrong_password',
            'auth/email-already-in-use': 'error_email_in_use',
            'auth/weak-password': 'error_weak_password',
            'auth/invalid-email': 'error_invalid_email',
            'auth/too-many-requests': 'error_too_many_requests'
        };
        const key = errorKeys[errorCode] || 'error_generic';
        return _chat(key); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º—É –ø–µ—Ä–µ–≤–æ–¥–æ–≤
    }
    function showError(message) { alert(message); }
    
    // ========== TAB SWITCHING ==========
    function switchTab(tabId) {
        if (!TABS[tabId] || tabId === currentTab) return; // –ù–µ –¥–µ–ª–∞–µ–º –Ω–∏—á–µ–≥–æ, –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É

        // --- –ù–û–í–´–ô –ë–õ–û–ö –û–ß–ò–°–¢–ö–ò ---
        // –ü–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º, –æ—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å–ª—É—à–∞—Ç–µ–ª—è –°–¢–ê–†–û–ô –≤–∫–ª–∞–¥–∫–∏
        if (currentTab === 'questions' && questionsListener) {
            questionsListener(); // –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–ø–∏—Å–∫–∏
            questionsListener = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
        }
        if (currentTab === 'favorites' && favoritesListener) {
            favoritesListener(); // –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–ø–∏—Å–∫–∏
            favoritesListener = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
        }
        // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê ---

        currentTab = tabId;

        // –ï—Å–ª–∏ –º—ã –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–ª—è –¢–ï–ö–£–©–ï–ì–û –∫–∞–Ω–∞–ª–∞
        if (tabId === 'messages') {

        }

        document.querySelectorAll('.tab-item').forEach(tab => tab.classList.remove('active'));
        document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
        document.getElementById('chatHeaderTitle').textContent = _chat(TABS[tabId].langKey);
        loadTabData(tabId);
    }
    
    // === –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò –í–ö–õ–ê–î–û–ö ===
    function loadTabData(tabId) {
        if (!currentUser || !db) return;
        
        const tabActionsContainer = document.getElementById('tabActionsContainer');
        tabActionsContainer.innerHTML = ''; 
        tabActionsContainer.classList.add('hidden');
    
        messageArea.classList.remove('user-list-mode');
        document.querySelector('.chat-input-area').style.display = 'flex';
    
        switch (tabId) {
            case 'messages':
                loadMessages();
                break;
            case 'questions':
                setupTabActions('questions'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
                loadQuestions();
                break;
            case 'favorites':
                setupTabActions('favorites'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
                loadFavorites();
                break;
            case 'users':
                loadUsers();
                break;
        }
    }
    
    // ========== DATA LOADING & DISPLAY ==========

    async function fetchAllUsers() {
        try {
            const snapshot = await db.collection('users').get();
            snapshot.forEach(doc => {
                allUsers.set(doc.id, doc.data());
            });
            updateTabCounter('users', allUsers.size); // <--- –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –°–¢–†–û–ö–£
            console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allUsers.size} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.`);
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", error);
        }
    }

    
    function loadUsers() {
        if (!messageArea) return;
        messageArea.innerHTML = '';
        messageArea.classList.add('user-list-mode');
        document.querySelector('.chat-input-area').style.display = 'none';

        if (allUsers.size === 0) {
            messageArea.innerHTML = '<div class="empty-state">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>';
            return;
        }

        const userListEl = document.createElement('div');
        userListEl.className = 'user-list-container';
        
        allUsers.forEach(user => {
            if (user.uid === currentUser.uid) return; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–µ–±—è –≤ —Å–ø–∏—Å–∫–µ
            const isOnline = onlineUsers.has(user.uid);
            
            const userEl = document.createElement('div');
            userEl.className = 'user-list-item';
            // –û–°–ù–û–í–ù–û–ô –ö–õ–ò–ö –ü–û –ö–ê–†–¢–û–ß–ö–ï –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            userEl.onclick = () => showUserActions(user.uid, user.username, user.email);
            
            // --- –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ó–î–ï–°–¨ ---
            // –¢–µ–ø–µ—Ä—å —É –∫–Ω–æ–ø–æ–∫ –µ—Å—Ç—å —Å–≤–æ–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ onclick, –∫–æ—Ç–æ—Ä—ã–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç "–≤—Å–ø–ª—ã—Ç–∏–µ" —Å–æ–±—ã—Ç–∏—è
            userEl.innerHTML = `
                <div class="user-list-avatar">
                    <span class="status-indicator ${isOnline ? 'online' : ''}"></span>
                    ${escapeHTML(user.username.charAt(0).toUpperCase())}
                </div>
                <div class="user-list-info">
                    <div class="username">${escapeHTML(user.username)}</div>
                    <div class="email">${escapeHTML(user.email)}</div>
                </div>
                <div class="user-list-actions">
                    <button class="action-btn chat" title="–ù–∞–ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç–µ" onclick="event.stopPropagation(); ChatModule.startPrivateChat('${user.uid}', '${escapeHTML(user.username)}')">üí¨</button>
                    <button class="action-btn mail" title="–ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞ Email" onclick="event.stopPropagation(); window.location.href='mailto:${user.email}'">‚úâÔ∏è</button>
                </div>
            `;
            userListEl.appendChild(userEl);
        });

        messageArea.appendChild(userListEl);
        updateTabCounter('users', allUsers.size);
    }

    /**
     * –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫–∞–º–∏ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
     * @param {string} channelId - ID –∫–∞–Ω–∞–ª–∞, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –º–µ–Ω—è–µ—Ç—Å—è —Å—á–µ—Ç—á–∏–∫.
     * @param {number} change - –ò–∑–º–µ–Ω–µ–Ω–∏–µ (+1, 0 –¥–ª—è —Å–±—Ä–æ—Å–∞).
     */
    function updateUnreadCount(channelId, change) {
        const currentCount = unreadCounts.get(channelId) || 0;
        // –ï—Å–ª–∏ change = 0, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫. –ò–Ω–∞—á–µ - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º.
        const newCount = change === 0 ? 0 : currentCount + change;
        unreadCounts.set(channelId, newCount);

        // –û–±–Ω–æ–≤–ª—è–µ–º UI –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
        const channelCounter = document.querySelector(`.channel-item[data-channel-id="${channelId}"] .unread-channel-badge`);
        if (channelCounter) {
            if (newCount > 0) {
                channelCounter.textContent = newCount;
                channelCounter.classList.remove('hidden');
            } else {
                channelCounter.classList.add('hidden');
            }
        }

        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π —Å—á–µ—Ç—á–∏–∫ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–°–æ–æ–±—â–µ–Ω–∏—è"
        let totalUnread = 0;
        unreadCounts.forEach(count => totalUnread += count);
        updateTabCounter('messages', totalUnread);
    }


    function loadMessages() {
        if (!db || !currentUser) return;

        // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
        if (messagesListener) {
            messagesListener();
        }

        messageArea.innerHTML = `<div class="empty-state">${_chat('loading_messages')}</div>`;

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å –¢–û–õ–¨–ö–û –î–õ–Ø –¢–ï–ö–£–©–ï–ì–û –ö–ê–ù–ê–õ–ê
        messagesListener = db.collection('messages')
            .where('channelId', '==', currentChannel)
            .orderBy('createdAt', 'asc')
            .onSnapshot(snapshot => {
                // –≠—Ç–æ—Ç –∫–æ–¥ –±—É–¥–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–Ω–æ–≤—ã–µ, –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ, —É–¥–∞–ª–µ–Ω–Ω—ã–µ)
                // –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞ –∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∏—Ö –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å.
                
                allMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayMessages(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —á–∞—Ç —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

            }, error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
                messageArea.innerHTML = `<div class="empty-state">${_chat('loading_error')}</div>`;
            });
    }




 
    function updateUnreadCount(channelId, change, isReset = false) {
        const currentCount = unreadCounts.get(channelId) || 0;
        // –ï—Å–ª–∏ isReset = true, –æ–±–Ω—É–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫. –ò–Ω–∞—á–µ - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º.
        const newCount = isReset ? 0 : currentCount + change;
        unreadCounts.set(channelId, newCount);

        // –û–±–Ω–æ–≤–ª—è–µ–º UI –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
        const channelCounter = document.querySelector(`.channel-item[data-channel-id="${channelId}"] .unread-channel-badge`);
        if (channelCounter) {
            if (newCount > 0) {
                channelCounter.textContent = newCount;
                channelCounter.classList.remove('hidden');
            } else {
                channelCounter.classList.add('hidden');
            }
        }

        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π —Å—á–µ—Ç—á–∏–∫ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–°–æ–æ–±—â–µ–Ω–∏—è"
        let totalUnread = 0;
        unreadCounts.forEach(count => totalUnread += count);
        updateTabCounter('messages', totalUnread);
    }




    function displayMessages() {
        if (!messageArea) return;
        messageArea.innerHTML = '';
        const messagesToDisplay = isPinnedMode ? allMessages.filter(msg => msg.isPinned) : allMessages;

        if (messagesToDisplay.length === 0) {
            const emptyStateKey = isPinnedMode ? 'pinned_messages_empty' : 'messages_empty';
            messageArea.innerHTML = `<div class="empty-state">${_chat(emptyStateKey)}</div>`;
            return;
        }
        
        messagesToDisplay.forEach(message => messageArea.appendChild(createMessageElement(message)));
        
        // –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
        messageArea.style.scrollBehavior = 'auto';
        scrollToBottom();
        setTimeout(() => { messageArea.style.scrollBehavior = 'smooth'; }, 100);

        // --- –ù–ê–ß–ê–õ–û –ù–û–í–û–ô "–£–ú–ù–û–ô" –õ–û–ì–ò–ö–ò ---

        // 1. –ï—Å–ª–∏ —Å—Ç–∞—Ä—ã–π "–Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å" –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –æ—Ç–∫–ª—é—á–∞–µ–º –µ–≥–æ
        if (lastMessageObserver) {
            lastMessageObserver.disconnect();
        }

        // 2. –ù–∞—Ö–æ–¥–∏–º —Å–∞–º–æ–µ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ
        const lastMessageElement = messageArea.lastElementChild;

        // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–æ–æ–±—â–µ —á—Ç–æ –Ω–∞–±–ª—é–¥–∞—Ç—å –∏ –µ—Å—Ç—å –ª–∏ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
        const unreadCountForChannel = unreadCounts.get(currentChannel) || 0;
        if (lastMessageElement && unreadCountForChannel > 0) {
            
            // 4. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ "–Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è"
            lastMessageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    // 5. –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ü–û–Ø–í–ò–õ–û–°–¨ –ù–ê –≠–ö–†–ê–ù–ï...
                    if (entry.isIntersecting) {
                        // ...–æ–±–Ω—É–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫...
                        updateUnreadCount(currentChannel, 0, true);
                        console.log(`–°—á–µ—Ç—á–∏–∫ –¥–ª—è –∫–∞–Ω–∞–ª–∞ ${currentChannel} –æ–±–Ω—É–ª–µ–Ω, —Ç.–∫. –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–µ–ª –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.`);
                        
                        // ...–∏ –æ—Ç–∫–ª—é—á–∞–µ–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è, –µ–≥–æ —Ä–∞–±–æ—Ç–∞ —Å–¥–µ–ª–∞–Ω–∞.
                        observer.disconnect();
                    }
                });
            }, { threshold: 0.8 }); // –°—Ä–∞–±–æ—Ç–∞–µ—Ç, –∫–æ–≥–¥–∞ 80% —Å–æ–æ–±—â–µ–Ω–∏—è –≤–∏–¥–Ω–æ

            // 6. –ì–æ–≤–æ—Ä–∏–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—é –Ω–∞—á–∞—Ç—å —Å–ª–µ–¥–∏—Ç—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
            lastMessageObserver.observe(lastMessageElement);
        }
    }
    
    function loadQuestions() {
        if (!db || !currentUser) return;
        
        // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
        if (questionsListener) {
            questionsListener();
        }

        try {
            // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –Ω–æ–≤–æ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è –Ω–∞—à–µ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
            questionsListener = db.collection('questions')
                .where('channelId', '==', currentChannel)
                .orderBy('createdAt', 'desc')
                .limit(20)
                .onSnapshot(snapshot => {
                    const questions = [];
                    snapshot.forEach(doc => {
                        questions.push({ id: doc.id, ...doc.data() });
                    });
                    
                    displayQuestions(questions);

                    // –ü–†–û–í–ï–†–Ø–ï–ú, –ù–£–ñ–ù–û –õ–ò –ü–û–î–°–í–ï–¢–ò–¢–¨ –í–û–ü–†–û–°
                    if (questionToHighlight) {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã DOM —É—Å–ø–µ–ª –æ–±–Ω–æ–≤–∏—Ç—å—Å—è
                        setTimeout(() => {
                            highlightAndScrollToQuestion(questionToHighlight);
                            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, —á—Ç–æ–±—ã –Ω–µ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—Ç—å —Å–Ω–æ–≤–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —á–∞—Ç–∞
                            questionToHighlight = null; 
                        }, 100);
                    }

                }, error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤:', error);
                });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∫–æ–ª–ª–µ–∫—Ü–∏–µ–π –≤–æ–ø—Ä–æ—Å–æ–≤:', error);
        }
    }


    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –µ–µ –¥–∞–≤–Ω–æ—Å—Ç–∏.
     * @param {firebase.firestore.Timestamp} fbTimestamp - –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ –∏–∑ Firebase.
     * @returns {string} - –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ (–Ω–∞–ø—Ä., "14:30", "–í—á–µ—Ä–∞, 14:30").
     */
    function formatSmartTimestamp(fbTimestamp) {
        if (!fbTimestamp || typeof fbTimestamp.toDate !== 'function') {
            return ''; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ—Ç—É, –µ—Å–ª–∏ –º–µ—Ç–∫–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞
        }
        
        const now = new Date();
        const msgDate = fbTimestamp.toDate();

        const timeString = msgDate.toLocaleTimeString(currentChatLang, {
            hour: '2-digit',
            minute: '2-digit'
        });

        // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ –¥–∞—Ç–µ, –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏
        const isToday = now.toDateString() === msgDate.toDateString();
        
        const yesterday = new Date();
        yesterday.setDate(now.getDate() - 1);
        const isYesterday = yesterday.toDateString() === msgDate.toDateString();

        const isThisYear = now.getFullYear() === msgDate.getFullYear();

        if (isToday) {
            return timeString;
        } else if (isYesterday) {
            return `${_chat('smart_timestamp_yesterday')}, ${timeString}`;
        } else if (isThisYear) {
            const datePart = msgDate.toLocaleDateString(currentChatLang, {
                month: 'long',
                day: 'numeric'
            });
            return `${datePart}, ${timeString}`;
        } else {
            const fullDatePart = msgDate.toLocaleDateString(currentChatLang, {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            return `${fullDatePart}, ${timeString}`;
        }
    }





    /**
     * –°–æ–∑–¥–∞–µ—Ç DOM-—ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ –≤—Å–µ–π –ª–æ–≥–∏–∫–æ–π.
     * –í–ï–†–°–ò–Ø 3.0: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ data-–∞—Ç—Ä–∏–±—É—Ç—ã –∏ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π.
     * @param {object} message - –û–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Firebase.
     * @returns {HTMLElement} - –ì–æ—Ç–æ–≤—ã–π –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ DOM —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è.
     */
    function createMessageElement(message) {
        const messageEl = document.createElement('div');
        messageEl.id = `message-${message.id}`;
        messageEl.className = `message ${message.authorId === currentUser?.uid ? 'mine' : 'other'}`;
        
        if (message.authorId) {
            messageEl.dataset.authorId = message.authorId;
        }

        if (message.isPinned) messageEl.classList.add('pinned');

        const timestamp = message.createdAt;
        const displayTime = formatSmartTimestamp(timestamp);
        const fullTimeTitle = timestamp?.toDate?.().toLocaleString(currentChatLang, {year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'}) || '';
        
        let replyHTML = '';
        if (message.replyTo) {
            replyHTML = `<div class="reply-context" data-action="scroll-to" data-message-id="${message.replyTo.messageId}">
                            <div class="reply-author">${escapeHTML(message.replyTo.authorName || '')}</div>
                            <div class="reply-text">${escapeHTML(message.replyTo.textSnippet || '')}</div>
                        </div>`;
        }
        
        let contentHTML = '';
        if (message.type === 'file_share') {
            messageEl.classList.add('file-share-bubble');
            const qCount = message.fileInfo.questions;
            const qText = qCount === 1 ? _chat('file_share_question_1') : (qCount >= 2 && qCount <= 4 ? _chat('file_share_question_2_4') : _chat('file_share_question_5_more'));
            const currentChannelData = channels.find(c => c.id === currentChannel);
            const isTestingChannel = currentChannelData && currentChannelData.isForTesting;
            const resultsButtonHTML = isTestingChannel 
                ? `<div class="test-results-action"><button class="results-btn" data-action="show-results" data-file-id="${message.fileInfo.id}" data-channel-id="${message.channelId}">${_chat('results_button')}</button></div>` 
                : '';
            contentHTML = `<div class="file-share-content" data-action="show-file-actions" data-file-id="${message.fileInfo.id}" data-file-name="${escape(message.fileInfo.name)}" data-is-testing="${isTestingChannel}">
                                <div class="file-share-icon">üìÑ</div>
                                <div class="file-share-details">
                                    <div class="file-share-name">${escapeHTML(message.fileInfo.name)}</div>
                                    <div class="file-share-info">${qCount} ${qText}</div>
                                </div>
                                <div class="file-share-arrow">‚Üí</div>
                           </div>${resultsButtonHTML}`;
        } else if (message.type === 'question_link') {
            messageEl.classList.add('question-link-bubble');
            contentHTML = `<div class="question-link-content" data-action="navigate-to-question" data-question-id="${message.questionId}" data-message-id="${message.id}">
                                <span class="question-link-icon">‚ùì</span>
                                <div class="question-link-text"><strong>${_chat('new_question_notification')}</strong><p>${escapeHTML(message.text.substring(0, 80))}...</p></div>
                                <span class="question-link-arrow">‚Üí</span>
                           </div>`;
        } else {
            let messageText = message.text || '';
            let translatingClass = '';
            if (isChatTranslateModeEnabled && message.text) {
                const lang = localStorage.getItem('appLanguage') || 'ru';
                const cacheKey = getChatCacheKey(message.id, lang);
                if (chatTranslations.has(cacheKey)) {
                    messageText = chatTranslations.get(cacheKey);
                } else {
                    fetchAndCacheTranslation(message);
                    translatingClass = 'translating';
                }
            }
            const editedIndicator = message.editedAt ? `<span class="edited-indicator">${_chat('edited_indicator')}</span>` : '';
            const pinnedIcon = message.isPinned ? `<span class="pinned-icon" title="–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ">üìå</span>` : '';
            contentHTML = `<div class="message-content ${translatingClass}">${pinnedIcon} ${escapeHTML(messageText.trim())} ${editedIndicator}</div>`;
        }
        
        let reactionsHTML = '<div class="reactions-container">';
        if (message.reactions) {
            Object.entries(message.reactions).forEach(([emoji, userIds]) => {
                if (userIds && userIds.length > 0) {
                    const isReactedByMe = userIds.includes(currentUser.uid);
                    reactionsHTML += `<button class="reaction-badge ${isReactedByMe ? 'mine' : ''}" data-action="toggle-reaction" data-emoji="${emoji}">${emoji} ${userIds.length}</button>`;
                }
            });
        }
        reactionsHTML += '</div>';

        let actionsHTML = `
            <button title="${_chat('tooltip_reply')}" data-action="reply">‚Ü©Ô∏è</button>
            <button title="${_chat('tooltip_add_reaction')}" data-action="show-reaction-picker">üòä</button>
            <button title="${message.isPinned ? _chat('tooltip_unpin') : _chat('tooltip_pin')}" data-action="toggle-pin">üìå</button>
        `;
        const isAdmin = currentUser?.email === 'iverrum@gmail.com';
        
        // –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∞–≤—Ç–æ—Ä –ò–õ–ò –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
        if ((message.authorId === currentUser?.uid || isAdmin) && message.type !== 'question_link') {
            actionsHTML += `<button title="${_chat('tooltip_edit_message')}" data-action="edit">‚úèÔ∏è</button>`;
            actionsHTML += `<button title="${_chat('tooltip_delete_message')}" data-action="delete">üóëÔ∏è</button>`;
        }

        messageEl.innerHTML = `<div class="message-header"><span class="author">${message.authorName || _chat('anonymous_user')}</span><span class="timestamp" title="${fullTimeTitle}">${displayTime}</span></div>${replyHTML}${contentHTML}${reactionsHTML}<div class="message-actions-toolbar">${actionsHTML}</div>`;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        messageEl.dataset.rawText = message.text || '';

        const contentEl = messageEl.querySelector('.message-content');
        if (contentEl) {
            setTimeout(() => {
                const MAX_HEIGHT = 250;
                if (contentEl.scrollHeight > MAX_HEIGHT) {
                    contentEl.classList.add('collapsible');
                    const expandBtn = document.createElement('button');
                    expandBtn.className = 'expand-message-btn';
                    expandBtn.textContent = _chat('expand_message');
                    expandBtn.onclick = function() {
                        const isExpanded = contentEl.classList.toggle('expanded');
                        this.textContent = isExpanded ? _chat('collapse_message') : _chat('expand_message');
                    };
                    messageEl.appendChild(expandBtn);
                }
            }, 0);
        }
        
        return messageEl;
    }







    // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–º ---
    function showProfileModal() {
        if (!currentUser) return;
        document.getElementById('profileDisplayName').value = currentUser.displayName || '';
        document.getElementById('profileEmail').value = currentUser.email || '';
        document.getElementById('profileNewPassword').value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–∞—Ä–æ–ª—è
        showModal('profileEditModal');
    }



    async function saveProfile() {
        if (!currentUser) return;

        const newName = document.getElementById('profileDisplayName').value.trim();
        const newPassword = document.getElementById('profileNewPassword').value;

        try {
            const updatePromises = [];

            if (newName && newName !== currentUser.displayName) {
                updatePromises.push(currentUser.updateProfile({ displayName: newName }));
            }

            if (newPassword) {
                if (newPassword.length < 6) {
                    showError(_chat('chat_profile_update_password_error'));
                    return;
                }
                updatePromises.push(currentUser.updatePassword(newPassword));
            }

            await Promise.all(updatePromises);
            alert(_chat('chat_profile_update_success'));
            updateUserUI();

            if (newName && newName !== currentUser.displayName) {
                updateAuthorNameInView(currentUser.uid, newName);
            }
            
            closeModal('profileEditModal');

        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:", error);
            showError(`${_chat('chat_profile_update_fail_prefix')} ${getErrorMessage(error.code)}`);
        }
    }



    async function logout() {
        try {
            await auth.signOut();
            ChatModule.closeChatModal(); 
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:", error);
        }
    }



    /**
     * –ü–ª–∞–≤–Ω–æ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç –∫ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –≤–æ–ø—Ä–æ—Å—É –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç –µ–≥–æ.
     * @param {string} questionId ID –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏.
     */
    function highlightAndScrollToQuestion(questionId) {
        const element = document.getElementById(`question-${questionId}`);
        if (element) {
            // –ü–ª–∞–≤–Ω–æ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —ç–ª–µ–º–µ–Ω—Ç—É, —á—Ç–æ–±—ã –æ–Ω –æ–∫–∞–∑–∞–ª—Å—è –ø–æ —Ü–µ–Ω—Ç—Ä—É —ç–∫—Ä–∞–Ω–∞
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
            element.classList.add('highlighted');

            // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ 2.5 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                element.classList.remove('highlighted');
            }, 2500);
        }
    }


    function scrollToMessage(messageId) {
        const element = document.getElementById(`message-${messageId}`);
        if (element) {
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —ç–ª–µ–º–µ–Ω—Ç—É
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
            element.classList.add('highlighted');

            // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                element.classList.remove('highlighted');
            }, 2000);
        } else {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏:', messageId);
        }
    }

    // –ù–û–í–ê–Ø, –ù–ê–î–ï–ñ–ù–ê–Ø –í–ï–†–°–ò–Ø
    function escape(str) {
        if (!str) return '';
        return str
            .replace(/\\/g, '\\\\')  // 1. –°–Ω–∞—á–∞–ª–∞ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–∞–º–∏ —Å–ª–µ—à–∏
            .replace(/'/g, "\\'")   // 2. –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
            .replace(/"/g, '\\"')   // 3. –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
            .replace(/\n/g, '\\n')  // 4. –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –Ω–∞ –∏—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã–π —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç
            .replace(/\r/g, '\\r'); // 5. –¢–æ –∂–µ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫–∞—Ä–µ—Ç–∫–∏
    }





    async function navigateToQuestion(questionId, linkMessageId = null) {
        if (!db) return;

        try {
            const questionRef = db.collection('questions').doc(questionId);
            const doc = await questionRef.get();

            if (doc.exists) {
                // 1. –ó–ê–ü–û–ú–ò–ù–ê–ï–ú, –ö–ê–ö–û–ô –í–û–ü–†–û–° –ù–£–ñ–ù–û –í–´–î–ï–õ–ò–¢–¨
                questionToHighlight = questionId;

                // 2. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–í–æ–ø—Ä–æ—Å—ã"
                switchTab('questions');

                // –°–∞–º–∞ –ª–æ–≥–∏–∫–∞ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤
                console.log(`–ü–µ—Ä–µ—Ö–æ–¥ –∫ –≤–æ–ø—Ä–æ—Å—É: ${questionId}`);

            } else {
                // –≠—Ç–æ—Ç –±–ª–æ–∫ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
                alert(_chat('chat_question_deleted_alert'));
                if (linkMessageId) {
                    await db.collection('messages').doc(linkMessageId).delete();
                }
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ –≤–æ–ø—Ä–æ—Å—É:", error);
            showError(_chat('chat_check_question_status_failed'));
        }
    }
    


    function displayQuestions(questions) {
        if (!messageArea) return;
        
        messageArea.innerHTML = '';
        
        if (questions.length === 0) {
            messageArea.innerHTML = `<div class="empty-state">${_chat('questions_empty')}</div>`;
            return;
        }
        
        questions.forEach(question => {
            const questionEl = createQuestionElement(question);

            const favButton = questionEl.querySelector('.add-to-favorites-btn');
            if (favButton) {
                const itemToSave = {
                    text: question.text,
                    options: question.options
                };
                favButton.onclick = () => ChatModule.addToFavorites(itemToSave, 'question');
            }

            const copyBtn = questionEl.querySelector('.copy-question-btn');
            if (copyBtn) {
                copyBtn.onclick = () => ChatModule.copyQuestionAsQst(question);
            }

            messageArea.appendChild(questionEl);
        });
    }




    function createQuestionElement(question) {
        const questionEl = document.createElement('div');
        questionEl.className = 'question-bubble';
        questionEl.id = `question-${question.id}`; 

        const timestamp = question.createdAt?.toDate?.() || new Date();
        const currentLocale = LOCALE_MAP[currentChatLang] || 'ru-RU'; // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –ª–æ–∫–∞–ª—å
        const timeStr = timestamp.toLocaleString(currentLocale); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –µ–µ

        if (question.options && Array.isArray(question.options)) {
            
            const hasCorrectAnswer = question.options.some(opt => opt.isCorrect);

            const optionsHTML = question.options.map((option, index) => {
                const votes = Array.isArray(option.votedBy) ? option.votedBy.length : 0;
                let buttonClass = 'option-vote-btn';

                if (hasCorrectAnswer && option.isCorrect) {
                    buttonClass += ' correct';
                }
                if (currentUser && Array.isArray(option.votedBy) && option.votedBy.includes(currentUser.uid)) {
                    buttonClass += ' voted-by-user';
                }

                // –í–∞–∂–Ω–æ: –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—Ç–∞–≤–∏–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –û–†–ò–ì–ò–ù–ê–õ
                return `
                    <button class="${buttonClass}" onclick="ChatModule.voteForOption('${question.id}', ${index})">
                        <span class="option-text">${escapeHTML(option.text)}</span>
                        <span class="option-votes-badge">${votes}</span>
                    </button>
                `;
            }).join('');

            const totalVotes = question.options.reduce((sum, opt) => sum + (Array.isArray(opt.votedBy) ? opt.votedBy.length : 0), 0);
            
            let actionsHTML = `
                <button class="add-to-favorites-btn">${_chat('add_to_favorites_button')}</button>
                <button class="copy-question-btn">${_chat('copy_question_button')}</button> 
            `;

            if (currentUser && question.authorId === currentUser?.uid) {
                actionsHTML += `<button class="delete-question-btn" onclick="ChatModule.deleteQuestion('${question.id}')">${_chat('delete_question_button')}</button>`;
            }

            questionEl.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div class="question-square ${totalVotes > 0 ? 'has-votes' : ''}">
                        ${totalVotes > 0 ? `<span class="vote-indicator">${totalVotes}</span>` : ''}Q</div>
                    <div class="question-content">
                        <p><strong>${_chat('question_card_question_label')}</strong> ${escapeHTML(question.text || '')}</p>
                        <p><strong>${_chat('question_card_author_label')}</strong> ${escapeHTML(question.authorName || _chat('question_card_anonymous'))}</p>
                        <p><strong>${_chat('question_card_date_label')}</strong> ${timeStr}</p>
                        <div class="question-options-container">${optionsHTML}</div>
                        <div class="question-actions">${actionsHTML}</div>
                    </div>
                </div>`;

        } else if (question.text) {
            // ... (—Å—Ç–∞—Ä—ã–π –∫–æ–¥ –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –≤–æ–ø—Ä–æ—Å–æ–≤) ...
        } else {
            return document.createDocumentFragment();
        }
        return questionEl;
    }



    function loadFavorites() {
        if (!currentUser || !db) return;

        if (favoritesListener) {
            favoritesListener();
        }

        messageArea.innerHTML = `<div class="empty-state">${_chat('loading_messages')}</div>`;

        favoritesListener = db.collection('favorites')
            .where('userId', '==', currentUser.uid)
            .orderBy('createdAt', 'desc')
            .onSnapshot(snapshot => {
                const favoriteItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (favoriteItems.length === 0) {
                    messageArea.innerHTML = `<div class="empty-state">${_chat('chat_favorites_empty')}</div>`;
                    return;
                }

                messageArea.innerHTML = '';
                
                favoriteItems.forEach(favoriteInfo => {
                    if (favoriteInfo.content) {
                        let renderedElement;
                        const contentData = { id: favoriteInfo.id, ...favoriteInfo.content };

                        if (favoriteInfo.type === 'question') {
                            renderedElement = createQuestionElement(contentData);
                            
                            const voteButtons = renderedElement.querySelectorAll('.option-vote-btn');
                            voteButtons.forEach((btn, index) => {
                                btn.setAttribute('onclick', `ChatModule.voteForFavoriteOption('${favoriteInfo.id}', ${index})`);
                            });
                            
                            const addToFavBtn = renderedElement.querySelector('.add-to-favorites-btn');
                            if (addToFavBtn) addToFavBtn.remove();

                            const copyBtn = renderedElement.querySelector('.copy-question-btn');
                            if (copyBtn) {
                                copyBtn.onclick = () => ChatModule.copyQuestionAsQst(contentData);
                            }
                        } else {
                            renderedElement = createMessageElement(contentData);
                        }
                        
                        const deleteButton = document.createElement('button');
                        deleteButton.className = 'remove-favorite';
                        deleteButton.innerHTML = _chat('delete_favorite_button');
                        deleteButton.onclick = () => ChatModule.removeFromFavorites(favoriteInfo.id);

                        const actionsContainer = renderedElement.querySelector('.question-actions, .message-actions-toolbar');
                        if (actionsContainer) {
                            actionsContainer.appendChild(deleteButton);
                        } else {
                            const newActionsContainer = document.createElement('div');
                            newActionsContainer.className = 'favorite-actions';
                            newActionsContainer.appendChild(deleteButton);
                            renderedElement.appendChild(newActionsContainer);
                        }
                        messageArea.appendChild(renderedElement);
                    }
                });

            }, error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', error);
                messageArea.innerHTML = `<div class="empty-state">${_chat('chat_favorites_loading_error')}</div>`;
            });
    }


    function updateTabCounter(tabId, count) {
        if (tabCounters[tabId]) {
            tabCounters[tabId].textContent = count;
        }
    }

    function showUserActions(targetId, targetName, targetEmail) {
        if (targetId === currentUser.uid) return;
        
        document.getElementById('userActionsModalTitle').textContent = targetName;
        document.getElementById('userActionsModalText').textContent = _chat('chat_user_actions_for').replace('{userName}', targetName);

        const chatBtn = document.getElementById('userActionsChatBtn');
        const emailBtn = document.getElementById('userActionsEmailBtn');
        
        chatBtn.onclick = () => startPrivateChat(targetId, targetName);
        emailBtn.onclick = () => {
            window.location.href = `mailto:${targetEmail}`;
            closeModal('userActionsModal');
        };
        
        showModal('userActionsModal');
    }

    // === –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ù–ê–ß–ê–õ–ê –õ–ò–ß–ù–û–ì–û –ß–ê–¢–ê ===
    async function startPrivateChat(targetId, targetName) {
        closeModal('userActionsModal');
        const channelId = `private_${[currentUser.uid, targetId].sort().join('_')}`;
        const userDocRef = db.collection('users').doc(currentUser.uid);
    
        try {
            const userDoc = await userDocRef.get();
            if (!userDoc.exists) throw "–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.";
     

            const userData = userDoc.data();

            // –ü–†–û–í–ï–†–ö–ê: –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∏ userData —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏ privateChatPartners —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º
            if (userData && Array.isArray(userData.privateChatPartners)) {
                // –ï—Å–ª–∏ –≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ª–æ–≥–∏–∫—É
                if (!userData.privateChatPartners.includes(targetId)) {
                    await userDocRef.update({ privateChatPartners: firebase.firestore.FieldValue.arrayUnion(targetId) });
                }
            } else if (userData) {
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—Å—Ç—å, –∞ –ø–æ–ª—è —Å —á–∞—Ç–∞–º–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
                await userDocRef.update({ privateChatPartners: [targetId] });
            }
            
            // –ú—ã –ù–ï –¢–†–û–ì–ê–ï–ú –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞, —á—Ç–æ–±—ã –Ω–µ –Ω–∞—Ä—É—à–∞—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞.
            // –ï–≥–æ —Å–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–∏—Ç—Å—è, –∫–æ–≥–¥–∞ –æ–Ω —Å–∞–º –∑–∞–π–¥–µ—Ç –≤ —á–∞—Ç.
    
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ª–∏—á–Ω–æ–≥–æ —á–∞—Ç–∞: ", error);
            showError("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –ª–∏—á–Ω—ã–π —á–∞—Ç.");
            return;
        }
        
        await loadPrivateChats(); 
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —á–∞—Ç
        switchToChannel(channelId, targetName, 'private');
    }
    
    async function sendMessage() {
        if (!chatInput || !currentUser || !db) return;
        const text = chatInput.value.trim();
        if (!text) return;

        
        const sendBtn = document.getElementById('sendBtn');
        sendBtn.disabled = true;
        sendBtn.classList.add('loading');
        sendBtn.innerHTML = ''; 
        

        const isQuestionFormat = text.startsWith('?') && (text.includes('\n+') || text.includes('\n-'));

        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —É—á–∞—Å—Ç–Ω–∏–∫–∏
            if (currentChannelType === 'public' && currentChannel !== 'general') {
                // –ù–∞—Ö–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–Ω–∞–ª–∞ –≤ –Ω–∞—à–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–º –∫—ç—à–µ (—ç—Ç–æ –±—ã—Å—Ç—Ä–æ)
                const channel = channels.find(c => c.id === currentChannel);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –¢–û–õ–¨–ö–û –ï–°–õ–ò –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –≤ –Ω–µ–º
                if (channel && (!channel.members || !channel.members.includes(currentUser.uid))) {
                    const channelRef = db.collection('channels').doc(currentChannel);
                    await channelRef.update({
                        members: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                    });
                }
            }

            if (isQuestionFormat) {
                await createQuestionFromMessage(text);
                chatInput.value = '';
            } else {

                let memberIds = [];
                if (currentChannelType === 'private') {
                    // –î–ª—è –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤ ID —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –µ—Å—Ç—å –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞
                    memberIds = currentChannel.replace('private_', '').split('_');
                } else {
                    // –î–ª—è –ü–£–ë–õ–ò–ß–ù–´–• –∫–∞–Ω–∞–ª–æ–≤ –¥–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –º–µ—Ç–∫—É "public"
                    // –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –ª—é–±–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —ç—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.
                    memberIds = ['public']; 
                }

                const message = {
                    text: text,
                    authorId: currentUser.uid,
                    authorName: currentUser.displayName || currentUser.email || '–ê–Ω–æ–Ω–∏–º',
                    channelId: currentChannel,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'message',
                    reactions: {},
                    memberIds: memberIds // <--- –î–û–ë–ê–í–õ–ï–ù–û –≠–¢–û –ü–û–õ–ï
                };


                
                if (replyContext) {
                    message.replyTo = replyContext;
                }

                await db.collection('messages').add(message);
                updateUnreadCount(currentChannel, 0, true);
                chatInput.value = '';
                chatInput.style.height = 'auto';
                cancelReply();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            showError(_chat('error_send_message_failed'));
        } finally {

            sendBtn.disabled = false;
            sendBtn.classList.remove('loading');
            sendBtn.innerHTML = '‚û§'; 
            
        }
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –û—Ç–≤–µ—Ç–æ–≤ ---
    function startReply(messageId, authorName, text) {
        replyContext = {
            messageId: messageId,
            authorName: authorName,
            textSnippet: text.substring(0, 80) + (text.length > 80 ? '...' : '')
        };
        
        document.getElementById('replyingToText').textContent = replyContext.textSnippet;
        document.getElementById('replyingToPanel').classList.remove('hidden');
        chatInput.focus();
    }

    function cancelReply() {
        replyContext = null;
        document.getElementById('replyingToPanel').classList.add('hidden');
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ---
    function startEditMessage(messageId, currentText) {
        document.getElementById('editMessageIdInput').value = messageId;
        document.getElementById('editMessageInput').value = currentText;
        showModal('editMessageModal');
    }

    // –ù–æ–≤—ã–π (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π) –∫–æ–¥
    async function saveMessageEdit() {
        const messageId = document.getElementById('editMessageIdInput').value;
        const newText = document.getElementById('editMessageInput').value.trim();
        if (!messageId || !newText) return;

        const messageRef = db.collection('messages').doc(messageId);
        try {
            const isAdmin = currentUser.email === 'iverrum@gmail.com';
            const doc = await messageRef.get();
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–æ–º –ò–õ–ò –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
            if (doc.exists && (doc.data().authorId === currentUser.uid || isAdmin)) {
                await messageRef.update({
                    text: newText,
                    editedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                closeModal('editMessageModal');
            } else {
                throw new Error("Permission denied or message not found.");
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            showError(_chat('error_save_message_failed'));
        }
    }



    function showReactionPicker(messageId, buttonElement) {
            // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É–¥–∞–ª—è–µ–º –ª—é–±—ã–µ —Å—Ç–∞—Ä—ã–µ –ø–∏–∫–µ—Ä—ã
            document.querySelectorAll('.reaction-picker, .full-reaction-picker').forEach(p => p.remove());

            const picker = document.createElement('div');
            picker.className = 'reaction-picker';
            
            // 1. –°–ù–ê–ß–ê–õ–ê –û–ë–™–Ø–í–õ–Ø–ï–ú –§–£–ù–ö–¶–ò–Æ –ó–ê–ö–†–´–¢–ò–Ø
            // –¢–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Å–æ–∑–¥–∞–¥–∏–º –Ω–∏–∂–µ, –±—É–¥—É—Ç –æ –Ω–µ–π –∑–Ω–∞—Ç—å.
            const closePickerOnClickOutside = function(event) {
                if (document.body.contains(picker) && !picker.contains(event.target)) {
                    picker.remove();
                    window.removeEventListener('click', closePickerOnClickOutside);
                }
            };
            
            // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–µ–∞–∫—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const quickEmojis = getQuickReactions();
            
            // 2. –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —ç–º–æ–¥–∑–∏
            quickEmojis.forEach(emoji => {
                const span = document.createElement('span');
                span.textContent = emoji;
                span.onclick = (e) => {
                    e.stopPropagation();
                    window.removeEventListener('click', closePickerOnClickOutside); // –£–±–∏—Ä–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å
                    picker.remove();
                    toggleReaction(messageId, emoji);
                };
                picker.appendChild(span);
            });

            // 3. –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É "+" –∏ –µ–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –∫–æ—Ç–æ—Ä—ã–π —Ç–µ–ø–µ—Ä—å –≤–∏–¥–∏—Ç 'closePickerOnClickOutside'
            const addButton = document.createElement('button');
            addButton.textContent = 'Ôºã';
            addButton.className = 'reaction-picker-add-btn';
            addButton.title = _chat('tooltip_choose_reaction');
            addButton.onclick = (e) => {
                e.stopPropagation();

                // 1. –°–ù–ê–ß–ê–õ–ê –ø–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–Ω–æ–ø–∫–∏, –ü–û–ö–ê –æ–Ω–∞ –µ—â–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ.
                const buttonRect = addButton.getBoundingClientRect();

                // 2. –¢–µ–ø–µ—Ä—å —É–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏ —Å–∞–º—É –ø–∞–Ω–µ–ª—å.
                window.removeEventListener('click', closePickerOnClickOutside);
                picker.remove();

                // 3. –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–∫–∞–∑–∞ –Ω–æ–≤–æ–≥–æ –ø–∏–∫–µ—Ä–∞, –Ω–æ –ø–µ—Ä–µ–¥–∞–µ–º –µ–π —É–∂–µ
                // —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –∞ –Ω–µ —Å–∞–º—É –∫–Ω–æ–ø–∫—É, –∫–æ—Ç–æ—Ä–æ–π –±–æ–ª—å—à–µ –Ω–µ—Ç.
                showFullReactionPicker(messageId, buttonRect);
            };
            picker.appendChild(addButton);

            document.body.appendChild(picker);

            // --- –ù–ê–ß–ê–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø: –£–º–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ---
            const btnRect = buttonElement.getBoundingClientRect();
            const pickerRect = picker.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const margin = 8; // –ù–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞–µ–≤ —ç–∫—Ä–∞–Ω–∞

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ (–≤–≤–µ—Ä—Ö –∏–ª–∏ –≤–Ω–∏–∑ –æ—Ç –∫–Ω–æ–ø–∫–∏)
            let topPos = btnRect.top - pickerRect.height - margin;
            if (topPos < margin) { 
                topPos = btnRect.bottom + margin; 
            }

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
            let leftPos = btnRect.left;

            // –ü–†–û–í–ï–†–ö–ê –ü–†–ê–í–û–ì–û –ö–†–ê–Ø: –µ—Å–ª–∏ –ø–∏–∫–µ—Ä –≤—ã–ª–µ–∑–∞–µ—Ç —Å–ø—Ä–∞–≤–∞...
            if (leftPos + pickerRect.width > viewportWidth - margin) {
                // ...—Ç–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –µ–≥–æ –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é –∫–Ω–æ–ø–∫–∏.
                leftPos = btnRect.right - pickerRect.width;
            }

            // –ü–†–û–í–ï–†–ö–ê –õ–ï–í–û–ì–û –ö–†–ê–Ø: –µ—Å–ª–∏ –ø–∏–∫–µ—Ä –≤—ã–ª–µ–∑–∞–µ—Ç —Å–ª–µ–≤–∞...
            if (leftPos < margin) {
                // ...—Ç–æ –ø—Ä–∏–∂–∏–º–∞–µ–º –µ–≥–æ –∫ –ª–µ–≤–æ–º—É –∫—Ä–∞—é —ç–∫—Ä–∞–Ω–∞ —Å –æ—Ç—Å—Ç—É–ø–æ–º.
                leftPos = margin;
            }

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            picker.style.top = `${topPos}px`;
            picker.style.left = `${leftPos}px`;
            // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---


            // 4. –ò —Ç–æ–ª—å–∫–æ —Ç–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –≤—Å–µ –≥–æ—Ç–æ–≤–æ, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏–µ
            setTimeout(() => window.addEventListener('click', closePickerOnClickOutside), 0);
        }




    /**
     * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø–∏–∫–µ—Ä —ç–º–æ–¥–∑–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–æ–≤–æ–π —Ä–µ–∞–∫—Ü–∏–∏.
     * @param {string} messageId - ID —Å–æ–æ–±—â–µ–Ω–∏—è, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ä–µ–∞–∫—Ü–∏—è.
     * @param {DOMRect} positionRect - –û–±—ä–µ–∫—Ç —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏, –≥–¥–µ —Ä–∞–Ω–µ–µ –Ω–∞—Ö–æ–¥–∏–ª–∞—Å—å –∫–Ω–æ–ø–∫–∞ "+".
     */
    function showFullReactionPicker(messageId, positionRect) {
        if (!customElements.get('emoji-picker')) {
            console.warn('Emoji picker –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
            return;
        }

        const fullPicker = document.createElement('emoji-picker');
        fullPicker.className = 'full-reaction-picker'; 

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–µ–º—É –ø–∏–∫–µ—Ä–∞
        if (document.body.classList.contains('dark-mode')) {
            fullPicker.classList.add('dark');
        } else {
            fullPicker.classList.add('light');
        }

        fullPicker.addEventListener('emoji-click', event => {
            const selectedEmoji = event.detail.unicode;
            toggleReaction(messageId, selectedEmoji);
            updateQuickReactions(selectedEmoji);
            if (fullPicker.parentNode) {
                 fullPicker.remove();
            }
        });

        // --- –ù–ê–ß–ê–õ–û –ù–û–í–û–ô –õ–û–ì–ò–ö–ò –ü–û–ó–ò–¶–ò–û–ù–ò–†–û–í–ê–ù–ò–Ø ---
        
        // 1. –î–æ–±–∞–≤–ª—è–µ–º –ø–∏–∫–µ—Ä –≤ DOM, –Ω–æ –¥–µ–ª–∞–µ–º –µ–≥–æ –Ω–µ–≤–∏–¥–∏–º—ã–º –∏ –≤—ã–Ω–æ—Å–∏–º –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —ç–∫—Ä–∞–Ω–∞.
        // –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä —Ä–∞—Å—Å—á–∏—Ç–∞–ª –µ–≥–æ —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã.
        document.body.appendChild(fullPicker);
        fullPicker.style.position = 'fixed';
        fullPicker.style.visibility = 'hidden';
        fullPicker.style.left = '-9999px';
        fullPicker.style.top = '-9999px';
        
        // 2. –¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ —Ä–∞–∑–º–µ—Ä—ã –∏–∑–≤–µ—Å—Ç–Ω—ã, –ø–æ–ª—É—á–∞–µ–º –∏—Ö.
        const pickerRect = fullPicker.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const margin = 10; // –û—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞–µ–≤

        // 3. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é, –∫–∞–∫ –º—ã —ç—Ç–æ –¥–µ–ª–∞–ª–∏ –¥–ª—è –º–∞–ª–µ–Ω—å–∫–æ–π –ø–∞–Ω–µ–ª–∏.
        // –ü–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏:
        let leftPos = positionRect.left; // –ù–∞—á–∏–Ω–∞–µ–º —Å –ø–æ–∑–∏—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏ "+"
        if (leftPos + pickerRect.width > viewportWidth - margin) {
            // –ï—Å–ª–∏ –≤—ã–ª–µ–∑–∞–µ—Ç —Å–ø—Ä–∞–≤–∞, –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é —ç–∫—Ä–∞–Ω–∞
            leftPos = viewportWidth - pickerRect.width - margin;
        }
        if (leftPos < margin) {
            // –ï—Å–ª–∏ –≤—ã–ª–µ–∑–∞–µ—Ç —Å–ª–µ–≤–∞, –ø—Ä–∏–∂–∏–º–∞–µ–º –∫ –ª–µ–≤–æ–º—É –∫—Ä–∞—é
            leftPos = margin;
        }

        // –ü–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏:
        let topPos = positionRect.bottom + margin; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π "+"
        if (topPos + pickerRect.height > viewportHeight - margin) {
            // –ï—Å–ª–∏ –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è —Å–Ω–∏–∑—É, —Å—Ç–∞–≤–∏–º –Ω–∞–¥ –∫–Ω–æ–ø–∫–æ–π
            topPos = positionRect.top - pickerRect.height - margin;
        }
         if (topPos < margin) {
            // –ï—Å–ª–∏ –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è –∏ —Å–≤–µ—Ä—Ö—É, –ø—Ä–∏–∂–∏–º–∞–µ–º –∫ –≤–µ—Ä—Ö—É —ç–∫—Ä–∞–Ω–∞
            topPos = margin;
        }

        // 4. –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã.
        fullPicker.style.left = `${leftPos}px`;
        fullPicker.style.top = `${topPos}px`;
        
        // 5. –ò —Ç–æ–ª—å–∫–æ —Ç–µ–ø–µ—Ä—å –¥–µ–ª–∞–µ–º –ø–∏–∫–µ—Ä –≤–∏–¥–∏–º—ã–º –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        fullPicker.style.visibility = 'visible';

        // --- –ö–û–ù–ï–¶ –ù–û–í–û–ô –õ–û–ì–ò–ö–ò –ü–û–ó–ò–¶–ò–û–ù–ò–†–û–í–ê–ù–ò–Ø ---

        // 6. –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–∏–∫–µ—Ä–∞
        setTimeout(() => {
            window.addEventListener('click', function closeFullPicker(e) {
                if (fullPicker.parentNode && !fullPicker.contains(e.target)) {
                    fullPicker.remove();
                    // –í–∞–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å–∞–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –≤–∏—Å–µ–ª –≤ –ø–∞–º—è—Ç–∏
                    window.removeEventListener('click', closeFullPicker);
                }
            });
        }, 0);
    }






    async function toggleReaction(messageId, emoji) {
        if (!currentUser) return;
        const messageRef = db.collection('messages').doc(messageId);
        const userId = currentUser.uid;

        try {
            await db.runTransaction(async (transaction) => {
                const doc = await transaction.get(messageRef);
                if (!doc.exists) return;

                const reactions = doc.data().reactions || {};
                
                if (reactions[emoji] && reactions[emoji].includes(userId)) {
                    // –ï—Å–ª–∏ —É–∂–µ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª - —É–±–∏—Ä–∞–µ–º —Ä–µ–∞–∫—Ü–∏—é
                    reactions[emoji] = reactions[emoji].filter(id => id !== userId);
                    if (reactions[emoji].length === 0) {
                        delete reactions[emoji]; // –£–¥–∞–ª—è–µ–º —ç–º–æ–¥–∑–∏, –µ—Å–ª–∏ –º–∞—Å—Å–∏–≤ –ø—É—Å—Ç
                    }
                } else {
                    // –ï—Å–ª–∏ –Ω–µ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª - –¥–æ–±–∞–≤–ª—è–µ–º
                    if (!reactions[emoji]) {
                        reactions[emoji] = [];
                    }
                    reactions[emoji].push(userId);
                }
                transaction.update(messageRef, { reactions: reactions });
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Ä–µ–∞–∫—Ü–∏–∏:', error);
        }
    }
        
    async function deleteMessage(messageId) {
        if (!currentUser || !db) return;

        if (confirm(_chat('confirm_delete_message'))) {
            const messageRef = db.collection('messages').doc(messageId);
            try {
                const isAdmin = currentUser.email === 'iverrum@gmail.com';
                const doc = await messageRef.get();
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–æ–º –ò–õ–ò –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
                if (doc.exists && (doc.data().authorId === currentUser.uid || isAdmin)) {
                    await messageRef.delete();
                } else {
                    throw new Error("Permission denied or message not found.");
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                showError(_chat('error_delete_message_failed'));
            }
        }
    }
 
    async function deleteQuestion(questionId) {
        if (!currentUser || !db) return;

        if (confirm(_chat('confirm_delete_question'))) {
            const questionRef = db.collection('questions').doc(questionId);
            try {
                const isAdmin = currentUser.email === 'iverrum@gmail.com';
                const doc = await questionRef.get();
                if (doc.exists && (doc.data().authorId === currentUser.uid || isAdmin)) {
                    await questionRef.delete();
                } else {
                     throw new Error("Permission denied or question not found.");
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞:', error);
                showError(_chat('error_delete_question_failed'));
            }
        }
    }



    // --- –í–°–¢–ê–í–¨–¢–ï –ö–û–î –ü–ê–†–°–ï–†–ê –°–Æ–î–ê ---
    /**
     * –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø–∞—Ä—Å–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–ª–æ–∫–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ –æ–¥–Ω–æ–º —Ç–µ–∫—Å—Ç–µ.
     * @param {string} content - –¢–µ–∫—Å—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ .qst.
     * @returns {Array<Object>} - –ú–∞—Å—Å–∏–≤ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤.
     */
    function parseMultipleQstBlocks(content) {
        let questions = [];
        let currentQuestionData = null;
        const lines = content.split(/\r?\n/);

        for (const line of lines) {
            const trimmedLine = line.trim();
            if (trimmedLine.startsWith('?')) {
                // –ï—Å–ª–∏ –º—ã –Ω–∞—à–ª–∏ –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å, —Å–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
                if (currentQuestionData && currentQuestionData.options.length > 0) {
                    questions.push(currentQuestionData);
                }
                // –ù–∞—á–∏–Ω–∞–µ–º —Å–æ–±–∏—Ä–∞—Ç—å –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å
                currentQuestionData = { 
                    text: trimmedLine.substring(1).trim(), 
                    options: [], 
                    correctAnswerIndex: -1
                };
            } else if ((trimmedLine.startsWith('+') || trimmedLine.startsWith('-')) && currentQuestionData) {
                // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ –∫ –¢–ï–ö–£–©–ï–ú–£ –≤–æ–ø—Ä–æ—Å—É
                const isCorrect = trimmedLine.startsWith('+');
                const optionText = trimmedLine.substring(1).trim();
                currentQuestionData.options.push({ text: optionText, isCorrect: isCorrect });
                if (isCorrect && currentQuestionData.correctAnswerIndex === -1) {
                    currentQuestionData.correctAnswerIndex = currentQuestionData.options.length - 1;
                }
            } else if (trimmedLine !== '' && currentQuestionData) {
                // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ –ø—É—Å—Ç–∞—è –∏ –Ω–µ –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ - —ç—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞
                currentQuestionData.text += " " + trimmedLine;
            }
        }

        // –ù–µ –∑–∞–±—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–∞–º—ã–π –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ü–∏–∫–ª–∞
        if (currentQuestionData && currentQuestionData.options.length > 0) {
            questions.push(currentQuestionData);
        }

        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤ –≤—Å–µ—Ö –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
        return questions;
    }




    async function createQuestionFromMessage(rawText) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à –Ω–æ–≤—ã–π –ø–∞—Ä—Å–µ—Ä –∏ –∑–¥–µ—Å—å!
        const questionsToCreate = parseMultipleQstBlocks(rawText);

        if (questionsToCreate.length === 0) {
            showError(_chat('question_format_unrecognized'));
            return;
        }

        try {
            // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
            for (const question of questionsToCreate) {
                // 1. –°–æ–∑–¥–∞–µ–º —Å–∞–º –≤–æ–ø—Ä–æ—Å –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ 'questions'
                const questionPayload = {
                    text: question.text,
                    options: question.options,
                    authorId: currentUser.uid,
                    authorName: currentUser.displayName || currentUser.email || '–ê–Ω–æ–Ω–∏–º',
                    channelId: currentChannel,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                const newQuestionRef = await db.collection('questions').add(questionPayload);

                // 2. –°–æ–∑–¥–∞–µ–º –¥–ª—è –Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ-—Å—Å—ã–ª–∫—É –≤ —á–∞—Ç–µ
                const questionLinkMessage = {
                    authorId: currentUser.uid,
                    authorName: currentUser.displayName || currentUser.email || '–ê–Ω–æ–Ω–∏–º',
                    channelId: currentChannel,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'question_link',
                    questionId: newQuestionRef.id,
                    text: question.text
                };
                await db.collection('messages').add(questionLinkMessage);
            }
             alert(`${_chat('questions_added_from_chat_success')} ${questionsToCreate.length}`);

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            showError(_chat('error_create_question_failed'));
        }
    }

    // --- –ó–ê–ú–ï–ù–ò–¢–ï –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ ---
    async function createQuestion() {
        const rawText = document.getElementById('questionTextInput').value.trim();
        if (!rawText || !currentUser || !db) return;

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à –Ω–æ–≤—ã–π –º–æ—â–Ω—ã–π –ø–∞—Ä—Å–µ—Ä
        const questionsToCreate = parseMultipleQstBlocks(rawText);

        if (questionsToCreate.length === 0) {
            showError(_chat('error_question_parse_failed_detailed'));
            return;
        }

        try {
            // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –ø—Ä–æ–º–∏—Å–æ–≤ –¥–ª—è –≤—Å–µ—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
            const creationPromises = questionsToCreate.map(q => {
                const questionPayload = {
                    text: q.text,
                    options: q.options,
                    authorId: currentUser.uid,
                    authorName: currentUser.displayName || currentUser.email || '–ê–Ω–æ–Ω–∏–º',
                    channelId: currentChannel,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                return db.collection('questions').add(questionPayload);
            });
            
            // –ñ–¥–µ–º, –ø–æ–∫–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã
            await Promise.all(creationPromises);
            
            alert(`${_chat('questions_added_success')} ${questionsToCreate.length}`);
            document.getElementById('questionTextInput').value = '';
            closeModal('questionCreateModal');

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤:', error);
            showError(_chat('error_create_question_failed'));
        }
    }

    async function voteForOption(questionId, optionIndex) {
        if (!currentUser || !db) return;

        const questionRef = db.collection('questions').doc(questionId);
        const userId = currentUser.uid;

        try {
            await db.runTransaction(async (transaction) => {
                const doc = await transaction.get(questionRef);
                if (!doc.exists) throw "–í–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω!";

                const questionData = doc.data();
                if (!Array.isArray(questionData.options)) return;
                
                // –°–æ–∑–¥–∞–µ–º –≥–ª—É–±–æ–∫—É—é –∫–æ–ø–∏—é –º–∞—Å—Å–∏–≤–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                const newOptions = JSON.parse(JSON.stringify(questionData.options));
                const option = newOptions[optionIndex];

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                if (!Array.isArray(option.votedBy)) {
                    option.votedBy = [];
                }

                const voteIndex = option.votedBy.indexOf(userId);

                if (voteIndex > -1) {
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª - —É–¥–∞–ª—è–µ–º –µ–≥–æ –≥–æ–ª–æ—Å
                    option.votedBy.splice(voteIndex, 1);
                } else {
                    // –ï—Å–ª–∏ –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª - –¥–æ–±–∞–≤–ª—è–µ–º
                    option.votedBy.push(userId);
                }

                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ –æ–±—Ä–∞—Ç–Ω–æ
                transaction.update(questionRef, { options: newOptions });
            });
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏:", error);
            showError(_chat('error_vote_failed'));
        }
    }

    async function voteForFavoriteOption(favoriteId, optionIndex) {
        if (!currentUser || !db) return;

        const favoriteRef = db.collection('favorites').doc(favoriteId);
        const userId = currentUser.uid;

        try {
            await db.runTransaction(async (transaction) => {
                const doc = await transaction.get(favoriteRef);
                if (!doc.exists) throw "–ò–∑–±—Ä–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!";

                const favoriteData = doc.data();
                const questionContent = favoriteData.content;
                if (!Array.isArray(questionContent.options)) return;
                
                const newOptions = JSON.parse(JSON.stringify(questionContent.options));
                const option = newOptions[optionIndex];

                if (!Array.isArray(option.votedBy)) {
                    option.votedBy = [];
                }

                const voteIndex = option.votedBy.indexOf(userId);

                if (voteIndex > -1) {
                    option.votedBy.splice(voteIndex, 1);
                } else {
                    option.votedBy.push(userId);
                }

                transaction.update(favoriteRef, { 'content.options': newOptions });
            });
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º:", error);
            showError(_chat('error_vote_favorite_failed') + " " + error);
        }
    }
        
    async function addToFavorites(itemObject, type) { 
        if (!currentUser || !db) {
            showError(_chat('add_to_favorites_auth_required'));
            openAuthModal(); 
            return;
        }
        try {
            // --- –ù–ê–ß–ê–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---
            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Firestore
            const favorite = {
                userId: currentUser.uid,
                content: itemObject, // –°–æ–¥–µ—Ä–∂–∏–º–æ–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–∏—à–ª–æ –≤ —Ñ—É–Ω–∫—Ü–∏—é
                type: type,          // –¢–∏–ø —ç–ª–µ–º–µ–Ω—Ç–∞ ('question')
                createdAt: firebase.firestore.FieldValue.serverTimestamp() // –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
            };
            // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---

            await db.collection('favorites').add(favorite); // –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç
            alert(_chat('add_to_favorites_success'));

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ:', error);
            showError(_chat('error_add_to_favorites_failed'));
        }
    }

    
    async function removeFromFavorites(favoriteId) {
        if (!currentUser || !db) return;
        
        try {
            await db.collection('favorites').doc(favoriteId).delete();
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥, —á—Ç–æ–±—ã —ç–ª–µ–º–µ–Ω—Ç –∏—Å—á–µ–∑
            loadFavorites();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', error);
            showError(_chat('error_remove_from_favorites_failed'));
        }
    }
    
    // ========== CHANNELS & PRESENCE ==========
    function setupPresenceSystem() {
        if (!currentUser || !db) return;
        const presenceRef = db.collection('presence').doc(currentUser.uid);
        const heartbeat = () => presenceRef.update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(console.error);
        presenceRef.set({ online: true, lastSeen: firebase.firestore.FieldValue.serverTimestamp(), username: currentUser.displayName || currentUser.email, uid: currentUser.uid })
            .then(() => {
                if (heartbeatInterval) clearInterval(heartbeatInterval);
                heartbeatInterval = setInterval(heartbeat, 30000);
            });
        window.addEventListener('beforeunload', () => {
            if (!currentUser) return;
            presenceRef.update({ online: false });
            clearInterval(heartbeatInterval);
        });
        if (presenceListener) presenceListener();
        presenceListener = db.collection('presence').onSnapshot(snapshot => {
            const now = Date.now();
            onlineUsers.clear();
            snapshot.forEach(doc => {
                const data = doc.data();
                const lastSeenDate = data.lastSeen?.toDate();
                if (data.online && lastSeenDate && (now - lastSeenDate.getTime() < 60000)) {
                    onlineUsers.set(doc.id, data);
                }
            });
            updateOnlineUsersList();
            if(currentTab === 'users') loadUsers(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
        });
    }

    function cleanupPresenceSystem() {
        if (presenceListener) presenceListener();
        if (heartbeatInterval) clearInterval(heartbeatInterval);
        if (pmUnreadListener) pmUnreadListener(); // <-- –î–û–ë–ê–í–õ–ï–ù–û
        if (publicUnreadListener) publicUnreadListener(); // <-- –î–û–ë–ê–í–õ–ï–ù–û
        onlineUsers.clear();
        updateOnlineUsersList();
    }



    function updateOnlineUsersList() {
        if (!onlineUsersList) return;
        onlineUsersList.innerHTML = '';
        if (tabCounters['online']) tabCounters['online'].textContent = onlineUsers.size;

        if (onlineUsers.size === 0) {
            onlineUsersList.innerHTML = `<div style="padding: 10px; text-align: center; color: var(--secondary-text-color);">${_chat('chat_online_list_empty')}</div>`;
            return;
        }
        onlineUsers.forEach(userData => {
            const userEl = document.createElement('div');
            userEl.className = 'online-user';
            userEl.innerHTML = `<span class="status-indicator online"></span><span class="username" title="${escapeHTML(userData.username)}">${escapeHTML(userData.username)}</span>`;
            onlineUsersList.appendChild(userEl);
        });
    }



    function initializeDataListeners() {
        if (!currentUser || !db) return;

        console.log("–ó–∞–ø—É—Å–∫ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π –¥–∞–Ω–Ω—ã—Ö...");

        // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤
        db.collection('questions')
          .where('channelId', '==', currentChannel) // –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–Ω–∞–ª–∞
          .onSnapshot(snapshot => {
              updateTabCounter('questions', snapshot.size);
          }, err => console.error("–û—à–∏–±–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤:", err));

        // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
        db.collection('favorites')
          .where('userId', '==', currentUser.uid)
          .onSnapshot(snapshot => {
              updateTabCounter('favorites', snapshot.size);
          }, err => console.error("–û—à–∏–±–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:", err));

        // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —É–∂–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ, –∏—Ö —Ç—Ä–æ–≥–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ.
    }

    function renderChannelsList() {
        if(!channelsList) return;
        channelsList.innerHTML = '';
        channels.forEach(channel => {
            const isOwner = channel.createdBy === currentUser.uid;
            const channelEl = document.createElement('div');
            // –î–æ–±–∞–≤–ª—è–µ–º data-–∞—Ç—Ä–∏–±—É—Ç –¥–ª—è –ª–µ–≥–∫–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
            channelEl.dataset.channelId = channel.id; // <-- –î–û–ë–ê–í–õ–ï–ù–û
            channelEl.className = `channel-item ${channel.id === currentChannel && currentChannelType === 'public' ? 'active' : ''}`;

            const lockIcon = channel.hasPassword ? 'üîí ' : '';
            const settingsIcon = isOwner ? `<button class="channel-settings-btn" onclick="event.stopPropagation(); ChatModule.showChannelEditModal('${channel.id}')">‚öôÔ∏è</button>` : '';
            const unreadCount = unreadCounts.get(channel.id) || 0; // <-- –î–û–ë–ê–í–õ–ï–ù–û

            // –î–æ–±–∞–≤–ª—è–µ–º HTML –¥–ª—è —Å—á–µ—Ç—á–∏–∫–∞
            channelEl.innerHTML = `
                <span class="channel-name">${lockIcon}# ${escapeHTML(channel.name)}</span>
                <span class="unread-channel-badge ${unreadCount > 0 ? '' : 'hidden'}">${unreadCount}</span>
                ${settingsIcon}
            `; // <-- –ò–ó–ú–ï–ù–ï–ù–û

            channelEl.addEventListener('click', () => handleChannelClick(channel));
            channelsList.appendChild(channelEl);
        });
    }

    async function loadPrivateChats() {
        if (!db || !currentUser) return;
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (!userDoc.exists) return;

        const userData = userDoc.data();
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∞ –ø–æ—Ç–æ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ –±–µ—Ä–µ–º –ø–æ–ª–µ.
        // –ï—Å–ª–∏ –ø–æ–ª—è privateChatPartners –Ω–µ—Ç, partnerIds —Å—Ç–∞–Ω–µ—Ç –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º [].
        const partnerIds = userData?.privateChatPartners || []; 

        // --- –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ö–û–î–ê ---

        // 1. –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –ø—Ä–æ–º–∏—Å–æ–≤, —á—Ç–æ–±—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –ø–æ–ª—É—á–∏—Ç—å –¥–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        const privateChatsPromises = partnerIds.map(async (partnerId) => {
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–∞–º–æ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ (–∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ)
            let partnerData = allUsers.get(partnerId);
            if (!partnerData) {
                const partnerDoc = await db.collection('users').doc(partnerId).get();
                if (partnerDoc.exists) partnerData = partnerDoc.data();
            }
            if (!partnerData) return null; // –ï—Å–ª–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –Ω–µ –Ω–∞—à–ª–∏, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º

            // 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID –ª–∏—á–Ω–æ–≥–æ —á–∞—Ç–∞
            const channelId = `private_${[currentUser.uid, partnerId].sort().join('_')}`;

            // 3. –ù–∞—Ö–æ–¥–∏–º –ü–û–°–õ–ï–î–ù–ï–ï —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —ç—Ç–æ–º —á–∞—Ç–µ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –µ–≥–æ –≤—Ä–µ–º—è
            const messagesQuery = await db.collection('messages')
                .where('channelId', '==', channelId)
                .orderBy('createdAt', 'desc')
                .limit(1)
                .get();

            let lastMessageTimestamp = null;
            if (!messagesQuery.empty) {
                // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –µ—Å—Ç—å, –±–µ—Ä–µ–º –≤—Ä–µ–º—è —Å–∞–º–æ–≥–æ –Ω–æ–≤–æ–≥–æ
                lastMessageTimestamp = messagesQuery.docs[0].data().createdAt;
            }

            // 4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∏ –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞, –∏ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            return { ...partnerData, lastMessageTimestamp };
        });

        // –ñ–¥–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        let fetchedChats = await Promise.all(privateChatsPromises);

        // –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º –ø—É—Å—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–µ—Å–ª–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏)
        fetchedChats = fetchedChats.filter(chat => chat !== null);

        // 5. –°–û–†–¢–ò–†–£–ï–ú —á–∞—Ç—ã: —É –∫–æ–≥–æ –Ω–æ–≤–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —Ç–æ—Ç –≤—ã—à–µ
        fetchedChats.sort((a, b) => {
            const timeA = a.lastMessageTimestamp ? a.lastMessageTimestamp.toMillis() : 0;
            const timeB = b.lastMessageTimestamp ? b.lastMessageTimestamp.toMillis() : 0;
            return timeB - timeA; // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é (–Ω–æ–≤–æ–µ –≤–≤–µ—Ä—Ö—É)
        });

        privateChats = fetchedChats;

        // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ö–û–î–ê ---

        renderPrivateChatsList();
    }

     function renderPrivateChatsList() {
        if (!privateChatsList) return;
        privateChatsList.innerHTML = '';
        privateChats.forEach(chatPartner => {
            const channelId = `private_${[currentUser.uid, chatPartner.uid].sort().join('_')}`;
            const chatEl = document.createElement('div');
            
            chatEl.dataset.channelId = channelId; // <--- –î–û–ë–ê–í–õ–ï–ù–û: –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º ID –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å—á–µ—Ç—á–∏–∫–∞

            chatEl.className = `channel-item ${channelId === currentChannel && currentChannelType === 'private' ? 'active' : ''}`;
            const isOnline = onlineUsers.has(chatPartner.uid);
            const unreadCount = unreadCounts.get(channelId) || 0; // <--- –î–û–ë–ê–í–õ–ï–ù–û: –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—á–µ—Ç—á–∏–∫

            // –ò–ó–ú–ï–ù–ï–ù–û: –î–æ–±–∞–≤–ª—è–µ–º HTML-—ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å—á–µ—Ç—á–∏–∫–∞
            chatEl.innerHTML = `
                <span class="status-indicator ${isOnline ? 'online' : ''}" style="margin-right: 8px;"></span>
                <span class="channel-name">${escapeHTML(chatPartner.username)}</span>
                <span class="unread-channel-badge ${unreadCount > 0 ? '' : 'hidden'}">${unreadCount}</span>
            `;

            chatEl.addEventListener('click', () => switchToChannel(channelId, chatPartner.username, 'private'));
            privateChatsList.appendChild(chatEl);
        });
    }
   
 
    function switchToChannel(channelId, channelName, type = 'public') {

        if (lastMessageObserver) lastMessageObserver.disconnect();

        // –î–µ–π—Å—Ç–≤–∏–µ ‚Ññ2: –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∫–∞–Ω–∞–ª–∞
        const channelNameEl = document.getElementById('currentChannelName');
        if (channelNameEl) {
            const prefix = type === 'public' ? '# ' : '@ ';
            channelNameEl.textContent = `${prefix}${channelName}`;
        }

        // –î–µ–π—Å—Ç–≤–∏–µ ‚Ññ3: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –Ω–∞–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –º–µ–Ω—è—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç
        if (currentChannel !== channelId) {
            // –ï—Å–ª–∏ –º—ã –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –î–†–£–ì–û–ô –∫–∞–Ω–∞–ª:
            currentChannel = channelId;
            currentChannelType = type;
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞
            loadMessages();
        }

        // –î–µ–π—Å—Ç–≤–∏–µ ‚Ññ4: –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–°–æ–æ–±—â–µ–Ω–∏—è"
        // –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏.
        // –§—É–Ω–∫—Ü–∏—è switchTab —Å–∞–º–∞ –ø–æ–∑–∞–±–æ—Ç–∏—Ç—Å—è –æ —Ç–æ–º, —á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∞—Ç—å –ª–∏—à–Ω–µ–π —Ä–∞–±–æ—Ç—ã.
        switchTab('messages');
        renderChannelsList();
        renderPrivateChatsList();
    }
    
    function loadChannels() {
        if (!db) return;
        db.collection('channels').orderBy('createdAt').onSnapshot(snapshot => {
            channels = [];
            snapshot.forEach(doc => channels.push({ id: doc.id, ...doc.data() }));
            renderChannelsList();
            if (channels.length === 0) createDefaultChannel();
        });
    }

    async function showChannelEditModal(channelId) { 
        const channel = channels.find(c => c.id === channelId);
        if (!channel) return;

        document.getElementById('editChannelId').value = channel.id;
        document.getElementById('editChannelNameInput').value = channel.name;
        document.getElementById('editChannelDescInput').value = channel.description || '';
        document.getElementById('editChannelPasswordInput').value = ''; 

        const membersSection = document.getElementById('channelMembersSection');
        const membersList = document.getElementById('channelMembersList');
        membersList.innerHTML = `<li>${_chat('channel_members_loading')}</li>`; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏

        if (channel.members && channel.members.length > 0) {
            membersSection.classList.remove('hidden');
            const memberItems = await Promise.all(channel.members.map(async (memberId) => {
                if (memberId === channel.createdBy) return ''; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞

                let memberData = allUsers.get(memberId);
                if (!memberData) {
                    const doc = await db.collection('users').doc(memberId).get();
                    if (doc.exists) memberData = doc.data();
                }

                if (memberData) {
                    return `<li>
                                <span>${escapeHTML(memberData.username)}</span>
                                <button class="kick-btn" onclick="ChatModule.removeUserFromChannel('${channel.id}', '${memberId}')">${_chat('kick_user_button')}</button>
                            </li>`
                }
                return '';
            }));
            membersList.innerHTML = memberItems.join('');
        } else {
            membersSection.classList.add('hidden');
        }
        
        showModal('channelEditModal');
    }


    async function removeUserFromChannel(channelId, userId) {
        if (!confirm(_chat('chat_kick_user_confirm'))) return;
        try {
            const channelRef = db.collection('channels').doc(channelId);
            await channelRef.update({
                members: firebase.firestore.FieldValue.arrayRemove(userId)
            });
            
            await showChannelEditModal(channelId);
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞:", error);
            showError(_chat('chat_kick_user_fail'));
        }
    }


    async function saveChannelEdit() {
        const channelId = document.getElementById('editChannelId').value;
        const newName = document.getElementById('editChannelNameInput').value.trim();
        const newDesc = document.getElementById('editChannelDescInput').value.trim();
        const newPassword = document.getElementById('editChannelPasswordInput').value;

        if (!channelId || !newName) {
            alert(_chat('channel_name_empty'));
            return;
        }

        const updates = {
            name: newName,
            description: newDesc
        };

        if (newPassword) {
            updates.hasPassword = true;
            updates.passwordHash = await hashPassword(newPassword);
        } else {
            updates.hasPassword = false;
            updates.passwordHash = null;
        }

        try {
            await db.collection('channels').doc(channelId).update(updates);
            closeModal('channelEditModal');
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞:", error);
            alert(_chat('error_save_channel_failed'));
        }
    }




    async function deleteChannel() {
        const channelId = document.getElementById('editChannelId').value;
        if (!channelId) return;

        if (channelId === 'general') {
            alert(_chat('chat_cannot_delete_general_alert'));
            return;
        }

        if (confirm(_chat('confirm_delete_channel'))) {
            const channelRef = db.collection('channels').doc(channelId);
            try {
                const isAdmin = currentUser.email === 'iverrum@gmail.com';
                const doc = await channelRef.get();
                if (doc.exists && (doc.data().createdBy === currentUser.uid || isAdmin)) {
                    await channelRef.delete();
                    closeModal('channelEditModal');
                    if (currentChannel === channelId) {
                        const generalChannel = channels.find(c => c.id === 'general');
                        if(generalChannel) handleChannelClick(generalChannel);
                    }
                } else {
                    throw new Error("Permission denied or channel not found.");
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞:", error);
                alert(_chat('chat_delete_channel_fail_alert'));
            }
        }
    }



    
    function createDefaultChannel() {
        if (!currentUser) return;
        
        db.collection('channels').doc('general').set({
            name: _chat('default_channel_name'),
            description: _chat('default_channel_desc'),
            createdBy: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            hasPassword: false // <-- –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º
        });
    }

    // --- –ù–ê–ß–ê–õ–û: –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–∞–±–æ—Ç—ã —Å –ø–∞—Ä–æ–ª—è–º–∏ ---
    async function hashPassword(password) {
        if (!password) return null;
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hashBuffer = await window.crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex;
    }

    async function handleChannelClick(channel) {
        // --- –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ö–û–î–ê ---

        // –§—É–Ω–∫—Ü–∏—è-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –∫–∞–Ω–∞–ª –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ —É—á–∞—Å—Ç–Ω–∏–∫–∏
        const enterChannel = async () => {
            // –†–ï–®–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ ‚Ññ2: –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—Ä–∏ –≤—Ö–æ–¥–µ
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª –∏ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ —É—á–∞—Å—Ç–Ω–∏–∫
            if (channel.id !== 'general' && (!channel.members || !channel.members.includes(currentUser.uid))) {
                try {
                    const channelRef = db.collection('channels').doc(channel.id);
                    await channelRef.update({
                        members: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                    });
                    console.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${currentUser.displayName} –¥–æ–±–∞–≤–ª–µ–Ω –≤ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–∞–Ω–∞–ª–∞ "${channel.name}"`);
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —É—á–∞—Å—Ç–Ω–∏–∫–∏:", error);
                }
            }
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –∫–∞–Ω–∞–ª
            switchToChannel(channel.id, channel.name, 'public');
        };

        // –ï—Å–ª–∏ –∫–∞–Ω–∞–ª –∑–∞—â–∏—â–µ–Ω –ø–∞—Ä–æ–ª–µ–º
        if (channel.hasPassword) {
            // –†–ï–®–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ ‚Ññ1: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å–µ –µ—â–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–º
            const isMember = channel.members && channel.members.includes(currentUser.uid);

            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï —É—á–∞—Å—Ç–Ω–∏–∫ (–∏–ª–∏ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ—Ç), —Ç–æ –∫–ª—é—á –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω
            if (!isMember) {
                // –ï—Å–ª–∏ –æ–Ω –±—ã–ª —É–¥–∞–ª–µ–Ω, –Ω–æ –∫–ª—é—á –æ—Å—Ç–∞–ª—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ - –∞–Ω–Ω—É–ª–∏—Ä—É–µ–º –∫–ª—é—á
                if (unlockedChannels.has(channel.id)) {
                    unlockedChannels.delete(channel.id);
                    localStorage.setItem(`unlockedChannels_${currentUser.uid}`, JSON.stringify(Array.from(unlockedChannels)));
                    console.log(`–õ–æ–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –∫–∞–Ω–∞–ª–∞ "${channel.name}" –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω, —Ç–∞–∫ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª —É–¥–∞–ª–µ–Ω.`);
                }
            }

            // –¢–µ–ø–µ—Ä—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –∫–∞–Ω–∞–ª –≤—Å–µ –µ—â–µ –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–∞—Ä–æ–ª—å
            if (!unlockedChannels.has(channel.id)) {
                            const password = prompt(_chatFormat('channel_enter_password_prompt', {
                                channelName: channel.name
                            }));
                if (password === null) return;

                const enteredPasswordHash = await hashPassword(password);
                if (enteredPasswordHash === channel.passwordHash) {
                    // –ï—Å–ª–∏ –ø–∞—Ä–æ–ª—å –≤–µ—Ä–Ω—ã–π, —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∏ –≤—Ö–æ–¥–∏–º
                    unlockedChannels.add(channel.id);
                    localStorage.setItem(`unlockedChannels_${currentUser.uid}`, JSON.stringify(Array.from(unlockedChannels)));
                    await enterChannel();
                } else {
                    alert(_chat('invalid_channel_password'));
                }
            } else {
                // –ï—Å–ª–∏ –∫–ª—é—á –µ—Å—Ç—å –∏ –æ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å–µ –µ—â–µ —É—á–∞—Å—Ç–Ω–∏–∫), –ø—Ä–æ—Å—Ç–æ –≤—Ö–æ–¥–∏–º
                await enterChannel();
            }
        } else {
            // –ï—Å–ª–∏ –∫–∞–Ω–∞–ª –ø—É–±–ª–∏—á–Ω—ã–π (–±–µ–∑ –ø–∞—Ä–æ–ª—è), –ø—Ä–æ—Å—Ç–æ –≤—Ö–æ–¥–∏–º
            await enterChannel();
        }
        // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ö–û–î–ê ---
    }
    

    async function createChannel() {
        const name = document.getElementById('channelNameInput').value.trim();
        const description = document.getElementById('channelDescInput').value.trim();
        const password = document.getElementById('channelPasswordInput').value;
        const isForTesting = document.getElementById('channelIsForTesting').checked;
        
        if (!name) {
            alert(_chat('chat_channel_name_empty_alert'));
            return;
        }

        const passwordHash = await hashPassword(password);
        
        try {
            await db.collection('channels').add({
                name: name,
                description: description,
                createdBy: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                hasPassword: !!password,
                passwordHash: passwordHash,
                isForTesting: isForTesting
            });
            
            closeModal('channelCreateModal');
            document.getElementById('channelNameInput').value = '';
            document.getElementById('channelDescInput').value = '';
            document.getElementById('channelPasswordInput').value = '';
            document.getElementById('channelIsForTesting').checked = false;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞:', error);
            showError(_chat('chat_create_channel_fail_alert'));
        }
    }



    // ========== UI HELPERS ==========
    function showModal(modalId) {
        document.getElementById(modalId)?.classList.remove('hidden');
    }
    
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
        }

        // --- –ù–ê–ß–ê–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---
        // –ï—Å–ª–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∏–º–µ–Ω–Ω–æ –æ–∫–Ω–æ —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –ò–ò,
        // —É–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å, –±–ª–æ–∫–∏—Ä—É—é—â–∏–π –ø—Ä–æ–∫—Ä—É—Ç–∫—É.
        if (modalId === 'aiExplanationModal') {
            document.body.classList.remove('chat-open');
        }
        // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---
    }
    



    // –ó–ê–ú–ï–ù–ò–¢–ï –í–°–Æ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–û–¢ –ö–û–î
    function showEmojiPicker() {
        const emojiBtn = document.getElementById('emojiBtn');
        if (!emojiBtn) return;

        if (!customElements.get('emoji-picker')) {
            console.warn('Emoji picker –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
            return;
        }

        // --- –ù–ê–ß–ê–õ–û –ù–û–í–û–ô, –ù–ê–î–ï–ñ–ù–û–ô –õ–û–ì–ò–ö–ò ---

        const existingPicker = document.querySelector('emoji-picker.main-input-picker');
        // 1. –ï—Å–ª–∏ –ø–∏–∫–µ—Ä —É–∂–µ –æ—Ç–∫—Ä—ã—Ç, –º—ã –µ–≥–æ –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º –∏ –≤—ã—Ö–æ–¥–∏–º.
        // –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ "–≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å".
        if (existingPicker) {
            existingPicker.remove();
            return;
        }

        // 2. –°–æ–∑–¥–∞–µ–º –ù–û–í–´–ô —ç–ª–µ–º–µ–Ω—Ç –ø–∏–∫–µ—Ä–∞ –ö–ê–ñ–î–´–ô —Ä–∞–∑ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏.
        const picker = document.createElement('emoji-picker');
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å, —á—Ç–æ–±—ã –ª–µ–≥–∫–æ –µ–≥–æ –Ω–∞—Ö–æ–¥–∏—Ç—å
        picker.classList.add('main-input-picker'); 

        picker.addEventListener('emoji-click', event => {
            insertEmoji(event.detail.unicode);
            // –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Å–º–∞–π–ª–∏–∫–∞ –ø–∏–∫–µ—Ä –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –∑–∞–∫—Ä—ã—Ç—å
            if (picker.parentNode) {
                picker.remove();
            }
        });

        // 3. –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à—É –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        document.body.appendChild(picker);
        picker.style.visibility = 'hidden';
        picker.style.position = 'fixed';
        picker.style.left = '-9999px';
        picker.style.top = '-9999px';

        const pickerRect = picker.getBoundingClientRect();
        const btnRect = emojiBtn.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const margin = 10;

        let leftPos = btnRect.left + (btnRect.width / 2) - (pickerRect.width / 2);
        if (leftPos < margin) leftPos = margin;
        if (leftPos + pickerRect.width > viewportWidth - margin) {
            leftPos = viewportWidth - pickerRect.width - margin;
        }

        let topPos = btnRect.top - pickerRect.height - margin;
        if (topPos < margin) {
            topPos = btnRect.bottom + margin;
        }

        picker.style.top = `${topPos}px`;
        picker.style.left = `${leftPos}px`;
        
        if (document.body.classList.contains('dark-mode')) {
            picker.classList.add('dark');
        } else {
            picker.classList.add('light');
        }

        picker.style.visibility = 'visible';
        picker.classList.add('visible');

        // 4. –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –£–î–ê–õ–Ø–¢–¨ –ø–∏–∫–µ—Ä –ø—Ä–∏ –∫–ª–∏–∫–µ —Å–Ω–∞—Ä—É–∂–∏.
        const closeOnClickOutside = (e) => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–∏–∫–µ—Ä –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∫–ª–∏–∫ –±—ã–ª –Ω–µ –ø–æ –Ω–µ–º—É –∏ –Ω–µ –ø–æ –∫–Ω–æ–ø–∫–µ
            if (document.body.contains(picker) && !picker.contains(e.target) && !emojiBtn.contains(e.target)) {
                picker.remove(); // <-- –°–ê–ú–û–ï –ì–õ–ê–í–ù–û–ï: –ü–û–õ–ù–û–ï –£–î–ê–õ–ï–ù–ò–ï
                // –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–±–∏—Ä–∞–µ–º —Å–∞–º —Å–ª—É—à–∞—Ç–µ–ª—å, —á—Ç–æ–±—ã –æ–Ω –Ω–µ "–≤–∏—Å–µ–ª" –≤ –ø–∞–º—è—Ç–∏
                window.removeEventListener('click', closeOnClickOutside);
            }
        };
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å
        setTimeout(() => {
            window.addEventListener('click', closeOnClickOutside);
        }, 0);
    }
    



    function insertEmoji(emoji) {
        if (!chatInput) return;
        
        const start = chatInput.selectionStart;
        const end = chatInput.selectionEnd;
        chatInput.value = chatInput.value.substring(0, start) + emoji + chatInput.value.substring(end);
        chatInput.selectionStart = chatInput.selectionEnd = start + emoji.length;
        
        chatInput.focus();
    }
    


    
    
    function clearChatData() {
        // –û–ß–ò–©–ê–ï–ú –•–†–ê–ù–ò–õ–ò–©–ï –ü–†–ò –í–´–•–û–î–ï
        if (currentUser) {
            localStorage.removeItem(`unlockedChannels_${currentUser.uid}`);
        }

        allMessages = [];
        channels = [];
        privateChats = [];
        unlockedChannels.clear(); // <-- –î–û–ë–ê–í–õ–ï–ù–û: –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
        if (messageArea) messageArea.innerHTML = `<div class="empty-state">${_chat('auth_required_to_view')}</div>`;
        Object.keys(TABS).forEach(tabId => {
            if(tabCounters[tabId]) updateTabCounter(tabId, 0);
        });
    }


    
    function scrollToBottom() { if (messageArea) messageArea.scrollTop = messageArea.scrollHeight; }
    
    function escapeHTML(str) { 
        const div = document.createElement('div'); 
        div.textContent = str; return div.innerHTML; 
    }

    async function deleteAccount() {
        if (!currentUser) return;

        if (!confirm(_chat('confirm_delete_account'))) {
            return;
        }

        const password = prompt(_chat('reauth_prompt'));
        if (password === null || password === "") {
            alert(_chat('reauth_cancelled'));
            return;
        }

        console.log(`–ù–∞—á–∞–ª–æ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${currentUser.uid}`);
        const deleteButton = document.getElementById('deleteAccountBtn');
        if (deleteButton) {
            deleteButton.disabled = true;
            deleteButton.textContent = _chat('deleting_account_status');
        }
        
        try {
            const userId = currentUser.uid;
            
            const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, password);
            await currentUser.reauthenticateWithCredential(credential);
            console.log("–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ.");

            await db.collection('users').doc(userId).delete();
            console.log(`–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId} —É–¥–∞–ª–µ–Ω –∏–∑ Firestore.`);

            await currentUser.delete();
            console.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —É–¥–∞–ª–µ–Ω –∏–∑ Firebase Auth.`);

            alert(_chat('delete_account_success'));
            
            ChatModule.closeModal('profileEditModal');
            ChatModule.closeChatModal();

        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞:", error);
            let errorMessage = _chat('error_generic');
            
            if (error.code === 'auth/wrong-password') {
                errorMessage = _chat('reauth_wrong_password');
            } else if (error.code === 'auth/requires-recent-login') {
                errorMessage += ' –î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–µ–¥–∞–≤–Ω–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–π–¥–∏—Ç–µ –∏ –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.';
            }
            
            alert(errorMessage);
        } finally {
            if (deleteButton) {
                deleteButton.disabled = false;
                deleteButton.textContent = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
            }
        }
    }



    // --- –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ö–û–î–ê: –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ñ–∞–π–ª–æ–≤ –≤ —á–∞—Ç–µ ---

    function handleChatFileUploadTrigger() {
        document.getElementById('chatFileInput')?.click();
    }

    function handleChatFileSelected(event) {
        const file = event.target.files[0];
        if (!file) return;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
        const allowedExtensions = ['.qst', '.txt'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        if (!allowedExtensions.includes(fileExtension)) {
            alert(_chat('error_upload_file_type'));
            return;
        }

        const reader = new FileReader();
        reader.onload = async (e) => {
            const fileContent = e.target.result;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.classList.add('loading');
            sendBtn.innerHTML = ''; 

            try {
                // 1. –ü–∞—Ä—Å–∏–º —Ñ–∞–π–ª, —á—Ç–æ–±—ã –ø–æ—Å—á–∏—Ç–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã
                const questions = window.mainApp.parseQstContent(fileContent);
                const questionCount = questions.length;

                // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                const response = await fetch(googleAppScriptUrl, {
                    method: 'POST',
                    mode: 'no-cors', // –í–∞–∂–Ω–æ –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS
                    body: JSON.stringify({
                        action: 'chatFileUpload',
                        fileName: file.name,
                        content: fileContent
                    })
                });

                // –¢–∞–∫ –∫–∞–∫ mode='no-cors', –º—ã –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞–ø—Ä—è–º—É—é.
                // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ, –¥–µ–ª–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å ID —Ñ–∞–π–ª–∞.
                // –≠—Ç–æ –æ–±—Ö–æ–¥–Ω–æ–π –ø—É—Ç—å –¥–ª—è Google Apps Script.
                 setTimeout(async () => {
                    try {
                        const checkResponse = await fetch(`${googleAppScriptUrl}?action=getChatFileInfoByName&fileName=${encodeURIComponent(file.name)}`);
                        const fileData = await checkResponse.json();
                        
                        if(fileData.success && fileData.fileId){
                            // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ñ–∞–π–ª–µ
                            await sendFileMessage(file.name, fileData.fileId, questionCount);
                        } else {
                            throw new Error(fileData.error || _chat('error_fetch_file_id_failed'));
                        }
                    } catch(error) {
                        console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è ID —Ñ–∞–π–ª–∞: ", error);
                        showError(_chat('error_upload_failed'));
                    } finally {
                        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                        sendBtn.disabled = false;
                        sendBtn.classList.remove('loading');
                        sendBtn.innerHTML = '‚û§';
                    }
                }, 2000); // –î–∞–µ–º —Å–µ—Ä–≤–µ—Ä—É –≤—Ä–µ–º—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞ —á–∞—Ç–∞:', error);
                showError(_chat('error_file_process_failed'));
                sendBtn.disabled = false;
                sendBtn.classList.remove('loading');
                sendBtn.innerHTML = '‚û§';
            }
        };
        reader.readAsText(file, 'UTF-8');

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–Ω–ø—É—Ç–∞, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª –µ—â–µ —Ä–∞–∑
        event.target.value = '';
    }

    async function sendFileMessage(fileName, fileId, questionCount) {
        if (!currentUser || !db) return;

        const message = {
            authorId: currentUser.uid,
            authorName: currentUser.displayName || currentUser.email || '–ê–Ω–æ–Ω–∏–º',
            channelId: currentChannel,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            type: 'file_share', // –ù–æ–≤—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è
            fileInfo: {
                id: fileId,
                name: fileName,
                questions: questionCount
            }
        };

        await db.collection('messages').add(message);
    }


// script.js

    function showFileActionsModal(fileId, fileName, isTestingChannel = false) {
        document.getElementById('fileActionsModalTitle').textContent = `${_chat('file_actions_modal_title')} ${decodeURIComponent(fileName)}`;

        const downloadBtn = document.getElementById('fileActionDownloadBtn');
        const testBtn = document.getElementById('fileActionTestBtn');
        const modalButtonsContainer = testBtn.parentElement;
        const closeBtn = modalButtonsContainer.querySelector('button[onclick*="closeModal"]');

        // –£–¥–∞–ª—è–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Å—Ç–∞–ª–∞—Å—å —Å –ø—Ä–æ—à–ª–æ–≥–æ —Ä–∞–∑–∞
        const oldPracticeBtn = document.getElementById('fileActionPracticeTestBtn');
        if (oldPracticeBtn) {
            oldPracticeBtn.remove();
        }

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Ä—è–¥–æ–∫ –∫–Ω–æ–ø–æ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω)
        modalButtonsContainer.insertBefore(downloadBtn, closeBtn);
        modalButtonsContainer.insertBefore(testBtn, closeBtn);


        if (isTestingChannel) {
            // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –î–õ–Ø –ö–ê–ù–ê–õ–û–í –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø ---
            
            // 1. –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–±–Ω—ã–π —Ç–µ—Å—Ç"
            const practiceTestBtn = document.createElement('button');
            practiceTestBtn.id = 'fileActionPracticeTestBtn';
            practiceTestBtn.textContent = _chat('practice_test_button');
            practiceTestBtn.onclick = () => startTestFromShare(fileId, fileName, { isPractice: true });

            // 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç" (–æ—Å–Ω–æ–≤–Ω–∞—è)
            testBtn.textContent = _chat('official_test_button'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –∫–ª—é—á –±–µ–∑ —Å–∫–æ–±–æ–∫
            testBtn.onclick = () => startTestFromShare(fileId, fileName, { isPractice: false });

            // 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–û–†–Ø–î–û–ö:
            // –í—Å—Ç–∞–≤–ª—è–µ–º "–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç" –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–æ–π "–û—Ç–º–µ–Ω–∞"
            modalButtonsContainer.insertBefore(testBtn, closeBtn); 
            // –í—Å—Ç–∞–≤–ª—è–µ–º "–ü—Ä–æ–±–Ω—ã–π —Ç–µ—Å—Ç" –ø–æ—Å–ª–µ "–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç"
            modalButtonsContainer.insertBefore(practiceTestBtn, closeBtn);
            // –í—Å—Ç–∞–≤–ª—è–µ–º "–°–∫–∞—á–∞—Ç—å" –ø–æ—Å–ª–µ "–ü—Ä–æ–±–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞"
            modalButtonsContainer.insertBefore(downloadBtn, closeBtn);

        } else {
            // --- –õ–û–ì–ò–ö–ê –î–õ–Ø –û–ë–´–ß–ù–´–• –ö–ê–ù–ê–õ–û–í ---
            // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –æ–±—â–∏–π –∫–ª—é—á 'file_actions_test' –≤–º–µ—Å—Ç–æ 'practice_test_button'
            testBtn.textContent = _chat('file_actions_test'); 
            testBtn.onclick = () => startTestFromShare(fileId, fileName, { isPractice: true });
        }
        
        downloadBtn.onclick = () => downloadSharedFile(fileId, fileName);
        
        showModal('fileActionsModal');
    }



    async function downloadSharedFile(fileId, fileName) {
        try {
            closeModal('fileActionsModal');
            const url = `${googleAppScriptUrl}?action=getChatFileContent&fileId=${fileId}`;
            const response = await fetch(url);
            const data = await response.json();
            if (!data.success) throw new Error(data.error);

            await window.mainApp.downloadOrShareFile(fileName, data.content, 'text/plain;charset=utf-8', _chat('share_title_generic_file'));
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ –∏–∑ —á–∞—Ç–∞:', error);
            alert(_chat('chat_file_download_failed').replace('{error}', error.message));
        }
    }



    async function startTestFromShare(fileId, fileName, options = { isPractice: true }) {
         try {
            closeModal('fileActionsModal');
            ChatModule.closeChatModal();

            window.mainApp.showGlobalLoader(`${_chat('global_loader_loading_test')} "${decodeURIComponent(fileName)}"...`);

            const url = `${googleAppScriptUrl}?action=getChatFileContent&fileId=${fileId}`;
            const response = await fetch(url);
            const data = await response.json();
            if (!data.success) throw new Error(data.error);
            
            // --- –ù–û–í–´–ô –ö–û–î ---
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∑–∞–ø–∏—Å–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            const quizContext = {
                fileId: fileId,
                channelId: currentChannel,
                isPractice: options.isPractice
            };
            // –ü–µ—Ä–µ–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Ä–µ–∂–∏–º –≤ —Å–ª–µ–¥—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é
            window.mainApp.processFile(decodeURIComponent(fileName), data.content, quizContext);
            // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ö–û–î–ê ---

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–∞ –∏–∑ —á–∞—Ç–∞:', error);
            window.mainApp.hideGlobalLoader();
            alert(_chat('error_start_test_failed').replace('{error}', error.message));
        }
    }



    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ö–û–î
    async function uploadFileToServer(fileName, fileContent, url) {
        if (!fileName || !fileContent) {
            console.warn("–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª. –û—Ç–º–µ–Ω–µ–Ω–æ.");
            return;
        }
        if (!url) {
            console.error("URL –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω. –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.");
            return;
        }

        console.log(`–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–∞ "${fileName}" `);

        try {
            const payload = {
                action: 'saveToArchive', // <-- –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –°–¢–†–û–ö–£
                fileName: fileName,
                content: fileContent,
                isQstValid: true
            };

            const response = await fetch(url, {
                method: 'POST',
                mode: 'no-cors',
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            console.log("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω");

        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞:", error);
        }
    }




    function toggleNotifications() {
        notificationsEnabled = !notificationsEnabled;

        const notificationBtn = document.getElementById('notificationToggle');
        if (notificationBtn) {
            notificationBtn.classList.toggle('active', notificationsEnabled);
            notificationBtn.title = notificationsEnabled ? _chat('notifications_title_enabled') : _chat('notifications_title_disabled');
        }

        alert(notificationsEnabled ? _chat('notifications_enabled') : _chat('notifications_disabled'));
        console.log(`–°—Ç–∞—Ç—É—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: ${notificationsEnabled}`);
    }


    function showNotification(playSound) {
        if (!notificationsEnabled) return;

        if (document.hidden) {
            try {
                if (playSound) {
                    const sound = document.getElementById('notificationSound');
                    if (sound) {
                        sound.currentTime = 0;
                        sound.play().catch(e => console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è."));
                    }
                }

                unreadMessageCount++;
                document.title = `(${unreadMessageCount}) ${_chat('notification_new_message')}`;
            } catch(e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:", e);
            }
        }
    }

    function setupVisibilityListener() {
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                if (unreadMessageCount > 0) {
                    unreadMessageCount = 0;
                    setTimeout(() => {
                        document.title = originalTitle;
                    }, 2000);
                }
            }
        });
    }

    async function togglePinMessage(messageId) {
        if (!db || !currentUser) return;

        const messageRef = db.collection('messages').doc(messageId);
        try {
            const doc = await messageRef.get();
            if (!doc.exists) return;

            const isCurrentlyPinned = doc.data().isPinned || false;
            await messageRef.update({
                isPinned: !isCurrentlyPinned
            });
            console.log(`–°–æ–æ–±—â–µ–Ω–∏–µ ${messageId} ${!isCurrentlyPinned ? '–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ' : '–æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–æ'}`);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            showError(_chat('error_pin_message_failed'));
        }
    }

    function togglePinnedModeView() {
        isPinnedMode = !isPinnedMode;
        
        const toggleBtn = document.getElementById('togglePinnedBtn');
        if (toggleBtn) {
            toggleBtn.classList.toggle('active', isPinnedMode);
            toggleBtn.title = isPinnedMode ? _chat('chat_show_all_messages') : _chat('chat_show_pinned_messages');
        }

        displayMessages();
    }




    /**
     * –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø
     * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º –ø–µ—Ä–µ–≤–æ–¥–∞ —á–∞—Ç–∞ –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è.
     */
    function toggleChatTranslation() {
        isChatTranslateModeEnabled = !isChatTranslateModeEnabled;
        const toggleBtn = getEl('chatTranslateBtn');
        if (toggleBtn) {
            toggleBtn.classList.toggle('active', isChatTranslateModeEnabled);
            toggleBtn.title = isChatTranslateModeEnabled 
                ? _chat('chat_translate_button_title_on') 
                : _chat('chat_translate_button_title_off');
        }
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Å–µ –≤–∏–¥–∏–º—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        displayMessages();
    }


    async function fetchAndCacheTranslation(message) {
        if (!message.text || !message.text.trim()) return;

        const lang = localStorage.getItem('appLanguage') || 'ru';
        
        // –ò–°–ü–û–õ–¨–ó–£–ï–ú –ù–û–í–£–Æ –í–ù–£–¢–†–ï–ù–ù–Æ–Æ –§–£–ù–ö–¶–ò–Æ
        const cacheKey = getChatCacheKey(message.id, lang);
        
        try {
            const response = await fetch(googleAppScriptUrl, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'translateText',
                    text: message.text,
                    targetLang: lang
                })
            });
            const result = await response.json();
            if (result.success) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∫–ª—é—á–æ–º
                chatTranslations.set(cacheKey, result.translatedText);
                
                const messageEl = getEl(`message-${message.id}`);
                const contentEl = messageEl?.querySelector('.message-content');
                if (contentEl) {
                    // 1. –°–Ω–∞—á–∞–ª–∞ —É–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å "–º–æ—Ä–≥–∞–Ω–∏—è".
                    // –≠—Ç–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç –∞–Ω–∏–º–∞—Ü–∏—é "–Ø —Ä–∞–±–æ—Ç–∞—é..."
                    contentEl.classList.remove('translating');

                    // 2. –í—ã–∑—ã–≤–∞–µ–º "—É–º–Ω—É—é" –∞–Ω–∏–º–∞—Ü–∏—é —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ –∏–∑ mainApp.
                    //    –≠—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç –∞–Ω–∏–º–∞—Ü–∏—é "–í–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç!".
                    //    message.text - —ç—Ç–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç.
                    //    result.translatedText - —ç—Ç–æ —Ç–µ–∫—Å—Ç, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.
                    await window.mainApp.animateTextTransformation(contentEl, message.text, result.translatedText);
                }
            } else {
                throw new Error(result.error);
            }

        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ${message.id}:`, error);
            chatTranslations.set(cacheKey, _chat('chat_translation_failed'));
            const messageEl = getEl(`message-${message.id}`);
            const contentEl = messageEl?.querySelector('.message-content');
            if (contentEl) {
                contentEl.textContent = _chat('chat_translation_failed');
                contentEl.classList.add('translation-error');
                contentEl.classList.remove('translating');
            }
        }
    }


    
    // === –ù–ê–ß–ê–õ–û –ù–û–í–´–• –§–£–ù–ö–¶–ò–ô –î–õ–Ø –ö–ù–û–ü–û–ö ===
    
    function setupTabActions(tabId) {
        const container = document.getElementById('tabActionsContainer');
        if (!container) return;
        
        container.innerHTML = ''; 
        container.classList.remove('hidden');
    
        if (tabId === 'questions' || tabId === 'favorites') {
            const downloadQstBtn = document.createElement('button');
            downloadQstBtn.textContent = _chat('download_qst_button'); // –ò–ó–ú–ï–ù–ï–ù–û
            downloadQstBtn.onclick = () => handleDownload(tabId, 'qst');
            container.appendChild(downloadQstBtn);
    
            const downloadTxtBtn = document.createElement('button');
            downloadTxtBtn.textContent = _chat('download_txt_button'); // –ò–ó–ú–ï–ù–ï–ù–û
            downloadTxtBtn.onclick = () => handleDownload(tabId, 'txt');
            container.appendChild(downloadTxtBtn);
        }
    
        if (tabId === 'favorites') {
            const clearBtn = document.createElement('button');
            clearBtn.textContent = _chat('clear_favorites_button'); // –ò–ó–ú–ï–ù–ï–ù–û
            clearBtn.classList.add('btn-danger'); 
            clearBtn.onclick = () => clearAllFavorites();
            container.appendChild(clearBtn);
        }
    }





    async function handleDownload(dataType, format) {
        if (!currentUser) {
            alert(_chat('error_download_auth_required'));
            return;
        }
        
        let itemsToProcess = [];
        const fileName = `${dataType}_${new Date().toISOString().slice(0, 10)}`;

        try {
            if (dataType === 'favorites') {
                const snapshot = await db.collection('favorites').where('userId', '==', currentUser.uid).get();
                itemsToProcess = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return { ...data.content, type: data.type };
                });

            } else if (dataType === 'questions') {
                const snapshot = await db.collection('questions').where('channelId', '==', currentChannel).get();
                itemsToProcess = snapshot.docs.map(doc => ({ id: doc.id, type: 'question', ...doc.data() }));
            }

            if (itemsToProcess.length === 0) {
                alert(`–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤ —Ä–∞–∑–¥–µ–ª–µ "${dataType}".`);
                return;
            }

            let fileContent = '';
            if (format === 'qst') {
                fileContent = itemsToProcess.map(item => {
                    let qstBlock = `? ${item.text || ''}\n`;
                    if (item.type === 'question' && item.options) {
                        item.options.forEach(opt => {
                            qstBlock += `${opt.isCorrect ? '+' : '-'} ${opt.text}\n`;
                        });
                    } else { 
                        qstBlock += `+ ${item.text || ''}\n`;
                    }
                    return qstBlock;
                }).join('\n');
            } else { // txt format
                fileContent = itemsToProcess.map(item => {
                    if (item.type === 'question' && item.options) {
                        const correctAnswer = item.options.find(opt => opt.isCorrect)?.text || 'N/A';
                        return `${_chat('download_file_question_label')}: ${item.text}\n${_chat('download_file_answer_label')}: ${correctAnswer}\n`;
                    } else {
                        return `${_chat('download_file_message_label')}: ${item.text}\n`;
                    }
                }).join('----------------------------------\n');
            }



            const fullFileName = `${fileName}.${format}`;
            const shareTitle = dataType === 'favorites' ? _chat('share_title_favorites') : _chat('share_title_questions');
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            if (window.mainApp && typeof window.mainApp.downloadOrShareFile === 'function') {
                console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏–∑ —á–∞—Ç–∞');
                await window.mainApp.downloadOrShareFile(fullFileName, fileContent, 'text/plain;charset=utf-8', shareTitle);
            } else {
                console.warn('–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback');
                // Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É
                if (window.mainApp && typeof window.mainApp.downloadFile === 'function') {
                    window.mainApp.downloadFile(fullFileName, fileContent, 'text/plain;charset=utf-8');
                } else {
                    alert(_chat('error_download_system_unavailable'));
                }
            }

        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –¥–ª—è ${dataType}:`, error);
            alert(_chat('error_download_failed'));
        }
    }
    



    async function clearAllFavorites() {
        if (!currentUser || !db) return;
    
        if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.")) {
            return;
        }
    
        try {
            const querySnapshot = await db.collection('favorites')
                .where('userId', '==', currentUser.uid)
                .get();
    
            if (querySnapshot.empty) {
                alert(_chat('chat_favorites_empty_to_clear'));
                return;
            }
    
            const batch = db.batch();
            querySnapshot.docs.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
    
            alert("–ò–∑–±—Ä–∞–Ω–Ω–æ–µ —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω–æ.");
            loadFavorites(); 
    
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:", error);
            showError(_chat('error_clear_favorites_failed'));
        }
    }



    async function copyQuestionAsQst(questionObject) {
        if (!questionObject || !questionObject.text || !Array.isArray(questionObject.options)) {
            console.error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞.");
            return;
        }

        // 1. –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ .qst —Ñ–æ—Ä–º–∞—Ç
        let qstContent = `? ${questionObject.text}\n`;
        questionObject.options.forEach(opt => {
            qstContent += `${opt.isCorrect ? '+' : '-'} ${opt.text}\n`;
        });

        // 2. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ mainApp
        try {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à—É –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            await window.mainApp.copyToClipboardMain(qstContent);
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –≤—Å—Ç—Ä–æ–µ–Ω–æ –≤ copyToClipboardMain
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞:', error);
            alert(_chat('error_copy_question_failed'));
        }
    }


    function showAISummaryModal(title, content) {
        getEl('aiSummaryModalTitle').textContent = title;
        const outputEl = getEl('aiSummaryOutput');

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É marked –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        if (window.marked) {
            outputEl.innerHTML = marked.parse(content);
        } else {
            outputEl.textContent = content;
        }
        
        showModal('aiSummaryModal');
    }



    async function showTestResults(fileId, channelId) {
        const modalTitle = document.getElementById('testResultsModalTitle');
        const tableContainer = document.getElementById('testResultsTableContainer');
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á –ø–µ—Ä–µ–≤–æ–¥–∞ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
        modalTitle.textContent = _chat('results_modal_title');
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï ‚Ññ1: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è "–ó–∞–≥—Ä—É–∑–∫–∏"
        tableContainer.innerHTML = `<div class="loading-placeholder">${_chat('loading_messages')}</div>`;
        showModal('testResultsModal');

        try {
            const querySnapshot = await db.collection('testResults')
                .where('fileId', '==', fileId)
                .where('channelId', '==', channelId)
                .orderBy('accuracy', 'desc')
                .get();
                
            if (querySnapshot.empty) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á –ø–µ—Ä–µ–≤–æ–¥–∞ –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                tableContainer.innerHTML = `<div class="results-empty-state">${_chat('chat_test_results_empty')}</div>`;
                return;
            }
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï ‚Ññ2: –°–æ–±–∏—Ä–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
            let tableHTML = `
                <table>
                    <thead>
                        <tr>                      
                            <th>${_chat('results_table_header_num')}</th>
                            <th>${_chat('results_table_header_user')}</th>
                            <th>${_chat('results_table_header_accuracy')}</th>
                            <th>${_chat('results_table_header_time')}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            querySnapshot.docs.forEach((doc, index) => {
                const result = doc.data();
                const time = result.timeSpentSeconds;
                const minutes = Math.floor(time / 60);
                const seconds = time % 60;
                const timeFormatted = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${escapeHTML(result.userName || _chat('anonymous_user'))}</td>
                        <td>${result.accuracy.toFixed(1)}%</td>
                        <td>${timeFormatted}</td>
                    </tr>
                `;
            });
            
            tableHTML += `</tbody></table>`;
            tableContainer.innerHTML = tableHTML;

        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∞:", error);
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á –ø–µ—Ä–µ–≤–æ–¥–∞ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
            tableContainer.innerHTML = `<div class="results-empty-state">${_chat('chat_test_results_loading_error')} ${error.message}</div>`;
        }
    }


    function formatMessagesForAI(messages) {
        // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç
        return messages.map(msg => {
            const author = msg.authorName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            const text = msg.text || '';
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
            if (msg.type === 'question_link' || msg.type === 'file_share') return '';
            return `${author}: ${text}`;
        }).filter(Boolean).join('\n'); // –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ —Å–æ–µ–¥–∏–Ω—è–µ–º
    }

    async function getAIChatSummary(summaryType, providedMessages = null) {
        let messagesToProcess = [];

        // –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–∞–º –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å—Ä–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏–π (–∏–∑ —Ä–µ–∂–∏–º–∞ –≤—ã–±–æ—Ä–∞)
        if (providedMessages) {
            messagesToProcess = providedMessages;
        } 
        // –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ù–∞–º –Ω—É–∂–Ω–æ –≤–∑—è—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–Ω–∞–ª–∞
        else { 
            if (allMessages.length === 0) {
                // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º—É –ø–µ—Ä–µ–≤–æ–¥–æ–≤
                alert(_chat('chat_analyze_no_messages'));
                return;
            }
            messagesToProcess = allMessages;
        }

        // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –µ–¥–∏–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ò–ò
        const messagesText = formatMessagesForAI(messagesToProcess);
        if (!messagesText) {
            // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º—É –ø–µ—Ä–µ–≤–æ–¥–æ–≤
            alert(_chat('chat_analyze_no_valid_messages'));
            return;
        }
        
        // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º—É –ø–µ—Ä–µ–≤–æ–¥–æ–≤
        mainApp.showGlobalLoader(_chat('ai_analyzing_chat'));

        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –Ω–∞—à —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
            const response = await fetch(googleAppScriptUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'getChatSummary',
                    messagesText: messagesText,
                    summaryType: summaryType.replace('summarize-', ''),
                    targetLanguage: currentChatLang
                })
            });

            const result = await response.json();

            if (result.success && result.summary) {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                let titleKey;
                if (summaryType === 'summarize-all') {
                    titleKey = 'ai_summary_title_all';
                } else { // –î–ª—è 'summarize-from-selection'
                    titleKey = 'ai_summary_title_selection';
                }
                
                showAISummaryModal(_chat(titleKey), result.summary);
            } else {
                // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º—É –ø–µ—Ä–µ–≤–æ–¥–æ–≤
                throw new Error(result.error || _chat('ai_error_summary_generic'));
            }

        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–≤–æ–¥–∫–∏ –æ—Ç –ò–ò:", error);
            
            let userFriendlyError;
            if (error.message.includes("INTERNAL") || error.message.includes("HTTP 500")) {
                userFriendlyError = _chat('ai_error_summary_server');
            } else {
                userFriendlyError = _chat('ai_error_summary_generic');
            }
            alert(userFriendlyError);
        } finally {
            mainApp.hideGlobalLoader();
        }
    }


    function startAiSummarySelection() {
        if (allMessages.length === 0) {
            alert("–í —ç—Ç–æ–º –∫–∞–Ω–∞–ª–µ –µ—â–µ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –≤—ã–±–æ—Ä–∞.");
            return;
        }
        isAiSelectionMode = true;
        getEl('aiSelectionBanner').classList.remove('hidden');
        getEl('messageArea').classList.add('selection-mode');
        
        // --- –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ö–û–î–ê: "–£–º–Ω–∞—è" –æ—Ç–º–æ—Ç–∫–∞ –Ω–∞–∑–∞–¥ ---
        // –í—ã—á–∏—Å–ª—è–µ–º, –Ω–∞ —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö (–Ω–∞ 80% –≤—ã—Å–æ—Ç—ã –≤–∏–¥–∏–º–æ–≥–æ –æ–∫–Ω–∞)
        const scrollUpAmount = messageArea.clientHeight * 0.8;
        
        // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞
        let targetScrollTop = messageArea.scrollTop - scrollUpAmount;
        
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –º—ã –Ω–µ —É—à–ª–∏ –≤ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        if (targetScrollTop < 0) {
            targetScrollTop = 0;
        }

        // –ü–ª–∞–≤–Ω–æ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏
        messageArea.scrollTo({
            top: targetScrollTop,
            behavior: 'smooth'
        });
        // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ö–û–î–ê ---
    }

    function cancelAiSummarySelection() {
        isAiSelectionMode = false;
        getEl('aiSelectionBanner').classList.add('hidden');
        getEl('messageArea').classList.remove('selection-mode');
    }



    function handleAiMessageSelection(event) {
        // –§—É–Ω–∫—Ü–∏—è —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –≤ —Ä–µ–∂–∏–º–µ –≤—ã–±–æ—Ä–∞
        if (!isAiSelectionMode) return;

        const messageElement = event.target.closest('.message');
        if (!messageElement) return;

        const messageId = messageElement.id.replace('message-', '');
        
        // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –Ω–∞—à–µ–º –º–∞—Å—Å–∏–≤–µ
        const startIndex = allMessages.findIndex(msg => msg.id === messageId);

        if (startIndex > -1) {
            // "–û—Ç—Ä–µ–∑–∞–µ–º" –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–∞—á–∏–Ω–∞—è —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ
            const messagesToProcess = allMessages.slice(startIndex);
            // –í—ã–∑—ã–≤–∞–µ–º –Ω–∞—à—É –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –Ω–æ —É–∂–µ —Å –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–º —Å—Ä–µ–∑–æ–º
            getAIChatSummary('selection', messagesToProcess);
        } else {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
        }

        // –í–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ –≤—ã–±–æ—Ä–∞
        cancelAiSummarySelection();
    }


    async function handlePasswordReset() {
        if (!auth) {
            showError(_chat('auth_system_unavailable'));
            return;
        }

        const emailInput = getEl('resetEmailInput');
        const email = emailInput.value.trim();

        if (!email) {
            showError(_chat('fill_all_fields'));
            return;
        }

        try {
            await auth.sendPasswordResetEmail(email);
            closeModal('forgotPasswordModal');
            emailInput.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
            alert(_chat('password_reset_email_sent'));
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è:", error);
            if (error.code === 'auth/user-not-found') {
                showError(_chat('error_user_not_found_for_reset'));
            } else {
                showError(getErrorMessage(error.code));
            }
        }
    }



    // ========== PUBLIC METHODS ==========
    return {
        init,
        setCurrentUser: (user) => {
            currentUser = user;
            updateUserUI();
        },

        openChatModal: () => {
            if (!chatOverlay) return;
            
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤—Ö–æ–¥–∞
            if (!currentUser) {
                openChatAfterAuth = true;
                ChatModule.openAuthModal();
                return;
            }

            document.body.classList.add('chat-open');
            
            // –ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Ç. –¢–µ–∫—Å—Ç –≤ –Ω–µ–º —É–∂–µ –±—É–¥–µ—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —è–∑—ã–∫–µ.
            chatOverlay.classList.remove('hidden');

            // –ö–ª—é—á–µ–≤–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏ –ö–ê–ñ–î–´–ô –†–ê–ó –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏.
            // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∑—è—Ç—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å –≤ —Ñ–æ–Ω–µ.
            loadTabData(currentTab); 
            if (window.mainApp) window.mainApp.manageBackButtonInterceptor();

        },

        showTestResults,

        closeChatModal: () => {
            if (chatOverlay) {
                document.body.classList.remove('chat-open');
                chatOverlay.classList.add('hidden');
            }
            if (window.mainApp) window.mainApp.manageBackButtonInterceptor();
        },
        openAuthModal: () => {
            if (authOverlay) {
                authOverlay.classList.remove('hidden');
            }
        },
        closeAuthModal: () => {
            if (authOverlay) {
                authOverlay.classList.add('hidden');
            }
        },
        

        /**
         * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —è–∑—ã–∫ –¥–ª—è –º–æ–¥—É–ª—è —á–∞—Ç–∞ –∏ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –µ–≥–æ UI,
         * –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω —Å–∫—Ä—ã—Ç.
         * @param {string} lang - –ö–æ–¥ —è–∑—ã–∫–∞ ('ru' –∏–ª–∏ 'en').
         */
        setLanguage: (lang) => {
            if (LANG_PACK_CHAT[lang]) {
                currentChatLang = lang;
                localStorage.setItem('chatLanguage', lang);
                updateChatUIText();

                // === –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ö–û–î–ê: –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ ===
                // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç —á–∞—Ç –∏ –∞–∫—Ç–∏–≤–Ω–∞ –≤–∫–ª–∞–¥–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π,
                // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏—Ö, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏–ª—Å—è –Ω–æ–≤—ã–π —è–∑—ã–∫.
                if (chatOverlay && !chatOverlay.classList.contains('hidden') && currentTab === 'messages') {
                    displayMessages();
                }
                // 
            }
        },





        // Action methods
        sendChatMessage: sendMessage,
        createChannel,
        createQuestion,
        voteForOption,
        navigateToQuestion,
        startReply, 
        cancelReply, 
        startEditMessage, 
        saveMessageEdit, 
        showReactionPicker, 
        toggleReaction, 
        scrollToMessage,
        deleteMessage,   
        deleteQuestion,
        showProfileModal, 
        saveProfile,     
        logout,           
        addToFavorites,
        removeFromFavorites,
        toggleNotifications,
        closeModal,
        deleteAccount,
        insertEmoji,
        togglePinMessage,
        showChannelEditModal,
        saveChannelEdit,
        deleteChannel,
        showUserActions,
        startPrivateChat,
        uploadFileToServer,
        removeUserFromChannel,
        copyQuestionAsQst,
        voteForFavoriteOption,
        showFileActionsModal, 
        showModal: showModal, 
        handlePasswordReset,
        closeModal: closeModal,
        
        // Getters
        isInitialized: () => isInitialized,
        getCurrentUser: () => currentUser,
        getCurrentTab: () => currentTab
    };
})();



// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
window.ChatModule = ChatModule;










const googleAppScriptUrl = 'https://script.google.com/macros/s/AKfycbyBtPbM0J91gDiuj4Ha-gTLesCMI8gSqMC3D0GYbGZ0YHIsP2mvu5ePmiftA03GLso/exec';



























// ============================================
// –û–°–ù–û–í–ù–û–ô –°–ö–†–ò–ü–¢ –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
// ============================================    

const mainApp = (function() {
    'use strict';


    const THEMES = {
        'glass-dark': { name: '–°—Ç–µ–∫–ª–æ (—Ç—ë–º–Ω–∞—è)', icon: 'üîÆ' },
        'synthwave-mode':  { name: '–ù–µ–æ–Ω', icon: 'üî≠' },
        'dark-mode':       { name: '–¢—ë–º–Ω–∞—è', icon: 'üåô' },
        'claude-mode':     { name: 'Claude', icon: 'üå§Ô∏è' },
        'light':      { name: '–°–≤–µ—Ç–ª–∞—è', icon: '‚òÄÔ∏è' }
    };

    let backButtonPressedOnce = false;

    // --- –ù–ê–ß–ê–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô ---

    // 1. –°–æ–∑–¥–∞—ë–º –µ–¥–∏–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è —è–∑—ã–∫–æ–≤, –¥–æ—Å—Ç—É–ø–Ω—ã–π –¥–ª—è –≤—Å–µ–≥–æ –º–æ–¥—É–ª—è.
    const SUPPORTED_LANGS = {
        ru: '–†—É',
        en: 'En',
        kk: '“ö–∞–∑'
    };
    // –°–æ–∑–¥–∞—ë–º –µ–¥–∏–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è –ø–æ—Ä—è–¥–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è.
    const LANG_CYCLE = ['ru', 'en', 'kk'];

    // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô ---
// --- –°–õ–û–í–ê–†–¨ –ü–ï–†–ï–í–û–î–û–í ---
    const LANG_PACK = {
        ru: {
            // –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
            exit_toast_text: '–ù–∞–∂–º–∏—Ç–µ –µ—â–µ —Ä–∞–∑ –¥–ª—è –≤—ã—Ö–æ–¥–∞',
            continue_later_button: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∑–∂–µ',
            continue_sessions: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å:',
            answered_of: '–û—Ç–≤–µ—á–µ–Ω–æ',
            from: '–∏–∑',
            time_left: '–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏',
            continue_quiz_button: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å',
            delete_session_button: '–£–¥–∞–ª–∏—Ç—å',
            search_in_db: '–ü–æ–∏—Å–∫ –≤–æ–ø—Ä–æ—Å–∞ –≤ –±–∞–∑–µ:',
            search_placeholder: '–í–≤–µ–¥–∏—Ç–µ —á–∞—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞...',
            find_button: '–ù–∞–π—Ç–∏',
            searching_in_db: '–ò–¥–µ—Ç –ø–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ...',
            or_divider: '-- –∏–ª–∏ --',
            choose_file: '–í—ã–±–µ—Ä–∏—Ç–µ .qst –ª–∏–±–æ .txt —Ñ–∞–π–ª —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:',
            gradus_button_main: 'GRADUS',
            gradus_subtitle: '(General Repository for Academic Data, Utility & Structure)',
            parser_button_main: '–ü–µ—Ä–µ–≤–µ—Å—Ç–∏',
            parser_subtitle: '—Ç–µ–∫—Å—Ç –≤ —Ñ–æ—Ä–º–∞—Ç .qst',
            recent_files: '–ù–µ–¥–∞–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ:',
            // –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏
            nav_gradus: '–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ GRADUS',
            back_to_main: '–ù–∞–∑–∞–¥ –∫ –≥–ª–∞–≤–Ω–æ–º—É —ç–∫—Ä–∞–Ω—É',
            search_results_title: '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞',
            back_to_search: '–ù–æ–≤—ã–π –ø–æ–∏—Å–∫',
            quiz_settings_title: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Å—Ç–∞',
            cheat_sheet_title: '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–ø–æ—Ä–∞:',
            quiz_finished_title: '–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!',
            parser_description: '–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç —Ç–µ—Å—Ç–∞.',
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Å—Ç–∞
            time_limit: '–õ–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏ (–º–∏–Ω—É—Ç—ã, 0 - –±–µ–∑ –ª–∏–º–∏—Ç–∞):',
            time_limit_minutes: '–º–∏–Ω',
            question_range: '–î–∏–∞–ø–∞–∑–æ–Ω –≤–æ–ø—Ä–æ—Å–æ–≤:',
            range_from: '–û—Ç',
            range_to: '–î–æ',
            total_questions_label: '–≤—Å–µ–≥–æ',
            questions_label_for_range: '–≤–æ–ø—Ä–æ—Å–æ–≤',
            shuffle_questions: '–ü–µ—Ä–µ–º–µ—à–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã',
            shuffle_answers: '–ü–µ—Ä–µ–º–µ—à–∞—Ç—å –æ—Ç–≤–µ—Ç—ã',
            feedback_mode: '–†–µ–∂–∏–º –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ (ü§ñ–ò–ò –∞–Ω–∞–ª–∏–∑ + –ø—Ä–æ–π—Ç–∏ –Ω–µ–≤–µ—Ä–Ω—ã–µ)',
            reading_mode: '–†–µ–∂–∏–º —á—Ç–µ–Ω–∏—è (–ø–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –≤–µ—Ä–Ω—ã–π)',
            start_quiz_button: '–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç',
            generate_cheat_sheet_button: '–°–æ–∑–¥–∞—Ç—å —à–ø–æ—Ä—É',
            choose_another_file_button: '–í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª',
            // –®–ø–∞—Ä–≥–∞–ª–∫–∞
            download_cheat_sheet_button: '–°–∫–∞—á–∞—Ç—å —à–ø–æ—Ä—É (.txt)',
            back_to_settings_button: '–ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º',
            // –≠–∫—Ä–∞–Ω —Ç–µ—Å—Ç–∞
            timer_label: '–í—Ä–µ–º—è:',
            prev_question_button: '–ü—Ä–µ–¥—ã–¥—É—â–∏–π',
            next_question_button: '–°–ª–µ–¥—É—é—â–∏–π',
            finish_button: '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç',
            question_label: '–í–æ–ø—Ä–æ—Å:',
            correct_label: '–ü—Ä–∞–≤–∏–ª—å–Ω–æ:',
            quick_nav_title: '–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º:',
            finish_early_button: '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç',
            // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
            your_result: '–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç:',
            of_label: '–∏–∑',
            accuracy_label: '–¢–æ—á–Ω–æ—Å—Ç—å:',
            download_errors_button: '–°–∫–∞—á–∞—Ç—å –Ω–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã–µ/–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã',
            review_errors_button: '–†–∞–±–æ—Ç–∞ –Ω–∞–¥ –æ—à–∏–±–∫–∞–º–∏',
            download_triggered_quiz_button: '–°–∫–∞—á–∞—Ç—å —Ç–µ—Å—Ç —Å —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏',
            restart_button: '–ü—Ä–æ–π—Ç–∏ –¥—Ä—É–≥–æ–π —Ç–µ—Å—Ç',
            // –ü–∞—Ä—Å–µ—Ä
            parser_upload_or_paste: '1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª (.txt) –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∏–∂–µ:',
            clear_parser_input: '–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ',
            parser_input_placeholder: '–ò–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Ç–µ–∫—Å—Ç –∏–∑ –≤–∞—à–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞...',
            parser_select_format: '2. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –¥–ª—è –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è):',
            parser_auto_detect: '-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ --',
            parser_run_button: '3. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å',
            parser_errors_found: '‚ö†Ô∏è –û—à–∏–±–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è',
            parser_result_title: '–†–µ–∑—É–ª—å—Ç–∞—Ç:',
            download_parsed_button: '–°–∫–∞—á–∞—Ç—å .qst —Ñ–∞–π–ª',
            back_button: '–ù–∞–∑–∞–¥',





            // –ö–Ω–æ–ø–∫–∏ –≤ —à–∞–ø–∫–µ (–î–û–ë–ê–í–õ–ï–ù–û –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è)
            copy_question_title: '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å',
            search_web_title: '–ù–∞–π—Ç–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ',
            chat_button_title: 'üí¨',
            quick_mode_title: '–ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º (–ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥)',
            trigger_words_title: '–¢—Ä–∏–≥–≥–µ—Ä-—Å–ª–æ–≤–∞',
            theme_button_title: 'üåó',
            language_toggle_title: '–°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫',
            favorite_button_title: '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ',
            translate_question_title: '–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å',
            // –°–æ–æ–±—â–µ–Ω–∏—è (–î–û–ë–ê–í–õ–ï–ù–û)
            search_query_too_short: '–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞.',
            file_empty_or_invalid_part1: '–§–∞–π–ª "',
            file_empty_or_invalid_part2: '" –ø—É—Å—Ç –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.',
            no_questions_for_settings: '–ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∞ —Å —Ç–µ–∫—É—â–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏.',
            confirm_finish_early: '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç –¥–æ—Å—Ä–æ—á–Ω–æ?',
            copy_button: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
            search_provider_db: "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö",
            relevance_tag: "–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å:",
            copy_button: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
            copy_question_tooltip: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å",
            favorite_question_tooltip: "–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ",

            ai_explanation_title: 'üí° –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ—Ç –ò–ò',
            ai_explanation_style_label: '–°—Ç–∏–ª—å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è:',
            ai_explain_button: '–û–±—ä—è—Å–Ω–∏—Ç—åüí°',
            ai_explanation_loading: '–ò–ò –≥–æ—Ç–æ–≤–∏—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ...',

            ai_generating_button: 'ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...',
            ai_error_text_empty: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.',
            ai_error_generation: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–∞.',
            ai_question_count_label: '4. –£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ò–ò:',
            ai_auto_mode_label: '–ê–≤—Ç–æ',
            ai_style_simple: "–ü—Ä–æ—Å—Ç–æ",
            ai_style_scientific: "–ù–∞—É—á–Ω–æ",
            ai_style_associative: "–ê–Ω–∞–ª–æ–≥–∏—è",
            ai_style_stepbystep: "–ü–æ—à–∞–≥–æ–≤–æ",
            ai_style_practical: "–ü—Ä–∞–∫—Ç–∏—á–Ω–æ",
            ai_style_visual: "–ù–∞–≥–ª—è–¥–Ω–æ",
            ai_answer_count_label: '5. –£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞:', 
            ai_auto_category_label: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', 
            exit_modal_title: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ',
            exit_modal_text: '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è?',
            exit_modal_confirm: '–í—ã–π—Ç–∏',
            exit_modal_cancel: '–û—Å—Ç–∞—Ç—å—Å—è',
            update_available_text: '–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è!',
            update_button_text: '–û–±–Ω–æ–≤–∏—Ç—å',
            ai_explain_button_title: '–û–±—ä—è—Å–Ω–∏—Ç—å —Å –ø–æ–º–æ—â—å—é –ò–ò',
            download_translated_txt_button: '–°–∫–∞—á–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥ ({lang})(txt)',
            download_translated_qst_button: '–°–∫–∞—á–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥ ({lang})(qst)',
            no_translations_to_download: '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.',
            error_creating_translation_file: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –ø–µ—Ä–µ–≤–æ–¥–∞.',
            ai_show_original_button: '–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª',
            ai_show_translation_button: '–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥',
            flashcards_mode: '–†–µ–∂–∏–º –∫–∞—Ä—Ç–æ—á–µ–∫ (–≤–æ–ø—Ä–æ—Å/–æ—Ç–≤–µ—Ç)',
            start_flashcards_button: '–ù–∞—á–∞—Ç—å –∏–∑—É—á–µ–Ω–∏–µ',
            flashcard_category_label: '–°–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª:',
            results_flashcards_viewed: '–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ –∫–∞—Ä—Ç–æ—á–µ–∫',
            session_cards_viewed: '–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ',
            ai_error_generic: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –µ—â–µ —Ä–∞–∑.',
            ai_error_server: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ: –ü—Ä–æ–∏–∑–æ—à–ª–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ.',
            parser_overwrite_warning: '–ü–æ–ª–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –µ–≥–æ?',
            ai_error_generation: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–∞.',
            ai_error_server_generation: '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–∞: –ü—Ä–æ–∏–∑–æ—à–ª–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ.',
            ai_char_limit_exceeded: '–õ–∏–º–∏—Ç —Å–∏–º–≤–æ–ª–æ–≤ –ø—Ä–µ–≤—ã—à–µ–Ω ({current}/{max})',

            tab_converter: "–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –∏–∑ —Ç–µ–∫—Å—Ç–∞",
            tab_ai_generator: "–ò–ò-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–æ —Ç–µ–º–µ",
            ai_from_text_title: "ü§ñ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç –∏–∑ –≤–∞—à–µ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–ò–ò)",
            ai_generate_from_text_button: "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç –∏–∑ —Ç–µ–∫—Å—Ç–∞",
            ai_topic_description: "–ò–ò —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞—Å—Ç —Ç–µ—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ç–µ–º—ã, –∏—Å–ø–æ–ª—å–∑—É—è —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è.",
            ai_topic_label: "1. –í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–∞:",
            ai_topic_placeholder: "–ü—Ä–∏–º–µ—Ä: –ò—Å—Ç–æ—Ä–∏—è –î—Ä–µ–≤–Ω–µ–≥–æ –†–∏–º–∞ –≤ –ø–µ—Ä–∏–æ–¥ –†–µ—Å–ø—É–±–ª–∏–∫–∏, 15 –≤–æ–ø—Ä–æ—Å–æ–≤, 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞, —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –ø–æ –≤–æ–π–Ω–∞–º...",
            ai_topic_question_count_label: "2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –≤ —Ç–µ–º–µ):",
            ai_topic_answer_count_label: "3. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –≤ —Ç–µ–º–µ):",
            ai_generate_from_topic_button: "ü§ñ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç –ø–æ —Ç–µ–º–µ (–ò–ò)",
            ai_thinking_topic: "–ò–ò-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–∞–∑–º—ã—à–ª—è–µ—Ç –Ω–∞–¥ –≤–∞—à–µ–π —Ç–µ–º–æ–π...",
            ai_topic_auto_category_label: "4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",
            parser_auto_detect: '-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ --',
            filter_variants_button: '‚öôÔ∏è –§–∏–ª—å—Ç—Ä –ø–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º',
            filter_variants_header: '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª-–≤–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:',
            filter_apply_button: '–ü—Ä–∏–º–µ–Ω–∏—Ç—å',
            filter_reset_button: '–°–±—Ä–æ—Å',
            loading_default_text: '–ó–∞–≥—Ä—É–∑–∫–∞...',
            search_no_results: '–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.',
            search_error_prefix: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:',
            gradus_loading: '–ó–∞–≥—Ä—É–∑–∫–∞...',
            gradus_folder_empty: '–ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞',
            gradus_loading_error_prefix: '–û—à–∏–±–∫–∞:',
            gradus_loading_quiz_prefix: '–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–∞',
            error_no_questions_for_cheatsheet: '–ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —à–ø–æ—Ä—ã.',
            parser_input_empty_alert: '–ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –ø—É—Å—Ç–æ–µ!',
            parser_pattern_not_found_alert: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.',
            parser_no_questions_recognized_alert: '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π.',
            parser_no_questions_with_errors_alert: '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –Ω–∏ –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞. –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –æ—à–∏–±–æ–∫: {count}.',
            parser_conversion_success_alert: '–£—Å–ø–µ—à–Ω–æ —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ {count} –≤–æ–ø—Ä–æ—Å–æ–≤!',
            parser_conversion_summary_alert: '–û–ø–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.\n\n–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {parsed}\n–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {errors}',
            ai_topic_empty_alert: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–∞.',
            ai_explanation_prepare_error: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ–∫–Ω–æ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è.',
            ai_analyzing_errors_button: '–ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç... üß†', 
            ai_error_analysis_button: 'ü§ñ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç –ò–ò',
            search_engine_google: 'Google',
            search_engine_yandex: '–Ø–Ω–¥–µ–∫—Å',
            search_engine_perplexity: 'Perplexity',
            footer_copyright: 'prod by @iverrum',
            error_no_question_to_copy: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.',
            error_no_question_to_favorite: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ.',
            error_favorites_require_auth: '–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç.',
            error_cannot_process_question: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–æ–ø—Ä–æ—Å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.',
            app_title: 'QSTiUM',
            confirm_delete_session: '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç "{fileName}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.',
            error_session_not_found: '–û—à–∏–±–∫–∞: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.',
            error_session_file_not_found: '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é. –ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ "–ù–µ–¥–∞–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö".',
            error_cheat_sheet_first: '–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —à–ø–æ—Ä—É.',
            error_download_parsed_first: '–°–Ω–∞—á–∞–ª–∞ —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª.',
            error_filter_no_variant_selected: '–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.',
            error_filter_found_mismatch: '–ù–∞–π–¥–µ–Ω–æ {count} –≤–æ–ø—Ä–æ—Å–æ–≤, –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä—É.',
            error_filter_all_match: '–í—Å–µ –≤–æ–ø—Ä–æ—Å—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∑–∞–¥–∞–Ω–Ω–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É!',
            error_download_failed_generic: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.',
            error_generic_for_alert: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', // –î–ª—è –æ–±—â–∏—Ö –∞–ª–µ—Ä—Ç–æ–≤
            copy_error: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.',
            copy_success: '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!',
            ai_explanation_question: '–í–æ–ø—Ä–æ—Å',
            ai_explanation_correct_answer: '–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç',
            feedback_correct: '–ü—Ä–∞–≤–∏–ª—å–Ω–æ!',
            feedback_incorrect: '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!',
            mobile_download_ready_title: '‚úÖ –§–∞–π–ª –≥–æ—Ç–æ–≤ –∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—é!',
            mobile_download_button: 'üì• –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª',
            mobile_download_link_info: 'üí° –°—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–Ω–∞ 1 –º–∏–Ω—É—Ç—É',
            mobile_download_fallback_title: '‚ö†Ô∏è –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±',
            mobile_download_fallback_p1: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.',
            mobile_download_fallback_p2: '–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞',
            mobile_download_copy_button: 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å',
            session_saved_success: '–¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω! –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –µ–≥–æ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç —Å –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞.',

            download_txt_question_label: '–í–æ–ø—Ä–æ—Å',
            download_txt_answer_label: '–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç',

            quick_mode_title_on: "–ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º –í–ö–õ (–ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥)",
            quick_mode_title_off: "–ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º –í–´–ö–õ (–†—É—á–Ω–æ–π –ø–µ—Ä–µ—Ö–æ–¥)",
            trigger_mode_title_on: "–¢—Ä–∏–≥–≥–µ—Ä-—Å–ª–æ–≤–∞ –í–ö–õ (–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Å–ª–æ–≤–æ –≤ –≤–æ–ø—Ä–æ—Å–µ)",
            trigger_mode_title_off: "–¢—Ä–∏–≥–≥–µ—Ä-—Å–ª–æ–≤–∞ –í–´–ö–õ",

            share_title_cheatsheet: "–®–ø–æ—Ä–∞",
            share_title_errors: "–û—à–∏–±–∫–∏",
            share_title_triggered_quiz: "–¢–µ—Å—Ç —Å —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏",
            share_title_converted_test: "–°–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç",

            error_review_questions_not_found: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ –æ—à–∏–±–∫–∞–º–∏.",
            error_flashcard_translation_failed: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –∫–∞—Ä—Ç–æ—á–∫—É. –ë—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –æ—Ä–∏–≥–∏–Ω–∞–ª.",

            error_load_file_first: "–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏.",

            manual_copy_title: "üìã –†—É—á–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ",
            manual_copy_p1: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–¥–µ–ª–∏—Ç–µ –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∏–∂–µ:",
            manual_copy_close_button: "–ó–∞–∫—Ä—ã—Ç—å",


            error_no_current_question: "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å.",
            error_session_save_failed: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ—Å—Å–∏—é. –í–æ–∑–º–æ–∂–Ω–æ, –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å –º–µ—Å—Ç–æ.",
            error_analysis_no_data: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—à–∏–±–∫–∞—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.",
            error_no_question_for_explanation: "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è.",
            error_cannot_fully_process_question: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–æ–ø—Ä–æ—Å –¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è.",

            error_download_generic_with_filename: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª "{fileName}". –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.',
            mobile_download_preparing: '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è...',

            tooltip_open_folder: '–û—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É "{name}"',
            tooltip_start_test: '–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç "{name}"',
            tooltip_load_file: '–ó–∞–≥—Ä—É–∑–∏—Ç—å {name}',

            share_title_translated_test_txt: "–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç",
            share_title_translated_test_qst: "–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç (QST)",

            error_translation_failed: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥.",
            ai_option_default: "(—Å—Ç–∞–Ω–¥–∞—Ä—Ç)",


            error_firebase_init: "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Firebase. –ß–∞—Ç –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –û—à–∏–±–∫–∞:",
            copy_success_short: '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!',
            ai_analyzing_text: "–ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–∞—à —Ç–µ–∫—Å—Ç...",

            parser_pattern_structured: "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç (1. –í–æ–ø—Ä–æ—Å, –ê) –û—Ç–≤–µ—Ç+)",
            parser_pattern_plus_at_end: "–û—Ç–≤–µ—Ç —Å '+' –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫–∏",
            parser_pattern_no_markers: "–ë–µ–∑ –º–∞—Ä–∫–µ—Ä–æ–≤ (–ø–µ—Ä–≤—ã–π –æ—Ç–≤–µ—Ç - –≤–µ—Ä–Ω—ã–π)",
            parser_pattern_numbered_plus: "–ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ (1.) —Å –æ—Ç–≤–µ—Ç–æ–º '+' –≤ –Ω–∞—á–∞–ª–µ",
            parser_pattern_plus_at_start: "–û—Ç–≤–µ—Ç —Å '+' –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏",
            parser_pattern_tags_cyrillic: "–¢–µ–≥–∏ <–í–æ–ø—Ä–æ—Å> –∏ <–≤–∞—Ä–∏–∞–Ω—Ç>",
            parser_pattern_tags_latin: "–¢–µ–≥–∏ <question> –∏ <variant>",

            shuffle_n_questions: "–°–ª—É—á–∞–π–Ω—ã–π –Ω–∞–±–æ—Ä –∏–∑"
        },
        kk: {
            exit_toast_text: '–®—ã“ì—É “Ø—à—ñ–Ω —Ç–∞“ì—ã –±—ñ—Ä —Ä–µ—Ç –±–∞—Å—ã“£—ã–∑',
            // Main Screen
            continue_later_button: '–ö–µ–π—ñ–Ω—ñ—Ä–µ–∫ –∂–∞–ª“ì–∞—Å—Ç—ã—Ä—É',
            continue_sessions: '–ñ–∞–ª“ì–∞—Å—Ç—ã—Ä—É:',
            answered_of: '–ñ–∞—É–∞–ø –±–µ—Ä—ñ–ª–¥—ñ:',
            from: ', –∂–∞–ª–ø—ã:',
            time_left: '“ö–∞–ª“ì–∞–Ω —É–∞“õ—ã—Ç',
            continue_quiz_button: '–ñ–∞–ª“ì–∞—Å—Ç—ã—Ä—É',
            delete_session_button: '–ñ–æ—é',
            search_in_db: '–î–µ—Ä–µ–∫“õ–æ—Ä–¥–∞–Ω —Å“±—Ä–∞“õ—Ç—ã —ñ–∑–¥–µ—É:',
            search_placeholder: '–°“±—Ä–∞“õ –º”ô—Ç—ñ–Ω—ñ–Ω—ñ“£ –±”©–ª—ñ–≥—ñ–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑...',
            find_button: '–Ü–∑–¥–µ—É',
            searching_in_db: '–î–µ—Ä–µ–∫“õ–æ—Ä–¥–∞–Ω —ñ–∑–¥–µ—É –∂“Ø—Ä—ñ–ø –∂–∞—Ç—ã—Ä...',
            or_divider: '-- –Ω–µ–º–µ—Å–µ --',
            choose_file: '“ö“±—Ä—ã–ª“ì—ã–¥–∞–Ω .qst –Ω–µ–º–µ—Å–µ .txt —Ñ–∞–π–ª—ã–Ω —Ç–∞“£–¥–∞“£—ã–∑:',
            gradus_button_main: 'GRADUS',
            gradus_subtitle: '(General Repository for Academic Data, Utility & Structure)',
            parser_button_main: '–ú”ô—Ç—ñ–Ω–¥—ñ',
            parser_subtitle: '.qst –ø—ñ—à—ñ–º—ñ–Ω–µ –∞—É–¥–∞—Ä—É',
            recent_files: '–ñ–∞“õ—ã–Ω–¥–∞ –ø–∞–π–¥–∞–ª–∞–Ω—ã–ª“ì–∞–Ω–¥–∞—Ä:',
            // Navigation & Headers
            nav_gradus: 'GRADUS –±–æ–π—ã–Ω—à–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏—è',
            back_to_main: '–ë–∞—Å—Ç—ã —ç–∫—Ä–∞–Ω“ì–∞ –æ—Ä–∞–ª—É',
            search_results_title: '–Ü–∑–¥–µ—É –Ω”ô—Ç–∏–∂–µ–ª–µ—Ä—ñ',
            back_to_search: '–ñ–∞“£–∞ —ñ–∑–¥–µ—É',
            quiz_settings_title: '–¢–µ—Å—Ç –±–∞–ø—Ç–∞—É–ª–∞—Ä—ã',
            cheat_sheet_title: '–î–∞–π—ã–Ω–¥–∞–ª“ì–∞–Ω —à–ø–∞—Ä–≥–∞–ª–∫–∞:',
            quiz_finished_title: '–¢–µ—Å—Ç –∞—è“õ—Ç–∞–ª–¥—ã!',
            parser_description: '–¢–µ—Å—Ç –ø—ñ—à—ñ–º—ñ–Ω–µ —Ç“Ø—Ä–ª–µ–Ω–¥—ñ—Ä—É “Ø—à—ñ–Ω —Ñ–∞–π–ª–¥—ã –∂“Ø–∫—Ç–µ“£—ñ–∑ –Ω–µ–º–µ—Å–µ –º”ô—Ç—ñ–Ω–¥—ñ “õ–æ–π—ã“£—ã–∑.',
            // Quiz Settings
            time_limit: '–£–∞“õ—ã—Ç —à–µ–∫—Ç–µ—É—ñ (–º–∏–Ω—É—Ç, 0 - —à–µ–∫—Ç–µ—É—Å—ñ–∑):',
            time_limit_minutes: '–º–∏–Ω',
            question_range: '–°“±—Ä–∞“õ—Ç–∞—Ä –∞—É“õ—ã–º—ã:',
            range_from: '–ë–∞—Å—Ç–∞–ø',
            range_to: '–î–µ–π—ñ–Ω',
            total_questions_label: '–±–∞—Ä–ª—ã“ì—ã',
            questions_label_for_range: '—Å“±—Ä–∞“õ',
            shuffle_questions: '–°“±—Ä–∞“õ—Ç–∞—Ä–¥—ã –∞—Ä–∞–ª–∞—Å—Ç—ã—Ä—É',
            shuffle_answers: '–ñ–∞—É–∞–ø—Ç–∞—Ä–¥—ã –∞—Ä–∞–ª–∞—Å—Ç—ã—Ä—É',
            feedback_mode: '–ö–µ—Ä—ñ –±–∞–π–ª–∞–Ω—ã—Å —Ä–µ–∂–∏–º—ñ (ü§ñ–ñ–ò —Ç–∞–ª–¥–∞—É—ã + “õ–∞—Ç–µ–ª–µ—Ä–º–µ–Ω –∂“±–º—ã—Å)',
            reading_mode: '–û“õ—É —Ä–µ–∂–∏–º—ñ (–±—ñ—Ä—ñ–Ω—à—ñ –∂–∞—É–∞–ø –¥“±—Ä—ã—Å)',
            start_quiz_button: '–¢–µ—Å—Ç—Ç—ñ –±–∞—Å—Ç–∞—É',
            generate_cheat_sheet_button: '–®–ø–∞—Ä–≥–∞–ª–∫–∞ –∂–∞—Å–∞—É',
            choose_another_file_button: '–ë–∞—Å“õ–∞ —Ñ–∞–π–ª —Ç–∞“£–¥–∞—É',
            // Cheat Sheet
            download_cheat_sheet_button: '–®–ø–∞—Ä–≥–∞–ª–∫–∞–Ω—ã –∂“Ø–∫—Ç–µ—É (.txt)',
            back_to_settings_button: '–ë–∞–ø—Ç–∞—É–ª–∞—Ä“ì–∞ –æ—Ä–∞–ª—É',
            // Quiz Screen
            timer_label: '–£–∞“õ—ã—Ç:',
            prev_question_button: '–ê–ª–¥—ã“£“ì—ã',
            next_question_button: '–ö–µ–ª–µ—Å—ñ',
            finish_button: '–¢–µ—Å—Ç—Ç—ñ –∞—è“õ—Ç–∞—É',
            question_label: '–°“±—Ä–∞“õ:',
            correct_label: '–î“±—Ä—ã—Å:',
            quick_nav_title: '–°“±—Ä–∞“õ—Ç–∞—Ä –±–æ–π—ã–Ω—à–∞ –∂—ã–ª–¥–∞–º ”©—Ç—É:',
            finish_early_button: '–¢–µ—Å—Ç—Ç—ñ –∞—è“õ—Ç–∞—É',
            // Results
            your_result: '–°—ñ–∑–¥—ñ“£ –Ω”ô—Ç–∏–∂–µ“£—ñ–∑:',
            of_label: '—ñ—à—ñ–Ω–µ–Ω',
            accuracy_label: '–î”ô–ª–¥—ñ–∫:',
            download_errors_button: '–ñ–∞—É–∞–ø –±–µ—Ä—ñ–ª–º–µ–≥–µ–Ω/“õ–∞—Ç–µ —Å“±—Ä–∞“õ—Ç–∞—Ä–¥—ã –∂“Ø–∫—Ç–µ—É',
            review_errors_button: '“ö–∞—Ç–µ–ª–µ—Ä–º–µ–Ω –∂“±–º—ã—Å',
            download_triggered_quiz_button: '–¢—Ä–∏–≥–≥–µ—Ä–ª–µ—Ä—ñ –±–∞—Ä —Ç–µ—Å—Ç—Ç—ñ –∂“Ø–∫—Ç–µ—É',
            restart_button: '–ë–∞—Å“õ–∞ —Ç–µ—Å—Ç ”©—Ç—É',
            // Parser
            parser_upload_or_paste: '1. –§–∞–π–ª–¥—ã (.txt) –∂“Ø–∫—Ç–µ“£—ñ–∑ –Ω–µ–º–µ—Å–µ –º”ô—Ç—ñ–Ω–¥—ñ —Ç”©–º–µ–Ω–≥–µ “õ–æ–π—ã“£—ã–∑:',
            clear_parser_input: '”®—Ä—ñ—Å—Ç—ñ —Ç–∞–∑–∞—Ä—Ç—É',
            parser_input_placeholder: '–ù–µ–º–µ—Å–µ “õ“±–∂–∞—Ç—Ç–∞“ì—ã –º”ô—Ç—ñ–Ω–¥—ñ –æ—Å—ã–Ω–¥–∞ “õ–æ–π—ã“£—ã–∑...',
            parser_select_format: '2. –ü—ñ—à—ñ–º–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑ (–Ω–µ–º–µ—Å–µ –∞–≤—Ç–æ–∞–Ω—ã“õ—Ç–∞—É “Ø—à—ñ–Ω “õ–∞–ª–¥—ã—Ä—ã“£—ã–∑):',
            parser_auto_detect: '-- –ê–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ –∞–Ω—ã“õ—Ç–∞—É --',
            parser_run_button: '3. –¢“Ø—Ä–ª–µ–Ω–¥—ñ—Ä—É',
            parser_errors_found: '‚ö†Ô∏è –ü—ñ—à—ñ–º–¥–µ—É “õ–∞—Ç–µ–ª–µ—Ä—ñ',
            parser_result_title: '–ù”ô—Ç–∏–∂–µ:',
            download_parsed_button: '.qst —Ñ–∞–π–ª—ã–Ω –∂“Ø–∫—Ç–µ—É',
            back_button: '–ê—Ä—Ç“õ–∞',
            copy_success_short: '‚úì –ö”©—à—ñ—Ä—ñ–ª–¥—ñ!',




            // Header Buttons
            copy_question_title: '–ê“ì—ã–º–¥–∞“ì—ã —Å“±—Ä–∞“õ—Ç—ã –∫”©—à—ñ—Ä—É',
            search_web_title: '–ò–Ω—Ç–µ—Ä–Ω–µ—Ç—Ç–µ–Ω —ñ–∑–¥–µ—É',
            chat_button_title: 'üí¨',
            quick_mode_title: '–ñ—ã–ª–¥–∞–º —Ä–µ–∂–∏–º (–ê–≤—Ç–æ–º–∞—Ç—Ç—ã ”©—Ç—É)',
            trigger_words_title: '–¢—Ä–∏–≥–≥–µ—Ä-—Å”©–∑–¥–µ—Ä',
            theme_button_title: 'üåó',
            language_toggle_title: '–¢—ñ–ª–¥—ñ ”©–∑–≥–µ—Ä—Ç—É',
            favorite_button_title: '–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä“ì–∞ “õ–æ—Å—É',
            translate_question_title: '–ê“ì—ã–º–¥–∞“ì—ã —Å“±—Ä–∞“õ—Ç—ã –∞—É–¥–∞—Ä—É',
            // Messages
            search_query_too_short: '–Ü–∑–¥–µ—É —Å“±—Ä–∞–Ω—ã—Å—ã –∫–µ–º—ñ–Ω–¥–µ 3 —Ç–∞“£–±–∞–¥–∞–Ω —Ç“±—Ä—É—ã –∫–µ—Ä–µ–∫.',
            file_empty_or_invalid_part1: '"',
            file_empty_or_invalid_part2: '" —Ñ–∞–π–ª—ã –±–æ—Å –Ω–µ–º–µ—Å–µ –ø—ñ—à—ñ–º—ñ –∂–∞—Ä–∞–º—Å—ã–∑.',
            no_questions_for_settings: '–ê“ì—ã–º–¥–∞“ì—ã –±–∞–ø—Ç–∞—É–ª–∞—Ä “Ø—à—ñ–Ω —Å“±—Ä–∞“õ—Ç–∞—Ä —Ç–∞–±—ã–ª–º–∞–¥—ã.',
            confirm_finish_early: '–¢–µ—Å—Ç—Ç—ñ –º–µ—Ä–∑—ñ–º—ñ–Ω–µ–Ω –±“±—Ä—ã–Ω –∞—è“õ—Ç–∞“ì—ã“£—ã–∑ –∫–µ–ª–µ—Ç—ñ–Ω—ñ–Ω–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ?',
            copy_button: "–ö”©—à—ñ—Ä—É",
            search_provider_db: "–î–µ—Ä–µ–∫“õ–æ—Ä",
            relevance_tag: "–°”ô–π–∫–µ—Å—Ç—ñ–ª—ñ–∫:",
            copy_button: "–ö”©—à—ñ—Ä—É", 
            copy_question_tooltip: "–°“±—Ä–∞“õ—Ç—ã –∫”©—à—ñ—Ä—É",
            favorite_question_tooltip: "–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä“ì–∞ “õ–æ—Å—É",

            copy_success: "–ú–∞–∑–º“±–Ω –∞–ª–º–∞—Å—É –±—É—Ñ–µ—Ä—ñ–Ω–µ –∫”©—à—ñ—Ä—ñ–ª–¥—ñ!",
            ai_explanation_title: 'üí° –ñ–ò —Ç“Ø—Å—ñ–Ω–¥—ñ—Ä–º–µ—Å—ñ',
            ai_explanation_style_label: '–¢“Ø—Å—ñ–Ω–¥—ñ—Ä—É —Å—Ç–∏–ª—ñ:',
            ai_explain_button: '–¢“Ø—Å—ñ–Ω–¥—ñ—Ä—Éüí°',
            ai_explanation_loading: '–ñ–ò —Ç“Ø—Å—ñ–Ω–¥—ñ—Ä–º–µ –¥–∞–π—ã–Ω–¥–∞—É–¥–∞...',
            ai_generating_button: 'ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...',
            ai_error_text_empty: '–¢–∞–ª–¥–∞—É “Ø—à—ñ–Ω –º”ô—Ç—ñ–Ω–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑.',
            ai_error_generation: '–¢–µ—Å—Ç –∂–∞—Å–∞—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã.',
            ai_question_count_label: '4. –ñ–ò “Ø—à—ñ–Ω —Å“±—Ä–∞“õ—Ç–∞—Ä —Å–∞–Ω—ã–Ω –∫”©—Ä—Å–µ—Ç—ñ“£—ñ–∑:',
            ai_auto_mode_label: '–ê–≤—Ç–æ',
            ai_style_simple: "“ö–∞—Ä–∞–ø–∞–π—ã–º",
            ai_style_scientific: "“í—ã–ª—ã–º–∏",
            ai_style_associative: "–ê–Ω–∞–ª–æ–≥–∏—è",
            ai_style_stepbystep: "“ö–∞–¥–∞–º–º–µ–Ω",
            ai_style_practical: "–ü—Ä–∞–∫—Ç–∏–∫–∞–ª—ã“õ",
            ai_style_visual: "–ö”©—Ä–Ω–µ–∫—ñ",
            ai_answer_count_label: '5. –ñ–∞—É–∞–ø –Ω“±—Å“õ–∞–ª–∞—Ä—ã–Ω—ã“£ —Å–∞–Ω—ã–Ω –∫”©—Ä—Å–µ—Ç—ñ“£—ñ–∑:',
            ai_auto_category_label: '–°–∞–Ω–∞—Ç—Ç–∞—Ä–¥—ã –∞–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ –∂–∞—Å–∞—É',
            exit_modal_title: '–†–∞—Å—Ç–∞—É',
            exit_modal_text: '“ö–æ—Å—ã–º—à–∞–¥–∞–Ω —à—ã“õ“õ—ã“£—ã–∑ –∫–µ–ª–µ—Ç—ñ–Ω—ñ–Ω–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ?',
            exit_modal_confirm: '–®—ã“ì—É',
            exit_modal_cancel: '“ö–∞–ª—É',
            update_available_text: '–ñ–∞“£–∞ –Ω“±—Å“õ–∞—Å—ã “õ–æ–ª–∂–µ—Ç—ñ–º–¥—ñ!',
            update_button_text: '–ñ–∞“£–∞—Ä—Ç—É',
            ai_explain_button_title: '–ñ–ò –∞—Ä“õ—ã–ª—ã —Ç“Ø—Å—ñ–Ω–¥—ñ—Ä—É',
            download_translated_txt_button: '–ê—É–¥–∞—Ä–º–∞–Ω—ã –∂“Ø–∫—Ç–µ—É ({lang})(txt)',
            download_translated_qst_button: '–ê—É–¥–∞—Ä–º–∞–Ω—ã –∂“Ø–∫—Ç–µ—É ({lang})(qst)',
            no_translations_to_download: '–ñ“Ø–∫—Ç–µ—É “Ø—à—ñ–Ω “õ–æ–ª–∂–µ—Ç—ñ–º–¥—ñ –∞—É–¥–∞—Ä–º–∞–ª–∞—Ä –∂–æ“õ.',
            error_creating_translation_file: '–ê—É–¥–∞—Ä–º–∞ —Ñ–∞–π–ª—ã–Ω “õ“±—Ä—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',
            ai_show_original_button: '–¢“Ø–ø–Ω“±—Å“õ–∞–Ω—ã –∫”©—Ä—Å–µ—Ç—É',
            ai_show_translation_button: '–ê—É–¥–∞—Ä–º–∞–Ω—ã –∫”©—Ä—Å–µ—Ç—É',
            flashcards_mode: '–ö–∞—Ä—Ç–æ—á–∫–∞–ª–∞—Ä —Ä–µ–∂–∏–º—ñ (—Å“±—Ä–∞“õ/–∂–∞—É–∞–ø)',
            start_flashcards_button: '–û“õ—É–¥—ã –±–∞—Å—Ç–∞—É',
            flashcard_category_label: '–ö–µ–ª–µ—Å—ñ –±”©–ª—ñ–º:',
            results_flashcards_viewed: '“ö–∞—Ä–∞–ª“ì–∞–Ω –∫–∞—Ä—Ç–æ—á–∫–∞–ª–∞—Ä',
            session_cards_viewed: '“ö–∞—Ä–∞–ª–¥—ã',
            ai_error_generic: '–¢“Ø—Å—ñ–Ω–¥—ñ—Ä–º–µ–Ω—ñ –∂–∞—Å–∞—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã. “ö–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑.',
            ai_error_server: '–¢“Ø—Å—ñ–Ω–¥—ñ—Ä–º–µ–Ω—ñ –∂–∞—Å–∞—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã: –°–µ—Ä–≤–µ—Ä–¥–µ —É–∞“õ—ã—Ç—à–∞ “õ–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã. –ö–µ–π—ñ–Ω—ñ—Ä–µ–∫ “õ–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑.',
            parser_overwrite_warning: '–ù”ô—Ç–∏–∂–µ ”©—Ä—ñ—Å—ñ–Ω–¥–µ –º”ô—Ç—ñ–Ω –±–∞—Ä. –û–Ω—ã “õ–∞–π—Ç–∞ –∂–∞–∑“ì—ã“£—ã–∑ –∫–µ–ª–µ—Ç—ñ–Ω—ñ–Ω–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ?',
            ai_error_generation: '–¢–µ—Å—Ç –∂–∞—Å–∞—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã.',
            ai_error_server_generation: '–¢–µ—Å—Ç –∂–∞—Å–∞—É “õ–∞—Ç–µ—Å—ñ: –°–µ—Ä–≤–µ—Ä–¥–µ —É–∞“õ—ã—Ç—à–∞ “õ–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã. –ö–µ–π—ñ–Ω—ñ—Ä–µ–∫ “õ–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑.',
            ai_char_limit_exceeded: '–¢–∞“£–±–∞ —à–µ–≥—ñ–Ω–µ–Ω –∞—Å—ã–ø –∫–µ—Ç—Ç—ñ ({current}/{max})',

            tab_converter: "–ú”ô—Ç—ñ–Ω–Ω–µ–Ω —Ç“Ø—Ä–ª–µ–Ω–¥—ñ—Ä–≥—ñ—à",
            tab_ai_generator: "–¢–∞“õ—ã—Ä—ã–ø –±–æ–π—ã–Ω—à–∞ –ñ–ò-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä",
            ai_from_text_title: "ü§ñ –ú”ô—Ç—ñ–Ω—ñ“£—ñ–∑–¥–µ–Ω —Ç–µ—Å—Ç –∂–∞—Å–∞—É (–ñ–ò)",
            ai_generate_from_text_button: "–ú”ô—Ç—ñ–Ω–Ω–µ–Ω —Ç–µ—Å—Ç –∂–∞—Å–∞—É",
            ai_topic_description: "–ñ–ò ”©–∑ –±—ñ–ª—ñ–º—ñ–Ω –ø–∞–π–¥–∞–ª–∞–Ω–∞ –æ—Ç—ã—Ä—ã–ø, –∫”©—Ä—Å–µ—Ç—ñ–ª–≥–µ–Ω —Ç–∞“õ—ã—Ä—ã–ø –Ω–µ–≥—ñ–∑—ñ–Ω–¥–µ —Ç–µ—Å—Ç—Ç—ñ ”©–∑ –±–µ—Ç—ñ–Ω—à–µ –∂–∞—Å–∞–π–¥—ã.",
            ai_topic_label: "1. –¢–µ—Å—Ç –∂–∞—Å–∞—É “Ø—à—ñ–Ω —Ç–∞“õ—ã—Ä—ã–ø—Ç—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑:",
            ai_topic_placeholder: "–ú—ã—Å–∞–ª—ã: –†–µ—Å–ø—É–±–ª–∏–∫–∞ –∫–µ–∑–µ“£—ñ–Ω–¥–µ–≥—ñ –ï–∂–µ–ª–≥—ñ –†–∏–º —Ç–∞—Ä–∏—Ö—ã, 15 —Å“±—Ä–∞“õ, 4 –∂–∞—É–∞–ø –Ω“±—Å“õ–∞—Å—ã, —Å–æ“ì—ã—Å—Ç–∞—Ä –±–æ–π—ã–Ω—à–∞ —Å–∞–Ω–∞—Ç—Ç–∞—Ä–º–µ–Ω...",
            ai_topic_question_count_label: "2. –°“±—Ä–∞“õ—Ç–∞—Ä —Å–∞–Ω—ã (–µ–≥–µ—Ä —Ç–∞“õ—ã—Ä—ã–ø—Ç–∞ –∫”©—Ä—Å–µ—Ç—ñ–ª–º–µ—Å–µ):",
            ai_topic_answer_count_label: "3. –ñ–∞—É–∞–ø –Ω“±—Å“õ–∞–ª–∞—Ä—ã–Ω—ã“£ —Å–∞–Ω—ã (–µ–≥–µ—Ä —Ç–∞“õ—ã—Ä—ã–ø—Ç–∞ –∫”©—Ä—Å–µ—Ç—ñ–ª–º–µ—Å–µ):",
            ai_generate_from_topic_button: "ü§ñ –¢–∞“õ—ã—Ä—ã–ø –±–æ–π—ã–Ω—à–∞ —Ç–µ—Å—Ç –∂–∞—Å–∞—É (–ñ–ò)",
            ai_thinking_topic: "–ñ–ò-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—ñ–∑–¥—ñ“£ —Ç–∞“õ—ã—Ä—ã–±—ã“£—ã–∑–¥—ã –æ–π–ª–∞—Å—Ç—ã—Ä—É–¥–∞...",
            ai_topic_auto_category_label: "4. –°–∞–Ω–∞—Ç—Ç–∞—Ä–¥—ã –∞–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ –∂–∞—Å–∞—É",

            parser_auto_detect: '-- –ê–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ –∞–Ω—ã“õ—Ç–∞—É --',
            filter_variants_button: '‚öôÔ∏è –ù“±—Å“õ–∞–ª–∞—Ä —Å“Ø–∑–≥—ñ—Å—ñ',
            filter_variants_header: '–ù“±—Å“õ–∞–ª–∞—Ä —Å–∞–Ω—ã–Ω —Ç–∞“£–¥–∞“£—ã–∑:',
            filter_apply_button: '“ö–æ–ª–¥–∞–Ω—É',
            filter_reset_button: '–¢–∞—Å—Ç–∞—É',
            loading_default_text: '–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...',
            search_no_results: '–°—ñ–∑–¥—ñ“£ —Å“±—Ä–∞–Ω—ã—Å—ã“£—ã–∑ –±–æ–π—ã–Ω—à–∞ –µ—à—Ç–µ“£–µ —Ç–∞–±—ã–ª–º–∞–¥—ã.',
            search_error_prefix: '“ö–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã:',
            gradus_loading: '–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...',
            gradus_folder_empty: '“ö–∞–ª—Ç–∞ –±–æ—Å',
            gradus_loading_error_prefix: '“ö–∞—Ç–µ:',
            gradus_loading_quiz_prefix: '–¢–µ—Å—Ç –∂“Ø–∫—Ç–µ–ª—É–¥–µ',
            error_no_questions_for_cheatsheet: '–®–ø–∞—Ä–≥–∞–ª–∫–∞ –∂–∞—Å–∞—É “Ø—à—ñ–Ω —Å“±—Ä–∞“õ—Ç–∞—Ä –∂–æ“õ.',
            parser_input_empty_alert: '–ú”ô—Ç—ñ–Ω –µ–Ω–≥—ñ–∑—É ”©—Ä—ñ—Å—ñ –±–æ—Å!',
            parser_pattern_not_found_alert: '“ö–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã. –¢–∞“£–¥–∞–ª“ì–∞–Ω “Ø–ª–≥—ñ —Ç–∞–±—ã–ª–º–∞–¥—ã.',
            parser_no_questions_recognized_alert: '–¢–∞“£–¥–∞–ª“ì–∞–Ω –ø—ñ—à—ñ–º –±–æ–π—ã–Ω—à–∞ –±—ñ—Ä–¥–µ-–±—ñ—Ä —Å“±—Ä–∞“õ —Ç–∞–±—ã–ª–º–∞–¥—ã. –ë–∞—Å“õ–∞—Å—ã–Ω –∫”©—Ä—ñ“£—ñ–∑.',
            parser_no_questions_with_errors_alert: '–ë—ñ—Ä–¥–µ-–±—ñ—Ä —Å“±—Ä–∞“õ—Ç—ã —Ç–∞–Ω—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã. –¢–∞–±—ã–ª“ì–∞–Ω “õ–∞—Ç–µ–ª–µ—Ä: {count}.',
            parser_conversion_success_alert: '{count} —Å“±—Ä–∞“õ —Å”ô—Ç—Ç—ñ —Ç“Ø—Ä–ª–µ–Ω–¥—ñ—Ä—ñ–ª–¥—ñ!',
            parser_conversion_summary_alert: '–û–ø–µ—Ä–∞—Ü–∏—è –∞—è“õ—Ç–∞–ª–¥—ã.\n\n–¢–∞–Ω—ã–ª“ì–∞–Ω —Å“±—Ä–∞“õ—Ç–∞—Ä: {parsed}\n–ü—ñ—à—ñ–º–¥–µ—É “õ–∞—Ç–µ–ª–µ—Ä—ñ —Ç–∞–±—ã–ª–¥—ã: {errors}',
            ai_topic_empty_alert: '–¢–µ—Å—Ç –∂–∞—Å–∞—É “Ø—à—ñ–Ω —Ç–∞“õ—ã—Ä—ã–ø—Ç—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑.',
            ai_explanation_prepare_error: '–¢“Ø—Å—ñ–Ω–¥—ñ—Ä–º–µ —Ç–µ—Ä–µ–∑–µ—Å—ñ–Ω –¥–∞–π—ã–Ω–¥–∞—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',
            ai_analyzing_errors_button: '–ñ–ò —Ç–∞–ª–¥–∞—É–¥–∞... üß†',
            ai_error_analysis_button: 'ü§ñ –ñ–ò “õ–∞—Ç–µ–ª–µ—Ä –∞–Ω–∞–ª–∏—Ç–∏–∫–∞—Å—ã',

            search_engine_google: 'Google',
            search_engine_yandex: '–Ø–Ω–¥–µ–∫—Å',
            search_engine_perplexity: 'Perplexity',
            footer_copyright: 'prod by @iverrum',
            error_no_question_to_copy: '–ö”©—à—ñ—Ä—É “Ø—à—ñ–Ω –∞“ì—ã–º–¥–∞“ì—ã —Å“±—Ä–∞“õ—Ç—ã –∞–Ω—ã“õ—Ç–∞—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',
            error_no_question_to_favorite: '–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä“ì–∞ “õ–æ—Å—É “Ø—à—ñ–Ω –∞“ì—ã–º–¥–∞“ì—ã —Å“±—Ä–∞“õ—Ç—ã –∞–Ω—ã“õ—Ç–∞—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',
            error_favorites_require_auth: '–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä–¥—ã –ø–∞–π–¥–∞–ª–∞–Ω—É “Ø—à—ñ–Ω –∞–∫–∫–∞—É–Ω—Ç“õ–∞ –∫—ñ—Ä—É “õ–∞–∂–µ—Ç.',
            error_cannot_process_question: '–°–∞“õ—Ç–∞—É “Ø—à—ñ–Ω —Å“±—Ä–∞“õ—Ç—ã ”©“£–¥–µ—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',

            app_title: 'QSTiUM',
            confirm_delete_session: '–°–∞“õ—Ç–∞–ª“ì–∞–Ω "{fileName}" —Ç–µ—Å—Ç—ñ–Ω –∂–æ–π“ì—ã“£—ã–∑ –∫–µ–ª–µ—Ç—ñ–Ω—ñ–Ω–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ? –ë“±–ª ”ô—Ä–µ–∫–µ—Ç—Ç—ñ “õ–∞–π—Ç–∞—Ä—É –º“Ø–º–∫—ñ–Ω –µ–º–µ—Å.',
            error_session_not_found: '“ö–∞—Ç–µ: –±“±–ª —Ñ–∞–π–ª “Ø—à—ñ–Ω —Å–∞“õ—Ç–∞–ª“ì–∞–Ω —Å–µ—Å—Å–∏—è —Ç–∞–±—ã–ª–º–∞–¥—ã.',
            error_session_file_not_found: '–°–µ—Å—Å–∏—è–Ω—ã “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã. –ë–∞—Å—Ç–∞–ø“õ—ã —Ñ–∞–π–ª "–ñ–∞“õ—ã–Ω–¥–∞ –ø–∞–π–¥–∞–ª–∞–Ω—ã–ª“ì–∞–Ω–¥–∞—Ä" —ñ—à—ñ–Ω–¥–µ —Ç–∞–±—ã–ª–º–∞–¥—ã.',
            error_cheat_sheet_first: '–ê–ª–¥—ã–º–µ–Ω —à–ø–∞—Ä–≥–∞–ª–∫–∞–Ω—ã –∂–∞—Å–∞“£—ã–∑.',
            error_download_parsed_first: '–ê–ª–¥—ã–º–µ–Ω —Ñ–∞–π–ª–¥—ã —Ç“Ø—Ä–ª–µ–Ω–¥—ñ—Ä—ñ“£—ñ–∑.',
            error_filter_no_variant_selected: '–°“Ø–∑—É “Ø—à—ñ–Ω –±—ñ—Ä–¥–µ-–±—ñ—Ä –Ω“±—Å“õ–∞ —Å–∞–Ω—ã —Ç–∞“£–¥–∞–ª–º–∞–¥—ã.',
            error_filter_found_mismatch: '–°“Ø–∑–≥—ñ–≥–µ —Å”ô–π–∫–µ—Å –∫–µ–ª–º–µ–π—Ç—ñ–Ω {count} —Å“±—Ä–∞“õ —Ç–∞–±—ã–ª–¥—ã.',
            error_filter_all_match: '–ë–∞—Ä–ª—ã“õ —Å“±—Ä–∞“õ—Ç–∞—Ä –±–µ—Ä—ñ–ª–≥–µ–Ω —Å“Ø–∑–≥—ñ–≥–µ —Å”ô–π–∫–µ—Å –∫–µ–ª–µ–¥—ñ!',
            error_download_failed_generic: '–î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –∂“Ø–∫—Ç–µ—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã. “ö–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑.',
            error_generic_for_alert: '“ö–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã',

            copy_question_title: '–ê“ì—ã–º–¥–∞“ì—ã —Å“±—Ä–∞“õ—Ç—ã –∫”©—à—ñ—Ä—É',
            search_web_title: '–ò–Ω—Ç–µ—Ä–Ω–µ—Ç—Ç–µ–Ω —ñ–∑–¥–µ—É',
            quick_mode_title: '–ñ—ã–ª–¥–∞–º —Ä–µ–∂–∏–º (–ê–≤—Ç–æ–º–∞—Ç—Ç—ã ”©—Ç—É)',
            trigger_words_title: '–¢—Ä–∏–≥–≥–µ—Ä-—Å”©–∑–¥–µ—Ä',
            theme_button_title: 'üåó',
            language_toggle_title: '–¢—ñ–ª–¥—ñ ”©–∑–≥–µ—Ä—Ç—É',
            favorite_button_title: '–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä“ì–∞ “õ–æ—Å—É',
            translate_question_title: '–ê“ì—ã–º–¥–∞“ì—ã —Å“±—Ä–∞“õ—Ç—ã –∞—É–¥–∞—Ä—É',
            footer_copyright: 'prod by @iverrum',
            exit_toast_text: '–®—ã“ì—É “Ø—à—ñ–Ω —Ç–∞“ì—ã –±—ñ—Ä —Ä–µ—Ç –±–∞—Å—ã“£—ã–∑',
            app_title: 'QSTiUM',
            confirm_delete_session: '–°–∞“õ—Ç–∞–ª“ì–∞–Ω "{fileName}" —Ç–µ—Å—Ç—ñ–Ω –∂–æ–π“ì—ã“£—ã–∑ –∫–µ–ª–µ—Ç—ñ–Ω—ñ–Ω–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ? –ë“±–ª ”ô—Ä–µ–∫–µ—Ç—Ç—ñ “õ–∞–π—Ç–∞—Ä—É –º“Ø–º–∫—ñ–Ω –µ–º–µ—Å.',
            error_session_not_found: '“ö–∞—Ç–µ: –±“±–ª —Ñ–∞–π–ª “Ø—à—ñ–Ω —Å–∞“õ—Ç–∞–ª“ì–∞–Ω —Å–µ—Å—Å–∏—è —Ç–∞–±—ã–ª–º–∞–¥—ã.',
            error_session_file_not_found: '–°–µ—Å—Å–∏—è–Ω—ã “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã. –ë–∞—Å—Ç–∞–ø“õ—ã —Ñ–∞–π–ª "–ñ–∞“õ—ã–Ω–¥–∞ –ø–∞–π–¥–∞–ª–∞–Ω—ã–ª“ì–∞–Ω–¥–∞—Ä" —ñ—à—ñ–Ω–¥–µ —Ç–∞–±—ã–ª–º–∞–¥—ã.',
            error_cheat_sheet_first: '–ê–ª–¥—ã–º–µ–Ω —à–ø–∞—Ä–≥–∞–ª–∫–∞–Ω—ã –∂–∞—Å–∞“£—ã–∑.',
            error_download_parsed_first: '–ê–ª–¥—ã–º–µ–Ω —Ñ–∞–π–ª–¥—ã —Ç“Ø—Ä–ª–µ–Ω–¥—ñ—Ä—ñ“£—ñ–∑.',
            error_filter_no_variant_selected: '–°“Ø–∑—É “Ø—à—ñ–Ω –±—ñ—Ä–¥–µ-–±—ñ—Ä –Ω“±—Å“õ–∞ —Å–∞–Ω—ã —Ç–∞“£–¥–∞–ª–º–∞–¥—ã.',
            error_filter_found_mismatch: '–°“Ø–∑–≥—ñ–≥–µ —Å”ô–π–∫–µ—Å –∫–µ–ª–º–µ–π—Ç—ñ–Ω {count} —Å“±—Ä–∞“õ —Ç–∞–±—ã–ª–¥—ã.',
            error_filter_all_match: '–ë–∞—Ä–ª—ã“õ —Å“±—Ä–∞“õ—Ç–∞—Ä –±–µ—Ä—ñ–ª–≥–µ–Ω —Å“Ø–∑–≥—ñ–≥–µ —Å”ô–π–∫–µ—Å –∫–µ–ª–µ–¥—ñ!',
            error_download_failed_generic: '–î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –∂“Ø–∫—Ç–µ—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã. “ö–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑.',
            error_generic_for_alert: '“ö–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã',
            loading_default_text: '–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...',
            search_no_results: '–°—ñ–∑–¥—ñ“£ —Å“±—Ä–∞–Ω—ã—Å—ã“£—ã–∑ –±–æ–π—ã–Ω—à–∞ –µ—à—Ç–µ“£–µ —Ç–∞–±—ã–ª–º–∞–¥—ã.',
            search_error_prefix: '“ö–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã:',
            gradus_loading: '–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...',
            gradus_folder_empty: '“ö–∞–ª—Ç–∞ –±–æ—Å',
            gradus_loading_error_prefix: '“ö–∞—Ç–µ:',
            gradus_loading_quiz_prefix: '–¢–µ—Å—Ç –∂“Ø–∫—Ç–µ–ª—É–¥–µ',
            error_no_questions_for_cheatsheet: '–®–ø–∞—Ä–≥–∞–ª–∫–∞ –∂–∞—Å–∞—É “Ø—à—ñ–Ω —Å“±—Ä–∞“õ—Ç–∞—Ä –∂–æ“õ.',
            parser_input_empty_alert: '–ú”ô—Ç—ñ–Ω –µ–Ω–≥—ñ–∑—É ”©—Ä—ñ—Å—ñ –±–æ—Å!',
            parser_pattern_not_found_alert: '“ö–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã. –¢–∞“£–¥–∞–ª“ì–∞–Ω “Ø–ª–≥—ñ —Ç–∞–±—ã–ª–º–∞–¥—ã.',
            parser_no_questions_recognized_alert: '–¢–∞“£–¥–∞–ª“ì–∞–Ω –ø—ñ—à—ñ–º –±–æ–π—ã–Ω—à–∞ –±—ñ—Ä–¥–µ-–±—ñ—Ä —Å“±—Ä–∞“õ —Ç–∞–±—ã–ª–º–∞–¥—ã. –ë–∞—Å“õ–∞—Å—ã–Ω –∫”©—Ä—ñ“£—ñ–∑.',
            parser_no_questions_with_errors_alert: '–ë—ñ—Ä–¥–µ-–±—ñ—Ä —Å“±—Ä–∞“õ—Ç—ã —Ç–∞–Ω—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã. –¢–∞–±—ã–ª“ì–∞–Ω “õ–∞—Ç–µ–ª–µ—Ä: {count}.',
            parser_conversion_success_alert: '{count} —Å“±—Ä–∞“õ —Å”ô—Ç—Ç—ñ —Ç“Ø—Ä–ª–µ–Ω–¥—ñ—Ä—ñ–ª–¥—ñ!',
            parser_conversion_summary_alert: '–û–ø–µ—Ä–∞—Ü–∏—è –∞—è“õ—Ç–∞–ª–¥—ã.\n\n–¢–∞–Ω—ã–ª“ì–∞–Ω —Å“±—Ä–∞“õ—Ç–∞—Ä: {parsed}\n–ü—ñ—à—ñ–º–¥–µ—É “õ–∞—Ç–µ–ª–µ—Ä—ñ —Ç–∞–±—ã–ª–¥—ã: {errors}',
            ai_topic_empty_alert: '–¢–µ—Å—Ç –∂–∞—Å–∞—É “Ø—à—ñ–Ω —Ç–∞“õ—ã—Ä—ã–ø—Ç—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑.',
            ai_explanation_prepare_error: '–¢“Ø—Å—ñ–Ω–¥—ñ—Ä–º–µ —Ç–µ—Ä–µ–∑–µ—Å—ñ–Ω –¥–∞–π—ã–Ω–¥–∞—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',
            error_no_question_to_copy: '–ö”©—à—ñ—Ä—É “Ø—à—ñ–Ω –∞“ì—ã–º–¥–∞“ì—ã —Å“±—Ä–∞“õ—Ç—ã –∞–Ω—ã“õ—Ç–∞—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',
            error_no_question_to_favorite: '–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä“ì–∞ “õ–æ—Å—É “Ø—à—ñ–Ω –∞“ì—ã–º–¥–∞“ì—ã —Å“±—Ä–∞“õ—Ç—ã –∞–Ω—ã“õ—Ç–∞—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',
            error_favorites_require_auth: '–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä–¥—ã –ø–∞–π–¥–∞–ª–∞–Ω—É “Ø—à—ñ–Ω –∞–∫–∫–∞—É–Ω—Ç“õ–∞ –∫—ñ—Ä—É “õ–∞–∂–µ—Ç.',
            error_cannot_process_question: '–°–∞“õ—Ç–∞—É “Ø—à—ñ–Ω —Å“±—Ä–∞“õ—Ç—ã ”©“£–¥–µ—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',

            ai_explanation_question: '–°“±—Ä–∞“õ',
            ai_explanation_correct_answer: '–î“±—Ä—ã—Å –∂–∞—É–∞–ø',

            feedback_correct: '–î“±—Ä—ã—Å!',
            feedback_incorrect: '“ö–∞—Ç–µ!',

            mobile_download_ready_title: '‚úÖ –§–∞–π–ª –∂“Ø–∫—Ç–µ—É–≥–µ –¥–∞–π—ã–Ω!',
            mobile_download_button: 'üì• –§–∞–π–ª–¥—ã –∂“Ø–∫—Ç–µ—É',
            mobile_download_link_info: 'üí° –°—ñ–ª—Ç–µ–º–µ 1 –º–∏–Ω—É—Ç –±–æ–π—ã –±–µ–ª—Å–µ–Ω–¥—ñ –±–æ–ª–∞–¥—ã',
            mobile_download_fallback_title: '‚ö†Ô∏è –ë–∞–ª–∞–º–∞ —Ç”ô—Å—ñ–ª',
            mobile_download_fallback_p1: '–ñ“Ø–∫—Ç–µ—É —Å—ñ–ª—Ç–µ–º–µ—Å—ñ–Ω –∂–∞—Å–∞—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.',
            mobile_download_fallback_p2: '–§–∞–π–ª–¥—ã“£ –º–∞–∑–º“±–Ω—ã–Ω –∫”©—à—ñ—Ä—ñ“£—ñ–∑',
            mobile_download_copy_button: 'üìã –ö”©—à—ñ—Ä—É',
            session_saved_success: '–¢–µ—Å—Ç —Å–∞“õ—Ç–∞–ª–¥—ã! –°—ñ–∑ –æ–Ω—ã –∫–µ–∑ –∫–µ–ª–≥–µ–Ω —É–∞“õ—ã—Ç—Ç–∞ –±–∞—Å—Ç—ã —ç–∫—Ä–∞–Ω–Ω–∞–Ω –∂–∞–ª“ì–∞—Å—Ç—ã—Ä–∞ –∞–ª–∞—Å—ã–∑.',

            download_txt_question_label: '–°“±—Ä–∞“õ',
            download_txt_answer_label: '–î“±—Ä—ã—Å –∂–∞—É–∞–ø',

            quick_mode_title_on: "–ñ—ã–ª–¥–∞–º —Ä–µ–∂–∏–º “ö–û–°–£–õ–´ (–ê–≤—Ç–æ–º–∞—Ç—Ç—ã ”©—Ç—É)",
            quick_mode_title_off: "–ñ—ã–ª–¥–∞–º —Ä–µ–∂–∏–º ”®–®–Ü–†–£–õ–Ü (“ö–æ–ª–º–µ–Ω ”©—Ç—É)",
            trigger_mode_title_on: "–¢—Ä–∏–≥–≥–µ—Ä-—Å”©–∑–¥–µ—Ä “ö–û–°–£–õ–´ (–°“±—Ä–∞“õ—Ç–∞“ì—ã —Å”©–∑–≥–µ –±–∞—Å—ã“£—ã–∑)",
            trigger_mode_title_off: "–¢—Ä–∏–≥–≥–µ—Ä-—Å”©–∑–¥–µ—Ä ”®–®–Ü–†–£–õ–Ü",

            share_title_cheatsheet: "–®–ø–∞—Ä–≥–∞–ª–∫–∞",
            share_title_errors: "“ö–∞—Ç–µ–ª–µ—Ä",
            share_title_triggered_quiz: "–¢—Ä–∏–≥–≥–µ—Ä–ª–µ—Ä—ñ –±–∞—Ä —Ç–µ—Å—Ç",
            share_title_converted_test: "–¢“Ø—Ä–ª–µ–Ω–¥—ñ—Ä—ñ–ª–≥–µ–Ω —Ç–µ—Å—Ç",

            error_review_questions_not_found: "“ö–∞—Ç–µ–ª–µ—Ä–º–µ–Ω –∂“±–º—ã—Å —ñ—Å—Ç–µ—É “Ø—à—ñ–Ω —Å“±—Ä–∞“õ—Ç–∞—Ä–¥—ã “õ–∞–ª—ã–ø—Ç–∞—Å—Ç—ã—Ä—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.",
            error_flashcard_translation_failed: "–ö–∞—Ä—Ç–æ—á–∫–∞–Ω—ã –∞—É–¥–∞—Ä—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã. –¢“Ø–ø–Ω“±—Å“õ–∞ –∫”©—Ä—Å–µ—Ç—ñ–ª–µ–¥—ñ.",

            error_load_file_first: "–ê–ª–¥—ã–º–µ–Ω —Å“±—Ä–∞“õ—Ç–∞—Ä—ã –±–∞—Ä —Ñ–∞–π–ª–¥—ã –∂“Ø–∫—Ç–µ“£—ñ–∑.",

            manual_copy_title: "üìã “ö–æ–ª–º–µ–Ω –∫”©—à—ñ—Ä—É",
            manual_copy_p1: "–ê–≤—Ç–æ–º–∞—Ç—Ç—ã –∫”©—à—ñ—Ä—É –æ—Ä—ã–Ω–¥–∞–ª–º–∞–¥—ã. –¢”©–º–µ–Ω–¥–µ–≥—ñ –º”ô—Ç—ñ–Ω–¥—ñ –±–µ–ª–≥—ñ–ª–µ–ø, –∫”©—à—ñ—Ä—ñ–ø –∞–ª—ã“£—ã–∑:",
            manual_copy_close_button: "–ñ–∞–±—É",

            error_no_current_question: "–ê“ì—ã–º–¥–∞“ì—ã —Å“±—Ä–∞“õ—Ç—ã –∞–Ω—ã“õ—Ç–∞—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.",
            error_session_save_failed: "–°–µ—Å—Å–∏—è–Ω—ã —Å–∞“õ—Ç–∞—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã. –ë—Ä–∞—É–∑–µ—Ä–¥–µ –æ—Ä—ã–Ω –∂–µ—Ç–∫—ñ–ª—ñ–∫—Å—ñ–∑ –±–æ–ª—É—ã –º“Ø–º–∫—ñ–Ω.",
            error_analysis_no_data: "–¢–∞–ª–¥–∞—É “Ø—à—ñ–Ω “õ–∞—Ç–µ–ª–µ—Ä —Ç—É—Ä–∞–ª—ã –¥–µ—Ä–µ–∫—Ç–µ—Ä –∂–æ“õ.",
            error_no_question_for_explanation: "–¢“Ø—Å—ñ–Ω–¥—ñ—Ä—É “Ø—à—ñ–Ω —Å“±—Ä–∞“õ—Ç—ã“£ “õ“±—Ä—ã–ª—ã–º—ã–Ω —Ç–∞–Ω—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.",
            error_cannot_fully_process_question: "–¢“Ø—Å—ñ–Ω–¥—ñ—Ä—É “Ø—à—ñ–Ω —Å“±—Ä–∞“õ—Ç—ã —Ç–æ–ª—ã“õ ”©“£–¥–µ—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.",

            error_download_generic_with_filename: '"{fileName}" —Ñ–∞–π–ª—ã–Ω –∂“Ø–∫—Ç–µ—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã. “ö–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑.',
            mobile_download_preparing: '–§–∞–π–ª–¥—ã –∂“Ø–∫—Ç–µ—É–≥–µ –¥–∞–π—ã–Ω–¥–∞—É...',

            tooltip_open_folder: '"{name}" “õ–∞–ª—Ç–∞—Å—ã–Ω –∞—à—É',
            tooltip_start_test: '"{name}" —Ç–µ—Å—Ç—ñ–Ω –±–∞—Å—Ç–∞—É',
            tooltip_load_file: '{name} —Ñ–∞–π–ª—ã–Ω –∂“Ø–∫—Ç–µ—É',

            share_title_translated_test_txt: "–ê—É–¥–∞—Ä—ã–ª“ì–∞–Ω —Ç–µ—Å—Ç",
            share_title_translated_test_qst: "–ê—É–¥–∞—Ä—ã–ª“ì–∞–Ω —Ç–µ—Å—Ç (QST)",

            error_translation_failed: "–ê—É–¥–∞—Ä–º–∞–Ω—ã –∞–ª—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.",
            ai_option_default: "(—Å—Ç–∞–Ω–¥–∞—Ä—Ç—Ç—ã)",

            error_firebase_init: "Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è—Å—ã —Å”ô—Ç—Å—ñ–∑ –∞—è“õ—Ç–∞–ª–¥—ã. –ß–∞—Ç “õ–æ–ª–∂–µ—Ç—ñ–º—Å—ñ–∑ –±–æ–ª–∞–¥—ã. “ö–∞—Ç–µ:",
            ai_analyzing_text: "–ñ–ò —Å—ñ–∑–¥—ñ“£ –º”ô—Ç—ñ–Ω—ñ“£—ñ–∑–¥—ñ —Ç–∞–ª–¥–∞—É–¥–∞...",

            parser_pattern_structured: "“ö“±—Ä—ã–ª—ã–º–¥—ã —Ç–µ—Å—Ç (1. –°“±—Ä–∞“õ, –ê) –ñ–∞—É–∞–ø+)",
            parser_pattern_plus_at_end: "–ñ–æ–ª —Å–æ“£—ã–Ω–¥–∞ '+' –±–µ–ª–≥—ñ—Å—ñ –±–∞—Ä –∂–∞—É–∞–ø",
            parser_pattern_no_markers: "–ë–µ–ª–≥—ñ–ª–µ—Ä—Å—ñ–∑ (–±—ñ—Ä—ñ–Ω—à—ñ –∂–∞—É–∞–ø - –¥“±—Ä—ã—Å)",
            parser_pattern_numbered_plus: "–ù”©–º—ñ—Ä–ª–µ–Ω–≥–µ–Ω —Ç—ñ–∑—ñ–º (1.) –±–∞—Å—ã–Ω–¥–∞ '+' –∂–∞—É–∞–±—ã –±–∞—Ä",
            parser_pattern_plus_at_start: "–ñ–æ–ª –±–∞—Å—ã–Ω–¥–∞ '+' –±–µ–ª–≥—ñ—Å—ñ –±–∞—Ä –∂–∞—É–∞–ø",
            parser_pattern_tags_cyrillic: "<–í–æ–ø—Ä–æ—Å> –∂”ô–Ω–µ <–≤–∞—Ä–∏–∞–Ω—Ç> —Ç–µ–≥—Ç–µ—Ä—ñ",
            parser_pattern_tags_latin: "<question> –∂”ô–Ω–µ <variant> —Ç–µ–≥—Ç–µ—Ä—ñ",

            ai_question_count_label: '4. –ñ–ò “Ø—à—ñ–Ω —Å“±—Ä–∞“õ—Ç–∞—Ä —Å–∞–Ω—ã–Ω –∫”©—Ä—Å–µ—Ç—ñ“£—ñ–∑:',
            ai_answer_count_label: '5. –ñ–∞—É–∞–ø –Ω“±—Å“õ–∞–ª–∞—Ä—ã–Ω—ã“£ —Å–∞–Ω—ã–Ω –∫”©—Ä—Å–µ—Ç—ñ“£—ñ–∑:',
            ai_auto_category_label: '–°–∞–Ω–∞—Ç—Ç–∞—Ä–¥—ã –∞–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ –∂–∞—Å–∞—É',

            shuffle_n_questions: "–ê—Ä–∞–ª–∞—Å—Ç—ã—Ä—ã–ª“ì–∞–Ω –∂–∏—ã–Ω—Ç—ã“õ"

        },
        en: {
            // Main Screen
            exit_toast_text: 'Press back again to exit',
            continue_later_button: 'Continue Later',
            continue_sessions: 'Continue:',
            answered_of: 'Answered',
            from: 'of',
            time_left: 'Time left',
            continue_quiz_button: 'Continue',
            delete_session_button: 'Delete',
            search_in_db: 'Search question in database:',
            search_placeholder: 'Enter part of the question text...',
            find_button: 'Search',
            searching_in_db: 'Searching database...',
            or_divider: '-- or --',
            choose_file: 'Select a .qst or .txt file from your device:',
            gradus_button_main: 'GRADUS',
            gradus_subtitle: '(General Repository for Academic Data, Utility & Structure)',
            parser_button_main: 'Convert',
            parser_subtitle: 'text to .qst format',
            recent_files: 'Recently used:',
            // Navigation & Headers
            nav_gradus: 'GRADUS Navigation',
            back_to_main: 'Back to Main Screen',
            search_results_title: 'Search Results',
            back_to_search: 'New Search',
            quiz_settings_title: 'Quiz Settings',
            cheat_sheet_title: 'Generated Cheat Sheet:',
            quiz_finished_title: 'Quiz Finished!',
            parser_description: 'Upload a file or paste text to convert into a quiz format.',
            // Quiz Settings
            time_limit: 'Time limit (minutes, 0 - no limit):',
            time_limit_minutes: 'min',
            question_range: 'Question Range:',
            range_from: 'From',
            range_to: 'To',
            total_questions_label: 'total',
            questions_label_for_range: 'questions',
            shuffle_questions: 'Shuffle questions',
            shuffle_answers: 'Shuffle answers',
            feedback_mode: 'Feedback Mode (ü§ñAI analysis + review incorrect answers)',
            reading_mode: 'Reading mode (first option is correct)',
            start_quiz_button: 'Start Quiz',
            generate_cheat_sheet_button: 'Generate Cheat Sheet',
            choose_another_file_button: 'Choose Another File',
            // Cheat Sheet
            download_cheat_sheet_button: 'Download Cheat Sheet (.txt)',
            back_to_settings_button: 'Back to Settings',
            // Quiz Screen
            timer_label: 'Time:',
            prev_question_button: 'Previous',
            next_question_button: 'Next',
            finish_button: 'Finish Quiz',
            question_label: 'Question:',
            correct_label: 'Correct:',
            quick_nav_title: 'Quick Navigation:',
            finish_early_button: 'Finish Quiz',
            // Results
            your_result: 'Your result:',
            of_label: 'of',
            accuracy_label: 'Accuracy:',
            download_errors_button: 'Download unanswered/incorrect questions',
            review_errors_button: 'Review Mistakes',
            download_triggered_quiz_button: 'Download Quiz with Triggers',
            restart_button: 'Take Another Quiz',
            // Parser
            parser_upload_or_paste: '1. Upload a file (.txt) or paste text below:',
            clear_parser_input: 'Clear input',
            parser_input_placeholder: 'Or paste text from your document here...',
            parser_select_format: '2. Select format (or leave for auto-detection):',
            parser_auto_detect: '-- Automatic detection --',
            parser_run_button: '3. Convert',
            parser_errors_found: '‚ö†Ô∏è Formatting errors',
            parser_result_title: 'Result:',
            download_parsed_button: 'Download .qst file',
            back_button: 'Back',
            // Header Buttons (–ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–í–ï–î–ï–ù–û)
            copy_question_title: 'Copy current question',
            search_web_title: 'Search the web',
            quick_mode_title: 'Quick Mode (Auto-advance)',
            trigger_words_title: 'Trigger Words',
            theme_button_title: 'üåó',
            language_toggle_title: 'Change Language',
            favorite_button_title: 'Add to Favorites',
            translate_question_title: 'Translate current question',
            // Messages (–ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–í–ï–î–ï–ù–û)
            search_query_too_short: 'Search query must contain at least 3 characters.',
            file_empty_or_invalid_part1: 'File "',
            file_empty_or_invalid_part2: '" is empty or has an invalid format.',
            no_questions_for_settings: 'No questions found for the current settings.',
            confirm_finish_early: 'Are you sure you want to finish the quiz early?',
            copy_button: "Copy",
            search_provider_db: "Database",
            relevance_tag: "Relevance:",
            copy_button: "Copy",
            copy_question_tooltip: "Copy question",
            favorite_question_tooltip: "Add to favorites",
            ai_generating_button: 'ü§ñ Generating...',
            ai_error_text_empty: 'Please paste text to analyze.',
            ai_error_generation: 'An error occurred while generating the test.',

            copy_success: "Content copied to clipboard!",
            ai_explanation_title: 'üí° AI Explanation',
            ai_explanation_style_label: 'Explanation Style:',
            ai_explain_button: 'Explainüí°',
            ai_explanation_loading: 'AI is preparing an explanation...',
            ai_generating_button: 'ü§ñ Generating...',
            ai_error_text_empty: 'Please paste text to analyze.',
            ai_error_generation: 'An error occurred while generating the test.',
            ai_question_count_label: '4. Specify the number of questions for the AI:',
            ai_auto_mode_label: 'Auto',
            ai_style_simple: "Simple",
            ai_style_scientific: "Scientific",
            ai_style_associative: "Analogy",
            ai_style_stepbystep: "Step-by-step",
            ai_style_practical: "Practical",
            ai_style_visual: "Visual",
            ai_answer_count_label: '5. Specify the number of answer choices:',
            ai_auto_category_label: 'Automatically create categories',

            exit_modal_title: 'Confirmation',
            exit_modal_text: 'Are you sure you want to exit the application?',
            exit_modal_confirm: 'Exit',
            exit_modal_cancel: 'Stay',
            update_available_text: 'A new version is available!',
            update_button_text: 'Update',
            ai_explain_button_title: 'Explain with AI',
            download_translated_quiz_button: 'Download translation ({lang})',
            no_translations_to_download: 'No available translations to download.',
            error_creating_translation_file: 'Failed to create translation file.',
            download_translated_txt_button: 'Download translation ({lang})(txt)',
            download_translated_qst_button: 'Download translation ({lang})(qst)',
            no_translations_to_download: 'No available translations to download.',
            error_creating_translation_file: 'Failed to create translation file.',
            ai_show_original_button: 'Show Original',
            ai_show_translation_button: 'Show Translation',
            flashcards_mode: 'Flashcards mode (question/answer)',
            start_flashcards_button: 'Start Learning',
            flashcard_category_label: 'Next Section:',
            results_flashcards_viewed: 'Cards Viewed',
            session_cards_viewed: 'Viewed',
            ai_error_generic: 'Failed to generate explanation. Please try again.',
            ai_error_server: 'Failed to generate explanation: A temporary server error occurred. Please try again later.',
            parser_overwrite_warning: 'The result field already contains text. Are you sure you want to overwrite it?',
            ai_error_generation: 'An error occurred while generating the test.',
            ai_error_server_generation: 'Test generation failed: A temporary server error occurred. Please try again later.',
            ai_char_limit_exceeded: 'Character limit exceeded ({current}/{max})',

            tab_converter: "Converter from Text",
            tab_ai_generator: "AI Generator by Topic",
            ai_from_text_title: "ü§ñ Create Test from Your Text (AI)",
            ai_generate_from_text_button: "Generate Test from Text",
            ai_topic_description: "The AI will independently create a test based on the specified topic using its knowledge.",
            ai_topic_label: "1. Enter a topic to generate a test:",
            ai_topic_placeholder: "Example: History of Ancient Rome during the Republic, 15 questions, 4 answer choices, with categories by wars...",
            ai_topic_question_count_label: "2. Number of questions (if not specified in the topic):",
            ai_topic_answer_count_label: "3. Number of answer choices (if not specified in the topic):",
            ai_generate_from_topic_button: "ü§ñ Create Test by Topic (AI)",
            ai_thinking_topic: "AI generator is thinking about your topic...",
            ai_topic_auto_category_label: "4. Automatically create categories",

            parser_auto_detect: '-- Automatic detection --',
            filter_variants_button: '‚öôÔ∏è Filter by variants',
            filter_variants_header: 'Select number of variants:',
            filter_apply_button: 'Apply',
            filter_reset_button: 'Reset',
            loading_default_text: 'Loading...',
            search_no_results: 'Nothing was found for your query.',
            search_error_prefix: 'An error occurred:',
            gradus_loading: 'Loading...',
            gradus_folder_empty: 'Folder is empty',
            gradus_loading_error_prefix: 'Error:',
            gradus_loading_quiz_prefix: 'Loading quiz',
            error_no_questions_for_cheatsheet: 'No questions to generate a cheat sheet.',
            parser_input_empty_alert: 'The text input field is empty!',
            parser_pattern_not_found_alert: 'An error occurred. The selected pattern was not found.',
            parser_no_questions_recognized_alert: 'Could not find any questions for the selected format. Try another one.',
            parser_no_questions_with_errors_alert: 'Failed to recognize any questions. Errors found: {count}.',
            parser_conversion_success_alert: 'Successfully converted {count} questions!',
            parser_conversion_summary_alert: 'Operation completed.\n\nQuestions recognized: {parsed}\nFormatting errors found: {errors}',
            ai_topic_empty_alert: 'Please enter a topic to generate the test.',
            ai_explanation_prepare_error: 'Failed to prepare the explanation window.',
            ai_analyzing_errors_button: 'AI is analyzing... üß†',
            ai_error_analysis_button: 'ü§ñ AI Error Analysis',

            search_engine_google: 'Google',
            search_engine_yandex: 'Yandex',
            search_engine_perplexity: 'Perplexity',
            footer_copyright: 'prod by @iverrum',
            error_no_question_to_copy: 'Could not determine the current question to copy.',
            error_no_question_to_favorite: 'Could not determine the current question to add to favorites.',
            error_favorites_require_auth: 'You must be logged in to use favorites.',
            error_cannot_process_question: 'Could not process the question for saving.',


            app_title: 'QSTiUM',
            confirm_delete_session: 'Are you sure you want to delete the saved quiz "{fileName}"? This action is irreversible.',
            error_session_not_found: 'Error: saved session for this file not found.',
            error_session_file_not_found: 'Could not restore session. The original file was not found in "Recently used".',
            error_cheat_sheet_first: 'First, generate the cheat sheet.',
            error_download_parsed_first: 'First, convert the file.',
            error_filter_no_variant_selected: 'No number of variants selected for filtering.',
            error_filter_found_mismatch: 'Found {count} questions that do not match the filter.',
            error_filter_all_match: 'All questions match the specified filter!',

            error_download_failed_generic: 'Failed to download data. Please try again.',
            error_generic_for_alert: 'An error occurred',

            copy_question_title: 'Copy current question',
            search_web_title: 'Search the web',
            chat_button_title: 'üí¨',
            quick_mode_title: 'Quick Mode (Auto-advance)',
            trigger_words_title: 'Trigger Words',
            theme_button_title: 'üåó',
            language_toggle_title: 'Change Language',
            favorite_button_title: 'Add to Favorites',
            translate_question_title: 'Translate current question',
            footer_copyright: 'prod by @iverrum',
            exit_toast_text: 'Press back again to exit',
            app_title: 'QSTiUM',
            confirm_delete_session: 'Are you sure you want to delete the saved quiz "{fileName}"? This action is irreversible.',
            error_session_not_found: 'Error: saved session for this file not found.',
            error_session_file_not_found: 'Could not restore session. The original file was not found in "Recently used".',
            error_cheat_sheet_first: 'First, generate the cheat sheet.',
            error_download_parsed_first: 'First, convert the file.',
            error_filter_no_variant_selected: 'No number of variants selected for filtering.',
            error_filter_found_mismatch: 'Found {count} questions that do not match the filter.',
            error_filter_all_match: 'All questions match the specified filter!',
            error_download_failed_generic: 'Failed to download data. Please try again.',
            error_generic_for_alert: 'An error occurred',
            loading_default_text: 'Loading...',
            search_no_results: 'Nothing was found for your query.',
            search_error_prefix: 'An error occurred:',
            gradus_loading: 'Loading...',
            gradus_folder_empty: 'Folder is empty',
            gradus_loading_error_prefix: 'Error:',
            gradus_loading_quiz_prefix: 'Loading quiz',
            error_no_questions_for_cheatsheet: 'No questions to generate a cheat sheet.',
            parser_input_empty_alert: 'The text input field is empty!',
            parser_pattern_not_found_alert: 'An error occurred. The selected pattern was not found.',
            parser_no_questions_recognized_alert: 'Could not find any questions for the selected format. Try another one.',
            parser_no_questions_with_errors_alert: 'Failed to recognize any questions. Errors found: {count}.',
            parser_conversion_success_alert: 'Successfully converted {count} questions!',
            parser_conversion_summary_alert: 'Operation completed.\n\nQuestions recognized: {parsed}\nFormatting errors found: {errors}',
            ai_topic_empty_alert: 'Please enter a topic to generate the test.',
            ai_explanation_prepare_error: 'Failed to prepare the explanation window.',
            error_no_question_to_copy: 'Could not determine the current question to copy.',
            error_no_question_to_favorite: 'Could not determine the current question to add to favorites.',
            error_favorites_require_auth: 'You must be logged in to use favorites.',
            error_cannot_process_question: 'Could not process the question for saving.',

            ai_explanation_question: 'Question',
            ai_explanation_correct_answer: 'Correct Answer',
            feedback_correct: 'Correct!',
            feedback_incorrect: 'Incorrect!',

            mobile_download_ready_title: '‚úÖ File is ready for download!',
            mobile_download_button: 'üì• Download file',
            mobile_download_link_info: 'üí° The link will be active for 1 minute',
            mobile_download_fallback_title: '‚ö†Ô∏è Alternative method',
            mobile_download_fallback_p1: 'Failed to create a download link.',
            mobile_download_fallback_p2: 'Copy the file contents',
            mobile_download_copy_button: 'üìã Copy',
            session_saved_success: 'Quiz saved! You can continue it at any time from the main screen.',

            download_txt_question_label: 'Question',
            download_txt_answer_label: 'Correct Answer',

            quick_mode_title_on: "Quick Mode ON (Auto-advance)",
            quick_mode_title_off: "Quick Mode OFF (Manual advance)",
            trigger_mode_title_on: "Trigger Words ON (Click a word in the question)",
            trigger_mode_title_off: "Trigger Words OFF",

            share_title_cheatsheet: "Cheat Sheet",
            share_title_errors: "Mistakes",
            share_title_triggered_quiz: "Quiz with Triggers",
            share_title_converted_test: "Converted Test",

            error_review_questions_not_found: "Failed to generate questions for mistake review.",
            error_flashcard_translation_failed: "Failed to translate the flashcard. The original will be shown.",

            error_load_file_first: "Please load a file with questions first.",

            manual_copy_title: "üìã Manual Copy",
            manual_copy_p1: "Automatic copy failed. Please select and copy the text below:",
            manual_copy_close_button: "Close",

            error_no_current_question: "Could not determine the current question.",
            error_session_save_failed: "Failed to save the session. The browser may be out of storage space.",
            error_analysis_no_data: "No error data to analyze.",
            error_no_question_for_explanation: "Could not recognize the question structure for an explanation.",
            error_cannot_fully_process_question: "Could not fully process the question for an explanation.",

            error_download_generic_with_filename: 'Failed to download file "{fileName}". Please try again.',
            mobile_download_preparing: 'Preparing file for download...',

            tooltip_open_folder: 'Open folder "{name}"',
            tooltip_start_test: 'Start test "{name}"',
            tooltip_load_file: 'Load {name}',

            share_title_translated_test_txt: "Translated Test",
            share_title_translated_test_qst: "Translated Test (QST)",

            error_translation_failed: "Failed to get translation.",
            ai_option_default: "(standard)",

            error_firebase_init: "Failed to initialize Firebase. Chat will be unavailable. Error:",
            ai_analyzing_text: "AI is analyzing your text...",

            parser_pattern_structured: "Structured Test (1. Question, A) Answer+)",
            parser_pattern_plus_at_end: "Answer with '+' at the end of the line",
            parser_pattern_no_markers: "No markers (first answer is correct)",
            parser_pattern_numbered_plus: "Numbered list (1.) with '+' answer at the start",
            parser_pattern_plus_at_start: "Answer with '+' at the start of the line",
            parser_pattern_tags_cyrillic: "Tags <–í–æ–ø—Ä–æ—Å> and <–≤–∞—Ä–∏–∞–Ω—Ç>",
            parser_pattern_tags_latin: "Tags <question> and <variant>",
            copy_success_short: '‚úì Copied!',


            ai_question_count_label: '4. Specify the number of questions for the AI:',
            ai_answer_count_label: '5. Specify the number of answer choices:',
            ai_auto_category_label: 'Automatically create categories',

            shuffle_n_questions: "Random set of"
        }


    };





    function _(key) {
        const currentLang = localStorage.getItem('appLanguage') || 'ru';
        return LANG_PACK[currentLang][key] || key;
    }

    const getEl = (id) => document.getElementById(id);

    /**
     * –°–æ–∑–¥–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –∫—ç—à–∞, –∫–æ–º–±–∏–Ω–∏—Ä—É—è –∏–Ω–¥–µ–∫—Å –≤–æ–ø—Ä–æ—Å–∞ –∏ –∫–æ–¥ —è–∑—ã–∫–∞.
     * @param {number} originalIndex - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≤–æ–ø—Ä–æ—Å–∞.
     * @param {string} lang - –ö–æ–¥ —è–∑—ã–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'ru', 'en').
     * @returns {string} - –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á (–Ω–∞–ø—Ä–∏–º–µ—Ä, '15_en').
     */
    function getCacheKey(originalIndex, lang) {
        return `${originalIndex}_${lang}`;
    }


    // --- Firebase & Auth ---
    let db, auth, currentUser = null;
    const FIREBASE_CONFIG = {
        apiKey: "AIzaSyDk4J8N0mdPpFtulT5DMr2Y8tHX93HrU2s",
        authDomain: "qst-chat.firebaseapp.com",
        projectId: "qst-chat",
        storageBucket: "qst-chat.appspot.com",
        messagingSenderId: "24969645733",
        appId: "1:24969645733:web:47bc96a13817544246074c"
    };


    // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–¥–µ—Å—å, –Ω–æ –Ω–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è ---
    let fileInput, fileUploadArea, quizSetupArea, quizArea, resultsArea,
        questionTextEl, answerOptionsEl, feedbackAreaEl, prevQuestionButton,
        nextButton, restartButton, startQuizButton, currentQuestionNumEl,
        totalQuestionsNumEl, correctAnswersCountEl, finalCorrectEl, finalTotalEl,
        finalPercentageEl, timeLimitInput, timeLimitValueDisplay,
        questionRangeStartInput, questionRangeEndInput, maxQuestionsInfoEl,
        shuffleQuestionsCheckbox, shuffleAnswersCheckbox, feedbackModeCheckbox,
        timerDisplayEl, timeLeftEl, quickNavPanel, quickNavButtonsContainer,
        feedbackDownloadArea, downloadErrorsButton, themeToggleButton,
        quickModeToggle, triggerWordToggle, recentFilesArea, recentFilesListEl,
        errorReviewArea, reviewErrorsButton, generateCheatSheetButton,
        cheatSheetResultArea, cheatSheetOutputEl, downloadCheatSheetButton,
        backToSettingsButton, chooseAnotherFileButton, finishTestButton,
        triggeredQuizDownloadArea, downloadTriggeredQuizButton, gradusButton,
        gradusFoldersContainer, gradusFolderList, backToFileUploadButton,
        gradusBreadcrumbs, searchContainer, searchQueryInput, searchButton,
        searchResultsContainer, backToSearchButton, webSearchDropdown,
        searchWebButton, searchDropdownContent, chatToggleBtn, languageToggle,
        copyQuestionBtnQuiz, parserArea, parserButton, backToMainFromParserBtn,
        parserFileInput, parserInput, parserPatternSelect, runParserBtn,
        parserOutputArea, parserOutput, downloadParsedBtn, clearParserInputBtn,
        filterVariantsBtn, filterVariantsDropdown, filterVariantCheckboxes,
        applyVariantFilterBtn, resetVariantFilterBtn, searchNavigation,
        prevResultBtn, nextResultBtn, resultCounterEl, readingModeCheckbox, 
        searchResultCardsContainer, continueLaterButton, savedSessionArea, 
        savedSessionList, appTitleHeader;

    let rangeSliderStart, rangeSliderEnd, sliderProgress, questionRangeGroup,
            shuffleNCheckbox, shuffleNCountInput, sliderTicks, timeSliderTicks;

    let themeDropdownContainer, themeDropdownButton, themeDropdownContent, themeIcon;
    let converterTabBtn, aiGeneratorTabBtn, converterContent, aiGeneratorContent, 
        aiTopicInput, generateTestFromTopicBtn, aiTopicQuestionCount, aiTopicAnswerCount;
    let aiTopicAutoCategory;

    let generateTestFromTextBtn, aiQuestionCount, aiAutoCount, aiAutoCategory;
    let exitConfirmationModal, confirmExitBtn, cancelExitBtn;
    let updateNotification, updateBtn, translateQuestionBtn;
    let downloadTranslatedTxtButton, downloadTranslatedQstButton;
    let flashcardsModeCheckbox;


    // --- State Variables ---
    let allParsedQuestions = [];
    let questionsForCurrentQuiz = [];
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let score = 0;
    let quizSettings = { timeLimit: 0, shuffleQuestions: false, shuffleAnswers: false, questionRangeStart: 1, questionRangeEnd: 0, feedbackMode: false };
    let quickModeEnabled = localStorage.getItem('quizQuickModeEnabled') === 'true';
    const QUICK_MODE_DELAY = 1000;
    let triggerWordModeEnabled = false;
    let triggerWordsUsedInQuiz = false;
    let incorrectlyAnsweredQuestionsData = [];
    let currentQuizErrorData = [];
    let timerInterval = null;
    let timeLeftInSeconds = 0;
    const MAX_RECENT_FILES = 20;
    const RECENT_FILES_STORAGE_KEY = 'recentQstFilesData';
    const SAVED_SESSIONS_STORAGE_KEY = 'savedQuizSessions'; 
    let originalFileNameForReview = '';
    let generatedCheatSheetContent = '';
    let breadcrumbs = [];
    let searchResultsData = [];
    let currentResultIndex = 0;
    let currentQuizContext = null;
    let quizStartTime = 0;
    let currentAIQuestion = null; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    let currentAITranslation = null; // –ù–û–í–ê–Ø: –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    let isAIModalShowingTranslation = false; // –ù–û–í–ê–Ø: —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    let isExitConfirmed = false;
    let isTranslateModeEnabled = localStorage.getItem('isTranslateModeEnabled') === 'true'; 
    let currentQuizTranslations = new Map(); // –î–ª—è –∫—ç—à–∞ –≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
    let currentAIUserIncorrectAnswer = null;
    let currentFileCacheKey = null; // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è —Ñ–∞–π–ª–∞ –≤ localStorage
    const AI_INPUT_CHAR_LIMIT = 14000; // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ª–∏–º–∏—Ç —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –ò–ò


    

    // --- Constants ---

    const GRADUS_ROOT_FOLDER_ID = '1RLrkW1CZUo8PvpJt-C7xZgK0xzHnXmZ7';


    const handleBeforeUnload = (event) => {
        // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö
        event.preventDefault();
        // Chrome —Ç—Ä–µ–±—É–µ—Ç, —á—Ç–æ–±—ã returnValue –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.
        event.returnValue = '';
    };

    function initializeApp() {
        // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º –∑–¥–µ—Å—å ---
        
        
        fileInput = getEl('fileInput');
        fileUploadArea = getEl('fileUploadArea');
        quizSetupArea = getEl('quizSetupArea');
        quizArea = getEl('quizArea');
        resultsArea = getEl('resultsArea');
        questionTextEl = getEl('questionText');
        answerOptionsEl = getEl('answerOptions');
        feedbackAreaEl = getEl('feedbackArea');
        prevQuestionButton = getEl('prevQuestionButton');
        nextButton = getEl('nextButton');
        restartButton = getEl('restartButton');
        startQuizButton = getEl('startQuizButton');
        currentQuestionNumEl = getEl('currentQuestionNum');
        totalQuestionsNumEl = getEl('totalQuestionsNum');
        correctAnswersCountEl = getEl('correctAnswersCount');
        finalCorrectEl = getEl('finalCorrect');
        finalTotalEl = getEl('finalTotal');
        finalPercentageEl = getEl('finalPercentage');
        timeLimitInput = getEl('timeLimit');
        timeLimitValueDisplay = getEl('timeLimitValue');
        questionRangeStartInput = getEl('questionRangeStart');
        questionRangeEndInput = getEl('questionRangeEnd');
        maxQuestionsInfoEl = getEl('maxQuestionsInfo');
        shuffleQuestionsCheckbox = getEl('shuffleQuestions');
        shuffleAnswersCheckbox = getEl('shuffleAnswers');
        feedbackModeCheckbox = getEl('feedbackMode');
        readingModeCheckbox = getEl('readingMode');
        timerDisplayEl = getEl('timerDisplay');
        timeLeftEl = getEl('timeLeft');
        quickNavPanel = getEl('quickNavPanel');
        quickNavButtonsContainer = getEl('quickNavButtons');
        feedbackDownloadArea = getEl('feedbackDownloadArea');
        downloadErrorsButton = getEl('downloadErrorsButton');
        themeToggleButton = getEl('themeToggle');
        quickModeToggle = getEl('quickModeToggle');
        triggerWordToggle = getEl('triggerWordToggle');
        recentFilesArea = getEl('recentFilesArea');
        recentFilesListEl = getEl('recentFilesList');
        errorReviewArea = getEl('errorReviewArea');
        reviewErrorsButton = getEl('reviewErrorsButton');
        generateCheatSheetButton = getEl('generateCheatSheetButton');
        cheatSheetResultArea = getEl('cheatSheetResultArea');
        cheatSheetOutputEl = getEl('cheatSheetOutput');
        downloadCheatSheetButton = getEl('downloadCheatSheetButton');
        backToSettingsButton = getEl('backToSettingsButton');
        chooseAnotherFileButton = getEl('chooseAnotherFileButton');
        finishTestButton = getEl('finishTestButton');
        triggeredQuizDownloadArea = getEl('triggeredQuizDownloadArea');
        downloadTriggeredQuizButton = getEl('downloadTriggeredQuizButton');
        gradusButton = getEl('gradusButton');
        gradusFoldersContainer = getEl('gradusFoldersContainer');
        gradusFolderList = getEl('gradusFolderList');
        backToFileUploadButton = getEl('backToFileUploadButton');
        gradusBreadcrumbs = getEl('gradusBreadcrumbs');
        searchContainer = getEl('searchContainer');
        searchQueryInput = getEl('searchQueryInput');
        searchButton = getEl('searchButton');
        searchResultsContainer = getEl('searchResultsContainer');
        backToSearchButton = getEl('backToSearchButton');
        webSearchDropdown = getEl('webSearchDropdown');
        searchWebButton = getEl('searchWebButton');
        searchDropdownContent = getEl('searchDropdownContent');
        chatToggleBtn = getEl('chatToggle');
        languageToggle = getEl('languageToggle');
        copyQuestionBtnQuiz = getEl('copyQuestionBtnQuiz');
        parserArea = getEl('parserArea');
        parserButton = getEl('parserButton');
        backToMainFromParserBtn = getEl('backToMainFromParserBtn');
        parserFileInput = getEl('parserFileInput');
        parserInput = getEl('parserInput');
        parserPatternSelect = getEl('parserPatternSelect');
        runParserBtn = getEl('runParserBtn');
        parserOutputArea = getEl('parserOutputArea');
        parserOutput = getEl('parserOutput');
        downloadParsedBtn = getEl('downloadParsedBtn');
        clearParserInputBtn = getEl('clearParserInputBtn');
        filterVariantsBtn = getEl('filterVariantsBtn');
        filterVariantsDropdown = getEl('filterVariantsDropdown');
        filterVariantCheckboxes = getEl('filterVariantCheckboxes');
        applyVariantFilterBtn = getEl('applyVariantFilterBtn');
        resetVariantFilterBtn = getEl('resetVariantFilterBtn');
        searchNavigation = getEl('searchNavigation');
        prevResultBtn = getEl('prevResultBtn');
        nextResultBtn = getEl('nextResultBtn');
        resultCounterEl = getEl('resultCounter');
        searchResultCardsContainer = getEl('searchResultCards');
        continueLaterButton = getEl('continueLaterButton');
        savedSessionArea = getEl('savedSessionArea');
        savedSessionList = getEl('savedSessionList');
        generateTestFromTextBtn = getEl('generateTestFromTextBtn');
        aiQuestionCount = getEl('aiQuestionCount');
        aiAutoCount = getEl('aiAutoCount');
        aiAutoCategory = getEl('aiAutoCategory');
        exitConfirmationModal = getEl('exitConfirmationModal');
        confirmExitBtn = getEl('confirmExitBtn');
        cancelExitBtn = getEl('cancelExitBtn');
        updateNotification = getEl('updateNotification');
        updateBtn = getEl('updateBtn');
        appTitleHeader = getEl('appTitleHeader');

        themeDropdownContainer = getEl('themeDropdownContainer');
        themeDropdownButton = getEl('themeDropdownButton');
        themeDropdownContent = getEl('themeDropdownContent');
        themeIcon = getEl('themeIcon');

        flashcardsModeCheckbox = getEl('flashcardsMode');

        translateQuestionBtn = getEl('translateQuestionBtn');
        downloadTranslatedTxtButton = getEl('downloadTranslatedTxtButton');
        downloadTranslatedQstButton = getEl('downloadTranslatedQstButton');
        converterTabBtn = getEl('converterTabBtn');
        aiGeneratorTabBtn = getEl('aiGeneratorTabBtn');
        converterContent = getEl('converterContent');
        aiGeneratorContent = getEl('aiGeneratorContent');
        aiTopicInput = getEl('aiTopicInput');
        generateTestFromTopicBtn = getEl('generateTestFromTopicBtn');
        aiTopicQuestionCount = getEl('aiTopicQuestionCount');
        aiTopicAnswerCount = getEl('aiTopicAnswerCount');
        aiTopicAutoCategory = getEl('aiTopicAutoCategory');

        rangeSliderStart = getEl('rangeSliderStart');
        rangeSliderEnd = getEl('rangeSliderEnd');
        sliderProgress = getEl('sliderProgress');
        questionRangeGroup = getEl('questionRangeGroup');
        shuffleNCheckbox = getEl('shuffleNQuestions');
        shuffleNCountInput = getEl('shuffleNQuestionsCount');
        sliderTicks = getEl('sliderTicks');
        timeSliderTicks = getEl('timeSliderTicks');
        initServiceWorkerUpdater();

        // –û—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ initializeApp
        try {
            if (typeof firebase === 'undefined') {
                throw new Error('Firebase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
            }
            firebase.initializeApp(FIREBASE_CONFIG);
            db = firebase.firestore();
            auth = firebase.auth();
            console.log('‚úÖ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ');
            ChatModule.init(db, auth);
            auth.onAuthStateChanged(user => {
                currentUser = user;
                ChatModule.setCurrentUser(user);
            });
        } catch (e) {
            console.error("‚ùå Firebase initialization failed:", e);
            alert(`${_('error_firebase_init')} ${e.message}`);
            ChatModule.init(null, null);
        }
        
        setupEventListeners();
        loadTheme();
        updateQuickModeToggleVisual();
        updateTriggerWordToggleVisual();
        loadRecentFiles();
        loadSavedSession();
        const savedLang = localStorage.getItem('appLanguage') || 'ru';
        populateParserPatterns();
        populateThemeDropdown();
        setLanguage(savedLang);
        createVariantFilterCheckboxes();
        manageBackButtonInterceptor();
        setupExtensionListener();
        setupAnimationObserver();
    }



    async function copyToClipboardMain(text) {
        try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
                // –¢–µ–ø–µ—Ä—å —Ñ—É–Ω–∫—Ü–∏—è _() –∑–¥–µ—Å—å –¥–æ—Å—Ç—É–ø–Ω–∞!
                showCopyNotification(_('copy_success')); 
            } else {
                // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                textArea.setSelectionRange(0, 99999);
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showCopyNotification(_('copy_success'));
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
            // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, —á—Ç–æ–±—ã –æ–Ω–æ —Ç–æ–∂–µ –ø–µ—Ä–µ–≤–æ–¥–∏–ª–æ—Å—å
            alert(_('copy_error'));
        }
    }


    
    function setupEventListeners() {

        getEl('favoriteQuestionBtn')?.addEventListener('click', handleFavoriteClickInQuiz);
        translateQuestionBtn?.addEventListener('click', toggleTranslateMode);
        getEl('copyExplanationBtn')?.addEventListener('click', handleCopyExplanation);
        fileInput.addEventListener('change', handleFileSelect);
        startQuizButton.addEventListener('click', () => applySettingsAndStartQuiz(false, null));
        gradusButton?.addEventListener('click', () => {
            fileUploadArea.classList.add('hidden');
            gradusFoldersContainer.classList.remove('hidden');
            renderGradusView(GRADUS_ROOT_FOLDER_ID, 'GRADUS', true);
            manageBackButtonInterceptor();
        });
        backToFileUploadButton?.addEventListener('click', () => {
            gradusFoldersContainer.classList.add('hidden');
            fileUploadArea.classList.remove('hidden');
            manageBackButtonInterceptor();
        });
        searchButton?.addEventListener('click', performSearch);
        backToSearchButton?.addEventListener('click', () => {
            searchResultsContainer.classList.add('hidden');
            fileUploadArea.classList.remove('hidden');
            searchQueryInput.value = '';
            manageBackButtonInterceptor();
        });
        searchWebButton?.addEventListener('click', (event) => {
            event.stopPropagation();
            searchDropdownContent.classList.toggle('show');
        });
        searchDropdownContent?.addEventListener('click', handleWebSearch);
        window.addEventListener('click', (event) => {
            if (!event.target.matches('#searchWebButton') && searchDropdownContent?.classList.contains('show')) {
                searchDropdownContent.classList.remove('show');
            }
        });

        // ===== –ù–û–í–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –î–õ–Ø –í–ö–õ–ê–î–û–ö –ü–ê–†–°–ï–†–ê =====
        converterTabBtn?.addEventListener('click', () => switchParserTab('converter'));
        aiGeneratorTabBtn?.addEventListener('click', () => switchParserTab('aiGenerator'));

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ù–û–í–û–ô –∫–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ —Ç–µ–º–µ
        generateTestFromTopicBtn?.addEventListener('click', handleAIGenerationFromTopicRequest);

        generateTestFromTextBtn?.addEventListener('click', handleAIGenerationRequest);

        aiAutoCount?.addEventListener('change', () => {
            aiQuestionCount.disabled = aiAutoCount.checked;
        });

        getEl('aiExplanationTranslateBtn')?.addEventListener('click', handleAITranslateToggle);
        flashcardsModeCheckbox?.addEventListener('change', handleFlashcardsModeChange);

        getEl('aiAnalysisBtn')?.addEventListener('click', requestErrorAnalysis);
        // –ö–ª–∏–∫ –Ω–∞ –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è —Å–ø–∏—Å–∫–∞
        getEl('aiExplanationStyleButton')?.addEventListener('click', (e) => {
            e.stopPropagation();
            getEl('aiExplanationStyleDropdown').classList.toggle('open');
            getEl('aiExplanationStyleContent').classList.toggle('hidden');
        });

        // –ö–ª–∏–∫ –Ω–∞ –æ–¥–∏–Ω –∏–∑ –ø—É–Ω–∫—Ç–æ–≤ –≤ —Å–ø–∏—Å–∫–µ
        getEl('aiExplanationStyleContent')?.addEventListener('click', (e) => {
            e.preventDefault();
            const target = e.target.closest('a');
            if (target && target.dataset.style) {
                const style = target.dataset.style;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–µ
                getEl('aiExplanationStyleText').textContent = target.textContent;
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
                getEl('aiExplanationStyleDropdown').classList.remove('open');
                getEl('aiExplanationStyleContent').classList.add('hidden');

                fetchAndDisplayExplanation(style, currentAIUserIncorrectAnswer);
            }
        });

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ –ª—é–±–æ–º –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ –æ–∫–Ω–∞
        window.addEventListener('click', () => {
            const dropdown = getEl('aiExplanationStyleDropdown');
            if (dropdown && dropdown.classList.contains('open')) {
                dropdown.classList.remove('open');
                getEl('aiExplanationStyleContent').classList.add('hidden');
            }
        });


        // –í–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ setupEventListeners()
        parserButton?.addEventListener('click', () => {
            fileUploadArea.classList.add('hidden');
            parserArea.classList.remove('hidden');
            manageBackButtonInterceptor();
        });

        backToMainFromParserBtn?.addEventListener('click', () => {
            parserArea.classList.add('hidden');
            fileUploadArea.classList.remove('hidden');
            manageBackButtonInterceptor();
        });

        parserFileInput?.addEventListener('change', handleParserFileInput);
        runParserBtn?.addEventListener('click', runParser);
        downloadParsedBtn?.addEventListener('click', downloadParsedQst);
        clearParserInputBtn?.addEventListener('click', clearParserInput);
        parserInput?.addEventListener('input', checkAICharacterLimit);


        nextButton.addEventListener('click', handleNextButtonClick);
        prevQuestionButton.addEventListener('click', loadPreviousQuestion);
        restartButton.addEventListener('click', resetQuizForNewFile);
        downloadErrorsButton.addEventListener('click', downloadErrorFile);
        copyQuestionBtnQuiz?.addEventListener('click', handleCopyQuestionInQuiz);
        reviewErrorsButton?.addEventListener('click', startErrorReviewQuiz);
        generateCheatSheetButton?.addEventListener('click', handleGenerateCheatSheet);
        downloadCheatSheetButton?.addEventListener('click', handleDownloadOrShareCheatSheet);
        backToSettingsButton?.addEventListener('click', () => {
            cheatSheetResultArea.classList.add('hidden');
            quizSetupArea.classList.remove('hidden');
        });
        chooseAnotherFileButton?.addEventListener('click', () => resetQuizForNewFile(true));
        continueLaterButton?.addEventListener('click', saveSessionForLater);
        finishTestButton?.addEventListener('click', () => {
            if (confirm(_('confirm_finish_early'))) {
                if (timerInterval) clearInterval(timerInterval);
                showResults();
            }
        });

        quickModeToggle?.addEventListener('click', toggleQuickMode);
        triggerWordToggle?.addEventListener('click', toggleTriggerWordMode);
        downloadTriggeredQuizButton?.addEventListener('click', downloadTriggeredQuizFile);
        readingModeCheckbox?.addEventListener('change', handleReadingModeChange);
        timeLimitInput.addEventListener('input', () => {
                    timeLimitValueDisplay.textContent = timeLimitInput.value;
                    updateSingleSliderVisuals();
                });




        // --- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Ç–µ–º ---
        themeDropdownButton?.addEventListener('click', (event) => {
            event.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º "–≤—Å–ø–ª—ã—Ç–∏–µ" –∫–ª–∏–∫–∞ –¥–æ window
            themeDropdownContent.classList.toggle('show');
        });

        themeDropdownContent?.addEventListener('click', (event) => {
            event.preventDefault();
            const target = event.target.closest('a');
            if (target && target.dataset.theme) {
                setTheme(target.dataset.theme);
                themeDropdownContent.classList.remove('show'); // <-- –í–û–¢ –≠–¢–ê –°–¢–†–û–ö–ê
            }
        });
        
        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
        window.addEventListener('click', (event) => {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–∏—Å–∫–æ–≤–∏–∫–æ–≤
            if (!event.target.closest('#webSearchDropdown') && searchDropdownContent?.classList.contains('show')) {
                searchDropdownContent.classList.remove('show');
            }
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–µ–º (–£–õ–£–ß–®–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê)
            if (!event.target.closest('#themeDropdownContainer') && themeDropdownContent?.classList.contains('show')) {
                themeDropdownContent.classList.remove('show');
            }
        });




        languageToggle?.addEventListener('click', toggleLanguage);
        chatToggleBtn?.addEventListener('click', () => {
            ChatModule.openChatModal();
        });
                
        prevResultBtn?.addEventListener('click', () => {
            if (currentResultIndex > 0) {
                currentResultIndex--;
                displaySingleResult(currentResultIndex);
                if (isTranslateModeEnabled && !quizArea.classList.contains('hidden') && questionsForCurrentQuiz.length > 0) {
    loadQuestion(currentQuestionIndex);
}
            }

        });
        nextResultBtn?.addEventListener('click', () => {
            if (currentResultIndex < searchResultsData.length - 1) {
                currentResultIndex++;
                displaySingleResult(currentResultIndex);
            }
        });

        // –ù–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
        filterVariantsBtn?.addEventListener('click', (event) => {
            event.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Å–∞–º—É –∫–Ω–æ–ø–∫—É
            filterVariantsDropdown.classList.toggle('hidden');
        });

        applyVariantFilterBtn?.addEventListener('click', filterByVariantCount);
        resetVariantFilterBtn?.addEventListener('click', resetVariantFilter);
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.addEventListener('click', (event) => {
            if (filterVariantsDropdown && !filterVariantsDropdown.classList.contains('hidden')) {
                if (!filterVariantsDropdown.contains(event.target) && event.target !== filterVariantsBtn) {
                    filterVariantsDropdown.classList.add('hidden');
                }
            }
        });


        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –≤—ã—Ö–æ–¥–∞
        cancelExitBtn?.addEventListener('click', () => {
            isExitConfirmed = false;
            hideExitConfirmationModal();
        });

        confirmExitBtn?.addEventListener('click', () => {

            window.location.href = 'about:blank';
        });

        // === –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô ===
        downloadTranslatedTxtButton?.addEventListener('click', handleDownloadTranslatedTxt);
        downloadTranslatedQstButton?.addEventListener('click', handleDownloadTranslatedQst);
        // === –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ===

        shuffleNCheckbox?.addEventListener('change', handleShuffleNToggle);


    }



    function handleBackButton(event) {
        const chatOverlay = document.getElementById('chatOverlay');
        if (chatOverlay && !chatOverlay.classList.contains('hidden')) {
            event.preventDefault();
            ChatModule.closeChatModal();
            return;
        }

        if (!fileUploadArea.classList.contains('hidden')) {
            event.preventDefault();

            if (backButtonPressedOnce) {
                // –≠—Ç–æ –≤—Ç–æ—Ä–æ–µ –Ω–∞–∂–∞—Ç–∏–µ - –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                // –î–ª—è PWA —Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± - –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å navigator.app.exitApp
                if (navigator.app && navigator.app.exitApp) {
                    navigator.app.exitApp();
                } else {
                    // –ï—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, –ø—Ä–æ—Å—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ–º –±—Ä–∞—É–∑–µ—Ä—É —Å–¥–µ–ª–∞—Ç—å "–Ω–∞–∑–∞–¥",
                    // —á—Ç–æ –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤ –∑–∞–∫—Ä–æ–µ—Ç PWA.
                    window.removeEventListener('popstate', handleBackButton);
                    history.back();
                }
                return;
            }

            // –≠—Ç–æ –ø–µ—Ä–≤–æ–µ –Ω–∞–∂–∞—Ç–∏–µ
            backButtonPressedOnce = true;
            showExitToast();

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                backButtonPressedOnce = false;
            }, 2000);

            // "–û—Ç–º–µ–Ω—è–µ–º" –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ "–Ω–∞–∑–∞–¥"
            history.pushState({ page: 'app' }, "QSTiUM", "#app");

        } else {
            resetQuizForNewFile();
        }
    }


    function showGlobalLoader(message = _('loading_default_text')) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ª–æ–∞–¥–µ—Ä, —á—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã
        if (document.getElementById('globalLoader')) return;

        const loaderHTML = `
            <div id="globalLoader" class="global-loader-overlay">
                <div class="loader-content">
                    <div class="loader-spinner"></div>
                    <p>${escapeHTML(message)}</p>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', loaderHTML);
    }


    function hideGlobalLoader() {
        const loader = document.getElementById('globalLoader');
        if (loader) {
            loader.remove();
        }
    }



    async function performSearch() {
        const query = searchQueryInput.value.trim();
        if (query.length < 3) {
            alert(_('search_query_too_short'));
            return;
        }

        fileUploadArea.classList.add('hidden');
        searchResultsContainer.classList.remove('hidden');
        manageBackButtonInterceptor()
        
        searchResultCardsContainer.innerHTML = `
            <div class="loading-placeholder">
            <div class="loading-spinner"></div>
            <span>${_('searching_in_db')}</span>
            </div>
        `;

        searchNavigation.classList.add('hidden');

        try {
            const url = `${googleAppScriptUrl}?action=searchQuestions&query=${encodeURIComponent(query)}`;
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${response.statusText}`);
            }
            const data = await response.json();

            if (!data.success) {
                throw new Error(data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            }

            renderSearchResults(data.success && data.results ? data.results : []);
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ:", error);
            searchResultCardsContainer.innerHTML = `<div class="search-no-results-message">${_('search_error_prefix')} ${error.message}</div>`;
        }
    }



    function renderSearchResults(results) {
        searchResultsData = results || [];
        currentResultIndex = 0;

        if (searchResultsData.length === 0) {
            searchNavigation.classList.add('hidden');
            searchResultCardsContainer.innerHTML = `<div class="search-no-results-message">${_('search_no_results')}</div>`;
            return;
        }
        
        searchNavigation.classList.remove('hidden');
        displaySingleResult(currentResultIndex);
    }
    




    function displaySingleResult(index) {
        const resultText = searchResultsData[index];
        if (!resultText) return;

        const cardContentHTML = parseAndRenderQuestionBlock(resultText);
        // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –¥–ª—è –∞—Ç—Ä–∏–±—É—Ç–∞ onclick –∏ –¥–æ–±–∞–≤–ª—è–µ–º
        // —Ä–µ–∑—É–ª—å—Ç–∞—Ç —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏. –≠—Ç–æ —Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±.
       const escapedResultText = escape(resultText);

        searchResultCardsContainer.innerHTML = `
            <div class="result-card">
                <div class="result-card-header">
                    <div class="result-card-actions">
                        <span class="relevance-tag">${_('relevance_tag')} ${100 - index}%</span>
                        <button class="explain-search-result-btn" title="${_('ai_explain_button_title')}" onclick='window.mainApp.handleExplainClickInSearch(event, "${escapedResultText}")'>üí°</button>
                        <button class="copy-search-result-btn" title="${_('copy_question_tooltip')}" onclick='window.mainApp.handleCopyClickInSearch(event, "${escapedResultText}")'>üìã</button>
                        <button class="favorite-search-result-btn" title="${_('favorite_question_tooltip')}" onclick='window.mainApp.handleFavoriteClickInSearch(event, "${escapedResultText}")'>‚≠ê</button>
                        <button class="translate-search-result-btn" title="${_('translate_question_title')}" onclick='window.mainApp.handleTranslateClickInSearch(event, this, "${escapedResultText}")'>‡§Ö–∞</button>
                    </div>
                </div> <!--  <<<<<====== –í–û–¢ –û–ù, –ù–ï–î–û–°–¢–ê–Æ–©–ò–ô –ó–ê–ö–†–´–í–ê–Æ–©–ò–ô –¢–ï–ì! -->
                <div class="result-card-content">
                    ${cardContentHTML}
                </div>
            </div>
        `;

        resultCounterEl.textContent = `${index + 1} / ${searchResultsData.length}`;
        prevResultBtn.disabled = (index === 0);
        nextResultBtn.disabled = (index >= searchResultsData.length - 1);
        // === –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ö–û–î–ê ===
        // –ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –º—ã –æ—Ç–æ–±—Ä–∞–∑–∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∏—â–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        const resultCard = searchResultCardsContainer.querySelector('.result-card');
        if (resultCard) {
            // –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å –∫–ª–∞—Å—Å–æ–º 'correct'
            const correctAnswerEl = resultCard.querySelector('.answer-option.correct');
            if (correctAnswerEl) {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞, —É–±–∏—Ä–∞—è –≥–∞–ª–æ—á–∫—É "‚úì" –≤ –Ω–∞—á–∞–ª–µ
                const answerText = correctAnswerEl.textContent.replace(/^‚úì\s*/, '').trim();
                
                console.log(`QSTiUM.com: –ù–∞–π–¥–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: "${answerText}". –û—Ç–ø—Ä–∞–≤–ª—è—é –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ.`);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞—à–µ–º—É content.js, –∫–æ—Ç–æ—Ä—ã–π –∫—Ä—É—Ç–∏—Ç—Å—è –Ω–∞ —ç—Ç–æ–π –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                window.postMessage({
                    type: "TO_QSTIUM_EXTENSION", // –ù–æ–≤—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è
                    answer: answerText
                }, "*");
            }
        }
        // === –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ö–û–î–ê ===
    }



    function parseAndRenderQuestionBlock(blockText) {
        if (!blockText) return '<div class="question-text-detail">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>';

        // –†–ï–®–ï–ù–ò–ï: –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –Ω–µ–Ω—É–∂–Ω—ã—Ö —Ç–µ–≥–æ–≤
        const tagRemovalRegex = /<\/?(question|variant|–≤–æ–ø—Ä–æ—Å|–≤–∞—Ä–∏–∞–Ω—Ç|qst)>/gi;

        const correctedText = blockText.replace(/\\n/g, '\n');
        const lines = correctedText.split('\n').filter(line => line.trim() !== '');

        let questionContentLines = [];
        let optionsHTML = [];
        let foundOptions = false;

        lines.forEach(line => {
            const trimmedLine = line.trim();
            if (trimmedLine.startsWith('+') || trimmedLine.startsWith('=') || trimmedLine.startsWith('-') || trimmedLine.startsWith('~')) {
                foundOptions = true;
                let className = 'answer-option';
                let icon = trimmedLine.startsWith('+') || trimmedLine.startsWith('=') ? '‚úì' : '‚úó';
                if (icon === '‚úì') className += ' correct';
                
                // –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Ç–µ–≥–æ–≤
                const answerText = trimmedLine.substring(1).trim().replace(tagRemovalRegex, '').trim();
                optionsHTML.push(`<div class="${className}">${icon} ${escapeHTML(answerText)}</div>`);
            } else if (!foundOptions) {
                // –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ –æ—Ç —Ç–µ–≥–æ–≤
                const cleanLine = (trimmedLine.startsWith('?') ? trimmedLine.substring(1).trim() : trimmedLine).replace(tagRemovalRegex, '').trim();
                questionContentLines.push(escapeHTML(cleanLine));
            }
        });

        const questionHTML = `<div class="question-text-detail">${questionContentLines.join('<br>')}</div>`;
        const optionsContainerHTML = optionsHTML.length > 0 ? `<div class="answer-options-container">${optionsHTML.join('')}</div>` : '';
        
        return questionHTML + optionsContainerHTML;
    }



    function handleWebSearch(event) {
        event.preventDefault();
        const engine = event.target.dataset.engine;
        if (!engine) return;

        if (currentQuestionIndex >= questionsForCurrentQuiz.length) {
            return;
        }

        const currentQuestion = questionsForCurrentQuiz[currentQuestionIndex];
        const isAnswered = userAnswers[currentQuestionIndex] && userAnswers[currentQuestionIndex].answered;

        let searchQuery = currentQuestion.text;

        if (isAnswered) {
            const correctAnswerText = currentQuestion.options[currentQuestion.correctAnswerIndex].text;
            searchQuery += ` ${correctAnswerText}`;
        }
        
        let searchUrl;
        const encodedQuery = encodeURIComponent(searchQuery);

        switch (engine) {
            case 'google':
                searchUrl = `https://www.google.com/search?q=${encodedQuery}`;
                window.open(searchUrl, '_blank');
                break;
            case 'yandex':
                searchUrl = `https://yandex.ru/search/?text=${encodedQuery}`;
                window.open(searchUrl, '_blank');
                break;
            case 'perplexity':
                searchUrl = `https://www.perplexity.ai/search?q=${encodedQuery}`;
                window.open(searchUrl, '_blank');
                break;
        }

        if (searchDropdownContent) {
            searchDropdownContent.classList.remove('show');
        }
    }




    function renderGradusView(folderId, folderName, isRoot = false) {
        if (isRoot) {
            breadcrumbs = [{ id: folderId, name: folderName }];
        } else {
            const currentIndex = breadcrumbs.findIndex(b => b.id === folderId);
            if (currentIndex > -1) {
                breadcrumbs = breadcrumbs.slice(0, currentIndex + 1);
            } else {
                breadcrumbs.push({ id: folderId, name: folderName });
            }
        }
        updateBreadcrumbs();

        const url = `${googleAppScriptUrl}?action=getFolderContents&folderId=${folderId}`;
        gradusFolderList.innerHTML = `<div class="loading-placeholder">${_('gradus_loading')}</div>`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                gradusFolderList.innerHTML = '';
                if (!data.success) {
                    throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞');
                }

                (data.folders || []).forEach(folder => {
                    const li = document.createElement('li');
                    li.textContent = folder.name;
                    li.title = _('tooltip_open_folder').replace('{name}', folder.name);
                    li.addEventListener('click', () => renderGradusView(folder.id, folder.name));
                    gradusFolderList.appendChild(li);
                });

                (data.files || []).forEach(file => {
                    const li = document.createElement('li');
                    li.textContent = file.name;
                    li.classList.add('file-item');
                    li.title = _('tooltip_start_test').replace('{name}', file.name);
                    li.addEventListener('click', () => fetchAndLoadQstFile(file.id, file.name));
                    gradusFolderList.appendChild(li);
                });
                
                if (gradusFolderList.innerHTML === '') {
                    gradusFolderList.innerHTML = `<div class="loading-placeholder">${_('gradus_folder_empty')}</div>`;
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø–∞–ø–∫–∏:', error);
                gradusFolderList.innerHTML = `<div class="loading-placeholder">${_('gradus_loading_error_prefix')} ${error.message}</div>`;
            });
    }




    function updateBreadcrumbs() {
        gradusBreadcrumbs.innerHTML = '';
        breadcrumbs.forEach((crumb, index) => {
            const link = document.createElement('a');
            link.textContent = crumb.name;
            link.dataset.id = crumb.id;
            link.addEventListener('click', () => renderGradusView(crumb.id, crumb.name));
            gradusBreadcrumbs.appendChild(link);

            if (index < breadcrumbs.length - 1) {
                const separator = document.createElement('span');
                separator.textContent = '>';
                gradusBreadcrumbs.appendChild(separator);
            }
        });
    }



    function fetchAndLoadQstFile(fileId, fileName) {
        gradusFolderList.innerHTML = `<div class="loading-placeholder">${_('gradus_loading_quiz_prefix')} "${fileName}"...</div>`;
        const url = `${googleAppScriptUrl}?action=getFileContent&fileId=${fileId}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞');
                }
                
                originalFileNameForReview = data.fileName;
                allParsedQuestions = parseQstContent(data.content);

                if (allParsedQuestions.length === 0) {
                    alert(`${_('file_empty_or_invalid_part1')}"${data.fileName}" ${_('file_empty_or_invalid_part2')}`);
                    renderGradusView(breadcrumbs[breadcrumbs.length - 1].id, breadcrumbs[breadcrumbs.length - 1].name);
                    return;
                }

                gradusFoldersContainer.classList.add('hidden');
                quizSetupArea.classList.remove('hidden');
                
                questionRangeStartInput.value = 1;
                questionRangeStartInput.max = allParsedQuestions.length;
                questionRangeEndInput.value = allParsedQuestions.length;
                questionRangeEndInput.max = allParsedQuestions.length;
                maxQuestionsInfoEl.textContent = `(${_('total_questions_label')} ${allParsedQuestions.length} ${_('questions_label_for_range')})`;
            })
            .catch(error => {
                alert(`${_('gradus_loading_error_prefix')} ${error.message}`);
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞:', error);
                renderGradusView(breadcrumbs[breadcrumbs.length - 1].id, breadcrumbs[breadcrumbs.length - 1].name);
            });
    }




    function downloadFileBrowserFallback(fileName, content, contentType) {
        const blob = new Blob([content], { type: contentType });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    }
    






    async function downloadOrShareFile(fileName, content, contentType, shareDialogTitlePrefix = '–§–∞–π–ª') {
        console.log(`–ü–æ–ø—ã—Ç–∫–∞ —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª: ${fileName}`);
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
        const isMobile = detectMobileDevice();
        console.log(`–ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${isMobile}`);
        
        if (isMobile) {
            // === –ú–û–ë–ò–õ–¨–ù–´–ï –£–°–¢–†–û–ô–°–¢–í–ê: –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É ===
            await createTemporaryDownloadLink(fileName, content, contentType, shareDialogTitlePrefix);
        } else {
            // === –ü–ö: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ ===
            downloadFileBrowserFallback(fileName, content, contentType);
        }
    }

    // 2. –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ mainApp)
    function detectMobileDevice() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º User Agent
        const isMobileUA = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ touch —Å–æ–±—ã—Ç–∏—è
        const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
        const isSmallScreen = window.innerWidth <= 768;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ —ç—Ç–æ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (Capacitor/Cordova)
        const isMobileApp = !!(window.Capacitor || window.cordova);
        
        // –°—á–∏—Ç–∞–µ–º –º–æ–±–∏–ª—å–Ω—ã–º, –µ—Å–ª–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —É—Å–ª–æ–≤–∏–µ
        const isMobile = isMobileUA || isMobileApp || (hasTouch && isSmallScreen);
        
        console.log(`Mobile UA: ${isMobileUA}, Touch: ${hasTouch}, Small screen: ${isSmallScreen}, Mobile app: ${isMobileApp}`);
        
        return isMobile;
    }



    async function createTemporaryDownloadLink(fileName, content, contentType, shareDialogTitlePrefix) {
        try {
            console.log('–°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (v2)...');
            showMobileDownloadStatus(_('mobile_download_preparing'), 'loading');

            // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ –ø—Ä—è–º–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            const uniqueFileName = `qstium.com_${new Date().getTime()}_${fileName.replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9.\-_]/g, '_')}`;

            // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            const url = `${googleAppScriptUrl}?action=createTempFile&fileName=${encodeURIComponent(uniqueFileName)}`;

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –∫–∞–∫ –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å CORS preflight
            const response = await fetch(url, {
                method: 'POST',
                mode: 'cors', // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'cors', —Ç–∞–∫ –∫–∞–∫ Google Script –≤–µ—Ä–Ω–µ—Ç JSON —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
                headers: {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                body: content // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –Ω–∞–ø—Ä—è–º—É—é
            });

            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.statusText}`);
            }

            const result = await response.json();

            if (result.success && result.downloadUrl) {
                showMobileDownloadLink(fileName, result.downloadUrl, shareDialogTitlePrefix);
            } else {
                throw new Error(result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É');
            }

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å—Å—ã–ª–∫–∏:', error);
            showMobileDownloadFallback(fileName, content);
        }
    }




    function showMobileDownloadLink(fileName, downloadUrl, shareDialogTitlePrefix) {
        showMobileDownloadStatus(`
            <div style="text-align: center;">
                <h3 style="color: #28a745; margin-bottom: 15px;">${_('mobile_download_ready_title')}</h3>
                <p style="margin-bottom: 20px;"><strong>${fileName}</strong></p>
                <a href="${downloadUrl}" 
                   target="_blank" 
                   download="${fileName}"
                   style="
                       display: inline-block;
                       background: linear-gradient(135deg, #007bff, #0056b3);
                       color: white;
                       padding: 15px 30px;
                       text-decoration: none;
                       border-radius: 10px;
                       font-weight: bold;
                       font-size: 1.1em;
                       margin-bottom: 15px;
                       box-shadow: 0 4px 15px rgba(0,123,255,0.3);
                       transition: all 0.3s ease;
                   "
                   onmouseover="this.style.transform='translateY(-2px)'"
                   onmouseout="this.style.transform='translateY(0)'">
                    ${_('mobile_download_button')}
                </a>
                <p style="color: #6c757d; font-size: 0.9em; margin-top: 10px;">
                    ${_('mobile_download_link_info')}
                </p>
            </div>
        `, 'success');
    }


    /**
     * Fallback –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
     * —Å –∫–Ω–æ–ø–∫–æ–π –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –ø—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞.
     * @param {string} fileName - –ò–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.
     * @param {string} content - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞.
     */
    function showMobileDownloadFallback(fileName, content) {
        // –§–æ—Ä–º–∏—Ä—É–µ–º HTML-—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É—è –∫–ª—é—á–∏ –∏–∑ LANG_PACK
        const modalHTML = `
            <div style="text-align: center;">
                <h3 style="color: #f39c12; margin-bottom: 15px;">${_('mobile_download_fallback_title')}</h3>
                <p style="margin-bottom: 15px;">${_('mobile_download_fallback_p1')}</p>
                <p style="margin-bottom: 20px;">${_('mobile_download_fallback_p2')} <strong>${fileName}</strong>:</p>
                <textarea 
                    readonly 
                    style="
                        width: 100%;
                        height: 200px;
                        font-family: monospace;
                        font-size: 0.9em;
                        border: 1px solid #ddd;
                        border-radius: 5px;
                        padding: 10px;
                        margin-bottom: 15px;
                        background-color: #f8f9fa;
                    "
                >${escapeHTML(content)}</textarea>
                <button 
                    onclick="copyToClipboardMain('${escapeForJS(content)}')" 
                    style="
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 5px;
                        font-weight: bold;
                        cursor: pointer;
                        margin-right: 10px;
                    ">
                    ${_('mobile_download_copy_button')}
                </button>
            </div>
        `;

        // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –Ω—É–∂–Ω—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º –∏ —Å—Ç–∏–ª–µ–º "–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ"
        showMobileDownloadStatus(modalHTML, 'warning');
    }


    // –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç—É—Å–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º
    function showMobileDownloadStatus(message, type = 'info') {
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –µ—Å–ª–∏ –µ—Å—Ç—å
        const existingModal = document.getElementById('mobileDownloadModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        const modal = document.createElement('div');
        modal.id = 'mobileDownloadModal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            animation: fadeIn 0.3s ease;
        `;
        
        const content = document.createElement('div');
        content.style.cssText = `
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 80%;
            overflow-y: auto;
            color: black;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            position: relative;
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '√ó';
        closeBtn.style.cssText = `
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #999;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
        `;
        closeBtn.onclick = () => modal.remove();
        
        content.appendChild(closeBtn);
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        const messageDiv = document.createElement('div');
        messageDiv.innerHTML = message;
        content.appendChild(messageDiv);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è —Ç–∏–ø–∞ 'loading'
        if (type === 'loading') {
            const spinner = document.createElement('div');
            spinner.style.cssText = `
                border: 4px solid #f3f3f3;
                border-top: 4px solid #007bff;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
                margin: 20px auto;
            `;
            content.appendChild(spinner);
            
            // –î–æ–±–∞–≤–ª—è–µ–º CSS –∞–Ω–∏–º–∞—Ü–∏—é
            if (!document.getElementById('spinnerStyle')) {
                const style = document.createElement('style');
                style.id = 'spinnerStyle';
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫
        if (type === 'success') {
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.remove();
                }
            }, 30000);
        }
    }



        // –ü–æ–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    function showCopySuccess(button) {
        // –í—Ä–µ–º–µ–Ω–Ω–æ –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
        const originalText = button.textContent;
        const originalStyle = button.style.cssText;
        
        button.textContent = _('copy_success_short');
        button.style.cssText = `
            ${originalStyle}
            background: #28a745 !important;
            transform: scale(1.1);
            transition: all 0.3s ease;
        `;
        button.classList.add('copied');
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –≤–∏–¥ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            button.textContent = originalText;
            button.style.cssText = originalStyle;
            button.classList.remove('copied');
        }, 2000);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        showCopyNotification('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    }


    // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏
    function showCopyNotification(message) {
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
        const existingNotification = document.getElementById('copyNotification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        const notification = document.createElement('div');
        notification.id = 'copyNotification';
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #28a745;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 500;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            animation: slideDown 0.3s ease, fadeOut 0.3s ease 2.7s;
            pointer-events: none;
        `;
        
        document.body.appendChild(notification);
        
        // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }



    /**
     * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞, –µ—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ.
     * @param {string} text - –¢–µ–∫—Å—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.
     */
    function showManualCopyDialog(text) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10001;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            animation: fadeIn 0.3s ease;
        `;
        
        const content = document.createElement('div');
        content.style.cssText = `
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 80%;
            overflow-y: auto;
            color: black;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideUp 0.4s ease;
        `;
        
        // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
        // –í–µ—Å—å HTML-–∫–æ–¥ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–ª—é—á–∏ –∏–∑ LANG_PACK —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é _()
        content.innerHTML = `
            <h3 style="color: #f39c12; margin-bottom: 15px;">${_('manual_copy_title')}</h3>
            <p style="margin-bottom: 15px;">${_('manual_copy_p1')}</p>
            <textarea 
                readonly 
                style="
                    width: 100%;
                    height: 200px;
                    font-family: monospace;
                    font-size: 0.9em;
                    border: 2px solid #007bff;
                    border-radius: 8px;
                    padding: 10px;
                    margin-bottom: 15px;
                    background-color: #f8f9fa;
                    resize: vertical;
                "
                onclick="this.select()"
            >${escapeHTML(text)}</textarea>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                        style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-weight: 500;
                        ">
                    ${_('manual_copy_close_button')}
                </button>
            </div>
        `;
        // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
        
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const textarea = content.querySelector('textarea');
        setTimeout(() => {
            textarea.focus();
            textarea.select();
        }, 100);
    }


    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (—É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
    function isMobileDevice() {
        return /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
               ('ontouchstart' in window) ||
               (navigator.maxTouchPoints > 0) ||
               !!(window.Capacitor || window.cordova);
    }

    // –î–æ–±–∞–≤–ª—è–µ–º CSS –∞–Ω–∏–º–∞—Ü–∏–∏, –µ—Å–ª–∏ –∏—Ö –µ—â–µ –Ω–µ—Ç
    if (!document.getElementById('copyAnimationStyles')) {
        const style = document.createElement('style');
        style.id = 'copyAnimationStyles';
        style.textContent = `
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translate(-50%, -20px);
                }
                to {
                    opacity: 1;
                    transform: translate(-50%, 0);
                }
            }
            
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
            
            .copy-success-animation {
                animation: success-bounce 0.6s ease;
            }
            
            @keyframes success-bounce {
                0%, 20%, 60%, 100% { transform: scale(1); }
                40% { transform: scale(1.1); }
                80% { transform: scale(1.05); }
            }
        `;
        document.head.appendChild(style);
    }




    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ JavaScript
    function escapeForJS(str) {
        return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r');
    }

    // –û—Å—Ç–∞–≤–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –±—Ä–∞—É–∑–µ—Ä–Ω–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    function downloadFileBrowserFallback(fileName, content, contentType) {
        try {
            const blob = new Blob([content], { type: contentType });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            console.log(`–§–∞–π–ª —Å–∫–∞—á–∞–Ω —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä: ${fileName}`);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –±—Ä–∞—É–∑–µ—Ä–Ω–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', error);
            alert(_('error_download_generic_with_filename').replace('{fileName}', fileName));
        }
    }

    // --- –ù–û–í–´–ô –ö–û–î ---
    function initServiceWorkerUpdater() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(reg => {
                    // 1. –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ 'updatefound'
                    reg.onupdatefound = () => {
                        const installingWorker = reg.installing;
                        if (installingWorker) {
                            // 2. –ñ–¥–µ–º, –ø–æ–∫–∞ –Ω–æ–≤—ã–π SW —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è
                            installingWorker.onstatechange = () => {
                                if (installingWorker.state === 'installed') {
                                    // 3. –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π SW, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                                    if (navigator.serviceWorker.controller) {
                                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—à—É –ø–ª–∞—à–∫—É
                                        showUpdateNotification(installingWorker);
                                    }
                                }
                            };
                        }
                    };
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
                });

            // 4. –°–ª—É—à–∞–µ–º —Å–º–µ–Ω—É –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            navigator.serviceWorker.oncontrollerchange = () => {
                console.log('–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∏–∑–º–µ–Ω–∏–ª—Å—è, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...');
                window.location.reload();
            };
        }
    }

    function showUpdateNotification(worker) {
        if (updateNotification && updateBtn) {
            updateNotification.classList.remove('hidden');
            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –∫–ª–∏–∫–∞ –¢–û–õ–¨–ö–û –û–î–ò–ù –†–ê–ó
            updateBtn.onclick = () => {
                // 5. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–æ–≤–æ–º—É SW
                worker.postMessage({ action: 'skipWaiting' });
                updateNotification.classList.add('hidden');
            };
        }
    }
    // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ö–û–î–ê ---

    function updateQuickModeToggleVisual() {
        if (quickModeToggle) {
            quickModeToggle.classList.toggle('active', quickModeEnabled);
            quickModeToggle.title = quickModeEnabled ? _('quick_mode_title_on') : _('quick_mode_title_off');
        }
    }

    function toggleQuickMode() {
        quickModeEnabled = !quickModeEnabled;
        localStorage.setItem('quizQuickModeEnabled', quickModeEnabled);
        updateQuickModeToggleVisual();
    }

    function updateTriggerWordToggleVisual() {
        if (triggerWordToggle) {
            triggerWordToggle.classList.toggle('active', triggerWordModeEnabled);
            triggerWordToggle.title = triggerWordModeEnabled ? _('trigger_mode_title_on') : _('trigger_mode_title_off');
        }
    }

    function toggleTriggerWordMode() {
        triggerWordModeEnabled = !triggerWordModeEnabled;
        updateTriggerWordToggleVisual();
        if (!quizArea.classList.contains('hidden') && questionsForCurrentQuiz.length > 0) {
            loadQuestion(currentQuestionIndex);
        }
    }

    function tokenizeText(text) {
        return text.split(/(\s+|[.,;:!?()"‚Äú‚Äù¬´¬ª-]+)/g).filter(token => token.length > 0);
    }

    function renderQuestionTextWithTriggers(question) {
        const tokens = tokenizeText(question.text);
        let html = '';
        let wordIndex = 0;
        tokens.forEach(token => {
            const isWord = /\S/.test(token) && !/^[.,;:!?()"‚Äú‚Äù¬´¬ª-]+$/.test(token);
            if (isWord) {
                const isTriggered = question.triggeredWordIndices && question.triggeredWordIndices.includes(wordIndex);
                let spanClasses = [];
                if (isTriggered) {
                    spanClasses.push('triggered-word');
                }
                if (triggerWordModeEnabled) {
                    spanClasses.push('triggerable-word');
                }
                if (spanClasses.length > 0) {
                    html += `<span class="${spanClasses.join(' ')}" data-word-index="${wordIndex}">${token}</span>`;
                } else {
                    html += token;
                }
                wordIndex++;
            } else {
                html += token;
            }
        });
        return html;
    }




    function handleWordTriggerClick(event) {
        if (!triggerWordModeEnabled) return;
        const clickedElement = event.target.closest('.triggerable-word, .triggered-word');
        if (!clickedElement || !clickedElement.dataset.hasOwnProperty('wordIndex')) return;
        
        event.stopPropagation();
        event.preventDefault();

        const wordIndex = parseInt(clickedElement.dataset.wordIndex, 10);
        
        // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ ---

        let questionObjectToModify; // –≠—Ç–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –ª–∏–±–æ –æ—Ä–∏–≥–∏–Ω–∞–ª, –ª–∏–±–æ –ø–µ—Ä–µ–≤–æ–¥

        // 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å –∫–∞–∫–∏–º –æ–±—ä–µ–∫—Ç–æ–º –º—ã —Å–µ–π—á–∞—Å —Ä–∞–±–æ—Ç–∞–µ–º
        if (isTranslateModeEnabled) {
            // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω –ø–µ—Ä–µ–≤–æ–¥, –Ω–∞—à–∞ —Ü–µ–ª—å - –æ–±—ä–µ–∫—Ç –ø–µ—Ä–µ–≤–æ–¥–∞ –≤ –∫—ç—à–µ
            const lang = localStorage.getItem('appLanguage') || 'ru';
            const originalQuestion = questionsForCurrentQuiz[currentQuestionIndex];
            const cacheKey = getCacheKey(originalQuestion.originalIndex, lang);
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ –µ—Å—Ç—å –≤ –∫—ç—à–µ, –æ–Ω —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–∞—à–µ–π —Ü–µ–ª—å—é
            if (currentQuizTranslations.has(cacheKey)) {
                questionObjectToModify = currentQuizTranslations.get(cacheKey);
            } else {
                // –ï—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥–∞ –ø–æ—á–µ–º—É-—Ç–æ –Ω–µ—Ç, –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —Ä–∞–±–æ—Ç–∞–µ–º —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º
                questionObjectToModify = questionsForCurrentQuiz[currentQuestionIndex];
            }
        } else {
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ –≤—ã–∫–ª—é—á–µ–Ω, –Ω–∞—à–∞ —Ü–µ–ª—å - —ç—Ç–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å
            questionObjectToModify = questionsForCurrentQuiz[currentQuestionIndex];
        }

        // 2. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ triggeredWordIndices –¢–û–õ–¨–ö–û —É —Ü–µ–ª–µ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
        if (!questionObjectToModify.triggeredWordIndices) {
            questionObjectToModify.triggeredWordIndices = [];
        }

        const indexInArray = questionObjectToModify.triggeredWordIndices.indexOf(wordIndex);
        if (indexInArray > -1) {
            questionObjectToModify.triggeredWordIndices.splice(indexInArray, 1);
        } else {
            questionObjectToModify.triggeredWordIndices.push(wordIndex);
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥, —á—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å, —Å—Ç–∞–≤–∏–º –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
            if (!triggerWordsUsedInQuiz && questionObjectToModify.triggeredWordIndices.length > 0) {
                triggerWordsUsedInQuiz = true;
            }
        }

        // 3. –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç, –∏—Å–ø–æ–ª—å–∑—É—è —Ç–æ—Ç –∂–µ —Å–∞–º—ã–π –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç
        questionTextEl.innerHTML = renderQuestionTextWithTriggers(questionObjectToModify);

        // 4. –ó–∞–Ω–æ–≤–æ –Ω–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ –Ω–æ–≤—ã–µ <span>
        addTriggerClickListeners();
        
        // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
    }


    function addTriggerClickListeners() {
        if (triggerWordModeEnabled) {
            questionTextEl.querySelectorAll('.triggerable-word, .triggered-word').forEach(span => {
                span.removeEventListener('click', handleWordTriggerClick);
                span.addEventListener('click', handleWordTriggerClick);
            });
        }
    }

    function ÿ±Ÿàÿ≥ŸäŸÅÿßŸäQuestionText(text) {
        const cleanedText = text.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?]/g,"").replace(/~+/g, '');
        let result = '';
        const wordsAndNumbers = cleanedText.match(/[–∞-—è–ê-–Øa-zA-Z]+|\d+/g) || [];
        wordsAndNumbers.forEach(part => {
            if (/\d+/.test(part)) {
                result += part;
            } else if (/[–∞-—è–ê-–Øa-zA-Z]+/.test(part)) {
                result += part.charAt(0);
            }
        });
        return result.toUpperCase();
    }

    function generateCheatSheet(questions) {
        let cheatSheet = '';
        const questionsForSheet = questions.map(q => ({ ...q, }));
        const sortedQuestions = [...questionsForSheet].sort((a, b) => a.text.localeCompare(b.text, 'ru', { sensitivity: 'base' }));
        sortedQuestions.forEach(question => {
            const ÿ±Ÿàÿ≥ŸäŸÅÿßŸädQuestion = ÿ±Ÿàÿ≥ŸäŸÅÿßŸäQuestionText(question.text);
            let correctAnswerText = question.options.find(opt => opt.isCorrect)?.text || '';
            cheatSheet += `${ÿ±Ÿàÿ≥ŸäŸÅÿßŸädQuestion}\n+ ${correctAnswerText}\n\n`;
        });
        return cheatSheet.trim();
    }




    function handleGenerateCheatSheet() {
        if (allParsedQuestions.length === 0) {
            alert(_('error_load_file_first'));
            return;
        }
        let questionsToProcess = [];
        let startRange = parseInt(questionRangeStartInput.value);
        let endRange = parseInt(questionRangeEndInput.value);
        if (!isNaN(startRange) && !isNaN(endRange) && startRange >= 1 && endRange >= startRange && endRange <= allParsedQuestions.length) {
            questionsToProcess = allParsedQuestions.slice(startRange - 1, endRange);
        } else {
            questionsToProcess = allParsedQuestions;
        }
        if (questionsToProcess.length === 0) {
            alert(_('error_no_questions_for_cheatsheet'));
            return;
        }
        generatedCheatSheetContent = generateCheatSheet(questionsToProcess);
        cheatSheetOutputEl.value = generatedCheatSheetContent;
        quizSetupArea.classList.add('hidden');
        quizArea.classList.add('hidden');
        resultsArea.classList.add('hidden');
        cheatSheetResultArea.classList.remove('hidden');
    }




    async function handleDownloadOrShareCheatSheet() {
        if (!generatedCheatSheetContent) {
            alert(_('error_cheat_sheet_first'));
            return;
        }
        const fileNameBase = originalFileNameForReview ? originalFileNameForReview.replace(/\.qst$/i, '').replace(/\.txt$/i, '') : 'cheatsheet';
        const fileName = `${fileNameBase}_spora.txt`;
        await downloadOrShareFile(fileName, generatedCheatSheetContent, 'text/plain;charset=utf-8', _('share_title_cheatsheet'));
    }

    function saveRecentFile(fileName, fileContent) {
        let recentFiles = JSON.parse(localStorage.getItem(RECENT_FILES_STORAGE_KEY)) || [];
        recentFiles = recentFiles.filter(f => f.name !== fileName);
        recentFiles.unshift({ name: fileName, content: fileContent });
        if (recentFiles.length > MAX_RECENT_FILES) {
            recentFiles.pop();
        }
        try {
            localStorage.setItem(RECENT_FILES_STORAGE_KEY, JSON.stringify(recentFiles));
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ localStorage:", e);
            localStorage.removeItem(RECENT_FILES_STORAGE_KEY);
        }
        loadRecentFiles();
        ChatModule.uploadFileToServer(fileName, fileContent, googleAppScriptUrl); 
    }

    function loadRecentFiles() {
        const recentFilesData = JSON.parse(localStorage.getItem(RECENT_FILES_STORAGE_KEY)) || [];
        recentFilesListEl.innerHTML = '';
        if (recentFilesData.length > 0) {
            recentFilesArea.classList.remove('hidden');
            recentFilesData.forEach(fileData => {
                const li = document.createElement('li');
                li.textContent = fileData.name;
                li.title = _('tooltip_load_file').replace('{name}', fileData.name);
                li.addEventListener('click', () => {
                    fileInput.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–ø—É—Ç
                    processFile(fileData.name, fileData.content);
                });
                recentFilesListEl.appendChild(li);
            });


        } else {
            recentFilesArea.classList.add('hidden');
        }
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            processFile(file.name, e.target.result);
        };
        reader.readAsText(file, 'UTF-8');
    }

    function handleReadingModeChange() {
        if (readingModeCheckbox.checked) {
            // –ï—Å–ª–∏ —Ä–µ–∂–∏–º —á—Ç–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω, –æ—Ç–∫–ª—é—á–∞–µ–º –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ –æ–ø—Ü–∏–∏
            shuffleQuestionsCheckbox.checked = false;
            shuffleQuestionsCheckbox.disabled = true;
            shuffleAnswersCheckbox.checked = false;
            shuffleAnswersCheckbox.disabled = true;
        } else {
            // –ï—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω, —Å–Ω–æ–≤–∞ –¥–µ–ª–∞–µ–º –æ–ø—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏
            shuffleQuestionsCheckbox.disabled = false;
            shuffleAnswersCheckbox.disabled = false;
        }
    }


     

    function processFile(fileName, fileContent, quizContext = null) {
        originalFileNameForReview = fileName;
        currentFileCacheKey = `translation_cache_${fileName}_${fileContent.length}`;
        
        // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
        const storedTranslations = localStorage.getItem(currentFileCacheKey);
        if (storedTranslations) {
            try {
                // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞.
                // –°—Ç–∞—Ä—ã–π –∫—ç—à –±—ã–ª –ø—Ä–æ—Å—Ç–æ –º–∞—Å—Å–∏–≤–æ–º. –ù–æ–≤—ã–π - –º–∞—Å—Å–∏–≤ –º–∞—Å—Å–∏–≤–æ–≤.
                const parsedData = JSON.parse(storedTranslations);
                if (Array.isArray(parsedData) && (parsedData.length === 0 || Array.isArray(parsedData[0]))) {
                    currentQuizTranslations = new Map(parsedData);
                    console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω –∫—ç—à –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –¥–ª—è —Ñ–∞–π–ª–∞ "${fileName}" (${currentQuizTranslations.size} –∑–∞–ø–∏—Å–µ–π).`);
                } else {
                    // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç —Å—Ç–∞—Ä—ã–π, –ø—Ä–æ—Å—Ç–æ –Ω–∞—á–∏–Ω–∞–µ–º —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞.
                    console.log("–û–±–Ω–∞—Ä—É–∂–µ–Ω —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –∫—ç—à–∞. –°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π.");
                    currentQuizTranslations = new Map();
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫—ç—à–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤:", e);
                currentQuizTranslations = new Map();
            }
        } else {
            currentQuizTranslations = new Map();
        }

        allParsedQuestions = parseQstContent(fileContent);
        currentQuizContext = quizContext; 
        hideGlobalLoader();

        if (allParsedQuestions.length > 0) {
            saveRecentFile(fileName, fileContent);
            
            fileUploadArea.classList.add('hidden');
            searchResultsContainer.classList.add('hidden');
            quizSetupArea.classList.remove('hidden');
            
            const questionCount = allParsedQuestions.filter(q => q.type !== 'category').length;
            maxQuestionsInfoEl.textContent = `(${_('total_questions_label')} ${questionCount} ${_('questions_label_for_range')})`;
            shuffleNCountInput.max = questionCount; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å. –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
            
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–≤–æ–π–Ω–æ–π –ø–æ–ª–∑—É–Ω–æ–∫
            initDualSlider(questionCount);
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–π –ø–æ–ª–∑—É–Ω–æ–∫ –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏
            initSingleSlider(); 
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
            shuffleNCheckbox.checked = false;
            handleShuffleNToggle();

            if (quizContext && !quizContext.isPractice) {
                shuffleQuestionsCheckbox.checked = true;
                shuffleAnswersCheckbox.checked = true;
                readingModeCheckbox.checked = false;
                flashcardsModeCheckbox.checked = false; // <-- –î–û–ë–ê–í–õ–ï–ù–û: –£–±–∏—Ä–∞–µ–º –≥–∞–ª–æ—á–∫—É
                shuffleQuestionsCheckbox.disabled = true;
                shuffleAnswersCheckbox.disabled = true;
                readingModeCheckbox.disabled = true;
                flashcardsModeCheckbox.disabled = true; // <-- –î–û–ë–ê–í–õ–ï–ù–û: –ë–ª–æ–∫–∏—Ä—É–µ–º —á–µ–∫–±–æ–∫—Å
                questionRangeStartInput.disabled = true;
                questionRangeEndInput.disabled = true;
            } else {
                shuffleQuestionsCheckbox.disabled = false;
                shuffleAnswersCheckbox.disabled = false;
                readingModeCheckbox.disabled = false;
                flashcardsModeCheckbox.disabled = false; // <-- –î–û–ë–ê–í–õ–ï–ù–û: –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
                questionRangeStartInput.disabled = false;
                questionRangeEndInput.disabled = false;
            }
        } else {
            alert(`${_('file_empty_or_invalid_part1')}"${fileName}"${_('file_empty_or_invalid_part2')}`);
        }
        manageBackButtonInterceptor();
    }




    function parseQstContent(content) {
        let parsedItems = [];
        const lines = content.replace(/\r\n/g, '\n').split('\n');
        
        let currentQuestion = null;
        // –≠–≤—Ä–∏—Å—Ç–∏–∫–∞: —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –≤–æ–ø—Ä–æ—Å –∑–∞–∫–æ–Ω—á–∏–ª—Å—è, –µ—Å–ª–∏ —É –Ω–µ–≥–æ —É–∂–µ –µ—Å—Ç—å 4+ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∏ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π "+"
        const MIN_OPTIONS_BEFORE_SPLIT = 4; 
        // –•—Ä–∞–Ω–∏–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫ –∫–∞–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞
        let lastTextLines = []; 

        const saveCurrentQuestion = () => {
            if (currentQuestion && currentQuestion.options.length > 0 && currentQuestion.correctAnswerIndex > -1) {
                // –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞ –æ—Ç –≤—Å–µ—Ö —Ç–µ–≥–æ–≤
                currentQuestion.text = currentQuestion.text
                    .replace(/<\/?(question|–≤–æ–ø—Ä–æ—Å|qst)>/gi, '')
                    .trim();
                // –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—É—é –Ω—É–º–µ—Ä–∞—Ü–∏—é –≤ –Ω–∞—á–∞–ª–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "1. ", "2) ")
                currentQuestion.text = currentQuestion.text.replace(/^\s*\d+[\.\)]\s*/, '');

                if (currentQuestion.text) { // –°–æ—Ö—Ä–∞–Ω—è–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞
                    parsedItems.push(currentQuestion);
                }
            }
            currentQuestion = null;
        };

        for (const line of lines) {
            const trimmedLine = line.trim();
            const tagRemovalRegex = /<\/?(variant|–≤–∞—Ä–∏–∞–Ω—Ç)>/gi;

            if (!trimmedLine) continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏

            if (trimmedLine.startsWith('#_#') && trimmedLine.endsWith('#_#')) {
                saveCurrentQuestion();
                const categoryName = trimmedLine.slice(3, -3).trim();
                parsedItems.push({ text: categoryName, type: 'category' });
                lastTextLines = [];
                continue;
            }

            if (trimmedLine.startsWith('?')) {
                saveCurrentQuestion();
                currentQuestion = {
                    text: trimmedLine.substring(1).trim(),
                    options: [],
                    correctAnswerIndex: -1,
                    originalRaw: [line]
                };
                lastTextLines = []; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
            } else if (trimmedLine.startsWith('+')) {
                // –≠–í–†–ò–°–¢–ò–ö–ê: –ï—Å–ª–∏ —É —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ —É–∂–µ –µ—Å—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤,
                // —Ç–æ —ç—Ç–æ, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –Ω–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ "—Å–∫–ª–µ–µ–Ω–Ω–æ–≥–æ" –≤–æ–ø—Ä–æ—Å–∞.
                if (currentQuestion && currentQuestion.correctAnswerIndex > -1 && currentQuestion.options.length >= MIN_OPTIONS_BEFORE_SPLIT) {
                    saveCurrentQuestion();
                }

                if (!currentQuestion) {
                    // –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫.
                    currentQuestion = {
                        text: lastTextLines.join(' ').trim(),
                        options: [],
                        correctAnswerIndex: -1,
                        originalRaw: [...lastTextLines, line]
                    };
                }
                
                const optionText = trimmedLine.substring(1).trim().replace(tagRemovalRegex, '').trim();
                currentQuestion.options.push({ text: optionText, isCorrect: true });
                // –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Å–∫–æ–ª—å–∫–æ
                currentQuestion.correctAnswerIndex = currentQuestion.options.length - 1;
                lastTextLines = []; // –í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–µ–∫—Å—Ç–æ–º –≤–æ–ø—Ä–æ—Å–∞
            
            } else if (trimmedLine.startsWith('-')) {
                if (currentQuestion) {
                    const optionText = trimmedLine.substring(1).trim().replace(tagRemovalRegex, '').trim();
                    currentQuestion.options.push({ text: optionText, isCorrect: false });
                    currentQuestion.originalRaw.push(line);
                    lastTextLines = []; // –í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–µ–∫—Å—Ç–æ–º –≤–æ–ø—Ä–æ—Å–∞
                }
            } else if (trimmedLine.length > 0) {
                // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫–æ–º–∞–Ω–¥–∞, —Ç–æ —ç—Ç–æ –ª–∏–±–æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞, –ª–∏–±–æ —Å–∞–º —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞
                if (currentQuestion) {
                    currentQuestion.text += ' ' + trimmedLine;
                    currentQuestion.originalRaw.push(line);
                }
                // –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ, –∑–∞–ø–æ–º–∏–Ω–∞–µ–º —ç—Ç—É —Å—Ç—Ä–æ–∫—É –∫–∞–∫ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
                lastTextLines.push(trimmedLine);
                if(lastTextLines.length > 3) lastTextLines.shift(); // –•—Ä–∞–Ω–∏–º –Ω–µ –±–æ–ª—å—à–µ 3-—Ö –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å—Ç—Ä–æ–∫
            }
        }
        
        saveCurrentQuestion(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∞–º—ã–π –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å –≤ —Ñ–∞–π–ª–µ

        return parsedItems;
    }


    // –ù–æ–≤–∞—è –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
    function formatQuestionObjectToQstString(questionObject) {
        if (!questionObject || !questionObject.text || !questionObject.options) {
            return '';
        }
        let qstString = `? ${questionObject.text}\n`;
        questionObject.options.forEach(opt => {
            const prefix = opt.isCorrect ? '+' : '-';
            qstString += `${prefix} ${opt.text}\n`;
        });
        return qstString.trim();
    }

    /**
     * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω –Ω–æ–º–µ—Ä–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –º–∞—Å—Å–∏–≤–∞, –ø—Ä–æ–ø—É—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
     * @param {Array} sourceArray - –ú–∞—Å—Å–∏–≤ —Å–æ –≤—Å–µ–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ (–≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏).
     * @param {number} startNum - –ù–∞—á–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –≤–æ–ø—Ä–æ—Å–∞ (–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).
     * @param {number} endNum - –ö–æ–Ω–µ—á–Ω—ã–π –Ω–æ–º–µ—Ä –≤–æ–ø—Ä–æ—Å–∞ (–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).
     * @returns {{startIndex: number, endIndex: number}} - –û–±—ä–µ–∫—Ç —Å –Ω–∞—á–∞–ª—å–Ω—ã–º –∏ –∫–æ–Ω–µ—á–Ω—ã–º –∏–Ω–¥–µ–∫—Å–∞–º–∏.
     */
    function mapQuestionRangeToIndices(sourceArray, startNum, endNum) {
        let questionCounter = 0;
        let startIndex = -1;
        let endIndex = -1;
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –º–∞—Å—Å–∏–≤, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏
        const onlyQuestions = sourceArray.filter(item => item.type !== 'category');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∏–∞–ø–∞–∑–æ–Ω –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–æ–ø—Ä–æ—Å–æ–≤
        if (startNum < 1) startNum = 1;
        if (endNum > onlyQuestions.length) endNum = onlyQuestions.length;

        sourceArray.forEach((item, index) => {
            // –°—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
            if (item.type !== 'category') {
                questionCounter++;
                
                // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –Ω–∞—á–∞–ª—É –¥–∏–∞–ø–∞–∑–æ–Ω–∞
                if (questionCounter === startNum && startIndex === -1) {
                    startIndex = index;
                }
                
                // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ü—É –¥–∏–∞–ø–∞–∑–æ–Ω–∞
                if (questionCounter === endNum) {
                    endIndex = index;
                }
            }
        });

        // –ï—Å–ª–∏ –∫–æ–Ω–µ—á–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–µ –±—ã–ª –Ω–∞–π–¥–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–∏–∞–ø–∞–∑–æ–Ω –¥–æ –∫–æ–Ω—Ü–∞),
        // –∏—â–µ–º –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –º–∞—Å—Å–∏–≤–∞.
        if (endIndex === -1) {
            endIndex = sourceArray.length - 1;
        }

        return { startIndex, endIndex };
    }


    function applySettingsAndStartQuiz(isErrorReview = false, questionsSource = null) {
        let finalQuizContext = currentQuizContext; 
        
        let sourceArray;

        // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ ---
        if (shuffleNCheckbox.checked && !isErrorReview) {
            quizSettings.shuffleQuestions = true; // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞–µ–º –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ
            quizSettings.shuffleAnswers = shuffleAnswersCheckbox.checked;
            quizSettings.feedbackMode = feedbackModeCheckbox.checked;
            quizSettings.readingMode = readingModeCheckbox.checked;
            quizSettings.flashcardsMode = flashcardsModeCheckbox.checked;
            quizSettings.timeLimit = parseInt(timeLimitInput.value);

            const n = parseInt(shuffleNCountInput.value);
            const allActualQuestions = allParsedQuestions.filter(q => q.type !== 'category');
            
            if (n > allActualQuestions.length || n < 1) {
                alert(`–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç 1 –¥–æ ${allActualQuestions.length}`);
                return;
            }

            // --- –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–π ---
            const questionMap = new Map();
            allParsedQuestions.forEach((q, index) => {
                if(q.type !== 'category') {
                    questionMap.set(index, q);
                }
            });

            const allQuestionIndices = Array.from(questionMap.keys());
            shuffleArray(allQuestionIndices);
            const selectedIndices = new Set(allQuestionIndices.slice(0, n));
            
            sourceArray = [];
            allParsedQuestions.forEach((item, index) => {
                if (item.type === 'category' || selectedIndices.has(index)) {
                     // –î–æ–±–∞–≤–ª—è–µ–º –∫ –≤–æ–ø—Ä–æ—Å—É –µ–≥–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –∫—ç—à–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤
                    sourceArray.push({ ...item, originalIndex: index });
                }
            });

            // –û—á–∏—Å—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            sourceArray = sourceArray.filter((item, index, arr) => {
                if (item.type === 'category') {
                    const nextItem = arr[index + 1];
                    return nextItem && nextItem.type !== 'category';
                }
                return true;
            });

        } else if (!isErrorReview) {
            // --- –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞ ---
            quizSettings.timeLimit = parseInt(timeLimitInput.value);
            quizSettings.shuffleQuestions = shuffleQuestionsCheckbox.checked;
            quizSettings.shuffleAnswers = shuffleAnswersCheckbox.checked;
            quizSettings.feedbackMode = feedbackModeCheckbox.checked;
            quizSettings.readingMode = readingModeCheckbox.checked;
            quizSettings.flashcardsMode = flashcardsModeCheckbox.checked;
            
            const totalQuestionsCount = allParsedQuestions.filter(q => q.type !== 'category').length;
            
            let startRange = parseInt(questionRangeStartInput.value);
            let endRange = parseInt(questionRangeEndInput.value);

            if (isNaN(startRange) || startRange < 1) startRange = 1;
            if (isNaN(endRange) || endRange < startRange) endRange = totalQuestionsCount;

            const indices = mapQuestionRangeToIndices(allParsedQuestions, startRange, endRange);

            let finalStartIndex = indices.startIndex;
            if (indices.startIndex > 0 && allParsedQuestions[indices.startIndex - 1].type === 'category') {
                finalStartIndex = indices.startIndex - 1;
            }

            sourceArray = allParsedQuestions.slice(finalStartIndex, indices.endIndex + 1)
                .map((question, localIndex) => ({
                    ...question,
                    originalIndex: finalStartIndex + localIndex
                }));     

        } else {
            // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ –æ—à–∏–±–∫–∞–º–∏ (–Ω–µ –º–µ–Ω—è–µ—Ç—Å—è) ---
            sourceArray = questionsSource;
            quizSettings.timeLimit = 0;
            quizSettings.shuffleQuestions = false;
            quizSettings.shuffleAnswers = shuffleAnswersCheckbox.checked;
        }
        
        // --- –û–±—â–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (–Ω–µ –º–µ–Ω—è–µ—Ç—Å—è) ---
        if (quizSettings.shuffleQuestions && !isErrorReview) {
            let shuffledQuiz = [];
            let questionGroup = [];

            sourceArray.forEach((item) => {
                if (item.type === 'category') {
                    if (questionGroup.length > 0) {
                        shuffleArray(questionGroup);
                        shuffledQuiz.push(...questionGroup);
                        questionGroup = []; 
                    }
                    shuffledQuiz.push(item);
                } else {
                    questionGroup.push(item);
                }
            });

            if (questionGroup.length > 0) {
                shuffleArray(questionGroup);
                shuffledQuiz.push(...questionGroup);
            }
            
            questionsForCurrentQuiz = shuffledQuiz;

        } else {
            questionsForCurrentQuiz = [...sourceArray];
        }

        questionsForCurrentQuiz = questionsForCurrentQuiz.map(q => JSON.parse(JSON.stringify(q)));
        triggerWordsUsedInQuiz = questionsForCurrentQuiz.some(q => q.type !== 'category' && q.triggeredWordIndices && q.triggeredWordIndices.length > 0);
        
        if (quizSettings.readingMode) {
            questionsForCurrentQuiz.forEach(q => {
                if (q.type !== 'category' && q.options && q.correctAnswerIndex > -1) {
                    const correctAnswer = q.options[q.correctAnswerIndex];
                    q.options.splice(q.correctAnswerIndex, 1);
                    q.options.unshift(correctAnswer);
                    q.correctAnswerIndex = 0;
                }
            });
        }

        if (quizSettings.shuffleAnswers) {
            questionsForCurrentQuiz.forEach(q => {
                if (q.type !== 'category' && q.options) {
                    const correctAnswerObject = q.options[q.correctAnswerIndex];
                    shuffleArray(q.options);
                    q.correctAnswerIndex = q.options.findIndex(opt => opt === correctAnswerObject);
                }
            });
        }
        
        if (questionsForCurrentQuiz.filter(q => q.type !== 'category').length === 0) {
            alert("–ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∞ —Å —Ç–µ–∫—É—â–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏.");
            return;
        }

        questionsForCurrentQuiz.forEach((q, index) => {
            q.originalIndexInQuiz = index;
        });
        
        quizSetupArea.classList.add('hidden');
        cheatSheetResultArea.classList.add('hidden');
        gradusFoldersContainer.classList.add('hidden');
        quizArea.classList.remove('hidden');
        resultsArea.classList.add('hidden');
        startQuiz(finalQuizContext);
        manageBackButtonInterceptor();
    }



    function startQuiz(quizContext = null) {
        appTitleHeader?.classList.add('hidden');
        currentQuizContext = quizContext;
        quizStartTime = new Date().getTime();
        currentQuestionIndex = 0;
        score = 0;
        userAnswers = new Array(questionsForCurrentQuiz.length).fill(null).map(() => ({ answered: false, correct: null, selectedOptionIndex: null }));
        incorrectlyAnsweredQuestionsData = [];
        totalQuestionsNumEl.textContent = questionsForCurrentQuiz.filter(q => q.type !== 'category').length;
        updateScoreDisplay();
        setupTimer();
        generateQuickNav();

        // --- –ù–ê–ß–ê–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ô –õ–û–ì–ò–ö–ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ö–ù–û–ü–û–ö ---

        // 1. –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–Ω—ã –≤ –õ–Æ–ë–û–ú —Ä–µ–∂–∏–º–µ —Ç–µ—Å—Ç–∞
        finishTestButton?.classList.remove('hidden');
        continueLaterButton?.classList.remove('hidden');
        languageToggle?.classList.add('hidden'); // –ö–Ω–æ–ø–∫–∞ —Å–º–µ–Ω—ã —è–∑—ã–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ —Å–∫—Ä—ã—Ç–∞ –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞

        // 2. –¢–µ–ø–µ—Ä—å, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–ª—è –Ω–µ–≥–æ –∫–Ω–æ–ø–∫–∏
        if (quizSettings.flashcardsMode) {
            // –†–ï–ñ–ò–ú –ö–ê–†–¢–û–ß–ï–ö
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º:
            translateQuestionBtn?.classList.remove('hidden');
            // –°–∫—Ä—ã–≤–∞–µ–º:
            webSearchDropdown?.classList.add('hidden');
            copyQuestionBtnQuiz?.classList.add('hidden');
            getEl('favoriteQuestionBtn')?.classList.add('hidden');
            quickModeToggle?.classList.add('hidden');
            triggerWordToggle?.classList.add('hidden');
            downloadTranslatedTxtButton?.classList.add('hidden'); // <-- –í–∞–∂–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            downloadTranslatedQstButton?.classList.add('hidden'); // <-- –í–∞–∂–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        } else {
            // –û–ë–´–ß–ù–´–ô –†–ï–ñ–ò–ú –¢–ï–°–¢–ê
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º:
            webSearchDropdown?.classList.remove('hidden');
            copyQuestionBtnQuiz?.classList.remove('hidden');
            getEl('favoriteQuestionBtn')?.classList.remove('hidden');
            quickModeToggle?.classList.remove('hidden');
            triggerWordToggle?.classList.remove('hidden');
            translateQuestionBtn?.classList.remove('hidden');
            downloadTranslatedTxtButton?.classList.remove('hidden'); // <-- –í–∞–∂–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            downloadTranslatedQstButton?.classList.remove('hidden'); // <-- –í–∞–∂–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        }

        // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ô –õ–û–ì–ò–ö–ò ---

        // –í—ã–∑—ã–≤–∞–µ–º —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ, —á—Ç–æ–±—ã –æ–Ω–∏ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å –∫ –≤–∏–¥–∏–º—ã–º –∫–Ω–æ–ø–∫–∞–º
        updateDownloadButtonsText();
        updateTranslateModeToggleVisual();

        loadQuestion(currentQuestionIndex);
        window.addEventListener('beforeunload', handleBeforeUnload);
    }


    function setupTimer() {
        if (timerInterval) clearInterval(timerInterval);
        if (quizSettings.timeLimit > 0) {
            timeLeftInSeconds = quizSettings.timeLimit * 60;
            timerDisplayEl.classList.remove('hidden');
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeLeftInSeconds--;
                updateTimerDisplay();
                if (timeLeftInSeconds <= 0) {
                    clearInterval(timerInterval);
                    showResults();
                }
            }, 1000);
        } else {
            timerDisplayEl.classList.add('hidden');
        }
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timeLeftInSeconds / 60);
        const seconds = timeLeftInSeconds % 60;
        timeLeftEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }



    function generateQuickNav() {
        quickNavButtonsContainer.innerHTML = '';
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ —Ç–µ—Å—Ç–µ –±–æ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ (–≤–æ–ø—Ä–æ—Å–∞ –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
        if (questionsForCurrentQuiz.length > 1) {
            quickNavPanel.classList.remove('hidden');
            
            let questionNumber = 1; // –ó–∞–≤–æ–¥–∏–º –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –¥–ª—è –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –¢–û–õ–¨–ö–û –≤–æ–ø—Ä–æ—Å–æ–≤

            questionsForCurrentQuiz.forEach((item, index) => {
                // –ï–°–õ–ò –≠–¢–û –ö–ê–¢–ï–ì–û–†–ò–Ø
                if (item.type === 'category') {
                    const categoryHeader = document.createElement('div');
                    categoryHeader.className = 'quick-nav-category';
                    categoryHeader.textContent = item.text;
                    quickNavButtonsContainer.appendChild(categoryHeader);
                } 
                // –ï–°–õ–ò –≠–¢–û –û–ë–´–ß–ù–´–ô –í–û–ü–†–û–°
                else {
                    const btn = document.createElement('button');
                    btn.classList.add('quick-nav-btn');
                    btn.textContent = questionNumber; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à —Å—á–µ—Ç—á–∏–∫
                    btn.dataset.questionIndex = index; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≤ –º–∞—Å—Å–∏–≤–µ
                    btn.addEventListener('click', () => loadQuestion(index));
                    quickNavButtonsContainer.appendChild(btn);

                    questionNumber++; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤
                }
            });
        } else {
            quickNavPanel.classList.add('hidden');
        }
    }




    function updateQuickNavButtons() {
        const buttons = quickNavButtonsContainer.querySelectorAll('.quick-nav-btn');
        buttons.forEach((btn) => {
            const btnIndex = parseInt(btn.dataset.questionIndex);
            btn.classList.remove('current', 'answered', 'correct', 'incorrect');
            if (btnIndex === currentQuestionIndex) {
                btn.classList.add('current');
            }
            
            const answerState = userAnswers[btnIndex];
            if (answerState && answerState.answered) {
                btn.classList.add('answered');
                
                // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–µ–∂–∏–º–∞ ---
                if (quizSettings.flashcardsMode) {
                    // –î–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ "–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ" –≤—Å–µ–≥–¥–∞ –æ–∑–Ω–∞—á–∞–µ—Ç "–≤—ã–ø–æ–ª–Ω–µ–Ω–æ" (–∑–µ–ª–µ–Ω—ã–π)
                    btn.classList.add('correct');
                } else {
                    // –î–ª—è –æ–±—ã—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É
                    btn.classList.add(answerState.correct ? 'correct' : 'incorrect');
                }
                // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
            }
        });
    }



    function displayCategoryPage(categoryName) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–æ–ø—Ä–æ—Å–∞
        questionContainer.classList.remove('hidden');
        // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
        // –û—á–∏—â–∞–µ–º –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç, –∏—Å–ø–æ–ª—å–∑—É—è —Å–∏—Å—Ç–µ–º—É –ø–µ—Ä–µ–≤–æ–¥–æ–≤
        questionTextEl.innerHTML = `
            <div class="quiz-category-screen">
                <span>${_('flashcard_category_label')}</span>
                <h2>${escapeHTML(categoryName)}</h2>
            </div>
        `;
        // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
        getEl('score').style.visibility = 'hidden';

        // –ü—Ä—è—á–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        answerOptionsEl.innerHTML = '';
        feedbackAreaEl.textContent = '';
        feedbackAreaEl.className = 'feedback-area';
        copyQuestionBtnQuiz?.classList.add('hidden');
        getEl('favoriteQuestionBtn')?.classList.add('hidden');
        translateQuestionBtn?.classList.add('hidden');
        webSearchDropdown?.classList.add('hidden');
    }



    function loadQuestion(index) {
        if (index < 0 || index >= questionsForCurrentQuiz.length) return;
        currentQuestionIndex = index;
        const item = questionsForCurrentQuiz[index];

        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã UI, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω—ã –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤
        updateNavigationButtons();
        updateQuickNavButtons();
        getEl('score').style.visibility = 'hidden';
        feedbackAreaEl.innerHTML = '';
        answerOptionsEl.innerHTML = ''; // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –æ–±–ª–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤
        questionTextEl.innerHTML = ''; // –∏ –æ–±–ª–∞—Å—Ç—å –≤–æ–ø—Ä–æ—Å–∞

        // –ì–ª–∞–≤–Ω–æ–µ –≤–µ—Ç–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏
        if (quizSettings.flashcardsMode) {
            // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º –∫–∞—Ä—Ç–æ—á–µ–∫...
            if (item.type === 'category') {
                // ...–∏ —ç—Ç–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–µ –∫–∞–∫ –∫–∞—Ä—Ç–æ—á–∫—É-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
                displayCategoryAsCard(item);
            } else {
                // ...–∞ –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–ø—Ä–æ—Å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω—É—é —Ñ–ª–µ—à-–∫–∞—Ä—Ç—É
                displayFlashcard(item);
            }
        } else {
            // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º —Ç–µ—Å—Ç–∞...
            if (item.type === 'category') {
                // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
                // ...–∏ —ç—Ç–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–µ –∫–∞–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—É-–∑–∞—Å—Ç–∞–≤–∫—É, –ø–µ—Ä–µ–¥–∞–≤–∞—è –¢–û–õ–¨–ö–û –¢–ï–ö–°–¢
                displayCategoryPage(item.text);
                // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
            } else {
                // ...–∞ –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–ø—Ä–æ—Å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ç–µ—Å—Ç
                displayQuestionAsTest(item);
            }
        }
    }







    async function displayFlashcard(question) {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ –≤ —à–∞–ø–∫–µ
        webSearchDropdown?.classList.add('hidden');
        copyQuestionBtnQuiz?.classList.add('hidden');
        getEl('favoriteQuestionBtn')?.classList.add('hidden');
        quickModeToggle?.classList.add('hidden');
        triggerWordToggle?.classList.add('hidden');
        translateQuestionBtn?.classList.remove('hidden');

        // –û—á–∏—Å—Ç–∫–∞ –∏ –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞
        questionTextEl.innerHTML = '';
        answerOptionsEl.innerHTML = '';
        const indexAtRequestTime = question.originalIndexInQuiz;

        const originalCorrectAnswerText = question.options[question.correctAnswerIndex].text;
        const cardHTML = `
            <div class="flashcard-viewport">
                <div class="flashcard" id="currentFlashcard">
                    <div class="flashcard-face flashcard-front">
                        <div class="flashcard-text-content" id="flashcardFrontText">${escapeHTML(question.text)}</div>
                    </div>
                    <div class="flashcard-face flashcard-back" id="flashcardBack">
                        <div class="flashcard-answer-text">
                            <div class="flashcard-text-content" id="flashcardBackText">${escapeHTML(originalCorrectAnswerText)}</div>
                        </div>
                        <button id="explainFlashcardBtn" class="explain-flashcard-btn">üí° ${_('ai_explain_button')}</button>
                    </div>
                </div>
            </div>
        `;
        answerOptionsEl.innerHTML = cardHTML;

        // === –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ö–û–î–ê: –õ–û–ì–ò–ö–ê –ò–ó–ú–ï–ù–ï–ù–ò–Ø –†–ê–ó–ú–ï–†–ê ===
        // –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
        const cardElement = getEl('currentFlashcard');
        const frontFace = getEl('flashcardFront');
        const backFace = getEl('flashcardBack');
        const frontFaceTextContainer = getEl('flashcardFrontText');
        const backFaceTextContainer = getEl('flashcardBackText');
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã—Å–æ—Ç—ã
        const resizeCard = () => {
            if (!cardElement || !frontFace || !backFace) return;
            // requestAnimationFrame –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –±—Ä–∞—É–∑–µ—Ä —É—Å–ø–µ–ª –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç
            requestAnimationFrame(() => {
                const frontHeight = frontFace.scrollHeight;
                const backHeight = backFace.scrollHeight;
                const maxHeight = Math.max(frontHeight, backHeight);
                // –î–æ–±–∞–≤–ª—è–µ–º 40px –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã (padding)
                cardElement.style.height = `${maxHeight + 40}px`;
            });
        };
        // === –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ö–û–î–ê ===

// –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –∫ –∫–Ω–æ–ø–∫–µ "–û–±—ä—è—Å–Ω–∏—Ç—å"
        const explainBtn = getEl('explainFlashcardBtn');
        if (explainBtn) {
            explainBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                // === –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨ ===
                // –ü–µ—Ä–µ–¥–∞–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –≤—Ç–æ—Ä—ã–º –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º
                showAIExplanation(question, question.options[question.correctAnswerIndex].text);
                // === –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ===
            });
        }
        
        // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞
        if (isTranslateModeEnabled) {
            resizeCard(); // <-- –í—ã–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É
            translateQuestionBtn?.classList.add('translating');
            const lang = localStorage.getItem('appLanguage') || 'ru';
            
            const translationResult = await getCachedOrFetchTranslation(question, question.originalIndex, lang);
            
            if (currentQuestionIndex !== indexAtRequestTime) {
                translateQuestionBtn?.classList.remove('translating');
                return;
            }
            translateQuestionBtn?.classList.remove('translating');

            if (translationResult) {
                const translatedQuestion = translationResult.question;
                const translatedCorrectAnswerText = translatedQuestion.options[translatedQuestion.correctAnswerIndex].text;

                if (!translationResult.fromCache) {
                    await Promise.all([
                        animateTextTransformation(frontFaceTextContainer, question.text, translatedQuestion.text),
                        animateTextTransformation(backFaceTextContainer, originalCorrectAnswerText, translatedCorrectAnswerText)
                    ]);
                } else {
                    frontFaceTextContainer.textContent = translatedQuestion.text;
                    backFaceTextContainer.textContent = translatedCorrectAnswerText;
                }
                
                resizeCard(); // <-- –ò –≤—ã–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞
            } else {
                alert(_('error_flashcard_translation_failed'));
            }
        } else {
            resizeCard(); // <-- –ò –≤—ã–∑—ã–≤–∞–µ–º, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–∞
        }

        // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
        if (cardElement) {
            cardElement.addEventListener('click', (e) => {
                e.currentTarget.classList.toggle('is-flipped');
                if (!userAnswers[currentQuestionIndex].answered) {
                    userAnswers[currentQuestionIndex].answered = true;
                }
            });
        }
    }




    /**
     * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —ç–ª–µ–º–µ–Ω—Ç –∫–∞–∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å —Ç–µ—Å—Ç–∞.
     * (–≠—Ç–æ, –ø–æ —Å—É—Ç–∏, –∫–æ–¥ –∏–∑ –≤–∞—à–µ–π —Å—Ç–∞—Ä–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ loadQuestion)
     * @param {object} question - –û–±—ä–µ–∫—Ç –≤–æ–ø—Ä–æ—Å–∞.
     */
    function displayQuestionAsTest(question) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        feedbackAreaEl.className = 'feedback-area';
        getEl('score').style.visibility = 'visible';
        copyQuestionBtnQuiz?.classList.remove('hidden');
        getEl('favoriteQuestionBtn')?.classList.remove('hidden');
        translateQuestionBtn?.classList.remove('hidden');
        webSearchDropdown?.classList.remove('hidden');
        
        const questionNumber = questionsForCurrentQuiz.slice(0, currentQuestionIndex + 1).filter(q => q.type !== 'category').length;
        currentQuestionNumEl.textContent = questionNumber;

        // –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø–µ—Ä–µ–≤–æ–¥ –∏–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª)
        if (isTranslateModeEnabled) {
            displayTranslatedQuestion(question);
        } else {
            displayQuestionContent(question, false);
        }

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ (–µ—Å–ª–∏ —É–∂–µ –æ—Ç–≤–µ—á–∞–ª–∏)
        const answerState = userAnswers[currentQuestionIndex];
        if (answerState && answerState.answered) {
            if (answerState.correct) {
                feedbackAreaEl.textContent = _('feedback_correct');
                feedbackAreaEl.className = 'feedback-area correct-feedback';
            } else {
                feedbackAreaEl.textContent = _('feedback_incorrect');
                feedbackAreaEl.className = 'feedback-area incorrect-feedback';
            }
            const explainBtn = document.createElement('button');
            explainBtn.textContent = _('ai_explain_button');
            explainBtn.onclick = () => showAIExplanation(question);
            feedbackAreaEl.appendChild(explainBtn);
        }
    }


    /**
     * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤ –≤–∏–¥–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –Ω–µ–ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏.
     * @param {object} category - –û–±—ä–µ–∫—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
     */
    function displayCategoryAsCard(category) {
        // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ –≤ —à–∞–ø–∫–µ ---
        webSearchDropdown?.classList.add('hidden');
        copyQuestionBtnQuiz?.classList.add('hidden');
        getEl('favoriteQuestionBtn')?.classList.add('hidden');
        quickModeToggle?.classList.add('hidden');
        triggerWordToggle?.classList.add('hidden');
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ –¢–û–ß–ù–û –≤–∏–¥–Ω–∞
        translateQuestionBtn?.classList.remove('hidden');
        // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---

        // –°–æ–∑–¥–∞–µ–º HTML-—Å—Ç—Ä—É–∫—Ç—É—Ä—É, –∏–º–∏—Ç–∏—Ä—É—é—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É, –Ω–æ –±–µ–∑ 3D-—ç—Ñ—Ñ–µ–∫—Ç–æ–≤
        const cardHTML = `
            <div class="flashcard-viewport">
                <div class="flashcard" style="cursor: default;">
                    <div class="flashcard-face flashcard-category">
                        <div>
                            <span class="flashcard-category-label">${_('flashcard_category_label')}</span>
                            <h2 class="flashcard-category-title">${escapeHTML(category.text)}</h2>
                        </div>
                    </div>
                </div>
            </div>
        `;
        // –í—Å—Ç–∞–≤–ª—è–µ–º —ç—Ç—É –∫–∞—Ä—Ç–æ—á–∫—É –≤ –æ–±–ª–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤
        answerOptionsEl.innerHTML = cardHTML;
    }



    function handleAnswerSelect(event) {
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ —É–∂–µ –¥–∞–Ω –æ—Ç–≤–µ—Ç –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å
            if (userAnswers[currentQuestionIndex].answered) return;
        
            // 2. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∫–ª–∏–∫–µ –∏ —Ç–µ–∫—É—â–µ–º –≤–æ–ø—Ä–æ—Å–µ
            const selectedOptionLi = event.target;
            const selectedIndex = parseInt(selectedOptionLi.dataset.index);
            
            // --- –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ö–û–î–ê: –£–ú–ù–ê–Ø –õ–û–ì–ò–ö–ê –ü–†–û–í–ï–†–ö–ò ---
            
            // –í—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π (–Ω–µ–ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π) –≤–æ–ø—Ä–æ—Å –∫–∞–∫ –æ—Å–Ω–æ–≤—É
            const originalQuestion = questionsForCurrentQuiz[currentQuestionIndex];
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é, –≤–æ–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ - —ç—Ç–æ –æ—Ä–∏–≥–∏–Ω–∞–ª
            let questionForValidation = originalQuestion;
        
            // –ï—Å–ª–∏ —Ä–µ–∂–∏–º –ø–µ—Ä–µ–≤–æ–¥–∞ –∞–∫—Ç–∏–≤–µ–Ω, –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –¥–ª—è –ü–†–û–í–ï–†–ö–ò
            if (isTranslateModeEnabled) {
                const lang = localStorage.getItem('appLanguage') || 'ru';
                const cacheKey = getCacheKey(originalQuestion.originalIndex, lang);
                if (currentQuizTranslations.has(cacheKey)) {
                    // –ï—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ –µ—Å—Ç—å –≤ –∫—ç—à–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                    questionForValidation = currentQuizTranslations.get(cacheKey);
                }
            }
        
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å, –∏—Å–ø–æ–ª—å–∑—É—è –í–´–ë–†–ê–ù–ù–´–ô –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ–±—ä–µ–∫—Ç –≤–æ–ø—Ä–æ—Å–∞
            const isCorrect = selectedIndex === questionForValidation.correctAnswerIndex;
        
            // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ö–û–î–ê ---
        
            // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            userAnswers[currentQuestionIndex] = { answered: true, correct: isCorrect, selectedOptionIndex: selectedIndex };
        
            // 4. –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞
            if (isCorrect) {
                selectedOptionLi.classList.add('correct');
                feedbackAreaEl.textContent = _('feedback_correct');
                feedbackAreaEl.className = 'feedback-area correct-feedback';
                score++;
            } else {
                selectedOptionLi.classList.add('incorrect');
                feedbackAreaEl.textContent = _('feedback_incorrect');
                feedbackAreaEl.className = 'feedback-area incorrect-feedback';
        
                // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É—è –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                const correctLi = answerOptionsEl.querySelector(`li[data-index="${questionForValidation.correctAnswerIndex}"]`);
                if (correctLi) correctLi.classList.add('actual-correct');
        
                // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–± –æ—à–∏–±–∫–µ
                if (quizSettings.feedbackMode) {
                    // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—à–∏–±–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –í–°–ï–ì–î–ê –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –≤–æ–ø—Ä–æ—Å ---
                    let errorQstBlock = `? ${originalQuestion.text.replace(/\n/g, ' ')}\n`;
        
                    originalQuestion.options.forEach((option, index) => {
                        const prefix = (index === originalQuestion.correctAnswerIndex) ? '+' : '-';
                        errorQstBlock += `${prefix} ${option.text.replace(/\n/g, ' ')}\n`;
                    });
        
                    incorrectlyAnsweredQuestionsData.push(errorQstBlock, "");
        
                    // –î–ª—è –ò–ò-–∞–Ω–∞–ª–∏–∑–∞ —Ç–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å, –Ω–æ –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ—Ä–µ–º –∏–∑ —Ç–æ–≥–æ, —á—Ç–æ –æ–Ω –≤–∏–¥–µ–ª
                    const errorDetails = {
                      questionText: originalQuestion.text,
                      correctAnswer: originalQuestion.options[originalQuestion.correctAnswerIndex].text,
                      userAnswer: questionForValidation.options[selectedIndex].text // –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–æ–≥–æ —è–∑—ã–∫–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –æ–Ω –æ—Ç–≤–µ—á–∞–ª
                    };
                    currentQuizErrorData.push(errorDetails);
                }
            }
        
            // 5. –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–ª–∏–∫
            Array.from(answerOptionsEl.children).forEach(li => {
                li.removeEventListener('click', handleAnswerSelect);
                li.classList.add('answered');
            });
        
// 6. –°–æ–∑–¥–∞–µ–º –ø–∞–Ω–µ–ª—å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ —Å –∫–Ω–æ–ø–∫–æ–π "–û–±—ä—è—Å–Ω–∏—Ç—å"
            const feedbackText = isCorrect ? _('feedback_correct') : _('feedback_incorrect');
            
            const explainBtn = document.createElement('button');
            explainBtn.textContent = _('ai_explain_button');
            explainBtn.className = 'explain-btn';

            if (isCorrect) {
                // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—Å—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
                const correctAnswerText = originalQuestion.options[originalQuestion.correctAnswerIndex].text;
                // –ü–µ—Ä–µ–¥–∞–µ–º –µ–≥–æ –≤—Ç–æ—Ä—ã–º –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º, —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä –ø–æ–Ω—è–ª, —á—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –æ–±—ä—è—Å–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                explainBtn.onclick = () => showAIExplanation(originalQuestion, correctAnswerText);
            } else {
                const incorrectAnswerText = questionForValidation.options[selectedIndex].text;
                explainBtn.onclick = () => showAIExplanation(originalQuestion, incorrectAnswerText);
            }
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            feedbackAreaEl.innerHTML = ''; 
            const textNode = document.createTextNode(feedbackText);
            feedbackAreaEl.appendChild(textNode);
            feedbackAreaEl.appendChild(explainBtn);
        
            // 7. –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            updateScoreDisplay();
            updateNavigationButtons();
            updateQuickNavButtons();
            
            // 8. –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω –±—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            if (quickModeEnabled) {
                setTimeout(() => handleNextButtonClick(), QUICK_MODE_DELAY);
            }
        }



    function handleNextButtonClick() {
        if (currentQuestionIndex < questionsForCurrentQuiz.length - 1) {
            loadNextQuestion();
        } else {
            if (timerInterval) clearInterval(timerInterval);
            showResults();
        }
    }
    
    function loadNextQuestion() {
        currentQuestionIndex++;
        loadQuestion(currentQuestionIndex);
    }

    function loadPreviousQuestion() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            loadQuestion(currentQuestionIndex);
        }
    }

    function updateNavigationButtons() {
        prevQuestionButton.disabled = currentQuestionIndex === 0;
        const isLastQuestion = currentQuestionIndex === questionsForCurrentQuiz.length - 1;
        nextButton.textContent = isLastQuestion ? _('finish_button') : _('next_question_button');
        nextButton.classList.toggle('finish-test', isLastQuestion);
    }



    async function showResults() {
        localStorage.removeItem(SAVED_SESSIONS_STORAGE_KEY);
        window.removeEventListener('beforeunload', handleBeforeUnload);
        if (timerInterval) clearInterval(timerInterval);

        // === –ù–ê–ß–ê–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ===
        // 1. –ù–∞—Ö–æ–¥–∏–º –±–ª–æ–∫ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –∞–Ω–∞–ª–∏–∑–∞ –ò–ò.
        const aiAnalysisResult = getEl('aiAnalysisResult');
        // 2. –û—á–∏—â–∞–µ–º –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏ —Å–∫—Ä—ã–≤–∞–µ–º.
        //    –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –∏—Å—Ö–æ–¥–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É —Å "–∑–∞–≤–∏—Å—à–∏–º" —Ç–µ–∫—Å—Ç–æ–º.
        if (aiAnalysisResult) {
            aiAnalysisResult.innerHTML = '';
            aiAnalysisResult.classList.add('hidden');
        }
        // === –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ===

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —ç—Ç–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
        if (currentQuizContext && !currentQuizContext.isPractice && currentUser) {
            
            // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï ‚Ññ1: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ ---
            const timeTaken = quizStartTime > 0 ? Math.round((new Date().getTime() - quizStartTime) / 1000) : 0;
            
            const questionsInThisQuiz = questionsForCurrentQuiz.filter(q => q.type !== 'category');
            const finalAccuracy = questionsInThisQuiz.length > 0 
                ? ((score / questionsInThisQuiz.length) * 100) 
                : 0;

            const resultData = {
                userId: currentUser.uid,
                userName: currentUser.displayName || '–ê–Ω–æ–Ω–∏–º',
                fileId: currentQuizContext.fileId,
                channelId: currentQuizContext.channelId,
                accuracy: finalAccuracy,
                timeSpentSeconds: timeTaken,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï ‚Ññ2: –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ---
            try {
                // –ò—â–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —ç—Ç–æ–≥–æ –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —ç—Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞
                const querySnapshot = await db.collection('testResults')
                    .where('userId', '==', currentUser.uid)
                    .where('fileId', '==', currentQuizContext.fileId)
                    .limit(1)
                    .get();

                if (querySnapshot.empty) {
                    // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ—Ç - –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
                    await db.collection('testResults').add(resultData);
                    console.log("–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
                } else {
                    // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –µ—Å—Ç—å - –æ–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
                    const docId = querySnapshot.docs[0].id;
                    await db.collection('testResults').doc(docId).update(resultData);
                    console.log("–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!");
                }
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:", err);
            }
        }
        
        currentQuizContext = null;
        quizStartTime = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä

        quizArea.classList.add('hidden');
        resultsArea.classList.remove('hidden');
        webSearchDropdown?.classList.add('hidden');
        finishTestButton?.classList.add('hidden');
        downloadTranslatedTxtButton?.classList.add('hidden');
        downloadTranslatedQstButton?.classList.add('hidden');
        copyQuestionBtnQuiz?.classList.add('hidden');
        
        const questionsInThisQuiz = questionsForCurrentQuiz.filter(q => q.type !== 'category');
        const finalTotalContainer = finalTotalEl.parentElement; // <p> —Å –æ–±—â–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
        const finalPercentageContainer = finalPercentageEl.parentElement; // <p> —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é

        // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –õ–æ–≥–∏–∫–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤ ---
        if (quizSettings.flashcardsMode) {
            // –†–ï–ñ–ò–ú –ö–ê–†–¢–û–ß–ï–ö
            const cardsViewed = userAnswers.filter(a => a && a.answered).length;
            finalTotalContainer.innerHTML = `<span data-lang-key="results_flashcards_viewed">${_('results_flashcards_viewed')}:</span> ${cardsViewed} <span data-lang-key="of_label">${_('of_label')}</span> ${questionsInThisQuiz.length}.`;
            finalPercentageContainer.classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º —Ç–æ—á–Ω–æ—Å—Ç—å
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ –æ—à–∏–±–∫–∞–º–∏, –æ–Ω–∏ –Ω–µ –Ω—É–∂–Ω—ã –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
            feedbackDownloadArea.classList.add('hidden');
            errorReviewArea.classList.add('hidden');
            getEl('aiAnalysisArea').classList.add('hidden');
        } else {
            // –û–ë–´–ß–ù–´–ô –†–ï–ñ–ò–ú –¢–ï–°–¢–ê
            finalTotalContainer.innerHTML = `<span data-lang-key="your_result">${_('your_result')}:</span> <span id="finalCorrect">${score}</span> <span data-lang-key="of_label">${_('of_label')}</span> <span id="finalTotal">${questionsInThisQuiz.length}</span>.`;
            const percentage = questionsInThisQuiz.length > 0 ? ((score / questionsInThisQuiz.length) * 100).toFixed(1) : 0;
            finalPercentageEl.textContent = percentage;
            finalPercentageContainer.classList.remove('hidden'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—á–Ω–æ—Å—Ç—å

            if (quizSettings.feedbackMode && incorrectlyAnsweredQuestionsData.length > 0) {
                feedbackDownloadArea.classList.remove('hidden');
                errorReviewArea.classList.remove('hidden');
                getEl('aiAnalysisArea').classList.remove('hidden');
            } else {
                feedbackDownloadArea.classList.add('hidden');
                errorReviewArea.classList.add('hidden');
                getEl('aiAnalysisArea').classList.add('hidden');
            }
        }
        // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---

        if (triggerWordsUsedInQuiz) {
            triggeredQuizDownloadArea.classList.remove('hidden');
        } else {
            triggeredQuizDownloadArea.classList.add('hidden');
        }
    }



    function startErrorReviewQuiz() {
        const errorContent = incorrectlyAnsweredQuestionsData.join('\n');
        const errorQuestions = parseQstContent(errorContent);
        if (errorQuestions.length > 0) {
            resultsArea.classList.add('hidden');
            applySettingsAndStartQuiz(true, errorQuestions);
        } else {
            alert(_('error_review_questions_not_found'));
        }
    }

    function downloadErrorFile() {
        const content = incorrectlyAnsweredQuestionsData.join('\n').trim();
        const fileNameBase = originalFileNameForReview ? originalFileNameForReview.replace(/\.qst$|\.txt$/i, '') : 'test';
        const fileName = `errors_${fileNameBase}.qst`;
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á –∏–∑ —è–∑—ã–∫–æ–≤–æ–≥–æ –ø–∞–∫–µ—Ç–∞ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
        downloadOrShareFile(fileName, content, 'text/plain;charset=utf-8', _('share_title_errors'));
    }

    function downloadTriggeredQuizFile() {
        let content = '';
        questionsForCurrentQuiz.forEach(q => {
            const tokens = tokenizeText(q.text);
            let questionTextForFile = '? ';
            let wordIdx = 0;
            tokens.forEach(token => {
                const isWord = /\S/.test(token) && !/^[.,;:!?()"‚Äú‚Äù¬´¬ª-]+$/.test(token);
                if (isWord) {
                    if (q.triggeredWordIndices?.includes(wordIdx)) {
                        questionTextForFile += `~${token}~`;
                    } else {
                        questionTextForFile += token;
                    }
                    wordIdx++;
                } else {
                    questionTextForFile += token;
                }
            });
            content += questionTextForFile.trim() + '\n';
            q.options.forEach(opt => {
                content += `${opt.isCorrect ? '+' : '-'} ${opt.text}\n`;
            });
            content += '\n';
        });
        const fileNameBase = originalFileNameForReview ? originalFileNameForReview.replace(/\.qst$|\.txt$|\.txt$/i, '') : 'quiz';
        const fileName = `triggered_${fileNameBase}.qst`;
        downloadOrShareFile(fileName, content, 'text/plain;charset=utf-8', _('share_title_triggered_quiz'));
    }

    function updateScoreDisplay() {
        correctAnswersCountEl.textContent = score;
    }



    function resetQuizForNewFile(clearInput = true) {
        // –ï—Å–ª–∏ –º—ã —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ—Å—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π,
        // –∞ –Ω–µ –ø–æ—Ç–æ–º—É —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ —Å—Ç–∞—Ä—ã–π, —Ç–æ —É–¥–∞–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ.
        appTitleHeader?.classList.remove('hidden');
        quizSettings = { timeLimit: 0, shuffleQuestions: false, shuffleAnswers: false, questionRangeStart: 1, questionRangeEnd: 0, feedbackMode: false, readingMode: false, flashcardsMode: false };
        quizStartTime = 0;
        if (clearInput) {
             localStorage.removeItem(SAVED_SESSIONS_STORAGE_KEY);
        }
        window.removeEventListener('beforeunload', handleBeforeUnload);

        if (timerInterval) clearInterval(timerInterval);
        allParsedQuestions = [];
        questionsForCurrentQuiz = [];
        currentQuestionIndex = 0;
        score = 0;
        userAnswers = [];
        incorrectlyAnsweredQuestionsData = [];
        currentQuizErrorData = [];
        originalFileNameForReview = '';
        generatedCheatSheetContent = '';
        triggerWordsUsedInQuiz = false;

        // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–±—Ä–æ—Å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ò–ò (–æ—Å—Ç–∞–≤–ª—è–µ–º)
        const aiAnalysisResult = getEl('aiAnalysisResult');
        if (aiAnalysisResult) {
            aiAnalysisResult.innerHTML = ''; 
            aiAnalysisResult.classList.add('hidden');
        }

        isTranslateModeEnabled = false;
        localStorage.setItem('isTranslateModeEnabled', 'false');
        updateTranslateModeToggleVisual();

        // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫—ç—à–∞
        currentQuizTranslations.clear();
        currentFileCacheKey = null;
        
        const screensToHide = [quizSetupArea, quizArea, resultsArea, cheatSheetResultArea, gradusFoldersContainer, searchResultsContainer, parserArea];
        screensToHide.forEach(el => el?.classList.add('hidden'));
        fileUploadArea?.classList.remove('hidden');
        
        timerDisplayEl?.classList.add('hidden');
        quickNavPanel?.classList.add('hidden');
        
        // === –£–î–ê–õ–ï–ù–û ===
        // feedbackDownloadArea?.classList.add('hidden');
        // errorReviewArea?.classList.add('hidden');
        // –≠—Ç–∏ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏ –±—ã–ª–∏ –ø—Ä–∏—á–∏–Ω–æ–π –ø—Ä–æ–±–ª–µ–º—ã, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ —Å–∫—Ä—ã–≤–∞–ª–∏ –∫–Ω–æ–ø–∫–∏ –Ω–∞–ø—Ä—è–º—É—é.
        // –¢–µ–ø–µ—Ä—å –≤–∏–¥–∏–º–æ—Å—Ç—å —ç—Ç–∏—Ö –∫–Ω–æ–ø–æ–∫ –±—É–¥–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û —Ñ—É–Ω–∫—Ü–∏–µ–π showResults().
        
        copyQuestionBtnQuiz?.classList.add('hidden');
        triggeredQuizDownloadArea?.classList.add('hidden');
        finishTestButton?.classList.add('hidden');
        webSearchDropdown?.classList.add('hidden');
        getEl('favoriteQuestionBtn')?.classList.add('hidden');
        translateQuestionBtn?.classList.add('hidden');
        downloadTranslatedTxtButton?.classList.add('hidden');
        downloadTranslatedQstButton?.classList.add('hidden');
        languageToggle?.classList.remove('hidden');
        quickModeToggle?.classList.add('hidden');
        triggerWordToggle?.classList.add('hidden');
        
        if (clearInput) fileInput.value = '';
        
        if(questionTextEl) questionTextEl.textContent = '';
        if(answerOptionsEl) answerOptionsEl.innerHTML = '';
        if(feedbackAreaEl) {
            feedbackAreaEl.textContent = '';
            feedbackAreaEl.className = 'feedback-area';
        }
        
        loadRecentFiles();
        loadSavedSession();
        manageBackButtonInterceptor();
    }



    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }


    function saveSessionForLater() {
        if (questionsForCurrentQuiz.length === 0) return;

        // 1. –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –ù–û–í–û–ô —Å–µ—Å—Å–∏–∏
        const newSessionData = {
            questionOrderIndices: questionsForCurrentQuiz.map(q => q.originalIndex),
            userAnswers,
            currentQuestionIndex,
            score,
            quizSettings,
            timeLeftInSeconds,
            originalFileNameForReview,
            totalQuestionCount: questionsForCurrentQuiz.filter(q => q.type !== 'category').length,
            timestamp: new Date().getTime()
        };

        try {
            // 2. –ß–∏—Ç–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–∞—Å—Å–∏–≤ —Å–µ—Å—Å–∏–π (–∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π)
            const savedSessions = JSON.parse(localStorage.getItem(SAVED_SESSIONS_STORAGE_KEY)) || [];

            // 3. –ò—â–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
            const existingSessionIndex = savedSessions.findIndex(
                session => session.originalFileNameForReview === newSessionData.originalFileNameForReview
            );

            if (existingSessionIndex > -1) {
                // –ï—Å–ª–∏ –µ—Å—Ç—å - –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
                savedSessions[existingSessionIndex] = newSessionData;
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç - –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –≤ –º–∞—Å—Å–∏–≤
                savedSessions.push(newSessionData);
            }

            // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ –æ–±—Ä–∞—Ç–Ω–æ –≤ localStorage
            localStorage.setItem(SAVED_SESSIONS_STORAGE_KEY, JSON.stringify(savedSessions));

            alert(_('session_saved_success'));
            resetQuizForNewFile(false);

        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –≤ localStorage:", e);
            alert(_('error_session_save_failed'));
        }
    }




    function loadSavedSession() {
        const savedSessionsJSON = localStorage.getItem(SAVED_SESSIONS_STORAGE_KEY);
        const sessions = savedSessionsJSON ? JSON.parse(savedSessionsJSON) : [];

        if (sessions.length === 0) {
            savedSessionArea.classList.add('hidden');
            savedSessionList.innerHTML = '';
            return;
        }

        let allCardsHTML = '';
        sessions.forEach(sessionData => {
            const totalQuestions = sessionData.totalQuestionCount;
            const answeredQuestions = sessionData.userAnswers.filter(a => a && a.answered).length;
            const progress = totalQuestions > 0 ? (answeredQuestions / totalQuestions) * 100 : 0;

            let timeInfo = '';
            if (sessionData.quizSettings.timeLimit > 0 && sessionData.timeLeftInSeconds) {
                const minutes = Math.floor(sessionData.timeLeftInSeconds / 60);
                const seconds = sessionData.timeLeftInSeconds % 60;
                timeInfo = `<div class="saved-session-time">${_('time_left')}: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}</div>`;
            }

            // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ ---
            let progressLabel = '';
            if (sessionData.quizSettings && sessionData.quizSettings.flashcardsMode) {
                // –ï—Å–ª–∏ —ç—Ç–æ —Å–µ—Å—Å–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫
                progressLabel = `${_('session_cards_viewed')} ${answeredQuestions} ${_('from')} ${totalQuestions}`;
            } else {
                // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ã—á–Ω—ã–π —Ç–µ—Å—Ç
                progressLabel = `${_('answered_of')} ${answeredQuestions} ${_('from')} ${totalQuestions}`;
            }
            // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---

            // –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª—è–µ–º data-filename –∫ –∫–Ω–æ–ø–∫–∞–º!
            allCardsHTML += `
                <div class="saved-session-card">
                    <div class="saved-session-name">${sessionData.originalFileNameForReview || '–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç'}</div>
                    <div class="saved-session-progress-info">
                        <span>${progressLabel}</span>
                        ${timeInfo}
                    </div>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" style="width: ${progress}%;"></div>
                    </div>
                    <div class="saved-session-actions">
                        <button class="btn-resume" data-filename="${sessionData.originalFileNameForReview}">${_('continue_quiz_button')}</button>
                        <button class="btn-delete" data-filename="${sessionData.originalFileNameForReview}">${_('delete_session_button')}</button>
                    </div>
                </div>
            `;
        });

        savedSessionList.innerHTML = allCardsHTML;
        savedSessionArea.classList.remove('hidden');

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
        savedSessionList.removeEventListener('click', handleSessionCardClick); // –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥—É–±–ª–µ–π
        savedSessionList.addEventListener('click', handleSessionCardClick);
    }



    // –≠—Ç–æ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
    function handleSessionCardClick(event) {
        const target = event.target;
        const fileName = target.dataset.filename;
        if (!fileName) return;

        if (target.classList.contains('btn-resume')) {
            restoreQuizSession(fileName);
        } else if (target.classList.contains('btn-delete')) {
            deleteSavedSession(fileName);
        }
    }

    function restoreQuizSession(fileName) { // <-- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∏–º—è —Ñ–∞–π–ª–∞
        const savedSessionsJSON = localStorage.getItem(SAVED_SESSIONS_STORAGE_KEY);
        if (!savedSessionsJSON) return;
        
        const sessions = JSON.parse(savedSessionsJSON);
        const sessionData = sessions.find(s => s.originalFileNameForReview === fileName); // <-- –ù–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—É—é —Å–µ—Å—Å–∏—é –≤ –º–∞—Å—Å–∏–≤–µ
        
        if (!sessionData) {
            alert(_('error_session_not_found'));
            return;
        }

        // 1. –ù–∞—Ö–æ–¥–∏–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª –≤ "–ù–µ–¥–∞–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö"
        const recentFiles = JSON.parse(localStorage.getItem(RECENT_FILES_STORAGE_KEY)) || [];
        const originalFile = recentFiles.find(f => f.name === sessionData.originalFileNameForReview);

        if (!originalFile) {
            alert(_('error_session_file_not_found'));
            deleteSavedSession(); // –£–¥–∞–ª—è–µ–º "–æ—Å–∏—Ä–æ—Ç–µ–≤—à—É—é" —Å–µ—Å—Å–∏—é
            return;
        }

        // 2. –ó–∞–Ω–æ–≤–æ –ø–∞—Ä—Å–∏–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤
        allParsedQuestions = parseQstContent(originalFile.content);

        // 3. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¢–û–ß–ù–´–ô –ø–æ—Ä—è–¥–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π "–∫–∞—Ä—Ç—ã"
        questionsForCurrentQuiz = sessionData.questionOrderIndices.map(originalIndex => {
            // –í–∞–∂–Ω–æ —Ç–∞–∫–∂–µ –¥–æ–±–∞–≤–∏—Ç—å originalIndex –æ–±—Ä–∞—Ç–Ω–æ –≤ –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å
            return { ...allParsedQuestions[originalIndex], originalIndex };
        });


        if (sessionData.quizSettings && sessionData.quizSettings.shuffleAnswers) {
            console.log("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏: –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤.");
            questionsForCurrentQuiz.forEach(q => {
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —á—Ç–æ –∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –Ω–æ–≤–æ–≥–æ —Ç–µ—Å—Ç–∞
                if (q.type !== 'category' && q.options) {
                    const correctAnswerObject = q.options[q.correctAnswerIndex];
                    shuffleArray(q.options); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à—É –∂–µ —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è
                    q.correctAnswerIndex = q.options.findIndex(opt => opt === correctAnswerObject);
                }
            });
        }
        

        // 4. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        userAnswers = sessionData.userAnswers;
        currentQuestionIndex = sessionData.currentQuestionIndex;
        score = sessionData.score;
        quizSettings = sessionData.quizSettings;
        timeLeftInSeconds = sessionData.timeLeftInSeconds;
        originalFileNameForReview = sessionData.originalFileNameForReview;

        // 5. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —ç–∫—Ä–∞–Ω —Ç–µ—Å—Ç–∞
        fileUploadArea.classList.add('hidden');
        quizSetupArea.classList.add('hidden');
        quizArea.classList.remove('hidden');
        appTitleHeader?.classList.add('hidden');

        // 6. –ó–∞–ø—É—Å–∫–∞–µ–º UI —Ç–µ—Å—Ç–∞ —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        totalQuestionsNumEl.textContent = questionsForCurrentQuiz.filter(q => q.type !== 'category').length;
        updateScoreDisplay();
        setupTimer();
        generateQuickNav();
        loadQuestion(currentQuestionIndex);

        // 7. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        webSearchDropdown?.classList.remove('hidden');
        finishTestButton?.classList.remove('hidden');
        continueLaterButton?.classList.remove('hidden');
        copyQuestionBtnQuiz?.classList.remove('hidden');
        getEl('favoriteQuestionBtn')?.classList.remove('hidden');
        languageToggle?.classList.add('hidden');
        quickModeToggle?.classList.remove('hidden');
        triggerWordToggle?.classList.remove('hidden');

        // 8. –î–æ–±–∞–≤–ª—è–µ–º –∑–∞—â–∏—Ç—É –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –≤–∫–ª–∞–¥–∫–∏
        window.addEventListener('beforeunload', handleBeforeUnload);
    }
    
    function deleteSavedSession(fileName) { // <-- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∏–º—è —Ñ–∞–π–ª–∞
        if (confirm(_('confirm_delete_session').replace('{fileName}', fileName))) {
            const savedSessionsJSON = localStorage.getItem(SAVED_SESSIONS_STORAGE_KEY);
            let sessions = savedSessionsJSON ? JSON.parse(savedSessionsJSON) : [];
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤, –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–≤ —É–¥–∞–ª—è–µ–º—É—é —Å–µ—Å—Å–∏—é
            const updatedSessions = sessions.filter(s => s.originalFileNameForReview !== fileName);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤
            localStorage.setItem(SAVED_SESSIONS_STORAGE_KEY, JSON.stringify(updatedSessions));
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            loadSavedSession();
        }
    }

 

    function loadTheme() {
        const currentThemeId = localStorage.getItem('theme') || 'glass-dark';
        const themeData = THEMES[currentThemeId] || THEMES['glass-dark'];

        // 1. –£–¥–∞–ª—è–µ–º –í–°–ï –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–ª–∞—Å—Å—ã —Ç–µ–º, –ø–µ—Ä–µ–±–∏—Ä–∞—è –∫–ª—é—á–∏ –æ–±—ä–µ–∫—Ç–∞ THEMES
        Object.keys(THEMES).forEach(themeKey => {
            document.body.classList.remove(themeKey);
        });
        
        // 2. –î–æ–±–∞–≤–ª—è–µ–º –Ω—É–∂–Ω—ã–π –∫–ª–∞—Å—Å, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞
        if (currentThemeId !== 'light') {
            document.body.classList.add(currentThemeId);
        }

        // 3. –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        if (themeIcon) themeIcon.textContent = themeData.icon;

        // 4. –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –ø—É–Ω–∫—Ç –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ
        if (themeDropdownContent) {
            const links = themeDropdownContent.querySelectorAll('a');
            links.forEach(link => {
                link.classList.toggle('active', link.dataset.theme === currentThemeId);
            });
        }
    }


    function populateThemeDropdown() {
        if (!themeDropdownContent) return;
        themeDropdownContent.innerHTML = ''; // –û—á–∏—â–∞–µ–º –Ω–∞ —Å–ª—É—á–∞–π –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞

        for (const themeId in THEMES) {
            const theme = THEMES[themeId];
            const link = document.createElement('a');
            link.href = '#';
            link.dataset.theme = themeId;
            link.title = theme.name; // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã –≤–æ –≤—Å–ø–ª—ã–≤–∞—é—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
            link.innerHTML = `<span class="theme-option-icon">${theme.icon}</span>`;
            themeDropdownContent.appendChild(link);
        }
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–æ–≤—É—é —Ç–µ–º—É, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç UI.
     * @param {string} themeId - ID –Ω–æ–≤–æ–π —Ç–µ–º—ã.
     */
    function setTheme(themeId) {
        localStorage.setItem('theme', themeId);
        loadTheme();
    }


    async function handleCopyExplanation() {
        const outputEl = getEl('aiExplanationOutput');
        if (!outputEl) return;

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerText, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç —Ç–∞–∫, –∫–∞–∫ –µ–≥–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å,
        // –±–µ–∑ HTML-—Ç–µ–≥–æ–≤, –Ω–æ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫.
        const textToCopy = outputEl.innerText;

        if (textToCopy.trim()) {
            await copyToClipboardMain(textToCopy);
        }
    }


    // --- –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ü–ï–†–ï–í–û–î–ê –Ø–ó–´–ö–ê ---

 

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —è–∑—ã–∫ –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
     * @param {string} lang - –ö–æ–¥ —è–∑—ã–∫–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ('ru', 'en', 'kk').
     */
    function setLanguage(lang) {
        // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage –¥–ª—è –±—É–¥—É—â–∏—Ö —Å–µ—Å—Å–∏–π.
        localStorage.setItem('appLanguage', lang);
        
        // 2. –í—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ setLanguage –∏–∑ –º–æ–¥—É–ª—è —á–∞—Ç–∞, —á—Ç–æ–±—ã –æ–Ω —Ç–æ–∂–µ –æ–±–Ω–æ–≤–∏–ª—Å—è.
        // –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –º–æ–¥—É–ª—å —á–∞—Ç–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.
        if (window.ChatModule) {
            ChatModule.setLanguage(lang);
        }

        // 3. –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø–∞–∫–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.
        const translations = LANG_PACK[lang];
        if (!translations) {
            console.error(`–ü–∞–∫–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –¥–ª—è —è–∑—ã–∫–∞ "${lang}" –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
            return;
        }

        // 4. –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–∞—Ö —Å –∞—Ç—Ä–∏–±—É—Ç–æ–º data-lang-key.
        // –≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ö–∞–Ω–∏–∑–º –ø–µ—Ä–µ–≤–æ–¥–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            if (el.hasAttribute('data-lang-skip-content')) return; // <-- –î–û–ë–ê–í–õ–ï–ù–û: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å –º–µ—Ç–∫–æ–π

            const key = el.dataset.langKey;
            if (translations[key]) {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤ –∏–ª–∏ –¥–ª—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞.
                if (el.placeholder) {
                    el.placeholder = translations[key];
                } else {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML, —Ç–∞–∫ –∫–∞–∫ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø–µ—Ä–µ–≤–æ–¥–∞—Ö –º–æ–≥—É—Ç –±—ã—Ç—å —Ç–µ–≥–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, <span>)
                    el.innerHTML = translations[key];
                }
            }
        });
        
        // 5. –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ (–∞—Ç—Ä–∏–±—É—Ç title) —É –∫–Ω–æ–ø–æ–∫ –≤ —à–∞–ø–∫–µ.
        const copyBtn = getEl('copyQuestionBtnQuiz');
        if (copyBtn) copyBtn.title = translations.copy_question_title;
        
        const searchWebBtn = getEl('searchWebButton');
        if (searchWebBtn) searchWebBtn.title = translations.search_web_title;
        
        const chatBtn = getEl('chatToggle');
        if (chatBtn) chatBtn.title = translations.chat_button_title;
        
        const quickModeBtn = getEl('quickModeToggle');
        if (quickModeBtn) quickModeBtn.title = translations.quick_mode_title;
        
        const triggerBtn = getEl('triggerWordToggle');
        if (triggerBtn) triggerBtn.title = translations.trigger_words_title;
        
        const themeBtn = getEl('themeDropdownButton');
        if (themeBtn) themeBtn.title = translations.theme_button_title;
        
        const langBtn = getEl('languageToggle');
        if (langBtn) langBtn.title = translations.language_toggle_title;
        
        const favoriteBtn = getEl('favoriteQuestionBtn');
        if (favoriteBtn) favoriteBtn.title = translations.favorite_button_title;
        
        const translateBtn = getEl('translateQuestionBtn');
        if (translateBtn) translateBtn.title = translations.translate_question_title;
        
// 6. –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —Å–∞–º–æ–π –∫–Ω–æ–ø–∫–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —è–∑—ã–∫–∞.
        // –ö–Ω–æ–ø–∫–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä—É –¢–ï–ö–£–©–ï–ì–û —è–∑—ã–∫–∞.
        if (languageToggle && SUPPORTED_LANGS[lang]) {
            languageToggle.textContent = SUPPORTED_LANGS[lang];
        }

        // 7. –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç —ç–∫—Ä–∞–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞, –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –µ–≥–æ, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏–ª—Å—è –Ω–æ–≤—ã–π —è–∑—ã–∫.
        if (searchResultsContainer && !searchResultsContainer.classList.contains('hidden') && searchResultsData.length > 0) {
            console.log('–ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ —è–∑—ã–∫–∞...');
            displaySingleResult(currentResultIndex);
        }
        
// 9. –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞, –µ—Å–ª–∏ –æ–Ω–∏ –≤–∏–¥–∏–º—ã.
        updateDownloadButtonsText();

        // 10. (–ù–û–í–´–ô –®–ê–ì) –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–∞—Ä—Å–µ—Ä–∞ —Å –Ω–æ–≤—ã–º —è–∑—ã–∫–æ–º.
        populateParserPatterns();

        // --- –ù–ê–ß–ê–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –≤–æ–ø—Ä–æ—Å–æ–≤ ---
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∏–¥–µ–Ω –ª–∏ —ç–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ª–∏ –≤–æ–ø—Ä–æ—Å—ã
        if (quizSetupArea && !quizSetupArea.classList.contains('hidden') && allParsedQuestions.length > 0) {
            const questionCount = allParsedQuestions.filter(q => q.type !== 'category').length;
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å —É–∂–µ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–º–∏ —á–∞—Å—Ç—è–º–∏
            maxQuestionsInfoEl.textContent = `(${_('total_questions_label')} ${questionCount} ${_('questions_label_for_range')})`;
        }
        // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---
    }



    function toggleLanguage() {
        const currentLang = localStorage.getItem('appLanguage') || 'ru';
        
        // 2. –ò—Å–ø–æ–ª—å–∑—É–µ–º –µ–¥–∏–Ω—ã–π –º–∞—Å—Å–∏–≤ LANG_CYCLE
        const currentIndex = LANG_CYCLE.indexOf(currentLang);
        const nextIndex = (currentIndex + 1) % LANG_CYCLE.length;
        const newLang = LANG_CYCLE[nextIndex];
        
        setLanguage(newLang);
    }

    function handleCopyQuestionInQuiz() {
        if (currentQuestionIndex >= questionsForCurrentQuiz.length) {
            alert(_('error_no_question_to_copy')); // –ò–ó–ú–ï–ù–ï–ù–ò–ï
            return;
        }

        const questionData = questionsForCurrentQuiz[currentQuestionIndex];
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ .qst —Ñ–æ—Ä–º–∞—Ç
        let qstContent = `? ${questionData.text}\n`;
        questionData.options.forEach(opt => {
            qstContent += `${opt.isCorrect ? '+' : '-'} ${opt.text}\n`;
        });

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à—É –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        copyToClipboardMain(qstContent.trim());
    }


    function handleFavoriteClickInQuiz() {
        if (!ChatModule.isInitialized() || !ChatModule.getCurrentUser()) {
            alert(('error_no_question_to_favorite'));
            ChatModule.openAuthModal();
            return;
        }
        if (currentQuestionIndex >= questionsForCurrentQuiz.length) {
            alert(_('error_no_current_question'));
            return;
        }
        const questionData = questionsForCurrentQuiz[currentQuestionIndex];
        const questionObject = {
            text: questionData.text,
            options: questionData.options,
        };
        ChatModule.addToFavorites(questionObject, 'question');
    }

    function handleFavoriteClickInSearch(event, rawQuestionText) {
        event.stopPropagation(); 
        if (!ChatModule.isInitialized() || !ChatModule.getCurrentUser()) {
            alert(_('error_favorites_require_auth'));
            ChatModule.openAuthModal();
            return;
        }
        
        // –ò–°–ü–†–ê–í–¨–¢–ï —ç—Ç—É —Å—Ç—Ä–æ–∫—É - —É–±–µ—Ä–∏—Ç–µ escape():
        const cleanText = rawQuestionText.replace(/\\n/g, '\n');
        const parsedQuestion = parseQstContent(`? ${cleanText}`)[0];
        
        if (parsedQuestion) {
            const questionObject = {
                text: parsedQuestion.text,
                options: parsedQuestion.options
            };
            ChatModule.addToFavorites(questionObject, 'question');
        } else {
            alert(_('error_cannot_process_question'));
        }
    }


    function handleCopyClickInSearch(event, rawQuestionText) {
    event.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –∫–ª–∏–∫–æ–≤

    // –¢–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫ (\\n). 
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏—Ö –≤ –Ω–∞—Å—Ç–æ—è—â–∏–µ –ø–µ—Ä–µ–Ω–æ—Å—ã (\n).
    const cleanText = rawQuestionText.replace(/\\n/g, '\n');
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à—É –∂–µ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
    copyToClipboardMain(cleanText); 
}

    function showExitToast() {
        const toast = getEl('exitToast');
        if (!toast) return;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —Å–ª—É—á–∞–π —Å–º–µ–Ω—ã —è–∑—ã–∫–∞
        toast.textContent = _('exit_toast_text');

        toast.classList.remove('hidden');
        toast.classList.add('show');

        setTimeout(() => {
            toast.classList.remove('show');
        }, 1700); // –°–∫—Ä—ã–≤–∞–µ–º —á—É—Ç—å —Ä–∞–Ω—å—à–µ, —á–µ–º —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è —Ñ–ª–∞–≥
    }

    
    function escape(str) {
        if (!str) return '';
        // –≠—Ç–∞ –≤–µ—Ä—Å–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç –≤—Å–µ —Å–∏–º–≤–æ–ª—ã,
        // –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–ª–æ–º–∞—Ç—å JavaScript-—Å—Ç—Ä–æ–∫—É, –≤–∫–ª—é—á–∞—è –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫.
        return str
            .replace(/\\/g, '\\\\')  // 1. –°–Ω–∞—á–∞–ª–∞ —Å–∞–º–∏ –æ–±—Ä–∞—Ç–Ω—ã–µ —Å–ª–µ—à–∏
            .replace(/`/g, '\\`')   // 2. –ó–∞—Ç–µ–º –æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –¥–ª—è —à–∞–±–ª–æ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
            .replace(/'/g, "\\'")   // 3. –û–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
            .replace(/"/g, '\\"')   // 4. –î–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
            .replace(/\n/g, '\\n')  // 5. –ü–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
            .replace(/\r/g, '\\r'); // 6. –í–æ–∑–≤—Ä–∞—Ç –∫–∞—Ä–µ—Ç–∫–∏
    }

    function escapeHTML(str) {
        const p = document.createElement("p");
        p.textContent = str;
        return p.innerHTML;
    }


    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ü–µ–ª–µ–≤–æ–π —ç–ª–µ–º–µ–Ω—Ç —Ç–µ–∫—Å—Ç, –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å.
     * @param {HTMLElement} targetElement - –≠–ª–µ–º–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, textarea), –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å.
     * @returns {boolean} - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç true, –µ—Å–ª–∏ –º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å, –∏ false, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ.
     */
    function checkAndConfirmOverwrite(targetElement) {
        if (targetElement.value.trim() !== '') {
            // –ï—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –ø—É—Å—Ç–æ–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            return confirm(_('parser_overwrite_warning'));
        }
        // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ, —Ä–∞–∑—Ä–µ—à–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –±–µ–∑ –¥–∏–∞–ª–æ–≥–∞
        return true;
    }




    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è –ò–ò –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.
     */
    function checkAICharacterLimit() {
        if (!parserInput || !generateTestFromTextBtn) return;

        const currentLength = parserInput.value.length;
        const originalButtonText = _('ai_generate_button');

        if (currentLength > AI_INPUT_CHAR_LIMIT) {
            // –ï—Å–ª–∏ –ª–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω
            generateTestFromTextBtn.disabled = true;
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è —Å —Ç–µ–∫—É—â–∏–º –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
            const warningText = _('ai_char_limit_exceeded')
                .replace('{current}', currentLength)
                .replace('{max}', AI_INPUT_CHAR_LIMIT);
            generateTestFromTextBtn.innerHTML = `<span>‚ö†Ô∏è ${warningText}</span>`;
            // –î–æ–±–∞–≤–ª—è–µ–º –∫—Ä–∞—Å–Ω—É—é —Ä–∞–º–∫—É –∫ –ø–æ–ª—é –≤–≤–æ–¥–∞ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
            parserInput.style.borderColor = 'var(--accent, red)';
        } else {
            // –ï—Å–ª–∏ –≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ
            generateTestFromTextBtn.disabled = false;
            generateTestFromTextBtn.innerHTML = originalButtonText;
            // –£–±–∏—Ä–∞–µ–º –∫—Ä–∞—Å–Ω—É—é —Ä–∞–º–∫—É
            parserInput.style.borderColor = '';
        }
    }




    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è "—É–º–Ω–æ–≥–æ" —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–∞ –±–ª–æ–∫–∏
    function smartSplitIntoBlocks(text) {
        // –°–Ω–∞—á–∞–ª–∞ –∑–∞–º–µ–Ω—è–µ–º –¥–≤–æ–π–Ω—ã–µ –∏–ª–∏ –±–æ–ª–µ–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
        const withDelimiter = text.replace(/\n\s*\n/g, '<<<BLOCK_DELIMITER>>>');
        // –¢–µ–ø–µ—Ä—å –¥–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ø–µ—Ä–µ–¥ —Ç–µ–≥–∞–º–∏ –≤–æ–ø—Ä–æ—Å–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏
        const finalWithDelimiter = withDelimiter.replace(/\n(?=<–í–æ–ø—Ä–æ—Å>|<question>)/gi, '<<<BLOCK_DELIMITER>>>');
        
        return finalWithDelimiter.split('<<<BLOCK_DELIMITER>>>').filter(b => b.trim() !== '');
    }

    // --- –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ö–û–î–ê: –î–í–ò–ñ–û–ö –ü–ê–†–°–ï–†–ê ---

    const PARSER_PATTERNS = [
        {
            id: 'structured_test_format',
            langKey: "parser_pattern_structured",
            detector: (text) => /^\s*\d+[\.\)]/m.test(text) && /^\s*[a-zA-Z–∞-—è–ê-–Ø][\.\)]/m.test(text),
            processor: (text) => {
                const questions = [];
                let currentQuestion = null;
                const lines = text.split(/\r?\n/);

                const questionStartRegex = /^\s*\d+[\.\)]\s*/;
                const optionMarkerRegex = /^\s*[a-zA-Z–∞-—è–ê-–Ø][\.\)]\s*/;

                const saveCurrentQuestion = () => {
                    if (currentQuestion && currentQuestion.correctAnswer && currentQuestion.options.length > 0) {
                        currentQuestion.text = currentQuestion.text.trim();
                        questions.push(currentQuestion);
                    }
                };

                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) continue;

                    if (questionStartRegex.test(trimmedLine)) {
                        saveCurrentQuestion();
                        currentQuestion = {
                            text: trimmedLine.replace(questionStartRegex, ''),
                            options: [],
                            correctAnswer: null
                        };
                    } 
                    else if (currentQuestion) {
                        if (optionMarkerRegex.test(trimmedLine)) {
                            const optionText = trimmedLine.replace(optionMarkerRegex, '');
                            const isCorrect = optionText.includes('+');
                            const cleanOptionText = optionText.replace(/\+/g, '').trim();

                            currentQuestion.options.push(cleanOptionText);
                            if (isCorrect) {
                                currentQuestion.correctAnswer = cleanOptionText;
                            }
                        } 
                        else {
                            currentQuestion.text += ' ' + trimmedLine;
                        }
                    }
                }

                saveCurrentQuestion();
                return questions;
            }
        },
        {
            id: 'plus_at_end_generic',
            langKey: "parser_pattern_plus_at_end",
            detector: (text) => /\+\s*$/m.test(text),
            processor: (text) => {
                const questions = [];
                const blocks = smartSplitIntoBlocks(text);

                for (const block of blocks) {
                    const lines = block.trim().split('\n');
                    if (lines.length < 2) continue;

                    let questionLines = [];
                    const optionLines = [];
                    let correctAnswer = null;
                    
                    let firstOptionIndex = -1;

                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i] && /^\s/.test(lines[i])) { 
                            firstOptionIndex = i;
                            break;
                        }
                    }

                    if (firstOptionIndex === -1) {
                        firstOptionIndex = 1;
                    }

                    questionLines = lines.slice(0, firstOptionIndex).filter(l => l.trim() !== '');
                    const rawOptionLines = lines.slice(firstOptionIndex).filter(l => l.trim() !== '');
                    
                    const questionText = questionLines.join(' ').replace(/^\s*\d+\s*\.?\s*/, '').trim();

                    rawOptionLines.forEach(line => {
                        const trimmedLine = line.trim();
                        if (trimmedLine.endsWith('+')) {
                            const answer = trimmedLine.slice(0, -1).trim();
                            correctAnswer = answer;
                            optionLines.push(answer);
                        } else {
                            optionLines.push(trimmedLine);
                        }
                    });

                    if (questionText && correctAnswer) {
                        questions.push({
                            text: questionText,
                            options: optionLines,
                            correctAnswer: correctAnswer
                        });
                    }
                }
                return questions;
            }
        },
        {
            id: 'first_answer_correct_fallback',
            langKey: "parser_pattern_no_markers",
            detector: (text) => {
                if (!text || text.trim() === '') return false;
                const hasPlusAtStart = /^\s*\+/m.test(text);
                const hasPlusAtEnd = /\+\s*$/m.test(text);
                const hasTags = /<question>|<variant>|<–í–æ–ø—Ä–æ—Å>|<–≤–∞—Ä–∏–∞–Ω—Ç>/i.test(text);
                if (hasPlusAtStart || hasPlusAtEnd || hasTags) return false;
                const lines = text.trim().split('\n');
                const hasAtLeastTwoLines = lines.length >= 2;
                const hasLetters = /[a-zA-Z–∞-—è–ê-–Ø]/.test(text);
                return hasAtLeastTwoLines && hasLetters;
            },
            processor: (text) => {
                const questions = [];
                const blocks = smartSplitIntoBlocks(text);

                for (const block of blocks) {
                    const lines = block.trim().split('\n').filter(l => l.trim() !== '');
                    if (lines.length < 2) continue;

                    const questionText = lines.shift().replace(/^\s*\d+\s*\.?\s*/, '').trim();
                    const options = lines.map(l => l.trim());
                    
                    if (questionText && options.length > 0) {
                        questions.push({
                            text: questionText,
                            options: options,
                            correctAnswer: options[0]
                        });
                    }
                }
                return questions;
            }
        },
        {
            id: 'numbered_list_plus_answer',
            langKey: "parser_pattern_numbered_plus",
            detector: (text) => /^\s*\d+\./m.test(text) && /^\s*\+/m.test(text),
            processor: (text) => {
                const questions = [];
                let currentQuestion = null;
                const lines = text.split(/\r?\n/);

                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine === '') continue;

                    if (/^\d+\.\s*/.test(trimmedLine)) {
                        if (currentQuestion && currentQuestion.correctAnswer) {
                            questions.push(currentQuestion);
                        }
                        currentQuestion = {
                            text: trimmedLine.replace(/^\d+\.\s*/, '').trim(),
                            options: [],
                            correctAnswer: null
                        };
                    } else if (trimmedLine.startsWith('+') && currentQuestion) {
                        const answerText = trimmedLine.substring(1).trim();
                        currentQuestion.correctAnswer = answerText;
                        currentQuestion.options.push(answerText);
                    } else if (currentQuestion && !currentQuestion.correctAnswer) {
                        currentQuestion.options.push(trimmedLine);
                    } else if (currentQuestion && currentQuestion.correctAnswer) {
                        currentQuestion.options.push(trimmedLine);
                    }
                }

                if (currentQuestion && currentQuestion.correctAnswer) {
                    questions.push(currentQuestion);
                }

                return questions;
            }
        },
        {
            id: 'plus_at_start',
            langKey: "parser_pattern_plus_at_start",
            detector: (text) => text.split('\n').some(line => line.trim().startsWith('+')),
            processor: (text) => {
                const questions = [];
                const blocks = text.split(/\n\s*\n/);
                for (const block of blocks) {
                    const lines = block.trim().split('\n').filter(l => l.trim() !== '');
                    if (lines.length < 2) continue;

                    const questionLines = [];
                    const optionLines = [];
                    let correctAnswer = null;

                    lines.forEach(line => {
                        const trimmedLine = line.trim();
                        if (trimmedLine.startsWith('+')) {
                            correctAnswer = trimmedLine.substring(1).trim();
                            optionLines.push(correctAnswer);
                        } else if (/^[a-zA-Z–∞-—è–ê-–Ø0-9]/.test(trimmedLine) && correctAnswer !== null) {
                            optionLines.push(trimmedLine);
                        } else {
                            questionLines.push(trimmedLine);
                        }
                    });

                    if (questionLines.length > 0 && correctAnswer) {
                        questions.push({
                            text: questionLines.join(' '),
                            options: optionLines,
                            correctAnswer: correctAnswer
                        });
                    }
                }
                return questions;
            }
        },
        {
            id: 'tags_vopros_variant',
            langKey: "parser_pattern_tags_cyrillic",
            detector: (text) => /<–í–æ–ø—Ä–æ—Å>|<–≤–∞—Ä–∏–∞–Ω—Ç>/i.test(text),
            processor: (text) => {
                const questions = [];
                const cleanedText = text.replace(/^\s*\d+\s*\.?\s*</gm, '<');
                const blocks = cleanedText.split(/<–í–æ–ø—Ä–æ—Å>/i).filter(b => b.trim() !== '');

                for (const block of blocks) {
                    const parts = block.split(/<–≤–∞—Ä–∏–∞–Ω—Ç>/i).map(p => p.trim());
                    if (parts.length < 2) continue;

                    const questionText = parts.shift();
                    questions.push({
                        text: questionText,
                        options: parts,
                        correctAnswer: parts[0]
                    });
                }
                return questions;
            }
        },
        {
            id: 'tags_question_variant',
            langKey: "parser_pattern_tags_latin",
            detector: (text) => /<question|<variant>/i.test(text),
            processor: (text) => {
                const questions = [];
                const cleanedText = text.replace(/^\s*\d+\s*\.?\s*</gm, '<');
                const blocks = cleanedText.split(/<question.*?>/i).filter(b => b.trim() !== '');

                for (const block of blocks) {
                    const parts = block.split(/<variant>/i).map(p => p.trim().replace(/<\/?[^>]+(>|$)/g, ""));
                    if (parts.length < 2) continue;
                    
                    const questionText = parts.shift();
                    questions.push({
                        text: questionText,
                        options: parts,
                        correctAnswer: parts[0]
                    });
                }
                return questions;
            }
        }
    ];


    function processTextWithMultiFormat(text) {
        // === –ù–ê–ß–ê–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø: –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Ä—É—á–Ω–æ–π –ø–æ–¥—Å—á—ë—Ç –∏–Ω–¥–µ–∫—Å–∞ ===

        let allParsedQuestions = [];
        let parsingErrors = [];

        // 1. –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤—Å–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –∫ –µ–¥–∏–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É '\n'.
        //    –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å \r\n –∏ –¥–µ–ª–∞–µ—Ç –ø–æ–¥—Å—á–µ—Ç –Ω–∞–¥–µ–∂–Ω—ã–º.
        const normalizedText = text.replace(/\r\n/g, '\n');
        const lines = normalizedText.split('\n');

        const processAndAddBlock = (blockLines, startIndex) => {
            if (blockLines.length === 0) return;
            const blockText = blockLines.join('\n');
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–Ω–µ—á–Ω—ã–π –∏–Ω–¥–µ–∫—Å
            const endIndex = startIndex + blockText.length;

            const individualPatterns = PARSER_PATTERNS.filter(p => p.id !== 'multi_format');
            let blockParsed = false;

            for (const pattern of individualPatterns) {
                if (pattern.detector(blockText)) {
                    try {
                        const parsed = pattern.processor(blockText);
                        if (parsed.length > 0) {
                            allParsedQuestions.push(...parsed);
                            blockParsed = true;
                            break;
                        }
                    } catch (e) {
                        console.warn(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –±–ª–æ–∫–∞ —à–∞–±–ª–æ–Ω–æ–º "${pattern.name}":`, e);
                    }
                }
            }
            if (!blockParsed) {
                console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –±–ª–æ–∫–∞:\n---\n", blockText);
                parsingErrors.push({
                    text: blockText.trim(),
                    start: startIndex,
                    end: endIndex
                });
            }
        };

        // 2. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—á–Ω–æ–π –ø–æ–¥—Å—á–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ –≤–º–µ—Å—Ç–æ –Ω–µ–Ω–∞–¥–µ–∂–Ω–æ–≥–æ indexOf.
        let currentIndex = 0;
        let currentBlockLines = [];
        let currentBlockStartIndex = 0;

        lines.forEach(line => {
            const trimmedLine = line.trim();
            const isCategoryTag = trimmedLine.startsWith('#_#') && trimmedLine.endsWith('#_#');
            const isNewBlockStart = /^\s*\d+\.\s+/.test(trimmedLine) || /^\s*<question>|^\s*<–í–æ–ø—Ä–æ—Å>/i.test(trimmedLine);
            
            if (isCategoryTag) {
                processAndAddBlock(currentBlockLines, currentBlockStartIndex);
                const categoryName = trimmedLine.slice(3, -3).trim();
                allParsedQuestions.push({ text: categoryName, type: 'category' });
                currentBlockLines = [];
            } else if (isNewBlockStart && currentBlockLines.length > 0) {
                processAndAddBlock(currentBlockLines, currentBlockStartIndex);
                currentBlockLines = [line];
                // –ù–æ–≤—ã–π –±–ª–æ–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
                currentBlockStartIndex = currentIndex;
            } else {
                if (currentBlockLines.length === 0) {
                    // –≠—Ç–æ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞
                    currentBlockStartIndex = currentIndex;
                }
                currentBlockLines.push(line);
            }

            // 3. –í –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ —Å–¥–≤–∏–≥–∞–µ–º –∏–Ω–¥–µ–∫—Å –Ω–∞ –¥–ª–∏–Ω—É —Å—Ç—Ä–æ–∫–∏ + 1 (–∑–∞ —Å–∏–º–≤–æ–ª '\n')
            currentIndex += line.length + 1;
        });

        // –ù–µ –∑–∞–±—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–∞–º—ã–π –ø–æ—Å–ª–µ–¥–Ω–∏–π –±–ª–æ–∫
        processAndAddBlock(currentBlockLines, currentBlockStartIndex);

        return {
            questions: allParsedQuestions,
            errors: parsingErrors
        };
        // === –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ===
    }




    function populateParserPatterns() {
        // –®–ê–ì 1: –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–ø—Ü–∏–∏
        parserPatternSelect.innerHTML = '';

        // –®–ê–ì 2: –°–æ–∑–¥–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é "–ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ" –∑–∞–Ω–æ–≤–æ, –∏—Å–ø–æ–ª—å–∑—É—è —Å–∏—Å—Ç–µ–º—É –ø–µ—Ä–µ–≤–æ–¥–æ–≤
        const autoOption = document.createElement('option');
        autoOption.value = 'auto';
        autoOption.textContent = _('parser_auto_detect'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á –∏–∑ LANG_PACK
        autoOption.selected = true;
        parserPatternSelect.appendChild(autoOption);

        // –®–ê–ì 3: –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ –∏–∑ –Ω–∞—à–µ–≥–æ –º–∞—Å—Å–∏–≤–∞ (—ç—Ç–æ—Ç –∫–æ–¥ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è)
        PARSER_PATTERNS.forEach(pattern => {
            const option = document.createElement('option');
            option.value = pattern.id;
            option.textContent = _(pattern.langKey);
            parserPatternSelect.appendChild(option);
        });
    }



    function handleParserFileInput(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            parserInput.value = e.target.result;
            checkAICharacterLimit();
        };
        reader.readAsText(file, 'UTF-8');
    }



    /**
     * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫ –∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç –∫ –Ω–∏–º –∫–ª–∏–∫–∏ –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –≤ –Ω—É–∂–Ω–æ–º –ø–æ–ª–µ.
     * @param {HTMLTextAreaElement} targetTextarea - –ü–æ–ª–µ, –≤ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥—É—Ç –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—Ç—å—Å—è –æ—à–∏–±–∫–∏.
     * @param {Array<Object>} errors - –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –æ—à–∏–±–æ–∫.
     */
    function renderErrors(targetTextarea, errors) {
        const errorsArea = getEl('parserErrorsArea');
        const errorCountEl = getEl('errorCount');
        const errorListEl = getEl('errorList');

        if (!errorsArea || !errorCountEl || !errorListEl) return;

        errorListEl.innerHTML = ''; 
        errorCountEl.textContent = errors.length;
        errorsArea.classList.remove('hidden');

        errors.forEach(error => {
            const li = document.createElement('li');
            li.className = 'error-list-item';
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É –æ—à–∏–±–∫–∏ –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
            li.textContent = error.text.split('\n')[0].trim() || '[–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞]';
            li.title = `–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–¥–µ–ª–∏—Ç—å –æ—à–∏–±–∫—É:\n\n${error.text}`;
            
            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫–ª–∏–∫ –∫ –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–û–ô —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏, –ø–µ—Ä–µ–¥–∞–≤–∞—è –ù–£–ñ–ù–û–ï –ø–æ–ª–µ
            li.addEventListener('click', () => {
                // –®–ê–ì 1: –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª–∞—Å—Å. –ï—Å–ª–∏ –æ–Ω –µ—Å—Ç—å - —É–±–∏—Ä–∞–µ–º, –µ—Å–ª–∏ –Ω–µ—Ç - –¥–æ–±–∞–≤–ª—è–µ–º.
                li.classList.toggle('reviewed');
                
                // –®–ê–ì 2: –í—ã–ø–æ–ª–Ω—è–µ–º —É–∂–µ –∑–Ω–∞–∫–æ–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ - –ø–æ–¥—Å–≤–µ—Ç–∫—É –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –ø–æ–ª–µ.
                highlightErrorInTextarea(targetTextarea, error.start, error.end);
            });
      
            
            errorListEl.appendChild(li);
        });
    }





    /**
     * –í—ã–¥–µ–ª—è–µ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç —Ç–µ–∫—Å—Ç–∞ –≤ –£–ö–ê–ó–ê–ù–ù–û–ú —Ç–µ–∫—Å—Ç–æ–≤–æ–º –ø–æ–ª–µ –∏ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç –∫ –Ω–µ–º—É.
     * @param {HTMLTextAreaElement} targetTextarea - –ü–æ–ª–µ <textarea>, –≤ –∫–æ—Ç–æ—Ä–æ–º –Ω—É–∂–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—Å—Ç.
     * @param {number} start - –ù–∞—á–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è.
     * @param {number} end - –ö–æ–Ω–µ—á–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è.
     */
    function highlightErrorInTextarea(targetTextarea, start, end) {
        if (!targetTextarea) return;

        targetTextarea.focus();
        targetTextarea.setSelectionRange(start, end);

        const mirrorDiv = document.createElement('div');
        const computedStyle = getComputedStyle(targetTextarea);

        [
            'font', 'lineHeight', 'letterSpacing', 'wordSpacing',
            'paddingTop', 'paddingRight', 'paddingBottom', 'paddingLeft',
            'borderTopWidth', 'borderRightWidth', 'borderBottomWidth', 'borderLeftWidth',
            'boxSizing', 'whiteSpace', 'wordWrap', 'wordBreak'
        ].forEach(prop => {
            mirrorDiv.style[prop] = computedStyle[prop];
        });

        mirrorDiv.style.position = 'absolute';
        mirrorDiv.style.top = '-9999px';
        mirrorDiv.style.left = '0px';
        mirrorDiv.style.width = targetTextarea.clientWidth + 'px';
        mirrorDiv.textContent = targetTextarea.value.substring(0, start) + '\u00A0';
        document.body.appendChild(mirrorDiv);

        const scrollPosition = mirrorDiv.scrollHeight - 180;
        targetTextarea.scrollTop = scrollPosition > 0 ? scrollPosition : 0;

        document.body.removeChild(mirrorDiv);
    }



    function hideAndResetErrorArea() {
        getEl('parserErrorsArea')?.classList.add('hidden');
        getEl('errorList').innerHTML = '';
        getEl('errorCount').textContent = '0';
    }

 

    function createVariantFilterCheckboxes() {
        if (!filterVariantCheckboxes) return;
        let checkboxesHTML = '';
        for (let i = 1; i <= 10; i++) {
            checkboxesHTML += `
                <label>
                    <input type="checkbox" value="${i}">${i}
                </label>
            `;
        }
        filterVariantCheckboxes.innerHTML = checkboxesHTML;
    }

    /**
     * –ü–∞—Ä—Å–∏—Ç –≥–æ—Ç–æ–≤—ã–π .qst —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.
     * @param {string} qstText - –¢–µ–∫—Å—Ç –∏–∑ –ø–æ–ª—è "–†–µ–∑—É–ª—å—Ç–∞—Ç".
     * @returns {Array<Object>} –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤ { text, variantCount, start, end }.
     */
    function parseQstResultForFiltering(qstText) {
        const questions = [];
        const delimiterRegex = /\n\s*\n/g; // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π
        let lastIndex = 0; // –ò–Ω–¥–µ–∫—Å, —Å –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–∞—á–∏–Ω–∞–µ–º –∏—Å–∫–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–∏–∫–ª —Å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–º –≤—ã—Ä–∞–∂–µ–Ω–∏–µ–º, —á—Ç–æ–±—ã –Ω–∞–¥–µ–∂–Ω–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –ø–æ –≤—Å–µ–º—É —Ç–µ–∫—Å—Ç—É
        let match;
        while ((match = delimiterRegex.exec(qstText)) !== null) {
            // –¢–µ–∫—Å—Ç –±–ª–æ–∫–∞ - —ç—Ç–æ –≤—Å—ë, —á—Ç–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –º–µ–∂–¥—É lastIndex –∏ –Ω–∞—á–∞–ª–æ–º –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è
            const blockText = qstText.substring(lastIndex, match.index);
            const blockStart = lastIndex;

            if (blockText.trim() !== '') {
                const lines = blockText.split('\n');
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–æ–ø—Ä–æ—Å (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "?")
                if (lines.some(l => l.trim().startsWith('?'))) {
                    const variantCount = lines.filter(l => l.trim().startsWith('+') || l.trim().startsWith('-')).length;
                    questions.push({
                        text: blockText,
                        variantCount: variantCount,
                        start: blockStart, // –ù–∞–¥–µ–∂–Ω–∞—è —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è
                        end: blockStart + blockText.length // –ù–∞–¥–µ–∂–Ω–∞—è –∫–æ–Ω–µ—á–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
                    });
                }
            }
            // –°–¥–≤–∏–≥–∞–µ–º –∫—É—Ä—Å–æ—Ä –Ω–∞ –ø–æ–∑–∏—Ü–∏—é –ü–û–°–õ–ï –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è
            lastIndex = delimiterRegex.lastIndex;
        }

        // –ù–µ –∑–∞–±—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–∞–º—ã–π –ø–æ—Å–ª–µ–¥–Ω–∏–π –±–ª–æ–∫ —Ç–µ–∫—Å—Ç–∞, –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è
        const lastBlockText = qstText.substring(lastIndex);
        if (lastBlockText.trim() !== '') {
            const lines = lastBlockText.split('\n');
            if (lines.some(l => l.trim().startsWith('?'))) {
                const variantCount = lines.filter(l => l.trim().startsWith('+') || l.trim().startsWith('-')).length;
                questions.push({
                    text: lastBlockText,
                    variantCount: variantCount,
                    start: lastIndex,
                    end: lastIndex + lastBlockText.length
                });
            }
        }

        return questions;
    }

    function filterByVariantCount() {
        // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ—à–∏–±–∫–∏
        hideAndResetErrorArea();

        const selectedCounts = Array.from(filterVariantCheckboxes.querySelectorAll('input:checked'))
                                    .map(input => parseInt(input.value));

        if (selectedCounts.length === 0) {
            alert(_('error_filter_no_variant_selected'));
            return;
        }

        const qstText = parserOutput.value;
        const allQuestions = parseQstResultForFiltering(qstText);
        
        const defectiveQuestions = allQuestions.filter(q => !selectedCounts.includes(q.variantCount));

        if (defectiveQuestions.length > 0) {
            // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–æ–∫–∞ –æ—à–∏–±–æ–∫
            getEl('showErrorsBtn').innerHTML = `‚ö†Ô∏è –û—à–∏–±–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ (<span id="errorCount">${defectiveQuestions.length}</span>)`;
            renderErrors(parserOutput, defectiveQuestions);
            alert(_('error_filter_found_mismatch').replace('{count}', defectiveQuestions.length));
        } else {
            alert(_('error_filter_all_match'));
        }
        filterVariantsDropdown.classList.add('hidden');
    }

    function resetVariantFilter() {
        filterVariantCheckboxes.querySelectorAll('input:checked').forEach(input => input.checked = false);
        hideAndResetErrorArea(); // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –æ—à–∏–±–æ–∫
        filterVariantsDropdown.classList.add('hidden');
    }


    function runParser() {
        resetVariantFilter();
        const text = parserInput.value;
        if (text.trim() === '') {
            alert(_('parser_input_empty_alert'));
            return;
        }

        if (!checkAndConfirmOverwrite(parserOutput)) {
            return;
        }

        hideAndResetErrorArea();
        parserOutputArea.classList.add('hidden');

        const selectedPatternId = parserPatternSelect.value;
        let result;

        if (selectedPatternId === 'auto') {
            result = processTextWithMultiFormat(text);
        } else {
            const pattern = PARSER_PATTERNS.find(p => p.id === selectedPatternId);
            if (!pattern) {
                alert(_('parser_pattern_not_found_alert'));
                return;
            }
            result = {
                questions: pattern.processor(text),
                errors: []
            };
        }

        const parsedQuestions = result.questions;
        const errors = result.errors;
        
        if (errors.length > 0) {
            renderErrors(parserInput, errors);
        }

        if (parsedQuestions.length === 0) {
            if (errors.length > 0) {
                alert(_('parser_no_questions_with_errors_alert').replace('{count}', errors.length));
            } else {
                alert(_('parser_no_questions_recognized_alert'));
            }
            return;
        }

        let qstResult = '';
        parsedQuestions.forEach(q => {
            if (q.type === 'category') {
                qstResult += `#_#${q.text}#_#\n\n`;
            } else {
                if (q.text && q.options && q.options.length > 0) {
                    qstResult += `? ${q.text.replace(/\n/g, ' ')}\n`;
                    q.options.forEach(opt => {
                        const prefix = (opt === q.correctAnswer) ? '+' : '-';
                        qstResult += `${prefix} ${opt.replace(/\n/g, ' ')}\n`;
                    });
                    qstResult += '\n';
                }
            }
        });

        parserOutput.value = qstResult.trim();
        parserOutputArea.classList.remove('hidden');

        if (errors.length > 0) {
            alert(_('parser_conversion_summary_alert').replace('{parsed}', parsedQuestions.length).replace('{errors}', errors.length));
        } else {
            alert(_('parser_conversion_success_alert').replace('{count}', parsedQuestions.length));
        }
    }



    async function downloadParsedQst() {
        const content = parserOutput.value;
        if (!content) return;
        await downloadOrShareFile('parsed_test.qst', content, 'text/plain;charset=utf-8', _('share_title_converted_test'));
    }


    function clearParserInput() {
        parserInput.value = '';
        parserFileInput.value = ''; // –í–∞–∂–Ω–æ —Ç–∞–∫–∂–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª!
        parserInput.focus(); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—É—Ä—Å–æ—Ä –≤ –ø–æ–ª–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
        hideAndResetErrorArea();
        checkAICharacterLimit();
    }




    async function handleAIGenerationRequest() {
        const text = parserInput.value.trim();
        if (!text) {
            alert(_('ai_error_text_empty'));
            return;
        }
        
        // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å ---
        if (!checkAndConfirmOverwrite(parserOutput)) {
            return; // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–û—Ç–º–µ–Ω–∞", –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
        }
        // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---

        // –í—Ä–µ–º–µ–Ω–Ω–æ –∏–∑–º–µ–Ω—è–µ–º –≤–∏–¥ –∫–Ω–æ–ø–∫–∏ –Ω–∞ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏
        const originalButtonHTML = generateTestFromTextBtn.innerHTML;
        generateTestFromTextBtn.disabled = true;
        generateTestFromTextBtn.innerHTML = `<span>${_('ai_generating_button')}</span>`;
        showGlobalLoader(_('ai_analyzing_text'));

        const questionCount = aiAutoCount.checked ? 'auto' : aiQuestionCount.value;
        const answerCount = getEl('aiAnswerCount').value;
        const autoCategorize = getEl('aiAutoCategory').checked; // –°—á–∏—Ç—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —á–µ–∫–±–æ–∫—Å–∞

        try {
            const response = await fetch(googleAppScriptUrl, {
                method: 'POST',
                headers: {
                  'Content-Type': 'text/plain',
                },
                body: JSON.stringify({
                    action: 'generateTest',
                    text: text,
                    count: questionCount,
                    answerCount: answerCount,
                    autoCategorize: autoCategorize // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –ø–æ–ª–µ –≤ –∑–∞–ø—Ä–æ—Å
                })
            });

            const result = await response.json();

            if (result.success && result.qst) {
                parserOutput.value = result.qst;
                parserOutputArea.classList.remove('hidden');
                parserOutputArea.scrollIntoView({ behavior: 'smooth' });
            } else {
                throw new Error(result.error || _('ai_error_generation'));
            }



        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–∞:", error);
            // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ ---
            let userFriendlyError;

            if (error.message.includes("INTERNAL") || error.message.includes("HTTP 500")) {
                // –ï—Å–ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
                userFriendlyError = _('ai_error_server_generation');
            } else {
                // –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
                userFriendlyError = _('ai_error_generation');
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            alert(userFriendlyError);
            // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
        } finally {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            generateTestFromTextBtn.disabled = false;
            generateTestFromTextBtn.innerHTML = originalButtonHTML;
            hideGlobalLoader();
        }
    }



    /**
     * –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É –≤ —Ä–∞–∑–¥–µ–ª–µ –ø–∞—Ä—Å–µ—Ä–∞.
     * @param {string} tabId - ID –≤–∫–ª–∞–¥–∫–∏ ('converter' –∏–ª–∏ 'aiGenerator').
     */
    function switchParserTab(tabId) {
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
        converterContent.classList.remove('active');
        aiGeneratorContent.classList.remove('active');

        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
        converterTabBtn.classList.remove('active');
        aiGeneratorTabBtn.classList.remove('active');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –≤–∫–ª–∞–¥–∫—É –∏ –¥–µ–ª–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–π –µ–µ –∫–Ω–æ–ø–∫—É
        if (tabId === 'converter') {
            converterContent.classList.add('active');
            converterTabBtn.classList.add('active');
        } else if (tabId === 'aiGenerator') {
            aiGeneratorContent.classList.add('active');
            aiGeneratorTabBtn.classList.add('active');
        }
    }



    async function handleAIGenerationFromTopicRequest() {
        const topic = aiTopicInput.value.trim();
        if (!topic) {
            alert(_('ai_topic_empty_alert'));
            return;
        }

        if (!checkAndConfirmOverwrite(parserOutput)) {
            return;
        }

        const originalButtonHTML = generateTestFromTopicBtn.innerHTML;
        generateTestFromTopicBtn.disabled = true;
        generateTestFromTopicBtn.innerHTML = `<span>${_('ai_generating_button')}</span>`;
        showGlobalLoader(_('ai_thinking_topic'));

        const questionCount = aiTopicQuestionCount.value;
        const answerCount = aiTopicAnswerCount.value;
        const autoCategorize = aiTopicAutoCategory.checked;

        try {
            const response = await fetch(googleAppScriptUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'generateTestFromTopic',
                    topic: topic,
                    count: questionCount,
                    answerCount: answerCount,
                    autoCategorize: autoCategorize,
                    targetLanguage: localStorage.getItem('appLanguage') || 'ru'
                })
            });

            const result = await response.json();

            if (result.success && result.qst) {
                parserOutput.value = result.qst;
                parserOutputArea.classList.remove('hidden');
                parserOutputArea.scrollIntoView({ behavior: 'smooth' });
            } else {
                throw new Error(result.error || _('ai_error_generation'));
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–∞ –ø–æ —Ç–µ–º–µ:", error);
            
            let userFriendlyError;
            if (error.message.includes("INTERNAL") || error.message.includes("HTTP 500")) {
                userFriendlyError = _('ai_error_server_generation');
            } else {
                userFriendlyError = _('ai_error_generation');
            }
            alert(userFriendlyError);
        } finally {
            generateTestFromTopicBtn.disabled = false;
            generateTestFromTopicBtn.innerHTML = originalButtonHTML;
            hideGlobalLoader();
        }
    }





    /**
     * –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø-–ü–û–ú–û–©–ù–ò–ö
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—ã—Å–æ—Ç—É –±–ª–æ–∫–∞ —Å –≤–æ–ø—Ä–æ—Å–æ–º –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –ò–ò –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç/—É–±–∏—Ä–∞–µ—Ç
     * –∫–Ω–æ–ø–∫—É "—Å–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å", –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ.
     * @param {HTMLElement} questionElement - DOM-—ç–ª–µ–º–µ–Ω—Ç –±–ª–æ–∫–∞ —Å –≤–æ–ø—Ä–æ—Å–æ–º (#aiExplanationQuestion).
     */
    function setupAIQuestionCollapser(questionElement) {
        if (!questionElement) return;

        // –°–Ω–∞—á–∞–ª–∞ –≤—Å–µ–≥–¥–∞ —É–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—É—é –∫–Ω–æ–ø–∫—É –∏ –∫–ª–∞—Å—Å—ã, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞
        const oldBtn = questionElement.querySelector('.expand-question-btn');
        if (oldBtn) oldBtn.remove();
        questionElement.classList.remove('collapsible', 'expanded');
        
        // –î–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É –º–≥–Ω–æ–≤–µ–Ω–∏–µ –Ω–∞ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è innerHTML
        setTimeout(() => {
            const MAX_HEIGHT = 120; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏ —Ä–µ–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —Ç–µ–∫—Å—Ç–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é
            if (questionElement.scrollHeight > MAX_HEIGHT) {
                questionElement.classList.add('collapsible');
                const expandBtn = document.createElement('button');
                expandBtn.className = 'expand-question-btn';
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
                expandBtn.onclick = (e) => {
                    e.stopPropagation();
                    questionElement.classList.toggle('expanded');
                    const outputEl = getEl('aiExplanationOutput');
                    if (outputEl) {
                        outputEl.classList.toggle('collapsed', questionElement.classList.contains('expanded'));
                    }
                };
                questionElement.appendChild(expandBtn);
            }
        }, 0); // setTimeout —Å 0 –∑–∞–¥–µ—Ä–∂–∫–æ–π - —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ç—Ä—é–∫ –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
    }


 
    async function showAIExplanation(question, userIncorrectAnswerText = null) {
        currentAIQuestion = question;
        currentAIUserIncorrectAnswer = userIncorrectAnswerText;
        currentAITranslation = null;
        isAIModalShowingTranslation = false;
        
        const outputEl = getEl('aiExplanationOutput');
        const toggleBtn = getEl('aiExplanationTranslateBtn');
        const questionEl = getEl('aiExplanationQuestion');
        
        toggleBtn.classList.add('hidden');
        outputEl.innerHTML = '';

        const styleContentEl = getEl('aiExplanationStyleContent');
        const styleTextEl = getEl('aiExplanationStyleText');
        styleContentEl.innerHTML = ''; 
        
        const styles = ['simple', 'scientific', 'associative', 'stepbystep', 'practical', 'visual'];
        
        styles.forEach(styleKey => {
            const link = document.createElement('a');
            link.href = '#';
            link.dataset.style = styleKey;
            link.textContent = _('ai_style_' + styleKey.toLowerCase());
            
            if (styleKey === 'simple') {
                link.classList.add('active');
            }
            styleContentEl.appendChild(link);
        });
        styleTextEl.textContent = _('ai_style_simple');

        showGlobalLoader(_('ai_explanation_title')); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á

        try {
            if (isTranslateModeEnabled) {
                const lang = localStorage.getItem('appLanguage') || 'ru';
                const translationResult = await getCachedOrFetchTranslation(question, question.originalIndex, lang);
                
                if (translationResult) {
                    currentAITranslation = translationResult.question;
                    isAIModalShowingTranslation = true;
                    toggleBtn.classList.remove('hidden');
                }
            } else {
                const appLang = localStorage.getItem('appLanguage') || 'ru';
                const questionLang = detectLanguage(question.text);

                if (appLang !== questionLang) {
                    toggleBtn.classList.remove('hidden');
                }
            }
            
            updateAIModalQuestionText();
            document.body.classList.add('chat-open');
            ChatModule.showModal('aiExplanationModal');
            
            fetchAndDisplayExplanation('simple', userIncorrectAnswerText);

        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –æ–∫–Ω–∞ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è:", error);
            alert(_('ai_explanation_prepare_error'));
        } finally {
            hideGlobalLoader();
        }
    }




    function updateAIModalQuestionText() {
        const questionEl = getEl('aiExplanationQuestion');
        const toggleBtn = getEl('aiExplanationTranslateBtn');
        if (!questionEl || !toggleBtn) return;

        let questionToDisplay;

        // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ù–æ–≤–∞—è, –Ω–∞–¥–µ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ ---
        if (isAIModalShowingTranslation && currentAITranslation) {
            // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –ø–æ–∫–∞–∑–∞–Ω –ü–ï–†–ï–í–û–î
            questionToDisplay = currentAITranslation;
            // —Ç–æ –∫–Ω–æ–ø–∫–∞ –¥–æ–ª–∂–Ω–∞ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –ø–æ–∫–∞–∑–∞—Ç—å –û–†–ò–ì–ò–ù–ê–õ
            toggleBtn.textContent = _('ai_show_original_button');
        } else {
            // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –ø–æ–∫–∞–∑–∞–Ω –û–†–ò–ì–ò–ù–ê–õ
            questionToDisplay = currentAIQuestion;
            // —Ç–æ –∫–Ω–æ–ø–∫–∞ –¥–æ–ª–∂–Ω–∞ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –ø–æ–∫–∞–∑–∞—Ç—å –ü–ï–†–ï–í–û–î
            toggleBtn.textContent = _('ai_show_translation_button');
        }
        // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---

        if (!questionToDisplay) return;

        // –û–±–Ω–æ–≤–ª—è–µ–º HTML-—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        questionEl.innerHTML = `<strong>${_('ai_explanation_question')}:</strong> ${escapeHTML(questionToDisplay.text)}<br><strong>${_('ai_explanation_correct_answer')}:</strong> ${escapeHTML(questionToDisplay.options[questionToDisplay.correctAnswerIndex].text)}`;
        
        // –°–†–ê–ó–£ –ñ–ï –ü–û–°–õ–ï –û–ë–ù–û–í–õ–ï–ù–ò–Ø –≤—ã–∑—ã–≤–∞–µ–º –Ω–∞—à—É –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é-–ø–æ–º–æ—â–Ω–∏–∫!
        setupAIQuestionCollapser(questionEl);
    }



    /**
     * –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø
     * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —è–∑—ã–∫–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –ò–ò.
     */
    async function handleAITranslateToggle() {
        const toggleBtn = getEl('aiExplanationTranslateBtn');
        if (!toggleBtn) return;

        // –ï—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º –ø–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥, –Ω–æ –æ–Ω –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
        if (!isAIModalShowingTranslation && !currentAITranslation) {
            const lang = localStorage.getItem('appLanguage') || 'ru';
            toggleBtn.disabled = true;
            toggleBtn.textContent = '...'; // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥
            const translationResult = await getCachedOrFetchTranslation(currentAIQuestion, currentAIQuestion.originalIndex, lang);
            
            toggleBtn.disabled = false;
            
            if (translationResult) {
                currentAITranslation = translationResult.question;
                isAIModalShowingTranslation = true;
            } else {
                alert(_('error_translation_failed'));
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –æ—Å—Ç–∞–µ–º—Å—è –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ
                isAIModalShowingTranslation = false;
            }
        } else {
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ñ–ª–∞–≥
            isAIModalShowingTranslation = !isAIModalShowingTranslation;
        }
        
        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞/–æ—Ç–≤–µ—Ç–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        updateAIModalQuestionText();
    }



    async function fetchAndDisplayExplanation(style, userIncorrectAnswerText = null) { // <<<--- –î–æ–±–∞–≤–ª–µ–Ω –≤—Ç–æ—Ä–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä
        if (!currentAIQuestion) return;

        const styleContentEl = getEl('aiExplanationStyleContent');
        styleContentEl.querySelectorAll('a').forEach(a => a.classList.remove('active'));
        const activeLink = styleContentEl.querySelector(`a[data-style="${style}"]`);
        if (activeLink) activeLink.classList.add('active');
            
        const outputEl = getEl('aiExplanationOutput');
        outputEl.innerHTML = `<div class="typing-loader-container"><div class="typing-loader">${_('ai_explanation_loading')}</div></div>`;

        try {
            // --- –ù–û–í–´–ô –û–ë–™–ï–ö–¢ –î–õ–Ø –û–¢–ü–†–ê–í–ö–ò ---
            const payload = {
                action: 'getExplanation',
                question_text: currentAIQuestion.text,
                correct_answer_text: currentAIQuestion.options[currentAIQuestion.correctAnswerIndex].text,
                style: style,
                targetLanguage: localStorage.getItem('appLanguage') || 'ru'
            };

            // –ï—Å–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç –±—ã–ª –ø–µ—Ä–µ–¥–∞–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ payload
            if (userIncorrectAnswerText) {
                payload.user_incorrect_answer_text = userIncorrectAnswerText;
            }
            // ---------------------------------

            const response = await fetch(googleAppScriptUrl, {
                method: 'POST',
                body: JSON.stringify(payload) // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç
            });
            const result = await response.json();

            if (result.success) {
                if (window.marked) {
                    outputEl.innerHTML = marked.parse(result.explanation);
                } else {
                    console.warn('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ marked.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.');
                    outputEl.innerHTML = result.explanation.replace(/\n/g, '<br>');
                }
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            let userFriendlyError;
            if (error.message.includes("INTERNAL") || error.message.includes("HTTP 500")) {
                userFriendlyError = _('ai_error_server');
            } else {
                userFriendlyError = _('ai_error_generic');
            }
            outputEl.innerHTML = `<p style="color: var(--feedback-incorrect-text);">${userFriendlyError}</p>`;
        }
    }


    function handleExplainClickInSearch(event, rawQuestionText) {
        event.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –∫–ª–∏–∫–æ–≤

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à –º–æ—â–Ω—ã–π –ø–∞—Ä—Å–µ—Ä, —á—Ç–æ–±—ã –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å —Å—Ç—Ä–æ–∫—É –≤ –æ–±—ä–µ–∫—Ç
        // parseQstContent –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤, –ø–æ—ç—Ç–æ–º—É –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
        const parsedQuestions = parseQstContent(rawQuestionText);

        if (parsedQuestions && parsedQuestions.length > 0) {
            const questionObject = parsedQuestions[0];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–∞—Ä—Å–∏–Ω–≥ –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ –∏ —É –Ω–∞—Å –µ—Å—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
            if (questionObject && questionObject.text && questionObject.options) {
                // === –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨ ===
                // 1. –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—Å—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
                const correctAnswerText = questionObject.options[questionObject.correctAnswerIndex].text;
                // 2. –ü–µ—Ä–µ–¥–∞–µ–º –µ–≥–æ –≤—Ç–æ—Ä—ã–º –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º –≤ —Ñ—É–Ω–∫—Ü–∏—é
                showAIExplanation(questionObject, correctAnswerText);
                // === –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ===
            } else {
                alert(_('error_cannot_fully_process_question'));
            }
        } else {
            alert(_('error_no_question_for_explanation'));
        }
    }


    async function handleTranslateClickInSearch(event, buttonElement, rawQuestionText) {
        event.stopPropagation();

        const parsedQuestions = parseQstContent(rawQuestionText);
        if (!parsedQuestions || parsedQuestions.length === 0) {
            alert(_('error_cannot_process_question'));
            return;
        }
        const originalQuestionObject = parsedQuestions[0];

        buttonElement.classList.add('translating');
        buttonElement.disabled = true;

        try {
            const targetLang = localStorage.getItem('appLanguage') || 'ru';
            const translatedQuestionObject = await getTranslatedQuestion(originalQuestionObject, targetLang);

            if (translatedQuestionObject) {
                const card = buttonElement.closest('.result-card');
                if (!card) return;

                // 1. –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∞–Ω–∏–º–∏—Ä–æ–≤–∞—Ç—å
                const questionElement = card.querySelector('.question-text-detail');
                const optionElements = card.querySelectorAll('.answer-option');

                if (!questionElement || optionElements.length === 0) {
                    // –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–µ –Ω–∞—à–ª–∏ —ç–ª–µ–º–µ–Ω—Ç—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π
                    const contentArea = card.querySelector('.result-card-content');
                    const translatedRawText = formatQuestionObjectToQstString(translatedQuestionObject);
                    contentArea.innerHTML = parseAndRenderQuestionBlock(translatedRawText);
                } else {
                    // 2. –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –¥–ª—è –≤—Å–µ—Ö –∞–Ω–∏–º–∞—Ü–∏–π
                    const allAnimations = [];

                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞
                    allAnimations.push(
                        animateTextTransformation(questionElement, originalQuestionObject.text, translatedQuestionObject.text)
                    );
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞
                    optionElements.forEach((optionEl, i) => {
                        const originalOption = originalQuestionObject.options[i];
                        const translatedOption = translatedQuestionObject.options[i];

                        if (originalOption && translatedOption) {
                            // –°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç (—Å –∏–∫–æ–Ω–∫–æ–π) –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
                            const originalFullText = `${originalOption.isCorrect ? '‚úì' : '‚úó'} ${originalOption.text}`;
                            const translatedFullText = `${translatedOption.isCorrect ? '‚úì' : '‚úó'} ${translatedOption.text}`;
                            
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—É—é –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                            allAnimations.push(animateSingleLine(optionEl, originalFullText, translatedFullText));
                        }
                    });

                    // 3. –ñ–¥–µ–º, –ø–æ–∫–∞ –í–°–ï –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–∞—Ç—Å—è
                    await Promise.all(allAnimations);
                }

                // 4. –û–±–Ω–æ–≤–ª—è–µ–º onclick-–∞—Ç—Ä–∏–±—É—Ç—ã –∫–Ω–æ–ø–æ–∫ –Ω–æ–≤—ã–º (–ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–º) —Ç–µ–∫—Å—Ç–æ–º
                const translatedRawText = formatQuestionObjectToQstString(translatedQuestionObject);
                const escapedTranslatedText = escape(translatedRawText);

                const explainBtn = card.querySelector('.explain-search-result-btn');
                if (explainBtn) explainBtn.setAttribute('onclick', `window.mainApp.handleExplainClickInSearch(event, "${escapedTranslatedText}")`);
                
                const copyBtn = card.querySelector('.copy-search-result-btn');
                if (copyBtn) copyBtn.setAttribute('onclick', `window.mainApp.handleCopyClickInSearch(event, "${escapedTranslatedText}")`);
                
                const favBtn = card.querySelector('.favorite-search-result-btn');
                if (favBtn) favBtn.setAttribute('onclick', `window.mainApp.handleFavoriteClickInSearch(event, "${escapedTranslatedText}")`);
                
                buttonElement.setAttribute('onclick', `window.mainApp.handleTranslateClickInSearch(event, this, "${escapedTranslatedText}")`);
            } else {
                alert(_('error_translation_failed'));
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ –≤ –ø–æ–∏—Å–∫–µ:", error);
            alert(_('error_translation_failed'));
        } finally {
            buttonElement.classList.remove('translating');
            buttonElement.disabled = false;
        }
    }


    
    function manageBackButtonInterceptor() {
        // –ö–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–æ—Ç –∂–µ —Å–∞–º—ã–π
        history.pushState(null, '', location.href);
        window.addEventListener('popstate', handleBackButton);
        console.log('–õ–æ–≤—É—à–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞.');
    }




    function setupExtensionListener() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è Chrome
        // === –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ö–û–î–ê ===
        window.addEventListener("message", (event) => {
            // –ü—Ä–∏–Ω–∏–º–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –æ—Ç —Å–∞–º–æ–≥–æ —Å–µ–±—è (–æ—Ç –Ω–∞—à–µ–≥–æ content script)
            if (event.source !== window || !event.data) {
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞—à —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–∏–ø
            if (event.data.type && (event.data.type === "FROM_QSTIUM_EXTENSION")) {
                 console.log('–°–∞–π—Ç QSTiUM –ø–æ–ª—É—á–∏–ª –∫–æ–º–∞–Ω–¥—É –ø–æ–∏—Å–∫–∞ –æ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:', event.data.text);
                 
                 const searchInput = getEl('searchQueryInput');
                 const searchButton = getEl('searchButton');
                 
                 if(searchInput && searchButton) {
                    // –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ
                    searchInput.value = event.data.text;
                    
                    // –ò–º–∏—Ç–∏—Ä—É–µ–º –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –ø–æ–∏—Å–∫–∞
                    searchButton.click();
                 }
            }
        }, false);
        // === –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ö–û–î–ê ===
        console.log("–°–ª—É—à–∞—Ç–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è QSTiUM Helper –∞–∫—Ç–∏–≤–µ–Ω.");
    }



    /**
     * –°–æ–∑–¥–∞–µ—Ç –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç Intersection Observer –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è CSS-–∞–Ω–∏–º–∞—Ü–∏—è–º–∏.
     * –ê–Ω–∏–º–∞—Ü–∏—è –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–Ω–∞ —Ç–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ —ç–ª–µ–º–µ–Ω—Ç –≤–∏–¥–µ–Ω –Ω–∞ —ç–∫—Ä–∞–Ω–µ.
     */
    function setupAnimationObserver() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–∏ –±—Ä–∞—É–∑–µ—Ä —ç—Ç—É —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é
        if (!('IntersectionObserver' in window)) {
            console.warn('IntersectionObserver –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ê–Ω–∏–º–∞—Ü–∏–∏ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ.');
            // –í –∫–∞—á–µ—Å—Ç–≤–µ –∑–∞–ø–∞—Å–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –≤—Å–µ–º —ç–ª–µ–º–µ–Ω—Ç–∞–º
            document.querySelectorAll('.chat-badge, .unread-badge, .question-square.has-votes, .tab-counter').forEach(el => {
                el.classList.add('pulse-active');
            });
            return;
        }

        // –°–æ–∑–¥–∞–µ–º —Å–∞–º "–Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å"
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                // isIntersecting - —ç—Ç–æ —Å–≤–æ–π—Å—Ç–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ –≥–æ–≤–æ—Ä–∏—Ç, –≤–∏–¥–µ–Ω –ª–∏ —ç–ª–µ–º–µ–Ω—Ç
                if (entry.isIntersecting) {
                    // –ï—Å–ª–∏ –≤–∏–¥–µ–Ω - –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                    entry.target.classList.add('pulse-active');
                } else {
                    // –ï—Å–ª–∏ –Ω–µ –≤–∏–¥–µ–Ω - —É–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å
                    entry.target.classList.remove('pulse-active');
                }
            });
        });

        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –∑–∞ –∫–æ—Ç–æ—Ä—ã–º–∏ –Ω—É–∂–Ω–æ —Å–ª–µ–¥–∏—Ç—å
        const animatedElements = document.querySelectorAll('.chat-badge, .unread-badge, .question-square.has-votes, .tab-counter');
        
        // –ì–æ–≤–æ—Ä–∏–º "–Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—é" –Ω–∞—á–∞—Ç—å —Å–ª–µ–¥–∏—Ç—å –∑–∞ –∫–∞–∂–¥—ã–º –∏–∑ –Ω–∏—Ö
        animatedElements.forEach(el => observer.observe(el));
    }


    // Expose mainApp to window for ChatModule access
    // =================================================================
    // ====      –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ü–ï–†–ï–í–û–î–ê –í–û–ü–†–û–°–ê (v1.0)        ====
    // =================================================================

    /**
     * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º –ø–µ—Ä–µ–≤–æ–¥–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
     */
    function toggleTranslateMode() {
        isTranslateModeEnabled = !isTranslateModeEnabled;
        localStorage.setItem('isTranslateModeEnabled', isTranslateModeEnabled);
        updateTranslateModeToggleVisual();
        // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å/–æ—Ç–º–µ–Ω–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥
        if (!quizArea.classList.contains('hidden') && questionsForCurrentQuiz.length > 0) {
            loadQuestion(currentQuestionIndex);
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∫–Ω–æ–ø–∫–∏-–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞.
     */
    function updateTranslateModeToggleVisual() {
        if (translateQuestionBtn) {
            translateQuestionBtn.classList.toggle('active', isTranslateModeEnabled);
        }
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –æ–±—ä–µ–∫—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞.
     * @param {object} questionObject - –ò—Å—Ö–æ–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç –≤–æ–ø—Ä–æ—Å–∞.
     * @param {string} targetLang - –ö–æ–¥ —Ü–µ–ª–µ–≤–æ–≥–æ —è–∑—ã–∫–∞ ('ru', 'en', 'kz').
     * @returns {Promise<object|null>} - –ü—Ä–æ–º–∏—Å —Å –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–º –æ–±—ä–µ–∫—Ç–æ–º –≤–æ–ø—Ä–æ—Å–∞ –∏–ª–∏ null –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.
     */
    async function getTranslatedQuestion(questionObject, targetLang) {
        try {
            const response = await fetch(googleAppScriptUrl, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'translateQuestion',
                    questionObject: questionObject,
                    targetLang: targetLang
                })
            });
            const result = await response.json();
            if (result.success) {
                return result.translatedQuestion;
            } else {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:', result.error);
                return null;
            }
        } catch (error) {
            console.error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ:', error);
            return null;
        }
    }





    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –ø–µ—Ä–µ–≤–æ–¥ –∏–∑ –∫—ç—à–∞ –∏–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞, –µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –Ω–µ—Ç.
     * –¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∫–ª—é—á–∞–º–∏, –∑–∞–≤–∏—Å—è—â–∏–º–∏ –æ—Ç —è–∑—ã–∫–∞.
     * @param {object} questionObject - –ò—Å—Ö–æ–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç –≤–æ–ø—Ä–æ—Å–∞.
     * @param {number} originalIndex - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≤–æ–ø—Ä–æ—Å–∞ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ.
     * @param {string} targetLang - –¶–µ–ª–µ–≤–æ–π —è–∑—ã–∫ –ø–µ—Ä–µ–≤–æ–¥–∞.
     * @returns {Promise<{question: object, fromCache: boolean}|null>} - –û–±—ä–µ–∫—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –∏–ª–∏ null.
     */
    async function getCachedOrFetchTranslation(questionObject, originalIndex, targetLang) {
        // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π, –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á.
        const cacheKey = getCacheKey(originalIndex, targetLang);

        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à —Å–µ—Å—Å–∏–∏ –ø–æ –Ω–æ–≤–æ–º—É –∫–ª—é—á—É.
        if (currentQuizTranslations.has(cacheKey)) {
            return { question: currentQuizTranslations.get(cacheKey), fromCache: true };
        }

        // 2. –ï—Å–ª–∏ –≤ –∫—ç—à–µ –Ω–µ—Ç, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥ —Å —Å–µ—Ä–≤–µ—Ä–∞.
        const translatedQuestion = await getTranslatedQuestion(questionObject, targetLang);

        // 3. –ï—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ —É—Å–ø–µ—à–µ–Ω, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –í–ï–ó–î–ï.
        if (translatedQuestion) {
            // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à —Å–µ—Å—Å–∏–∏ —Å –Ω–æ–≤—ã–º –∫–ª—é—á–æ–º.
            currentQuizTranslations.set(cacheKey, translatedQuestion);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –∫—ç—à localStorage
            if (currentFileCacheKey) {
                try {
                    const serializedCache = JSON.stringify(Array.from(currentQuizTranslations.entries()));
                    localStorage.setItem(currentFileCacheKey, serializedCache);
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—ç—à–∞ –≤ localStorage (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Ç –º–µ—Å—Ç–∞):", e);
                }
            }
            return { question: translatedQuestion, fromCache: false };
        }

        // 4. –ï—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ –Ω–µ —É–¥–∞–ª—Å—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null.
        return null;
    }







    /**
     * –ö–æ–ø–∏—Ä—É–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ CSS-—Å—Ç–∏–ª–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∑–µ—Ä–∫–∞–ª—å–Ω—ã–π
     */
    function copyRelevantStyles(sourceElement, targetElement) {
        const computedStyle = window.getComputedStyle(sourceElement);
        const relevantStyles = [
            'width', 'font-family', 'font-size', 'font-weight', 'font-style',
            'line-height', 'letter-spacing', 'word-spacing', 'text-transform',
            'padding-left', 'padding-right', 'padding-top', 'padding-bottom',
            'border-left-width', 'border-right-width', 'box-sizing',
            'word-break', 'overflow-wrap', 'hyphens'
        ];
        
        relevantStyles.forEach(style => {
            targetElement.style[style] = computedStyle[style];
        });
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ —Ç–µ–∫—Å—Ç–∞, –∞–Ω–∞–ª–∏–∑–∏—Ä—É—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã—Å–æ—Ç—ã —ç–ª–µ–º–µ–Ω—Ç–∞
     */
    function getVisualLines(text, referenceElement) {
        if (!text.trim()) return [''];
        
        // –°–æ–∑–¥–∞–µ–º –∑–µ—Ä–∫–∞–ª—å–Ω—ã–π –Ω–µ–≤–∏–¥–∏–º—ã–π —ç–ª–µ–º–µ–Ω—Ç
        const mirror = document.createElement('div');
        mirror.style.position = 'absolute';
        mirror.style.visibility = 'hidden';
        mirror.style.top = '-9999px';
        mirror.style.left = '-9999px';
        mirror.style.whiteSpace = 'normal';
        mirror.style.wordWrap = 'break-word';
        
        // –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç–∏–ª–∏
        copyRelevantStyles(referenceElement, mirror);
        
        document.body.appendChild(mirror);
        
        const words = text.split(/(\s+)/); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–±–µ–ª—ã
        const lines = [];
        let currentLine = '';
        let lastHeight = 0;
        
        try {
            for (let i = 0; i < words.length; i++) {
                const testText = currentLine + words[i];
                mirror.textContent = testText;
                const currentHeight = mirror.offsetHeight;
                
                // –ï—Å–ª–∏ –≤—ã—Å–æ—Ç–∞ —É–≤–µ–ª–∏—á–∏–ª–∞—Å—å, –∑–Ω–∞—á–∏—Ç –ø—Ä–æ–∏–∑–æ—à–µ–ª –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
                if (lastHeight > 0 && currentHeight > lastHeight) {
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å—Ç—Ä–æ–∫—É –≤ –º–∞—Å—Å–∏–≤ (–±–µ–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–æ–≤–∞)
                    lines.push(currentLine.trim());
                    currentLine = words[i];
                } else {
                    currentLine = testText;
                }
                
                lastHeight = currentHeight;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É
            if (currentLine.trim()) {
                lines.push(currentLine.trim());
            }
            
            return lines.length > 0 ? lines : [''];
        } finally {
            document.body.removeChild(mirror);
        }
    }

    /**
     * –ê–Ω–∏–º–∏—Ä—É–µ—Ç –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º –∫—É—Ä—Å–æ—Ä–∞
     */
    async function animateSingleLine(element, startText, endText) {
        const cursor = '|';
        const charDelay = 7;
        const totalSteps = Math.max(startText.length, endText.length);

        for (let i = 0; i <= totalSteps; i++) {
            const newPart = endText.substring(0, i);
            const oldPart = startText.substring(i);
            element.textContent = newPart + cursor + oldPart;
            await new Promise(resolve => setTimeout(resolve, charDelay));
        }
        element.textContent = endText;
    }

    /**
     * –û—Å–Ω–æ–≤–Ω–∞—è "—É–º–Ω–∞—è" —Ñ—É–Ω–∫—Ü–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
     */
    async function animateTextTransformation(element, startText, endText) {
        // –§–∞–∑–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è: –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
        const startLines = getVisualLines(startText, element);
        const endLines = getVisualLines(endText, element);
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        const maxLines = Math.max(startLines.length, endLines.length);
        
        // –§–∞–∑–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏: —Å–æ–∑–¥–∞–µ–º div –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏
        const originalContent = element.innerHTML;
        element.innerHTML = '';
        
        const lineDivs = [];
        for (let i = 0; i < maxLines; i++) {
            const lineDiv = document.createElement('div');
            lineDiv.style.minHeight = '1em'; // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ö–ª–æ–ø—ã–≤–∞–Ω–∏–µ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫
            element.appendChild(lineDiv);
            lineDivs.push(lineDiv);
        }
        
        try {
            // –§–∞–∑–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏: –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
            const animations = [];
            
            for (let i = 0; i < maxLines; i++) {
                const startLine = startLines[i] || '';
                const endLine = endLines[i] || '';
                
                animations.push(
                    animateSingleLine(lineDivs[i], startLine, endLine)
                );
            }
            
            // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∞–Ω–∏–º–∞—Ü–∏–π
            await Promise.all(animations);
            
        } finally {
            // –§–∞–∑–∞ –æ—á–∏—Å—Ç–∫–∏: –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
            element.innerHTML = '';
            element.textContent = endText;
        }
    }





    /**
     * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —è–∑—ã–∫ —Ç–µ–∫—Å—Ç–∞ –ø–æ –Ω–∞–ª–∏—á–∏—é —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤.
     * @param {string} text - –¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
     * @returns {string} - –ö–æ–¥ —è–∑—ã–∫–∞ ('kk', 'en', 'ru').
     */
    function detectLanguage(text) {
        if (/[”ô—ñ“£“ì“Ø“±“õ”©“ª]/i.test(text)) return 'kk';
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ª–∞—Ç–∏–Ω–∏—Ü—É, –Ω–æ –∏—Å–∫–ª—é—á–∞–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –∏–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–≤–∞
        if (/[a-z]/i.test(text) && !/[–∞-—è]/i.test(text)) return 'en';
        return 'ru';
    }





    /**
     * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —É–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.
     * @param {object} originalQuestion - –ò—Å—Ö–æ–¥–Ω—ã–π (–Ω–µ–ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π) –æ–±—ä–µ–∫—Ç –≤–æ–ø—Ä–æ—Å–∞.
     */
    async function displayTranslatedQuestion(originalQuestion) {
        const indexAtRequestTime = currentQuestionIndex;
        
        // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–µ–ª–µ–≤–æ–π —è–∑—ã–∫ –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ.
        const targetLang = localStorage.getItem('appLanguage') || 'ru';
        const cacheKey = getCacheKey(originalQuestion.originalIndex, targetLang);

        // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫—ç—à–∞ –¥–ª—è –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –Ø–ó–´–ö–ê.
        const isCachedForThisLang = currentQuizTranslations.has(cacheKey);

        if (isCachedForThisLang) {
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ –¥–ª—è –Ω—É–∂–Ω–æ–≥–æ —è–∑—ã–∫–∞ —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –µ–≥–æ.
            const translatedQuestion = currentQuizTranslations.get(cacheKey);
            displayQuestionContent(translatedQuestion, false);
        } else {
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥–∞ –¥–ª—è —ç—Ç–æ–≥–æ —è–∑—ã–∫–∞ –Ω–µ—Ç, –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π.
            displayQuestionContent(originalQuestion, false);
            translateQuestionBtn?.classList.add('translating');
            
            try {
                // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º —Ü–µ–ª–µ–≤–æ–π —è–∑—ã–∫ –≤ —Ñ—É–Ω–∫—Ü–∏—é.
                const result = await getCachedOrFetchTranslation(originalQuestion, originalQuestion.originalIndex, targetLang);

                if (indexAtRequestTime !== currentQuestionIndex) {
                    console.log('–ü–µ—Ä–µ–≤–æ–¥ –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –æ—Ç–º–µ–Ω–µ–Ω.');
                    return;
                }
                
                if (result && !result.fromCache) {
                    const translatedQuestion = result.question;
                    const allAnimations = [];
                    
                    allAnimations.push(animateTextTransformation(questionTextEl, originalQuestion.text, translatedQuestion.text));

                    const optionElements = answerOptionsEl.querySelectorAll('li');
                    for (let i = 0; i < optionElements.length; i++) {
                        const li = optionElements[i];
                        const originalOptionText = originalQuestion.options[i]?.text || '';
                        const translatedOptionText = translatedQuestion.options[i]?.text || '';
                        
                        if (originalOptionText || translatedOptionText) {
                            allAnimations.push(
                                new Promise(resolve => {
                                    setTimeout(async () => {
                                        await animateSingleLine(li, originalOptionText, translatedOptionText);
                                        resolve();
                                    }, i * 100); 
                                })
                            );
                        }
                    }
                    
                    await Promise.all(allAnimations);
                    
                } else if (!result) {
                    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤–æ–ø—Ä–æ—Å. –ë—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –æ—Ä–∏–≥–∏–Ω–∞–ª.");
                }
            } finally {
                translateQuestionBtn?.classList.remove('translating');
            }
        }
    }





    /**
     * –ú–ì–ù–û–í–ï–ù–ù–û –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ –∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏.
     * –í–ï–†–°–ò–Ø 2.0: –í—Å–µ–≥–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø–æ–¥—Å–≤–µ—Ç–∫—É —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤,
     * –Ω–æ –¥–µ–ª–∞–µ—Ç —Å–ª–æ–≤–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ.
     * @param {object} question - –û–±—ä–µ–∫—Ç –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.
     */
    function displayQuestionContent(question) {
        // 1. –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ, –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ.
        questionTextEl.innerHTML = '';
        answerOptionsEl.innerHTML = '';

        // 2. –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–∑–¥–∞–µ—Ç HTML —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π.
        // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –µ—Å–ª–∏ —É –≤–æ–ø—Ä–æ—Å–∞ –µ—Å—Ç—å –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞, –æ–Ω–∏ –±—É–¥—É—Ç –∫—Ä–∞—Å–Ω—ã–º–∏.
        questionTextEl.innerHTML = renderQuestionTextWithTriggers(question);

        // 3. –ê –≤–æ—Ç –ö–õ–ò–ö–ê–ë–ï–õ–¨–ù–û–°–¢–¨ –¥–æ–±–∞–≤–ª—è–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–µ–∂–∏–º —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –∞–∫—Ç–∏–≤–µ–Ω.
        // –≠—Ç–æ —Ä–∞–∑–¥–µ–ª—è–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.
        if (triggerWordModeEnabled) {
            addTriggerClickListeners();
        }

        // 4. –ö–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Å—Ç–∞—ë—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
        if (question.options) {
            question.options.forEach((option, i) => {
                const li = document.createElement('li');
                li.dataset.index = i;
                li.textContent = option.text;
                answerOptionsEl.appendChild(li);
                
                const answerState = userAnswers[currentQuestionIndex];
                if (answerState && answerState.answered) {
                    li.classList.add('answered');
                    if (i === answerState.selectedOptionIndex) {
                        li.classList.add(answerState.correct ? 'correct' : 'incorrect');
                    }
                    if (!answerState.correct && i === question.correctAnswerIndex) {
                        li.classList.add('actual-correct');
                    }
                } else {
                    li.addEventListener('click', handleAnswerSelect);
                }
            });
        }
    }






    // === –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ö–û–î–ê ===
    function updateDownloadButtonsText() {
        if (!downloadTranslatedTxtButton || !downloadTranslatedQstButton) return;
        const lang = localStorage.getItem('appLanguage') || 'ru';
        
        let textTxt = _('download_translated_txt_button').replace('{lang}', lang);
        downloadTranslatedTxtButton.textContent = textTxt;

        let textQst = _('download_translated_qst_button').replace('{lang}', lang);
        downloadTranslatedQstButton.textContent = textQst;
    }



    /**
     * –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø-–ü–û–ú–û–©–ù–ò–ö
     * –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤–æ–ø—Ä–æ—Å–∞, –≤—Å—Ç–∞–≤–ª—è—è –º–∞—Ä–∫–µ—Ä—ã (~) –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä-—Å–ª–æ–≤.
     * @param {object} questionObject - –û–±—ä–µ–∫—Ç –≤–æ–ø—Ä–æ—Å–∞, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å triggeredWordIndices.
     * @returns {string} - –¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞, –≥–æ—Ç–æ–≤—ã–π –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ .qst —Ñ–∞–π–ª.
     */
    function reconstructTextWithTriggers(questionObject) {
        // –ï—Å–ª–∏ —É –≤–æ–ø—Ä–æ—Å–∞ –Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –Ω–µ—Ç –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤, –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç.
        if (!questionObject.text || !questionObject.triggeredWordIndices || questionObject.triggeredWordIndices.length === 0) {
            return questionObject.text;
        }

        const tokens = tokenizeText(questionObject.text);
        let reconstructedText = '';
        let wordIdx = 0;

        tokens.forEach(token => {
            const isWord = /\S/.test(token) && !/^[.,;:!?()"‚Äú‚Äù¬´¬ª-]+$/.test(token);
            if (isWord) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–µ–µ —Å–ª–æ–≤–æ —Ç—Ä–∏–≥–≥–µ—Ä–æ–º
                if (questionObject.triggeredWordIndices.includes(wordIdx)) {
                    reconstructedText += `~${token}~`; // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ –º–∞—Ä–∫–µ—Ä—ã
                } else {
                    reconstructedText += token;
                }
                wordIdx++;
            } else {
                // –≠—Ç–æ –ø—É–Ω–∫—Ç—É–∞—Ü–∏—è –∏–ª–∏ –ø—Ä–æ–±–µ–ª, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º
                reconstructedText += token;
            }
        });

        return reconstructedText.trim();
    }


 

    async function handleDownloadTranslatedTxt() {
        if (!isTranslateModeEnabled || currentQuizTranslations.size === 0) {
            alert(_('no_translations_to_download'));
            return;
        }

        const lang = localStorage.getItem('appLanguage') || 'ru';
        let fileContent = '';

        questionsForCurrentQuiz.forEach(q => {
            if (q.type === 'category') {
                fileContent += `--- ${q.text} ---\n\n`;
                return;
            }
            
            const cacheKey = getCacheKey(q.originalIndex, lang);
            const translatedQuestion = currentQuizTranslations.get(cacheKey);
            const questionToUse = translatedQuestion || q;
            
            const correctAnswer = questionToUse.options.find(opt => opt.isCorrect);

            // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞ ---
            const questionTextForFile = reconstructTextWithTriggers(questionToUse);

            fileContent += `${_('download_txt_question_label')}: ${questionTextForFile}\n`;
            fileContent += `${_('download_txt_answer_label')}: ${correctAnswer ? correctAnswer.text : 'N/A'}\n\n`;
        });

        if (!fileContent.trim()) {
            alert(_('error_creating_translation_file'));
            return;
        }

        const baseFileName = originalFileNameForReview ? originalFileNameForReview.replace(/\.(qst|txt)$/i, '') : 'quiz';
        const fileName = `${lang}_${baseFileName}.txt`;

        await downloadOrShareFile(fileName, fileContent, 'text/plain;charset=utf-8', _('share_title_translated_test_txt'));
    }



    async function handleDownloadTranslatedQst() {
        if (!isTranslateModeEnabled || currentQuizTranslations.size === 0) {
            alert(_('no_translations_to_download'));
            return;
        }
        
        const lang = localStorage.getItem('appLanguage') || 'ru';
        let fileContent = '';

        questionsForCurrentQuiz.forEach(q => {
            if (q.type === 'category') {
                fileContent += `#_#${q.text}#_#\n\n`;
                return;
            }
            
            const cacheKey = getCacheKey(q.originalIndex, lang);
            const translatedQuestion = currentQuizTranslations.get(cacheKey);
            const questionToUse = translatedQuestion || q;

            // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞ ---
            const questionTextForFile = reconstructTextWithTriggers(questionToUse);

            fileContent += `? ${questionTextForFile}\n`;
            questionToUse.options.forEach(opt => {
                const prefix = opt.isCorrect ? '+' : '-';
                fileContent += `${prefix} ${opt.text}\n`;
            });
            fileContent += '\n';
        });
        
        if (!fileContent.trim()) {
            alert(_('error_creating_translation_file'));
            return;
        }

        const baseFileName = originalFileNameForReview ? originalFileNameForReview.replace(/\.(qst|txt)$/i, '') : 'quiz';
        const fileName = `${lang}_${baseFileName}.qst`;

        await downloadOrShareFile(fileName, fileContent, 'text/plain;charset=utf-8', _('share_title_translated_test_qst'));
    }


     function handleFlashcardsModeChange() {
            const isChecked = flashcardsModeCheckbox.checked;

            // –ë–ª–æ–∫–∏—Ä—É–µ–º/—Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏
            shuffleAnswersCheckbox.disabled = isChecked;
            readingModeCheckbox.disabled = isChecked;
            feedbackModeCheckbox.disabled = isChecked;

            if (isChecked) {
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –æ–ø—Ü–∏–∏
                shuffleAnswersCheckbox.checked = false;
                readingModeCheckbox.checked = false;
                feedbackModeCheckbox.checked = false;
                // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
                startQuizButton.textContent = _('start_flashcards_button');
            } else {
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                startQuizButton.textContent = _('start_quiz_button');
            }
        }



    async function requestErrorAnalysis() {
        if (currentQuizErrorData.length === 0) {
            alert(_('error_analysis_no_data'));
            return;
        }

        const analysisBtn = getEl('aiAnalysisBtn');
        const resultContainer = getEl('aiAnalysisResult');
        const originalBtnText = analysisBtn.textContent;

        analysisBtn.disabled = true;
        // === –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º—É –ø–µ—Ä–µ–≤–æ–¥–æ–≤ ===
        analysisBtn.textContent = _('ai_analyzing_errors_button');
        resultContainer.classList.add('hidden');
        resultContainer.innerHTML = '';

        try {
            const currentUser = ChatModule.getCurrentUser();
            const userNameForAnalysis = currentUser ? currentUser.displayName : 'guest';

            const response = await fetch(googleAppScriptUrl, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'getErrorAnalysis',
                    errors: currentQuizErrorData,
                    userName: userNameForAnalysis,
                    targetLanguage: localStorage.getItem('appLanguage') || 'ru'
                })
            });

            const result = await response.json();

            if (result.success && result.analysis) {
                resultContainer.innerHTML = marked.parse(result.analysis);
                resultContainer.classList.remove('hidden');
            } else {
                throw new Error(result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –æ—Ç –ò–ò.');
            }

        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∞–Ω–∞–ª–∏–∑–∞ –æ—à–∏–±–æ–∫:", error);
            resultContainer.innerHTML = `<p style="color: var(--feedback-incorrect-text);">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${error.message}</p>`;
            resultContainer.classList.remove('hidden');
        } finally {
            analysisBtn.disabled = false;
            analysisBtn.textContent = _('ai_error_analysis_button');
        }
    }


    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –¥–≤–æ–π–Ω–æ–π –ø–æ–ª–∑—É–Ω–æ–∫ –≤—ã–±–æ—Ä–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞.
     * @param {number} totalQuestions - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ —Ç–µ—Å—Ç–µ.
     */
    function initDualSlider(totalQuestions) {
        if (!rangeSliderStart || !rangeSliderEnd) return;

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        rangeSliderStart.max = totalQuestions;
        rangeSliderEnd.max = totalQuestions;
        questionRangeStartInput.max = totalQuestions;
        questionRangeEndInput.max = totalQuestions;

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–≤–µ—Å—å –¥–∏–∞–ø–∞–∑–æ–Ω)
        rangeSliderStart.value = 1;
        questionRangeStartInput.value = 1;
        rangeSliderEnd.value = totalQuestions;
        questionRangeEndInput.value = totalQuestions;
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
        rangeSliderStart.removeEventListener('input', handleSliderInput);
        rangeSliderEnd.removeEventListener('input', handleSliderInput);
        questionRangeStartInput.removeEventListener('input', handleNumberInput);
        questionRangeEndInput.removeEventListener('input', handleNumberInput);

        rangeSliderStart.addEventListener('input', handleSliderInput);
        rangeSliderEnd.addEventListener('input', handleSliderInput);
        questionRangeStartInput.addEventListener('input', handleNumberInput);
        questionRangeEndInput.addEventListener('input', handleNumberInput);

        updateSliderVisuals();
        generateSliderTicks(totalQuestions); // <-- –î–û–ë–ê–í–õ–ï–ù–û
    }
    
    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª–∑—É–Ω–∫–∞ (–∑–∞–∫—Ä–∞—à–µ–Ω–Ω—É—é –æ–±–ª–∞—Å—Ç—å).
     */
    function updateSliderVisuals() {
        if (!sliderProgress || !rangeSliderStart || !rangeSliderEnd) return;
        
        const startValue = parseInt(rangeSliderStart.value);
        const endValue = parseInt(rangeSliderEnd.value);
        const max = parseInt(rangeSliderStart.max);

        const startPercent = ((startValue - 1) / (max - 1)) * 100;
        const endPercent = ((endValue - 1) / (max - 1)) * 100;

        sliderProgress.style.left = `${startPercent}%`;
        sliderProgress.style.width = `${endPercent - startPercent}%`;
    }


    function handleSliderInput(event) {
        const startSlider = rangeSliderStart;
        const endSlider = rangeSliderEnd;
        const step = 5; // –ù–∞—à –Ω–æ–≤—ã–π —à–∞–≥
        const max = parseInt(startSlider.max);

        // –ü–æ–ª—É—á–∞–µ–º "–ø—Ä–∏–º–∞–≥–Ω–∏—á–µ–Ω–Ω—ã–µ" –∑–Ω–∞—á–µ–Ω–∏—è
        let startValue = snapToStep(parseInt(startSlider.value), step, max);
        let endValue = snapToStep(parseInt(endSlider.value), step, max);
        
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –±–µ–≥—É–Ω–∫–æ–≤
        if (endValue < startValue) {
            // –ï—Å–ª–∏ –¥–≤–∏–≥–∞–ª–∏ –ª–µ–≤—ã–π –±–µ–≥—É–Ω–æ–∫ –∏ –æ–Ω "–∑–∞–µ—Ö–∞–ª" –∑–∞ –ø—Ä–∞–≤—ã–π, –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∏—Ö
            if (event.target.id === 'rangeSliderStart') {
                 startValue = endValue;
            } else { // –ò –Ω–∞–æ–±–æ—Ä–æ—Ç
                 endValue = startValue;
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–æ–∂–µ–Ω–∏–µ —Å–∞–º–∏—Ö –ø–æ–ª–∑—É–Ω–∫–æ–≤, —á—Ç–æ–±—ã –æ–Ω–∏ "–ø—Ä—ã–≥–Ω—É–ª–∏" –Ω–∞ –Ω—É–∂–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
        startSlider.value = startValue;
        endSlider.value = endValue;

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è
        questionRangeStartInput.value = startValue;
        questionRangeEndInput.value = endValue;
        
        updateSliderVisuals();
    }

    /**
     * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –≤ —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª—è—Ö.
     */
    function handleNumberInput(event) {
        let startValue = parseInt(questionRangeStartInput.value);
        let endValue = parseInt(questionRangeEndInput.value);
        const max = parseInt(rangeSliderStart.max);

        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (startValue < 1) startValue = 1;
        if (endValue > max) endValue = max;
        if (startValue > endValue) {
             if (event.target.id === 'questionRangeStart') {
                startValue = endValue;
             } else {
                endValue = startValue;
             }
        }
        
        questionRangeStartInput.value = startValue;
        questionRangeEndInput.value = endValue;

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø–æ–ª–∑—É–Ω–∫–∏
        rangeSliderStart.value = startValue;
        rangeSliderEnd.value = endValue;
        
        updateSliderVisuals();
    }
    
    /**
     * –í–∫–ª—é—á–∞–µ—Ç/–æ—Ç–∫–ª—é—á–∞–µ—Ç –±–ª–æ–∫ –≤—ã–±–æ—Ä–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —á–µ–∫–±–æ–∫—Å–∞ "–°–ª—É—á–∞–π–Ω—ã–π –Ω–∞–±–æ—Ä".
     */
    function handleShuffleNToggle() {
        const isDisabled = shuffleNCheckbox.checked;
        questionRangeGroup.classList.toggle('disabled', isDisabled);
        shuffleNCountInput.disabled = !isDisabled;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –Ω–∞—Å–µ—á–∫–∏ (ticks) –ø–æ–¥ –¥–≤–æ–π–Ω—ã–º –ø–æ–ª–∑—É–Ω–∫–æ–º.
     * @param {number} totalQuestions - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤.
     */
    function generateSliderTicks(totalQuestions) {
        if (!sliderTicks || totalQuestions < 10) {
            sliderTicks.innerHTML = '';
            return;
        }

        sliderTicks.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –Ω–∞—Å–µ—á–∫–∏

        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –Ω–∞—Å–µ—á–µ–∫, —á—Ç–æ–±—ã –∏—Ö –Ω–µ –±—ã–ª–æ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ
        const interval = 5;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫ —á–∞—Å—Ç–æ —Å—Ç–∞–≤–∏—Ç—å —á–∏—Å–ª–æ–≤—ã–µ –º–µ—Ç–∫–∏
        const labelIntervalMultiplier = totalQuestions > 200 ? 5 : 4;
        const labelInterval = interval * labelIntervalMultiplier;

        for (let i = 1; i <= totalQuestions; i += interval) {
            const positionPercent = ((i - 1) / (totalQuestions - 1)) * 100;
            
            const tick = document.createElement('div');
            tick.className = 'tick';
            tick.style.left = `${positionPercent}%`;
            sliderTicks.appendChild(tick);

            // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ, –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏ "—é–±–∏–ª–µ–π–Ω—ã—Ö" –∑–Ω–∞—á–µ–Ω–∏–π
            if (i === 1 || i % labelInterval === 0 || i + interval > totalQuestions) {
                const label = document.createElement('span');
                label.className = 'tick-label';
                label.textContent = (i + interval > totalQuestions && i !== totalQuestions) ? totalQuestions : i;
                label.style.left = `${positionPercent}%`;
                sliderTicks.appendChild(label);
            }
        }
    }


    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ–¥–∏–Ω–æ—á–Ω—ã–π –ø–æ–ª–∑—É–Ω–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏).
     */
    function initSingleSlider() {
        if (!timeLimitInput) return;
        generateTimeSliderTicks();
        updateSingleSliderVisuals(); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –ø–æ–ª–∑—É–Ω–∫–∞.
     */
    function updateSingleSliderVisuals() {
        const progressEl = getEl('timeSliderProgress');
        if (!progressEl || !timeLimitInput) return;
        
        const value = parseInt(timeLimitInput.value);
        const max = parseInt(timeLimitInput.max);
        const percent = (max > 0) ? (value / max) * 100 : 0;
        
        progressEl.style.width = `${percent}%`;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–∞—Å–µ—á–∫–∏ –¥–ª—è –ø–æ–ª–∑—É–Ω–∫–∞ –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏.
     */
    function generateTimeSliderTicks() {
        if (!timeSliderTicks) return;
        timeSliderTicks.innerHTML = '';
        const max = parseInt(timeLimitInput.max);
        const step = 30; // –ù–∞—Å–µ—á–∫–∏ –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç

        for (let i = 0; i <= max; i += step) {
             const positionPercent = (i / max) * 100;
             
             const tick = document.createElement('div');
             tick.className = 'tick';
             tick.style.left = `${positionPercent}%`;
             timeSliderTicks.appendChild(tick);

             if (i > 0 && i < max) {
                const label = document.createElement('span');
                label.className = 'tick-label';
                label.textContent = i;
                label.style.left = `${positionPercent}%`;
                timeSliderTicks.appendChild(label);
             }
        }
    }


    /**
     * "–ü—Ä–∏–º–∞–≥–Ω–∏—á–∏–≤–∞–µ—Ç" –∑–Ω–∞—á–µ–Ω–∏–µ –∫ –±–ª–∏–∂–∞–π—à–µ–º—É —à–∞–≥—É, —Å –æ—Å–æ–±—ã–º —Å–ª—É—á–∞–µ–º –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è.
     * @param {number} value - –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.
     * @param {number} step - –®–∞–≥, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –Ω—É–∂–Ω–æ "–ø—Ä–∏–º–∞–≥–Ω–∏—Ç–∏—Ç—å".
     * @param {number} max - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.
     * @returns {number} - "–ü—Ä–∏–º–∞–≥–Ω–∏—á–µ–Ω–Ω–æ–µ" –∑–Ω–∞—á–µ–Ω–∏–µ.
     */
    function snapToStep(value, step, max) {
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–≤–µ–ª –ø–æ–ª–∑—É–Ω–æ–∫ –¥–æ —Å–∞–º–æ–≥–æ –∫–æ–Ω—Ü–∞, –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞–∫—Å–∏–º—É–º.
      if (value === max) {
        return max;
      }
      // –û–∫—Ä—É–≥–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ, –∫—Ä–∞—Ç–Ω–æ–≥–æ —à–∞–≥—É.
      const snappedValue = Math.round(value / step) * step;
      // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –±—É–¥–µ—Ç –º–µ–Ω—å—à–µ 1.
      return Math.max(1, snappedValue);
    }




    // --- Public methods exposed from mainApp ---
    return {
        init: initializeApp,
        copyToClipboardMain: copyToClipboardMain, 
        parseQstContent: parseQstContent, 
        processFile: processFile,         
        downloadFile: downloadFileBrowserFallback,
        downloadOrShareFile: downloadOrShareFile,
        handleFavoriteClickInSearch: handleFavoriteClickInSearch,
        handleCopyClickInSearch: handleCopyClickInSearch,
        handleExplainClickInSearch: handleExplainClickInSearch,
        handleTranslateClickInSearch: handleTranslateClickInSearch,
        showGlobalLoader: showGlobalLoader,
        hideGlobalLoader: hideGlobalLoader,
        manageBackButtonInterceptor: manageBackButtonInterceptor,
        setupExtensionListener: setupExtensionListener,
        animateTextTransformation: animateTextTransformation,
        testMobileDownload: () => {
            console.log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è...');
            console.log('detectMobileDevice():', detectMobileDevice());
            downloadOrShareFile('test.txt', '–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞', 'text/plain', '–¢–µ—Å—Ç');
        }        
    };
})();

document.addEventListener('DOMContentLoaded', mainApp.init);





window.mainApp = mainApp;

